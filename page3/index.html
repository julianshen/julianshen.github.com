<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>朱隸安貓囈語錄 &#8211; Le murmure de Julian</title>
<meta name="description" content="朱隸安貓囈語錄">
<meta name="keywords" content="java, android, julianshen, backend, blog, golang, swift">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://blog.jln.co/images/bkg2.jpg">

<meta name="twitter:title" content="朱隸安貓囈語錄">
<meta name="twitter:description" content="朱隸安貓囈語錄">
<meta name="twitter:creator" content="@jlnshen">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="朱隸安貓囈語錄">
<meta property="og:description" content="朱隸安貓囈語錄">
<meta property="og:url" content="http://blog.jln.co/page3/">
<meta property="og:site_name" content="Le murmure de Julian">
<meta name="og:image" content="http://blog.jln.co/images/avatar.png">
<meta name="google-site-verification" content="Fwa4TQMXvroZpNT7rrwHzdf-rWBe1RDuTu75Enx_DWA">



<link rel="canonical" href="http://blog.jln.co/page3/">
<link href="http://blog.jln.co/feed.xml" type="application/atom+xml" rel="alternate" title="Le murmure de Julian Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://blog.jln.co/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://blog.jln.co/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://blog.jln.co/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.jln.co/images/apple-touch-icon-144x144-precomposed.png">



  
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1789797875470932",
        enable_page_level_ads: true
    });
    </script>
  

</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://blog.jln.co/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://blog.jln.co/images/avatar.png" alt="Julian Shen photo" class="author-photo">
					<h4>Julian Shen</h4>
					<p>software deverloper</p>
				</li>
				<li>
					<a href="mailto:julianshen22@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/jlnshen"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/julianshen"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				<li>
					<a href="https://linkedin.com/in/julianshen"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/julianshen"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="https://instagram.com/julianshen"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				<li>
					<a href="https://www.flickr.com/photos/julianshen"><i class="fa fa-fw fa-flickr"></i> Flickr</a>
				</li>
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://blog.jln.co/posts/">All Posts</a></li>
				<li><a href="http://blog.jln.co/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="http://blog.jln.co/images/bkg2.jpg" alt="朱隸安貓囈語錄">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Le murmure de Julian</h1>
      <h2>朱隸安貓囈語錄</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2017-01-01T01:56:29+08:00"><a href="http://blog.jln.co/go-%E5%88%A9%E7%94%A8goquery-+-otto%E4%BE%86%E5%88%86%E6%9E%90%E7%B6%B2%E9%A0%81/">January 01, 2017</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/go-%E5%88%A9%E7%94%A8goquery-+-otto%E4%BE%86%E5%88%86%E6%9E%90%E7%B6%B2%E9%A0%81/" rel="bookmark" title="[Go] 利用goquery + otto來分析網頁" itemprop="url">[Go] 利用goquery + otto來分析網頁</a></h1>
    
  </header>
  <div class="entry-content">
    <p>2017的第一篇blog就先又來回的go跟爬蟲了</p>

<p><a href="https://github.com/PuerkitoBio/goquery">goquery</a>在Go是像jquery一樣的存在, 可以讓你用jquery一樣的selector來解析html檔案內容, 像這樣:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">".sidebar-reviews article .content-block"</span><span class="p">)</span><span class="x">
</span></code></pre>
</div>

<p>只要有一些jquery的知識大概就不難上手, 但一般的網頁內容並不只有html這麼簡單而已, 有非常多的網頁是根本把資料給放在javascript, 在browser端再重組而成,
碰到這種, 光解析網頁原始檔是不夠的, 因為很多tag的內容都是之後被javascript所產生的</p>

<p>因此解析這類的網頁, 便可能需要去解析javascript的內容, 甚至是執行javascript, 在Go有一個好用的套件叫<a href="https://github.com/robertkrimen/otto">Otto</a>可以來解決這麻煩</p>

<p>這邊以<a href="https://today.line.me/TW">Line Today</a>的網頁當作範例來說明, 如果你打開Line today的網頁原始檔來看, 絕大部分都是javascript, 而且資料似乎都在categoryJson內(如下)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;script&gt;
    var categoryJson = {
		"categories":[
			{"id":100003,"name":"今日頭條","source":0,"title":null,"thumbnail":null,"url":{"type":"FILE","hash":
		...
		}
		...
&lt;/script&gt;
</code></pre>
</div>

<p>一個土法煉鋼的方式是找到categoryJson前後的{},把它substring出來, 這內容當Json來分析, 但這樣其實還蠻容易出錯的</p>

<p>另一個方式是先用goquery取得這個script內容, 然後用Otto去執行它後把值取出來, 像:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">url</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="s">"https://today.line.me/TW"</span><span class="x">
</span><span class="n">doc</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">goquery</span><span class="o">.</span><span class="n">NewDocument</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="x">

</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
	</span><span class="k">return</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">s</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">"script"</span><span class="p">)</span><span class="x">
</span><span class="n">script</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">.</span><span class="n">FirstChild</span><span class="o">.</span><span class="n">Data</span><span class="x">

</span><span class="n">vm</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">otto</span><span class="o">.</span><span class="n">New</span><span class="p">()</span><span class="x">
</span><span class="n">vm</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">script</span><span class="p">)</span><span class="x">

</span><span class="k">if</span><span class="x"> </span><span class="n">value</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">vm</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"categoryJson"</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">goData</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">value</span><span class="o">.</span><span class="n">Export</span><span class="p">()</span><span class="x">
	</span><span class="n">mapData</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">goData</span><span class="o">.</span><span class="p">([]</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{})</span><span class="x">
	</span><span class="o">...</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>otto很方便, 可以直接執行這個javascript, 還可以取裡面的值, 取出來的值其實是一個叫Value的struct, 如果要方便用的話, 就要用Export()來把資料轉成<code class="highlighter-rouge">interface{}</code></p>

<p>但<code class="highlighter-rouge">interface{}</code>對object來說還是很不好取用, 如果確定你要的值是個javascript object, 那轉成<code class="highlighter-rouge">[]map[string]interface{}</code>會稍稍方便點</p>

<p>不過針對很複雜也很深的物件來說, <code class="highlighter-rouge">[]map[string]interface{}</code>也不是那麼的好用, 當你要存取的值要往下好多層時, 光轉型就要做到瘋掉, 多層次的map很麻煩的呀!</p>

<p>因此我的做法是, 多加一段javascript來減低取出的結構的複雜度, 像這樣:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">vm</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">otto</span><span class="o">.</span><span class="n">New</span><span class="p">()</span><span class="x">
</span><span class="n">vm</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">script</span><span class="p">)</span><span class="x">
</span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">vm</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="s">`
	var news = categoryJson.categories[0].templates[0].sections[0].articles;

	var articles = [];

	for(var n in news) {
		var article = {
			'title': news[n].title,
			'link': news[n].url.url,
			'publisher': news[n].publisher
		};
		articles.push(article);
	}
`</span><span class="p">)</span><span class="x">

</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">if</span><span class="x"> </span><span class="n">value</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">vm</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"articles"</span><span class="p">);</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">goData</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">value</span><span class="o">.</span><span class="n">Export</span><span class="p">()</span><span class="x">

	</span><span class="n">mapData</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">goData</span><span class="o">.</span><span class="p">([]</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{})</span><span class="x">
	</span><span class="n">todayNews</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">make</span><span class="p">([]</span><span class="n">TodayNews</span><span class="p">,</span><span class="x"> </span><span class="m">0</span><span class="p">)</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">data</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">mapData</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">news</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">TodayNews</span><span class="p">{}</span><span class="x">
		</span><span class="n">news</span><span class="o">.</span><span class="n">Title</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">data</span><span class="p">[</span><span class="s">"title"</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="x">
		</span><span class="n">news</span><span class="o">.</span><span class="n">Link</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">data</span><span class="p">[</span><span class="s">"link"</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="x">
		</span><span class="n">news</span><span class="o">.</span><span class="n">ImageUrl</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">data</span><span class="p">[</span><span class="s">"imageUrl"</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="x">
		</span><span class="n">todayNews</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">todayNews</span><span class="p">,</span><span class="x"> </span><span class="n">news</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>這樣一來就稍微簡單多了, 不過目前碰到的缺點是, 似乎有些ES6的語法, 它不太認得呀</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-12-29T15:33:25+08:00"><a href="http://blog.jln.co/android-retrofit-+-protobuf-+-wire/">December 29, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/android-retrofit-+-protobuf-+-wire/" rel="bookmark" title="[Android] Retrofit + Protobuf + Wire" itemprop="url">[Android] Retrofit + Protobuf + Wire</a></h1>
    
  </header>
  <div class="entry-content">
    <p><a href="https://square.github.io/retrofit/">Retrofit</a>目前已然成為最熱門的呼叫REST API的開源程式庫了,不過,
大部分的Retrofit多是用來處理Json類的REST API, 但Retrofit的能力卻不僅限於此</p>

<p>透過Converter, Retrofit可以處理的不只是Json, 還包含了XML, <a href="https://developers.google.com/protocol-buffers/">Protobuf</a>, 甚至你自己的自訂格式, 剛好最近看Json不太順眼,
想來試試<a href="https://developers.google.com/protocol-buffers/">Protobuf</a>, 就來試試這部分</p>

<p><a href="https://square.github.io/retrofit/">Retrofit</a>官方網頁上列的<a href="https://developers.google.com/protocol-buffers/">Protobuf</a> converter有兩種,
一種是使用Google親生的<a href="https://developers.google.com/protocol-buffers/">Protobuf</a>, 這個只要引入<code class="highlighter-rouge">com.squareup.retrofit2:converter-protobuf</code>即可使用,
另一種是有點比較吸引我的是Square自己開發出來的<a href="https://github.com/square/wire">Wire</a>, Sqaure真的是蠻喜歡打造自己的東西的, 打造出來的又比別人威,
這點讓我對<a href="https://github.com/square/wire">Wire</a>的興趣比較大, 因此這篇主要是以<a href="https://github.com/square/wire">Wire</a>當範例來介紹</p>

<p>使用Wire converter其實相當簡單的:</p>

<p>在build.gradle內加入相關的dependencies, 包含了wire runtime跟retorfit的converter:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">compile</span> <span class="s1">'com.squareup.retrofit2:converter-wire:2.1.0'</span>
<span class="n">compile</span> <span class="s1">'com.squareup.wire:wire-runtime:2.2.0'</span>
</code></pre>
</div>

<p>在build service時, 用<code class="highlighter-rouge">addConverterFactory</code>將<code class="highlighter-rouge">WireConverterFactory</code>加入即可</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Retrofit</span> <span class="n">retrofit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Retrofit</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
		<span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
		<span class="o">.</span><span class="na">addConverterFactory</span><span class="o">(</span><span class="n">WireConverterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
		<span class="o">.</span><span class="na">addCallAdapterFactory</span><span class="o">(</span><span class="n">RxJava2CallAdapterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
		<span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">DataService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">retrofit</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">DataService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre>
</div>

<p>DataService的定義如下(這範例搭配了rxjava2):</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DataService</span> <span class="o">{</span>
    <span class="nd">@GET</span><span class="o">(</span><span class="s">"data"</span><span class="o">)</span>
    <span class="n">Single</span><span class="o">&lt;</span><span class="n">Posts</span><span class="o">&gt;</span> <span class="nf">getPosts</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>
</div>

<p>這邊有個問題, <code class="highlighter-rouge">Posts</code>這個class並不是直接用Java刻出來的, 而是由<code class="highlighter-rouge">.proto</code>檔產生的, 內容如下:</p>

<div class="language-protobuf highlighter-rouge"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>
<span class="kn">package</span> <span class="nn">wtf</span><span class="o">.</span><span class="n">cowbay.dp</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">FBPost</span> <span class="p">{</span>
	<span class="kt">string</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">title</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">imgsrc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">target</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">string</span> <span class="na">createdtime</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Posts</span> <span class="p">{</span>
	<span class="k">repeated</span> <span class="n">FBPost</span> <span class="na">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>必須要用工具產生Java class才能使用, Google的Protobuf有自己的工具, 而Wire也有自己的, 如果手動自己執行工具產生檔案後再加入, 未免太鳥,</p>

<p>還好Wire有<a href="https://github.com/square/wire-gradle-plugin">wire-gradle-plugin</a>, 不過這個有個大問題, 雖然放在Square的repo下, 但似乎
不是官方版本, 而是有人貢獻的, 因此並沒有跟上最新的2.x的版本, <a href="https://github.com/square/wire-gradle-plugin/issues/11">JakeWharton大神說將會有官方版本</a>,
但似乎從六月到現在都沒出現, 所以只好<a href="https://github.com/CowBayStudio/wire-gradle-plugin">自力救濟自己改 - 我的版本</a></p>

<p>使用這個plugin很簡單, 先在第一層的build.gradle裡的buildscript加入:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">buildscript</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">jcenter</span><span class="o">()</span>
        <span class="n">maven</span> <span class="o">{</span>
            <span class="n">url</span> <span class="s2">"https://jitpack.io"</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">dependencies</span> <span class="o">{</span>
        <span class="n">classpath</span> <span class="s1">'com.android.tools.build:gradle:2.2.3'</span>

        <span class="n">classpath</span> <span class="s1">'com.github.CowBayStudio:wire-gradle-plugin:ver12'</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>主要是加入jitpack.io, 並把我的版本的plugin放到dependencies去</p>

<p>接下來在app的build.gradle裡加入:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'com.squareup.wire'</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">.proto</code>檔案放置的位子在<code class="highlighter-rouge">app/src/main/proto</code>, 把檔案放在這邊, build的時候就會自動產生這些對應的Java classes了</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-12-27T15:39:59+08:00"><a href="http://blog.jln.co/android-%E6%8A%8Agithub%E7%95%B6maven-repository%E7%94%A8/">December 27, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/android-%E6%8A%8Agithub%E7%95%B6maven-repository%E7%94%A8/" rel="bookmark" title="[Android] 把Github當Maven repository用" itemprop="url">[Android] 把Github當Maven repository用</a></h1>
    
  </header>
  <div class="entry-content">
    <p>自從Android導入gradle之後, 使用開放的第三方的程式庫就越來越方便了, 雖然方便, 但也不免會碰到這類的問題:</p>

<ol>
  <li>想要的功能在master branch上更新了, 但卻遲遲不release以至於想用新的功能無法用</li>
  <li>程式碼已經沒在維護了, maven repository上一直都還是有問題的舊版本, 明知道怎麼修卻無法代他release到maven repository上去, PR又遲遲沒人理</li>
  <li>想加上自己的私有功能, 又不想包整包source codes到app裡面去</li>
  <li>想要開放自己做的程式庫卻覺得release到maven很麻煩</li>
</ol>

<p>還好有<a href="https://jitpack.io/">Jitpack</a>這東西, 剛剛就是碰到一個東西有問題, 想把它修掉直接用, 研究了一下</p>

<p>用法很簡單, 首先要先把<code class="highlighter-rouge">maven { url 'https://jitpack.io' }</code>加入到repositories裡面去</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">allprojects</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s1">'https://jitpack.io'</span> <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>然後在你的<code class="highlighter-rouge">dependencies</code>裡面加入:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">compile</span> <span class="s1">'com.github.User:Repo:Tag'</span>
</code></pre>
</div>

<p>User就是你Github的user name, Repo是Repository的名稱, Tag是Git的tag名稱, 舉個例：https://github.com/CowBayStudio/wire-gradle-plugin ,
像這樣的Url, User name就是CowBayStudio, repo就是wire-gradle-plugin , 如果你的Git repo並沒有任何的Tag, 可以用Commit hash或是branch-SNAPSHOT(例如master-SNAPSHOT), 當然
自己加上tag會是比較好的做法, 比較好控管</p>

<p>當你去build你的app時, 在抓這個dependency時, Jitpack就會自動幫你把code從github抓下來build好,
當然是developer就免不了有bug, 導致build fail, 去 Jitpack網站把你Github的URL貼上去就可以找到build log了, 像是<a href="https://jitpack.io/com/github/CowBayStudio/wire-gradle-plugin/ver11/build.log">這個</a></p>

<p>我在弄我的東西時, 就發生了build fail的狀況, 而問題的原因是其中一個依賴的jar是JAVA 8 build出來的, 但jitpack用Java 7去build我的程式庫(文件說default應該是Java 8呀, 騙我!),
這時候可以加一個jitpack.yml, 內容如下:</p>

<div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="s">jdk</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">oraclejdk8</span>
</code></pre>
</div>

<p>透過jitpack.yml可以有很多客制可設定, 詳情就看一下<a href="https://jitpack.io/docs/BUILDING/#build-customization">文件</a>吧!</p>

<p>所以碰到自己想動的程式庫, 可以直接fork出來改, 改出來的就可以直接這樣用了</p>

<p>那private repo呢?付錢給<a href="https://jitpack.io/private#subscribe">Jitpack</a>就有啦! XD</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-12-11T21:27:45+08:00"><a href="http://blog.jln.co/android-%E5%9C%A8android-studio%E5%8F%96%E5%BE%97certificate-fingerprints/">December 11, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/android-%E5%9C%A8android-studio%E5%8F%96%E5%BE%97certificate-fingerprints/" rel="bookmark" title="[Android] 在Android Studio取得certificate fingerprints" itemprop="url">[Android] 在Android Studio取得certificate fingerprints</a></h1>
    
  </header>
  <div class="entry-content">
    <p>在使用很多API服務像是Google的API或是Facebook的API, 常常會需要拿簽署APK的Key的signature登錄,
取得這sigature的方法有很多種, 剛學到一種是直接可以從Android studio的Gardle選單內取得的, 方法如下:</p>

<p>Gradle-&gt;(Project name)-&gt;Tasks-&gt;singningReports</p>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/D1HwAnk49xU" frameborder="0" allowfullscreen=""></iframe></figure></div>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-11-29T17:39:41+08:00"><a href="http://blog.jln.co/android-firebase-+-webrtc-on-android/">November 29, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/android-firebase-+-webrtc-on-android/" rel="bookmark" title="[Android] Firebase + WebRTC on Android" itemprop="url">[Android] Firebase + WebRTC on Android</a></h1>
    
  </header>
  <div class="entry-content">
    <p><a href="https://webrtc.org/">WebRTC</a>是一個支援瀏覽器的即時影音對話的架構, 算是一個業界標(W3C,IETF), 最近由於想做一個有影音通話的應用, 就研究了一下這東西</p>

<p>如果只是想嘗試一下<a href="https://webrtc.org/">WebRTC</a>, 是可以直接是可以直接試<a href="https://appr.tc/">AppRTC</a>這個Google的範例, 不過這個是Web的版本, 我想要做的是
手機的版本(Android, iOS), <a href="https://appr.tc/">AppRTC</a>其實也有Android的版本可搭配</p>

<p>為了熟悉一下整個用WebRTC建立video call的流程, 因此我就決定改一下這個Android版本, 原本Google的版本是透過Web Socket</p>

<p>至於流程與架構我會建議看這影片:</p>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/HS1eKPL4f1o" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>如果不想看太長, 就看這個:</p>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/nDPlGcoArdM" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>把Web RTC那段換成Firebase(好, 其實我蠻後悔選Firebase來實作的)其實就是把Signaling這段給換掉, 而這段流程是(節錄自影片):</p>

<p><img src="/images/posts/webrtc.png" alt="" /></p>

<p>這部分其實就是交換兩邊的SDP和ICE candidate的過程, 詳細可以參考<a href="http://blog.mozilla.com.tw/posts/3261/webrtc-%E7%9B%B8%E9%97%9C%E7%B8%AE%E5%AF%AB%E5%90%8D%E8%A9%9E%E7%B0%A1%E4%BB%8B">這邊:WebRTC 相關縮寫名詞簡介</a></p>

<p>結果的source code放在<a href="https://github.com/julianshen/apprtc-android-demo">這邊 : apprtc-android-demo</a></p>

<h3 id="building-webrtc-lib-on-android">Building WebRTC lib on Android</h3>

<p>其實現在寫WebRTC的應用的話, 也不用從頭實作, Google老早就把它實作在<a href="http://chromium.org">Chromium</a>裡面了, 也可以單獨build出library用</p>

<p>這邊有官方的<a href="https://webrtc.org/native-code/android/">如何建置出Android版本的Web RTC library</a>, 不過, 不要照著這份文件做呀, 不然頭髮會白好幾根, 可能還build不太起來,
找了一堆網路上人家的建議也都是不要直接build, 直接用人家build好現成的, 不過, 現成的雖然有一些, 但大多是過時的, API跟現今的也不太一樣, 如果
要套用到現在的Android版本AppRTC的source code內, 大多都沒辦法用</p>

<p>所幸找到這個<a href="https://github.com/pristineio/webrtc-build-scripts/tree/master/android">build script: pristineio/webrtc-build-scripts</a>,
這個從下載最新的source code到build出library一律包辦, 用法也很簡單, 只要執行下面的:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">source </span>android/build.sh
install_dependencies
get_webrtc
build_apprtc
</code></pre>
</div>

<p>簡單明暸, 但…有幾個問題, 第一個是只能在Linux下build, 因此在Mac跟Windows下要透過<a href="https://www.vagrantup.com/">Vagrant</a>這類的工具,
而且對硬體需求也很高, 我的2012年中版的Macbook Pro retina實在是跑不動, 後來跑去Digital Ocean租了台VM來build, 本以為最便宜的可以勝任,
後來發現, 至少要4G RAM, 硬碟要20G以上的instance(哭哭, 浪費好多時間)</p>

<p>build出來後, 所需要的東西包含了libjingle_peerconnection.jar和libjingle_peerconnection_so.so, 把這幾個備份起來就是了, 待會build apk需要用</p>

<h3 id="apprtc-android-source-codes">AppRTC 範例的Android source codes</h3>

<p>Android的範例的source codes<a href="https://chromium.googlesource.com/external/webrtc/+/master/webrtc/examples/androidapp/">可以在這邊下載</a></p>

<p>不過這並不是Android studio的project格式, 因此需要用匯入的方式, 或是可以直接fork<a href="https://github.com/julianshen/apprtc-android-demo">我的版本</a>去改,
由於原本的版本使用了Web socket做singaling的管道, 因此需要<a href="http://autobahn.ws/">Autobahn</a>,	但你切記絕對不能用<a href="http://autobahn.ws/">Autobahn</a>官方最新的jar檔,
而是要用Google放在third_party裡面那個autobanh.jar(啊, 我到現在才發現名字有些許不同), 這邊的差異是, 原本<a href="http://autobahn.ws/">Autobahn</a>是沒有支援SSL的websocket的,
但AppRTC的websocket則是要透過SSL來連接</p>

<p>把jar跟so檔放到對應的目錄去後, 記得改一下app目錄下的build.gradle加入 (因為import產生的不會幫你加):</p>

<div class="language-gradle highlighter-rouge"><pre class="highlight"><code><span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="nf">fileTree</span><span class="o">(</span><span class="nl">dir:</span> <span class="s1">'libs'</span><span class="o">,</span> <span class="nl">include:</span> <span class="o">[</span><span class="s1">'*.jar'</span><span class="o">])</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="firebase">加上firebase</h3>

<p>除了原本的Webcoket和Direct connect兩種方式外, 為了跑一次他的流程我多加了Firebase的部分, 利用它的realtime database來做Signaling這部分,
至於怎樣開始開發firebase, 就參考一下他的<a href="https://firebase.google.com/docs/database/android/start/">官方文件</a>吧</p>

<h3 id="signaling">Signaling的實作</h3>

<h4 id="callactivity">CallActivity</h4>

<p>選擇哪種signaling的方式是在CallActivity裡面依據roomId來看使用哪一個signaling client, 程式碼如下:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Create connection client. Use DirectRTCClient if room name is an IP otherwise use the</span>
    <span class="c1">// standard WebSocketRTCClient.</span>
    <span class="k">if</span><span class="o">(</span><span class="s">"firebase"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">roomId</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"firebase"</span><span class="o">);</span>
      <span class="n">appRtcClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FirebaseRTCClient</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">loopback</span> <span class="o">||</span> <span class="o">!</span><span class="n">DirectRTCClient</span><span class="o">.</span><span class="na">IP_PATTERN</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">roomId</span><span class="o">).</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">appRtcClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocketRTCClient</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Using DirectRTCClient because room name looks like an IP."</span><span class="o">);</span>
      <span class="n">appRtcClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DirectRTCClient</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>原本有WebSocketRTCClient和DirectRTCClient, 如果是IP的話就用DirectRTCClient,這邊我多加一個FirebaseRTCClient, 只要roomId是firebase就會使用這個(我偷懶)</p>

<h4 id="firebasertcclient">FirebaseRTCClient</h4>

<p>XXXRTCClient這部分實作了signaling的部分, 因此我參考了WebSocketRTCClient和DirectRTCClient的內容來寫FirebaseRTCClient</p>

<p>跟WebSocketRTCClinet一樣, 它必須實作AppRTCClient, AppRTCClient這個Interface定義如下:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * AppRTCClient is the interface representing an AppRTC client.
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AppRTCClient</span> <span class="o">{</span>
  <span class="cm">/**
   * Struct holding the connection parameters of an AppRTC room.
   */</span>
  <span class="kd">class</span> <span class="nc">RoomConnectionParameters</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">roomUrl</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">roomId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">loopback</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">RoomConnectionParameters</span><span class="o">(</span><span class="n">String</span> <span class="n">roomUrl</span><span class="o">,</span> <span class="n">String</span> <span class="n">roomId</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">loopback</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">roomUrl</span> <span class="o">=</span> <span class="n">roomUrl</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">roomId</span> <span class="o">=</span> <span class="n">roomId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">loopback</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Asynchronously connect to an AppRTC room URL using supplied connection
   * parameters. Once connection is established onConnectedToRoom()
   * callback with room parameters is invoked.
   */</span>
  <span class="kt">void</span> <span class="nf">connectToRoom</span><span class="o">(</span><span class="n">RoomConnectionParameters</span> <span class="n">connectionParameters</span><span class="o">);</span>

  <span class="cm">/**
   * Send offer SDP to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendOfferSdp</span><span class="o">(</span><span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">sdp</span><span class="o">);</span>

  <span class="cm">/**
   * Send answer SDP to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendAnswerSdp</span><span class="o">(</span><span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">sdp</span><span class="o">);</span>

  <span class="cm">/**
   * Send Ice candidate to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendLocalIceCandidate</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span> <span class="n">candidate</span><span class="o">);</span>

  <span class="cm">/**
   * Send removed ICE candidates to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendLocalIceCandidateRemovals</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span><span class="o">[]</span> <span class="n">candidates</span><span class="o">);</span>

  <span class="cm">/**
   * Disconnect from room.
   */</span>
  <span class="kt">void</span> <span class="nf">disconnectFromRoom</span><span class="o">();</span>

  <span class="cm">/**
   * Struct holding the signaling parameters of an AppRTC room.
   */</span>
  <span class="kd">class</span> <span class="nc">SignalingParameters</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="n">iceServers</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">initiator</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">wssUrl</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">wssPostUrl</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">offerSdp</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IceCandidate</span><span class="o">&gt;</span> <span class="n">iceCandidates</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SignalingParameters</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="n">iceServers</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">initiator</span><span class="o">,</span>
        <span class="n">String</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">String</span> <span class="n">wssUrl</span><span class="o">,</span> <span class="n">String</span> <span class="n">wssPostUrl</span><span class="o">,</span> <span class="n">SessionDescription</span> <span class="n">offerSdp</span><span class="o">,</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">IceCandidate</span><span class="o">&gt;</span> <span class="n">iceCandidates</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">iceServers</span> <span class="o">=</span> <span class="n">iceServers</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">initiator</span> <span class="o">=</span> <span class="n">initiator</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">clientId</span> <span class="o">=</span> <span class="n">clientId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">wssUrl</span> <span class="o">=</span> <span class="n">wssUrl</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">wssPostUrl</span> <span class="o">=</span> <span class="n">wssPostUrl</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">offerSdp</span> <span class="o">=</span> <span class="n">offerSdp</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">iceCandidates</span> <span class="o">=</span> <span class="n">iceCandidates</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Callback interface for messages delivered on signaling channel.
   *
   * &lt;p&gt;Methods are guaranteed to be invoked on the UI thread of |activity|.
   */</span>
  <span class="kd">interface</span> <span class="nc">SignalingEvents</span> <span class="o">{</span>
    <span class="cm">/**
     * Callback fired once the room's signaling parameters
     * SignalingParameters are extracted.
     */</span>
    <span class="kt">void</span> <span class="nf">onConnectedToRoom</span><span class="o">(</span><span class="kd">final</span> <span class="n">SignalingParameters</span> <span class="n">params</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once remote SDP is received.
     */</span>
    <span class="kt">void</span> <span class="nf">onRemoteDescription</span><span class="o">(</span><span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">sdp</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once remote Ice candidate is received.
     */</span>
    <span class="kt">void</span> <span class="nf">onRemoteIceCandidate</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span> <span class="n">candidate</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once remote Ice candidate removals are received.
     */</span>
    <span class="kt">void</span> <span class="nf">onRemoteIceCandidatesRemoved</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span><span class="o">[]</span> <span class="n">candidates</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once channel is closed.
     */</span>
    <span class="kt">void</span> <span class="nf">onChannelClose</span><span class="o">();</span>

    <span class="cm">/**
     * Callback fired once channel error happened.
     */</span>
    <span class="kt">void</span> <span class="nf">onChannelError</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">description</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>主要就是定義了如何處理connect, disconnect, 還有怎麼去註冊SDP和ICE candidate, 在確定好連接成功後, AppRTCClient要負責呼叫onConnectedToRoom來通知
CallActivity已經可以準備建立video call的後續流程, 且要負責處理如果Signal server(這邊是firebase)有傳來遠端的SDP跟ICE candidate, 要負責呼叫SignalingEvents對應的處理
(這邊一樣會叫到CallActivity, 而CallActivity則會使用PeerConnectionClient來處理需要傳遞給PeerConnection相關的參數)</p>

<p>這邊用Firebase處理Signaling的方式是監聽某一個key的改變, 有新的裝置連接, 註冊SDP, ICE Candidate, 就寫到這下面去, 這其實不是一個很好的方式,
因為這下面只要有值的改變, 就會觸發, 不像是WebSocket那個版本是一來一往的API calls, 而且你不知道每次觸發被更動的是哪一部分, 一開始發生了好幾次PeerConnection重複註冊SDP才讓我發現因為這原因被重複呼叫的問題</p>

<h3 id="turn-server">TURN server</h3>

<p>WebRTC是P2P的, 因此如果不具備穿牆能力的話, 在牆外就會被擋掉, 一開始我本來想說試驗P2P而不走TURN Server穿牆的(因為我一時也懶得架一台), 結果測試時老是連不上, 後來才發現我阿呆,
我的測試環境是一台實體手機, 另一台是電腦上跑模擬器, 本以為兩個(手機, 電腦)是同一個區網沒問題, 後來才想到模擬器是在另一個虛擬網路, 因此還是有需要TURN server</p>

<p>如果不想架一台, 要怎辦? 用Google免錢的, 他們做了這個demo, 一定有! 因此就偷看了一下WebRTCClient的code跟傳輸內容,發現它跟https://networktraversal.googleapis.com/v1alpha/iceconfig?key=AIzaSyAJdh2HkajseEIltlZ3SIXO02Tze9sO3NY
去要TURN server list, 所以基本上只要照copy下面這段就好:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>   <span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="nf">requestTurnServers</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">JSONException</span> <span class="o">{</span>
        <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="n">turnServers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Request TURN from: "</span> <span class="o">+</span> <span class="n">url</span><span class="o">);</span>
        <span class="n">HttpURLConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">openConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"REFERER"</span><span class="o">,</span> <span class="s">"https://appr.tc"</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="n">TURN_HTTP_TIMEOUT_MS</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">TURN_HTTP_TIMEOUT_MS</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">responseCode</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">responseCode</span> <span class="o">!=</span> <span class="mi">200</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Non-200 response when requesting TURN server from "</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">" : "</span>
                    <span class="o">+</span> <span class="n">connection</span><span class="o">.</span><span class="na">getHeaderField</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">InputStream</span> <span class="n">responseStream</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">drainStream</span><span class="o">(</span><span class="n">responseStream</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"TURN response: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">);</span>
        <span class="n">JSONObject</span> <span class="n">responseJSON</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="n">JSONArray</span> <span class="n">iceServers</span> <span class="o">=</span> <span class="n">responseJSON</span><span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"iceServers"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iceServers</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">JSONObject</span> <span class="n">server</span> <span class="o">=</span> <span class="n">iceServers</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">JSONArray</span> <span class="n">turnUrls</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"urls"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="o">?</span> <span class="n">server</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">credential</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"credential"</span><span class="o">)</span> <span class="o">?</span> <span class="n">server</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"credential"</span><span class="o">)</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">turnUrls</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">turnUrl</span> <span class="o">=</span> <span class="n">turnUrls</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="n">turnServers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">(</span><span class="n">turnUrl</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="n">credential</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">turnServers</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Return the contents of an InputStream as a String.</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">drainStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">"\\A"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>把這邊拿來的list當ICE candidate, 就可以成功透過Google的TURN server去穿牆了(長久之計還是自己架一台吧)</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    
      
        <li><a href="http://blog.jln.co/page2/" class="btn">Previous</a></li>
      
    

    
    
      <li><a href="http://blog.jln.co">1</a></li>
    

    
    

    
    
    

    
      
        
        
        
        <li><a href="http://blog.jln.co/page2/">2</a></li>
      
    
      
        <li><strong class="current-page">3</strong></li>
      
    
      
        
        
        
        <li><a href="http://blog.jln.co/page4/">4</a></li>
      
    
      
        
        
        
        <li><a href="http://blog.jln.co/page5/">5</a></li>
      
    

    
    
      <li>…</li>
    

    
      <li><a href="http://blog.jln.co/page70/">70</a></li>
    

    
    
      <li><a href="http://blog.jln.co/page4/" class="btn">Next</a></li>
    
  </ul>
</div>


</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Julian Shen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://blog.jln.co/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://blog.jln.co/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79243751-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


          

</body>
</html>