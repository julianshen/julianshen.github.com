<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Le murmure de Julian</title>
<meta name=description content><meta property="og:url" content="https://blog.jln.co/"><meta property="og:site_name" content="Le murmure de Julian"><meta property="og:title" content="Le murmure de Julian"><meta property="og:locale" content="zh_tw"><meta property="og:type" content="website"><meta property="og:image" content="https://blog.jln.co/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.jln.co/images/avatar.png"><meta name=twitter:title content="Le murmure de Julian"><link rel=canonical href=https://blog.jln.co/><link rel=alternate type=application/rss+xml href=https://blog.jln.co/feed.xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.128.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script><link rel="shortcut icon" href=/favicon.png></head><body id=post-index class=feature><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=entry-image><img src=/images/bkg2.jpg alt="Le murmure de Julian"></div><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>朱隸安貓囈語錄</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-08-20 19:11:48 +0800 +0800"><a href=/%E7%94%A8gradlesbt%E7%9B%B4%E6%8E%A5%E5%BB%BA%E7%BD%AEDocker-Image/>Aug 20, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~2 minutes</span></div><h1 class=entry-title><a href=/%E7%94%A8gradlesbt%E7%9B%B4%E6%8E%A5%E5%BB%BA%E7%BD%AEDocker-Image/ rel=bookmark title="用gradle／sbt直接建置Docker Image" itemprop=url>用gradle／sbt直接建置Docker Image</a></h1></header><div class=entry-content><p>現在流行甚麼東西都要包成Docker image來部署, 每一個都要寫一個Dockerfile, 每個又很類似, 建置完程式碼又得立刻跑Docker來建置Docker image, 如果有更簡單的方法可以一次做完, 應該會省事很多</p><p>以下提到的這些方法可以一行Dockerfile都不用寫</p><h2 id=使用gradle把java-application建置並包裝成docker-image>使用gradle把Java application建置並包裝成Docker image</h2><p>要達到這個目的, 可以使用 <code>com.bmuschko.docker-java-application</code> - <a href=https://bmuschko.github.io/gradle-docker-plugin/#java-application-plugin>https://bmuschko.github.io/gradle-docker-plugin/#java-application-plugin</a> 這個Gradle plugin, 這個plugin會去呼叫Docker client API, 所以使用前確定你有啟動dockerd</p><p>先來看一下底下這範例, 這是一個用<a href=https://ktor.io/>Ktor</a>寫的server application:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> ktor_version: String <span style=color:#66d9ef>by</span> project
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> kotlin_version: String <span style=color:#66d9ef>by</span> project
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> logback_version: String <span style=color:#66d9ef>by</span> project
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>plugins {
</span></span><span style=display:flex><span>    application
</span></span><span style=display:flex><span>    kotlin(<span style=color:#e6db74>&#34;jvm&#34;</span>) version <span style=color:#e6db74>&#34;1.5.21&#34;</span>
</span></span><span style=display:flex><span>    id(<span style=color:#e6db74>&#34;com.bmuschko.docker-java-application&#34;</span>) version <span style=color:#e6db74>&#34;6.7.0&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>group = <span style=color:#e6db74>&#34;co.jln&#34;</span>
</span></span><span style=display:flex><span>version = <span style=color:#e6db74>&#34;0.0.1&#34;</span>
</span></span><span style=display:flex><span>application {
</span></span><span style=display:flex><span>    mainClass.<span style=color:#66d9ef>set</span>(<span style=color:#e6db74>&#34;co.jln.ApplicationKt&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker {
</span></span><span style=display:flex><span>    javaApplication {
</span></span><span style=display:flex><span>        baseImage.<span style=color:#66d9ef>set</span>(<span style=color:#e6db74>&#34;openjdk:11-jre&#34;</span>)
</span></span><span style=display:flex><span>        ports.<span style=color:#66d9ef>set</span>(listOf(<span style=color:#ae81ff>8080</span>))
</span></span><span style=display:flex><span>        images.<span style=color:#66d9ef>set</span>(setOf(<span style=color:#e6db74>&#34;julianshen/myexamplekt:&#34;</span> + version, <span style=color:#e6db74>&#34;julianshen/myexamplekt:latest&#34;</span>))
</span></span><span style=display:flex><span>        jvmArgs.<span style=color:#66d9ef>set</span>(listOf(<span style=color:#e6db74>&#34;-Xms256m&#34;</span>, <span style=color:#e6db74>&#34;-Xmx2048m&#34;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>repositories {
</span></span><span style=display:flex><span>    mavenCentral()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies {
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;io.ktor:ktor-server-core:</span><span style=color:#e6db74>$ktor</span><span style=color:#e6db74>_version&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;io.ktor:ktor-server-netty:</span><span style=color:#e6db74>$ktor</span><span style=color:#e6db74>_version&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;ch.qos.logback:logback-classic:</span><span style=color:#e6db74>$logback</span><span style=color:#e6db74>_version&#34;</span>)
</span></span><span style=display:flex><span>    testImplementation(<span style=color:#e6db74>&#34;io.ktor:ktor-server-tests:</span><span style=color:#e6db74>$ktor</span><span style=color:#e6db74>_version&#34;</span>)
</span></span><span style=display:flex><span>    testImplementation(<span style=color:#e6db74>&#34;org.jetbrains.kotlin:kotlin-test:</span><span style=color:#e6db74>$kotlin</span><span style=color:#e6db74>_version&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>雖然是kotlin寫的, 不過這是一個標準的Java Application, 有它的main class, 我們要加上的只有 <code>id("com.bmuschko.docker-java-application") version "6.7.0"</code> 和 <code>docker {}</code> 內的內容而已, 基本主要就是baseImage跟image的名字就好了</p><p>執行 <code>gradle dockerBuildImage</code> 就可以直接幫你把程式建置好並包裝成docker image了</p><p>如果是要把image給push到repository上的話, 執行 <code>gradle dockerPushImage</code></p><p>如果你的不是一般的Java application 而是Spring boot application的話, 則是可以用 <code>com.bmuschko.docker-spring-boot-application</code> 這個plugin而不是上面那個, 不過如果是Spring boot 2.3之後, 還有另一個方法</p><h2 id=直接把spring-boot應用程式建置成docker-image>直接把Spring Boot應用程式建置成Docker image</h2><p>如果是Spring Boot 2.3之後, 因為內建就有支援 <a href=https://buildpacks.io/>Cloud Native Buildpacks</a> , 所以直接就可以建置成docker image , 蠻簡單的, 只要執行</p><pre tabindex=0><code>gradle bootBuildImage
</code></pre><p>不過, 它image的名字會是 <code>library/project_name</code> , 所以如果你需要用其他的名字取代的話, 有兩種方法, 一種是加上 <code>--imageName</code> 給定名字, 像是:</p><pre tabindex=0><code>gradle bootBuildImage --imageName=julianshen/springsample
</code></pre><p>另一種是把這段加到 <code>build.gradle.kts</code> 去(這邊以kotlin當範例):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>tasks.getByName&lt;org.springframework.boot.gradle.tasks.bundling.BootBuildImage&gt;(<span style=color:#e6db74>&#34;bootBuildImage&#34;</span>) {
</span></span><span style=display:flex><span>	docker {
</span></span><span style=display:flex><span>		imageName = <span style=color:#e6db74>&#34;julianshen/sprintsmaple&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這個的缺點是, 不像前面提到的plugin有支援push, 如果你需要把建置好的結果放到repository上的話, 就得自己執行 <code>docker push</code></p><h2 id=把scala-application包裝成docker-image>把Scala application包裝成Docker image</h2><p>如果是Scala就需要用到 <a href=https://www.scala-sbt.org/sbt-native-packager/index.html>SBT Native Packager</a></p><p>用法也不難, 首先先把下面這段加到 <code>plugins.sbt</code> 去:</p><pre tabindex=0><code>addSbtPlugin(&#34;com.typesafe.sbt&#34; % &#34;sbt-native-packager&#34; % &#34;1.7.6&#34;)
</code></pre><p>在 <code>build.sbt</code> 內加入:</p><pre tabindex=0><code>enablePlugins(DockerPlugin)
</code></pre><p>然後執行 <code>sbt docker:publishLocal</code>即可, 相關設定可以參考 <a href=https://www.scala-sbt.org/sbt-native-packager/formats/docker.html>Docker plugin的文件</a></p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-08-15 15:29:09 +0800 +0800"><a href=/%E7%AD%86%E8%A8%98-%E4%BD%BF%E7%94%A8Lens-%E7%AE%A1%E7%90%86%E5%8F%8A%E7%9B%A3%E6%8E%A7MicroK8s/>Aug 15, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~3 minutes</span></div><h1 class=entry-title><a href=/%E7%AD%86%E8%A8%98-%E4%BD%BF%E7%94%A8Lens-%E7%AE%A1%E7%90%86%E5%8F%8A%E7%9B%A3%E6%8E%A7MicroK8s/ rel=bookmark title="[筆記] 使用Lens 管理及監控MicroK8s" itemprop=url>[筆記] 使用Lens 管理及監控MicroK8s</a></h1></header><div class=entry-content><p>自從離職後, 就沒一個方便的環境可以來做實驗, 家裡的desktop要裝k8s雖然是夠, 但出門的話, 我只有一台六七年的notebook改了SSD裝了Linux, 還是想在這台NB裝K8S拿來玩一些東西</p><h2 id=microk8s>MicroK8s</h2><p><a href=https://microk8s.io/>MicroK8s</a> 算是一個不錯的選擇, 輕量化, 單機可以跑, 重要的是, 可以隨時開關, 對於我這台老電腦來說, 需要的時候再開就好</p><p>安裝方式很簡單(Linux下需要先有<a href=https://snapcraft.io/docs/installing-snapd>snap</a>):</p><pre tabindex=0><code>sudo snap install microk8s --classic
</code></pre><p>使用 <code>microk8s status</code> 可以看目前狀態, <code>microk8s start</code>可以開始執行, <code>microk8s stop</code>即可停止</p><pre tabindex=0><code># microk8s status
microk8s is not running, try microk8s start
# microk8s start
[sudo] password for julianshen:            
Started.
# microk8s status
microk8s is running
high-availability: no
  datastore master nodes: 127.0.0.1:19001
  datastore standby nodes: none
addons:
  enabled:
    cilium               # SDN, fast with full network policy
    dashboard            # The Kubernetes dashboard
    dns                  # CoreDNS
    ha-cluster           # Configure high availability on the current node
    helm                 # Helm 2 - the package manager for Kubernetes
    helm3                # Helm 3 - Kubernetes package manager
    ingress              # Ingress controller for external access
    metrics-server       # K8s Metrics Server for API access to service metrics
    prometheus           # Prometheus operator for monitoring and logging
    registry             # Private image registry exposed on localhost:32000
    storage              # Storage class; allocates storage from host directory
  disabled:
    ambassador           # Ambassador API Gateway and Ingress
    fluentd              # Elasticsearch-Fluentd-Kibana logging and monitoring
    gpu                  # Automatic enablement of Nvidia CUDA
    host-access          # Allow Pods connecting to Host services smoothly
    istio                # Core Istio service mesh services
    jaeger               # Kubernetes Jaeger operator with its simple config
    keda                 # Kubernetes-based Event Driven Autoscaling
    knative              # The Knative framework on Kubernetes.
    kubeflow             # Kubeflow for easy ML deployments
    linkerd              # Linkerd is a service mesh for Kubernetes and other frameworks
    metallb              # Loadbalancer for your Kubernetes cluster
    multus               # Multus CNI enables attaching multiple network interfaces to pods
    openebs              # OpenEBS is the open-source storage solution for Kubernetes
    openfaas             # openfaas serverless framework
    portainer            # Portainer UI for your Kubernetes cluster
    rbac                 # Role-Based Access Control for authorisation
    traefik              # traefik Ingress controller for external access
</code></pre><p>如果是正在執行的狀態下, <code>microk8s status</code> 可以看到有哪些可用的addon, 如果要啟動其中一個addon(例如trafik), 也只要執行 <code>microk8s enable traefik</code>, 非常簡單</p><p>最基本來說, 你可以使用 <code>microk8s kubectl</code> 來執行相關的 <code>kubectl</code>指令, 如果要方便的GUI界面來管理的話, 也可以透過啟動dashboard:</p><pre tabindex=0><code># microk8s enable dashboard
Enabling Kubernetes Dashboard
Addon metrics-server is already enabled.
Applying manifest
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created

If RBAC is not enabled access the dashboard using the default token retrieved with:

token=$(microk8s kubectl -n kube-system get secret | grep default-token | cut -d &#34; &#34; -f1)
microk8s kubectl -n kube-system describe secret $token

In an RBAC enabled setup (microk8s enable RBAC) you need to create a user with restricted
permissions as shown in:
https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md

# microk8s dashboard-proxy 
Checking if Dashboard is running.
Dashboard will be available at https://127.0.0.1:10443
Use the following token to login:
[TOKEN]
</code></pre><p>不過, 我個人是比較偏好用<a href=https://k8slens.dev/>Lens</a></p><h2 id=lens>Lens</h2><p><img src=/images/posts/lens_startup.png alt></p><p>Lens的界面蠻簡單直覺的, 功能也蠻強大的, 除了管理你的cluster外, 也可以作到簡單的監控, 同時也可以管理多個cluster, 在啟動Lens後, 到"Clusters Catalog", 會發現沒有任何的一個cluster, 也沒有剛剛啟動的MicroK8S cluster</p><p><img src=/images/posts/lens_cluster_no.png alt></p><p>有兩個方法可以加入剛剛創建的MicroK8s cluster, 第一個是按下那個"+&ldquo;按鈕:</p><p><img src=/images/posts/lens_add.png alt></p><p>這時候把k8s config貼進去就好, 這邊要注意的一點是, 本來獲取k8s config可以用 <code>kubectl config view</code> , 在MicroK8s下, 如果沒特別設定, 都是用 <code>microk8s kubectl</code> 取代 <code>kubectl</code>, 但這邊, 如果你用 <code>microk8s kubectl config view </code>去取得k8s config的話, 貼上去, Lens是會連不上你的cluster的</p><p>這邊應該用 <code>microk8s config</code>才對, 這個才能讓你的Lens正確連上</p><p>另一個方式是執行 <code>microk8s config > ~/.kube/config</code> , 這樣Lens就會自動抓到了, 這兩種的優缺點是, 直接在Lens設定k8s config的話, 管理多個clusters時, 可以不用一直切換context, 如果直接使用 &ldquo;.kube/config&rdquo; 的話, 則是, 你也可以直接使用 <code>kubectl</code>來操作你的cluster(就不需要用<code>microk8s kubectl</code>)</p><p><img src=/images/posts/lens_connect.png alt></p><p>最後要做的步驟就是連接了, 按下"Connect"即可</p><p>在MicroK8s這邊, 要記得enable prometheus , Lens會去偵測Prometheus operator並抓取相關的metric資訊顯示在界面上</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-08-12 15:54:06 +0800 +0800"><a href=/%E6%B5%81%E7%A8%8B%E5%9C%96%E7%9A%84%E5%A5%BD%E5%B9%AB%E6%89%8B-vscode-%E6%95%B4%E5%90%88-Drawio/>Aug 12, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~1 minute</span></div><h1 class=entry-title><a href=/%E6%B5%81%E7%A8%8B%E5%9C%96%E7%9A%84%E5%A5%BD%E5%B9%AB%E6%89%8B-vscode-%E6%95%B4%E5%90%88-Drawio/ rel=bookmark title="流程圖的好幫手: vscode 整合 Drawio" itemprop=url>流程圖的好幫手: vscode 整合 Drawio</a></h1></header><div class=entry-content><p>本來我寫blog畫流程圖都用<a href=https://github.com/mermaid-js/mermaid>Mermaid</a>, 不過由於不好預覽, 要畫比較複雜的圖也有點麻煩</p><p><a href=https://app.diagrams.net/>Draw.io</a>是一個不錯的免費工具, 蠻便利好用的, 但缺點就是是網頁版的, 要跟平常寫文章的流程整合比較不方便, 由於我是在vscode上寫文章的, 所以發現了 <a href="https://marketplace.visualstudio.com/items?itemName=hediet.vscode-drawio">Draw.io Integration</a> 這個vscode的extension, 蠻方便的</p><p><img src=https://raw.githubusercontent.com/hediet/vscode-drawio/2387501b949e43692efa027eb82255f3d060d8c3/docs/drawio-png.gif alt></p><p>除了可以直接在vscode上編輯流程圖外, 如果你的檔名是"XXXX.drawio.png", 或是 &ldquo;XXXX.drawio.svg&rdquo; 畫完後就直接輸出成png/svg, 就可以直接拿來用了, 有問題也可以直接改, 不用轉檔轉來轉去的</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-08-12 00:35:55 +0800 +0800"><a href=/%E4%BD%BF%E7%94%A8-OpenTelemetry-%E8%B7%A8%E4%B8%8D%E5%90%8C%E5%B9%B3%E5%8F%B0%E8%BF%BD%E8%B9%A4-Thrift-Rpc/>Aug 12, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~12 minutes</span></div><h1 class=entry-title><a href=/%E4%BD%BF%E7%94%A8-OpenTelemetry-%E8%B7%A8%E4%B8%8D%E5%90%8C%E5%B9%B3%E5%8F%B0%E8%BF%BD%E8%B9%A4-Thrift-Rpc/ rel=bookmark title="使用 OpenTelemetry 跨不同平台追蹤 Thrift Rpc" itemprop=url>使用 OpenTelemetry 跨不同平台追蹤 Thrift Rpc</a></h1></header><div class=entry-content><p>在離職前一周研究的一個小題目, 說小其實也蠻難搞的, 搞到這兩天重新看, 才釐清完整做法</p><p>難搞的原因有幾個, 雖然<a href=https://opentelemetry.io/>OpenTelemetry</a>有支援<a href=https://grpc.io/>gRPC</a>, 但對於 <a href=http://thrift.apache.org/>Thrift</a> 就沒人做相關的支援了, 再來就是系統環境跨了nodejs和<a href=https://twitter.github.io/finagle/>Finagle</a>/Scala兩種平台, Thrift 是用在這兩者之間的溝通, Finagle雖是有支援<a href=https://zipkin.io/>ZipKin</a><a href=https://twitter.github.io/finagle/guide/Tracing.html>做分散式追蹤</a>, 但那僅限於Finagle client呼叫Finagle server的部分才有支援在這之間傳遞追蹤資訊, 跨nodejs (client) 到 Finagle (server), 這邊也一樣找不到啥資訊</p><p>所以這邊主要會想做到的:</p><ol><li>自動插入追蹤的程式碼</li><li>在 Thrift client/server 間傳遞追蹤資訊 (client/server不同平台)</li></ol><p>大致上的原理有做過些小實驗, 確定應該可行, 只是懶得把整套完整做好就是了</p><h2 id=分散式追蹤-distributed-tracinghttpslightstepcomdistributed-tracing><a href=https://lightstep.com/distributed-tracing/>分散式追蹤 Distributed Tracing</a></h2><p>在大型的分散式系統, 一個從使用者端來的request通常都會被分發到不同的系統去做處理, 尤其現在大多流行微服務(Micro services)架構, 這種狀況相當的常見, 當問題發生的時候, 到底甚麼時間點在哪個系統, 碰到甚麼事, 要追查原因便得從這麼多系統分散且看不出關聯性的log去想辦法分析出來, 因此導入分散式追蹤, 就是為了解決這問題</p><p>最早出現應該是Google內部使用的Dapper, 也有發表相關的<a href=https://static.googleusercontent.com/media/research.google.com/en//archive/papers/dapper-2010-1.pdf>論文</a>, 開源的部分, 早期又有Twitter的<a href=https://zipkin.io/>ZipKin</a>和Uber的<a href=https://www.jaegertracing.io/>Jaeger</a>, 前面有提到的<a href=https://twitter.github.io/finagle/>Finagle</a>, 由於也是Twitter開源出來的應用程式框架, 所以<a href=https://twitter.github.io/finagle/>Finagle</a>出廠就支援<a href=https://zipkin.io/>ZipKin</a>也是理所當然的</p><p>後來又出現想要大一統的<a href=https://opentracing.io/>OpenTracing</a>和<a href=https://opencensus.io/>OpenCensus</a>, 這兩個後來又被大一統到這邊所要提到的<a href=https://opentelemetry.io/>OpenTelemetry</a></p><p>做Distributed Tracing雖然對追問題會有幫助, 但要導入並不見的容易, 先是要在所有要追蹤的插入追蹤程式碼, 對於既有系統的改動幅度自是不小, 此外, 早期, 不管是<a href=https://zipkin.io/>ZipKin</a>和Uber的<a href=https://www.jaegertracing.io/>Jaeger</a>還是<a href=https://www.jaegertracing.io/>Jaeger</a>考量的主要還是REST API的架構, REST是透過HTTP傳輸的, 因此在設計上, 就可以透過HTTP header帶追蹤相關資訊, 但在一個複雜的分散式系統, 可能包含不同的通訊協定, 像是REST, GraphQL, gRPC, Thrift, 或是呼叫資料庫之類的, 不見得都是透過HTTP, 那怎麼傳遞追蹤資訊就是個問題, 跨系統間如果無法分享追蹤資訊, 那也是白搭</p><h2 id=opentelemetryhttpsopentelemetryio><a href=https://opentelemetry.io/>OpenTelemetry</a></h2><p><a href=https://opentelemetry.io/>OpenTelemetry</a>其實也不是只有支援Distributed Tracing, 它能處理的資料型態, 主要就有下面這幾種:</p><ol><li>Traces</li><li>Metrics</li><li>Logs</li></ol><p>也就是說除了追蹤資訊, 它也囊括了系統狀態跟Logs, 另外也支援很多不同語言, 算是野心蠻大的, 這邊來看一下它的架構:</p><p><img src=https://raw.github.com/open-telemetry/opentelemetry.io/main/iconography/Reference_Architecture.svg alt></p><p>主要它包含了兩部分, 一個是各程式語言使用的程式庫 - OT Library, 另一個是蒐集資訊的Collector, 而Collector是這樣的:</p><p><img src=https://raw.github.com/open-telemetry/opentelemetry.io/main/iconography/Otel_Collector.svg alt></p><p>Collector包含了Receiver, Processor, Exporter, 這架構讓它有能力相容/支援不同的系統, 所以像是Finagle這種本來就有支援ZipKin的, 其實只要把原本倒到ZipKin的資料轉倒到OpenTelemetry的Collector就好, 這邊算是好解決, 如果系統是跑在K8S這類的環境上的話, 也可以考慮把Collector
當成sidecar來佈署</p><p>而各程式語言的程式庫的部分, 方便的是在某些程式語言有支援所謂的auto instrumentation, 針對有支援的程式庫或是框架, 可以在不寫任何程式碼或是寫少少的程式碼, 就可以達到分散式追蹤的目的(聽來有點玄), 像是Java就<a href=https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks>支援了這些</a>(請參考連結), 而<a href=https://github.com/open-telemetry/opentelemetry-js-contrib>Javascript有這些</a>(請參考連結)</p><p>但畢竟沒有甚麼是萬能的, 沒支援的還是得靠自己手動插追蹤的程式碼, 或是想辦法支援, 像是這篇正題的部分, 這邊想要追蹤從nodejs呼叫Finagle的部分, 就沒辦法使用現成的 (實際狀況更複雜, nodejs本身是graphql server, Finagle server又可能呼叫ElasticSearch或Kafka, 如果想全部串起來, 不算小, 這邊主要針對 nodejs &lt;-> Finagle部分)</p><h2 id=在nodejs下用opentelemetry做tracing>在Node.JS下用OpenTelemetry做Tracing</h2><p>基本使用上其實相當簡單, 可以參考這個<a href=https://opentelemetry.io/docs/js/getting_started/nodejs/>連結</a>, 先用一個小範例來解釋:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>HttpInstrumentation</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation-http&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>GrpcInstrumentation</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation-grpc&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ExpressInstrumentation</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation-express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ConsoleSpanExporter</span>, <span style=color:#a6e22e>SimpleSpanProcessor</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/tracing&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>NodeTracerProvider</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/node&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>registerInstrumentations</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NodeTracerProvider</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>addSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SimpleSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ConsoleSpanExporter</span>()));
</span></span><span style=display:flex><span><span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>register</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>registerInstrumentations</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>instrumentations</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>HttpInstrumentation</span>(), 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GrpcInstrumentation</span>(),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ExpressInstrumentation</span>()
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>以這範例來說, 它打開了支援http, grpc, express等程式庫的auto instrumentation, 亦即在你的程式中如果有用到這幾個程式庫, 它會自動加上對應的追蹤程式碼, 你不用額外做任何事, 從client到server都處理好, 或是你也可以像文件中用:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// This will automatically enable all instrumentations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>registerInstrumentations</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>instrumentations</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>getNodeAutoInstrumentations</span>()],
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><code>getNodeAutoInstrumentations()</code>包含了底下這幾種的資源:</p><ul><li><code>@opentelemetry/instrumentation-dns': DnsInstrumentation</code></li><li><code>@opentelemetry/instrumentation-express': ExpressInstrumentation</code></li><li><code>@opentelemetry/instrumentation-graphql': GraphQLInstrumentation</code></li><li><code>@opentelemetry/instrumentation-grpc': GrpcInstrumentation</code></li><li><code>@opentelemetry/instrumentation-http': HttpInstrumentation</code></li><li><code>@opentelemetry/instrumentation-ioredis': IORedisInstrumentation</code></li><li><code>@opentelemetry/instrumentation-koa': KoaInstrumentation</code></li><li><code>@opentelemetry/instrumentation-mongodb': MongoDBInstrumentation</code></li><li><code>@opentelemetry/instrumentation-mysql': MySQLInstrumentation</code></li><li><code>@opentelemetry/instrumentation-pg': PgInstrumentation</code></li><li><code>@opentelemetry/instrumentation-redis': RedisInstrumentation</code></li></ul><p>建議如果沒要追蹤這麼多東西的話, 還是一個個加就好, 畢竟資訊多雜訊也多</p><p>在這邊:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NodeTracerProvider</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>addSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SimpleSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ConsoleSpanExporter</span>()));
</span></span></code></pre></div><p>這兩行是建立Trace Provider, 告訴它要用哪個Processor或哪個Exporter去處理追蹤資訊, 這跟前面提到的Collector的架構上大致類似, 這邊用的是Consle exporter,也就是追蹤資訊會被直接印在螢幕上, 如果想輸出到ZipKin或是Jaeger就用相對應的Exporter就可以了, 或者也可以用OTLP的Exporter直接輸出到OpenTelemetry的collector</p><p>但這是在有支援的狀況下, 如果沒有呢? 就得手動去插了, 看一下下面這範例:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opentelemetry</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/api&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tracer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>opentelemetry</span>.<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>getTracer</span>(<span style=color:#e6db74>&#39;example-basic-tracer-node&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a span. A span must be closed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>span</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>startSpan</span>(<span style=color:#e6db74>&#39;main&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>doWork</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>// Be sure to end the span.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>end</span>();
</span></span></code></pre></div><p>這是簡單追蹤一個程序的方法, 在這範例是<code>doWork()</code>, 這邊就可以追蹤從<code>startSpan</code>到<code>end</code>之間的耗費的時間了, 針對沒有支援auto instrumentation, 或是你想額外在你程式內追蹤些別的, 那就得用這種方式在需要追蹤的地方加入這些</p><p>很不幸的, 目前不管哪個語言, Java, Javascript, 都沒支援Thrift相關的, 所以如果要追蹤 Thrift, 可能就得是這樣, 除了可能需要改不少地方外, 插入這些code其實也不太好看啦 :p</p><h2 id=追蹤-thrift-rpc>追蹤 Thrift RPC</h2><p>Thrift算是一個有點歷史的RPC框架(framework)了, 雖然應該還有不少大公司像是Twitter, Facebook, LINE, LinkedIn還有在使用, 不過現在大家大部分應該是比較常用比較潮的gRPC, 比較少用Thrift了, 所以在OpenTelemetry這種新東西找不到支援應該也情有可原</p><p>為了比較好確認解決這問題的概念是怎樣, 這邊先把問題/架構先簡化如下:</p><ol><li>Thrift client: 跑在nodejs下, 以typescript開發</li><li>Thrift server: 跑在Twitter Finagle框架, 以scala開發 (事實上, 我也有實做一個go版本的server, 不過先不在這討論)</li></ol><p>所以這邊會需要知道的是:</p><ol><li>client呼叫每個Thrift call需要的時間</li><li>在server上每個call又對應哪些呼叫或花費</li></ol><p>用以下ZipKin這張圖來當範例, 就可以這樣一層層追蹤下去</p><p><img src=/images/posts/2021-08-12-11-43-50.png alt=ZipKin></p><p>Client部分雖然可以使用手工插入tracing相關的程式碼, 但當然還是做成自動的最好, 而且client必須要可以把相關的trace ID, span ID給傳遞到server, 要不然線索就會斷掉了</p><p>為了達到這目標, 首先我們先來看一下Thrift從Client到Server經過哪些地方:</p><p><img src=/images/posts/thrift.drawio.png alt=Thrift></p><p>從這圖看來, 可能可以插入追蹤碼的點可以是產生出來的Client code或是TProtocol的位置(為何?後面再提)</p><p>在前面我也寫了一篇"<a href=https://blog.jln.co/%E5%9C%A8nodejs%E4%BD%BF%E7%94%A8typescript%E5%91%BC%E5%8F%ABthrift-client/>在nodejs使用typescript呼叫thrift client</a>&ldquo;裡面有提到利用<code>thrift -r --gen js:ts smaple.thrift</code>來產生nodejs用的client code</p><p>以下面這個Thrift IDL來當範例:</p><pre tabindex=0><code>namespace java sample.thrift
#@namespace scala sample.thrift
namespace go rpc

service SampleService {
    string hello(1: i64 a, 2: i64 b)
    void hello2()
}
</code></pre><p>用<code>thrift -r --gen js:ts sample.thrift</code>就可以產生四個檔案, 分別是:</p><ol><li>sample_types.js</li><li>sample_types.d.ts</li><li>SampleService.js SampleService的定義</li><li>SampleService.d.ts SampleService的javascript實作(Client + Processor)</li></ol><p>再仔細去看SampleService.js, 以hello這個method為例, 你會發現在 <code>SampleServiceClient</code> 裡關於hello的部分有三部分:</p><ol><li><code>hello(a, b, callback)</code> 實際給程式呼叫的介面, 這邊回傳是個Promise</li><li><code>send_hello(a, b)</code> 會由hello去呼叫, 實際上負責傳遞呼叫的相關資訊</li><li><code>recv_hello(input,mtype,rseqid)</code> 當send_hello送出呼叫資訊到server後, Connection會等到Server回應後, 會呼叫 recv_functionname, 去處理回傳回來的資訊</li></ol><p>另外在 <code>send_hello</code> 的一開始會去呼叫 <code>output.writeMessageBegin('hello', Thrift.MessageType.CALL, this.seqid());</code> , 這邊的output是TProtocol, 在呼叫 <code>recv_hello</code> 之前則是會呼叫 <code>input.readMessageBegin()</code> 這邊也可以得到呼叫的method的資訊</p><p>由上面的線索看來, 可以插入追蹤程式碼可能的幾個點:</p><ol><li><code>hello(a, b, callback)</code> 的一開始到Promise結束</li><li><code>send_hello(a, b)</code>到<code>recv_hello(input,mtype,rseqid)</code>的結束</li><li><code>writeMessageBegin</code> 到 <code>readMessageBegin</code></li></ol><p>這邊問題在於 <code>hello</code>, <code>send_hello</code>, <code>recv_hello</code>都是由<code>thrift</code>這個指令產出的, 而<code>writeMessageBegin</code>, <code>readMessageBegin</code>則是在thrift的程式庫內</p><p>我們要怎樣在裡面插入追蹤的程式碼?或是有沒辦法做到auto instrumentation那樣?</p><h2 id=javascript-auto-instrumentation-in-opentelemetry>Javascript auto instrumentation in OpenTelemetry</h2><p>OpenTelemetry其實是有開放介面給大家去開發相關的auto instrumentation, 不過這一塊實在看得有點頭痛, 沒文件, 又不好懂, 我最後沒採用這方法實作, 但因為在這邊花了不少時間, 還是簡單的介紹一下</p><p>前面有提到的有許多auto instrumentation的實作, 都是被放到 <a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>opentelemetry-js-contrib/plugins/node</a>, 也就是說你可以用一樣的方法做出自己的auto instrumentation</p><p>其架構的原始碼可以參考<a href=https://github.com/open-telemetry/opentelemetry-js/tree/4a1f2e5fd441cc9c0359d6aaff1919d9c6672682/packages/opentelemetry-instrumentation>opentelemetry-js/packages/opentelemetry-instrumentation</a>, 至於如何去寫一個plugin則可以參考 <a href=https://reachmnadeem.wordpress.com/2021/02/22/opentelemetry-automatic-instrumentation-of-a-nodejs-library/>這篇</a></p><p>基本的plugin大致上像這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>mssql</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;mypackage&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>InstrumentationBase</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>InstrumentationConfig</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>InstrumentationModuleDefinition</span>,
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@opentelemetry/instrumentation&#39;</span>;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>InstrumentationConfig</span> ;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MYPlugin</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>InstrumentationBase</span>&lt;<span style=color:#f92672>typeof</span> <span style=color:#a6e22e>mypackage</span>&gt; {
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>init</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>InstrumentationModuleDefinition</span>&lt;<span style=color:#f92672>any</span>&gt; <span style=color:#f92672>|</span> <span style=color:#a6e22e>InstrumentationModuleDefinition</span>&lt;<span style=color:#f92672>any</span>&gt;[] {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Method not implemented.&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Plugin必須繼承自InstrumentationBase, 最好的範例應該是 <a href=https://github.com/open-telemetry/opentelemetry-js/blob/4a1f2e5fd441cc9c0359d6aaff1919d9c6672682/packages/opentelemetry-instrumentation-http/src/http.ts>http的instrumentation的實作</a>, 在這裏面, 你會看到像是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_wrap</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>moduleExports</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;request&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_getPatchOutgoingRequestFunction</span>(<span style=color:#e6db74>&#39;http&#39;</span>)
</span></span><span style=display:flex><span>        );
</span></span></code></pre></div><p>這目的就是為了把原本的函數替換成包裝過有插追蹤碼的程式, 原理其實很容易理解, 而它是用了 <a href=https://github.com/othiym23/shimmer/>shimmer</a> 這個package, 來達到這個替換的目的, 實際上去看 <a href=https://github.com/othiym23/shimmer/>shimmer</a>, 也並不是一個很複雜的做法就是了</p><p>本來我是考慮寫一個plugin來處理Thrift client的部分, 原本的考量點是, 由於 <a href=https://github.com/othiym23/shimmer/>shimmer</a> 需要先知道method的名字才能替代, 所以 <code>hello</code>, <code>send_hello</code>, <code>recv_hello</code> 就不適合用來做包裝, 畢竟要做也是要做一個通用的, 不然試作後, 單純包裝 <code>hello</code> 其實算容易 (在呼叫原版本hello前先startSpan, 並把span.end包裝到回傳的Promise), 所以適合用在這邊的可能是包裝 <code>TProtocol.writeMessageBegin</code>, <code>TProtocol.readMessageBegin</code> ,不過這邊一直弄不成功, 可能也沒搞很懂instrumentation plugin, 後來又發現更簡便的做法就先放棄</p><h2 id=從-thift-generator-下手>從 thift generator 下手</h2><p>在用 <a href=https://github.com/othiym23/shimmer/>shimmer</a> 包裝 <code>hello</code> 時, 發現了一個問題, 由於我是用 typescript 而非javascript 在做這個實驗, typescript會去做型別檢查, 本來Javascript版本的 <code>hello</code> 的回傳是Promise, 但我在定義wrapped function的時候, 回傳型別設成
<code>Promise&lt;string></code> 則是會報錯, 結果實際上去看產生的程式碼:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>hello</span>(<span style=color:#a6e22e>a</span>: <span style=color:#66d9ef>Int64</span>, <span style=color:#a6e22e>b</span>: <span style=color:#66d9ef>Int64</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>;
</span></span></code></pre></div><p>這完全是錯的, 也就是由Apache thrift這個工具產生的typescript是有問題的</p><p>想到在Scala中, 產生Thrift相關程式碼是用scrooge並不會去用官方Apache thrift的工具, typescript會不會也有像scrooge這工具? 結果就找到了<a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>creditkarma/thrift-typescript</a></p><p>這個專案也是蠻有趣的, 它是透過 <a href=https://github.com/Microsoft/TypeScript/wiki/Using-the-Compiler-API>Typescript compiler API</a>, 把Thrift IDL完全轉成typescript程式碼, 跟官方工具不同的地方是, 它產生的是純typecsript實做, 而非javascript實做搭配typescript定義, 因此產生的程式碼也好讀多了</p><p>所以我想, 何必一定糾結在auto instrumentation, 從code generator 去修改也是一個可行的做法, 要做到這件事, 那就要先看看, 我們預期它產生怎樣的程式碼, 於是我就去修改產生的程式碼來實驗, 像這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Client</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>_seqid</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>_reqs</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        [<span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>number</span>]<span style=color:#f92672>:</span> (<span style=color:#a6e22e>err</span>: <span style=color:#66d9ef>Error</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>object</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span>, <span style=color:#a6e22e>val?</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>output</span>: <span style=color:#66d9ef>thrift.TTransport</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>protocol</span>: <span style=color:#66d9ef>new</span> (<span style=color:#a6e22e>trans</span>: <span style=color:#66d9ef>thrift.TTransport</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TProtocol</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>tracer</span>:<span style=color:#66d9ef>opentelemetry.Tracer</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>serverSupportTracing</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>output</span>: <span style=color:#66d9ef>thrift.TTransport</span>, <span style=color:#a6e22e>protocol</span>: <span style=color:#66d9ef>new</span> (<span style=color:#a6e22e>trans</span>: <span style=color:#66d9ef>thrift.TTransport</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TProtocol</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_seqid</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_reqs</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>output</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>protocol</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>protocol</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tracer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>opentelemetry</span>.<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>getTracer</span>(<span style=color:#e6db74>&#39;SampleServiceClient&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>serverSupportTracing</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>incrementSeqId</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_seqid</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>hello</span>(<span style=color:#a6e22e>a</span>: <span style=color:#66d9ef>Int64</span>, <span style=color:#a6e22e>b</span>: <span style=color:#66d9ef>Int64</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>incrementSeqId</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>span</span>:<span style=color:#66d9ef>opentelemetry.Span</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>startSpan</span>(<span style=color:#e6db74>&#34;hello&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt;((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_reqs</span>[<span style=color:#a6e22e>requestId</span>] <span style=color:#f92672>=</span> (<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>result</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_reqs</span>[<span style=color:#a6e22e>requestId</span>];
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>send_hello</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這一段程式碼是截自 <a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>creditkarma/thrift-typescript</a> 從我的IDL產生的程式碼, 加上了tracer跟span, <code>startSpan</code>和<code>span.end</code>就插在hello裡面</p><p>這一段先用手工插入實驗後沒問題, 接下來我們就可以去改 <a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>creditkarma/thrift-typescript</a> 讓程式自動去產生</p><p>由於這邊牽涉多一點, 我就不一一解釋, 貼上我修改的<a href=https://github.com/julianshen/thrift-typescript/commit/5f2ebeb85f6e639be11d5184f5470ca8d4d466b9>commit</a>, 大家有興趣可以參考 : <a href=https://github.com/julianshen/thrift-typescript/commit/5f2ebeb85f6e639be11d5184f5470ca8d4d466b9>https://github.com/julianshen/thrift-typescript/commit/5f2ebeb85f6e639be11d5184f5470ca8d4d466b9</a></p><p>這樣一來, 產生我們要的client code就沒啥問題了</p><h2 id=傳遞追蹤資訊>傳遞追蹤資訊</h2><p>前面有提到<a href=https://twitter.github.io/finagle/>Finagle</a>有支援Zipkin Tracing, 只有client和server都是Finagle才可以在Thrift間傳遞追蹤資訊, 那實際上Finagle又是怎做的呢? 它的做法是在Thrift的通訊協定上做了一些小修改, 先來看看底下這三張圖</p><p><img src=/images/posts/twitterthrift.drawio.png alt="Twitter Thrift"></p><p>第一張是通常狀況, 在兩端都不支援傳遞追蹤資訊, 或是Client不支援, 就是走正常的路線, 第二三張則是在Client有支援(Finagle client), client會先送<code>__can__finagle__trace__v3__</code>這個呼叫確認server有支援, server如果有支援的話, 就會回傳正確的結果, 如果沒支援則會是 <code>UNKNOW_METHOD</code></p><p>Client在確認server有支援後, 後面的request就會先多帶一個header包含Tracing相關的資訊了</p><p>這部分, 我目前也只實做go版本的server, client版本尚未做, 這邊會需要做的部份包含:</p><ol><li>呼叫 <code>__can__finagle__trace__v3__</code> 確認是否支援tracing</li><li>將client端的tracing資訊帶入相關的header中</li></ol><p>如果client是用OpenTelemetry, 而server這邊是用Finagle加zipkin的話, 就得要注意Trace ID, Span ID的轉換, 這兩邊用的長度跟型別有點不太一樣, 轉換的範例如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>UInt64ToTraceID</span>(<span style=color:#a6e22e>high</span>, <span style=color:#a6e22e>low</span> <span style=color:#66d9ef>uint64</span>) <span style=color:#a6e22e>pdata</span>.<span style=color:#a6e22e>TraceID</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>traceID</span> <span style=color:#f92672>:=</span> [<span style=color:#ae81ff>16</span>]<span style=color:#66d9ef>byte</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>.<span style=color:#a6e22e>PutUint64</span>(<span style=color:#a6e22e>traceID</span>[:<span style=color:#ae81ff>8</span>], <span style=color:#a6e22e>high</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>.<span style=color:#a6e22e>PutUint64</span>(<span style=color:#a6e22e>traceID</span>[<span style=color:#ae81ff>8</span>:], <span style=color:#a6e22e>low</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pdata</span>.<span style=color:#a6e22e>NewTraceID</span>(<span style=color:#a6e22e>traceID</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>(Source: <a href=https://github.com/open-telemetry/opentelemetry-collector/blob/6ae558c8757cad4ed29f7c9496b38827990f156f/internal/idutils/big_endian_converter.go#L24>https://github.com/open-telemetry/opentelemetry-collector/blob/6ae558c8757cad4ed29f7c9496b38827990f156f/internal/idutils/big_endian_converter.go#L24</a>)</p><p>只要在把這整段整合到code generator, 應該就可以大功告成了</p><p>雖然一開始覺得是個小題目, 沒想到居然讓我用這麼大篇幅介紹, 而且全部實做還沒完成, 看來是有點太過低估了</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-08-09 20:24:52 +0800 +0800"><a href=/%E5%84%AA%E5%8C%96-Open-Graph-Image/>Aug 9, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~7 minutes</span></div><h1 class=entry-title><a href=/%E5%84%AA%E5%8C%96-Open-Graph-Image/ rel=bookmark title="優化 Open Graph Image" itemprop=url>優化 Open Graph Image</a></h1></header><div class=entry-content><p>在<a href=http://blog.jln.co/%E7%94%A8Hugo-GitHub-Actions%E6%89%93%E9%80%A0Blog/>之前一篇</a>寫用Hugo打造blog有提到, 寫了一個<a href=https://github.com/julianshen/myblog_hugo/tree/master/ogp>小工具來產生open graph image</a>, 但由於這個是一個command line工具, 而我又是把它放在 git pre-commit 去觸發並寫回檔案, 感覺不是那麼乾淨, 因此我又有另一個想法想把它寫成一個服務, 順便又思考了一下, 怎樣的圖片比較適合OG(Open Graph)</p><h2 id=為什麼要設定-open-graph-image>為什麼要設定 Open Graph Image</h2><p>這邊並沒有要探討<a href=https://ogp.me/>Open Graph</a>是什麼, 怎麼去使用, 這應該可以找到其他相關的文章或是參考官網 <a href=https://ope.me/>https://ope.me/</a></p><p>目前OG會影響到的, 大概就是被分享到社群的文章/網頁, Facebook跟Twitter都支援OG來產生分享到Timeline上的預覽, Twitter則是另外支援它自己的<a href=https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/abouts-cards>Twitter Card</a>, 而這其中 og:image 會影響到分享後的版面</p><p>首先, 這邊先介紹一下工具, 如果要先預覽Facebook分享出去的結果可以使用Facebook提供的 <a href=https://developers.facebook.com/tools/debug/>分享偵錯工具</a>, Twitter部分則可使用<a href=https://cards-dev.twitter.com/validator>Card validator</a></p><p>先來看看沒設定og:image的版面是怎樣一個狀況?</p><p><img src=/images/posts/og/og_sample_no_image.jpg alt="OG No Image"></p><p><img src=/images/posts/og/tc_sample_no_image.jpg alt="Twitter card No Image"></p><p>前面一個是分享到Facebook上的版面, 後一個則是在Twitter上會看到的, 很明顯的版面偏小, 不起眼, 分享出去後應該也引不起使用者點擊的慾望</p><p>這邊Twitter跟Facebook不太一樣的地方是, Facebook決定大小版面是以og:image的大小來決定的, 大版面的圖片需要有1200x630的解析度, 但對Twitter來說, 你如果設定Twitter card的型別是 <strong>&ldquo;summary_large_image&rdquo;</strong> , 那就會選擇使用大版面來顯示, 因此如果圖不是很大的話, 會像下個範例:</p><p><img src=/images/posts/og/og_sample_small.jpg alt="OG Small"></p><p><img src=/images/posts/og/tc_sample_small.jpg alt="Twitter card small Image"></p><p>這邊Twitter card使用的是 <strong>&ldquo;summary_large_image&rdquo;</strong> , 因此可以看到結果(第二張), 版面是較大的版面, 但圖片的部分就糊的有點慘了, 而且, 重點被截到了, Facebook圖雖沒那麼糊, 但版面依然很小</p><p>現在應該很多網站都有注意使用了大圖來做為og:image了, 效果就像是這樣:</p><p><img src=/images/posts/og/og_sample_big_prod.jpg alt="OG Big"></p><p>這樣版面是大得很明顯了, 但似乎有點問題, 這邊用的是LOGO, 但它賣的是"【JOYOUNG 九陽】LINE FRIENDS系列真空悶燒罐 熊大", 沒商品圖片, 我不知道大家是怎看, 至少, 不吸引我</p><p>再來看另一個例子:</p><p><img src=/images/posts/og/og_sample_pchome.jpg alt="OG PCHOME"></p><p>看的到商品, 但部分字被遮住了, 而且"限時優惠"這個是有時效性的, 被分享出去的圖片是不會被改變的</p><p>那我自己之前的blog文章呢? 我最早設定的邏輯是這樣的, 如果文章內有圖, 就挑第一張圖, 把它放大到1200x630的規格, 如果沒有圖, 就拿標題做一張圖(前面提到的<a href=https://github.com/julianshen/myblog_hugo/tree/master/ogp>小工具</a>)</p><p><img src=/images/posts/og/og_sample_blog_1.jpg alt="OG Blog"></p><p><img src=/images/posts/og/og_sample_blog_2.jpg alt="OG Blog"></p><p><img src=/images/posts/og/og_sample_blog_3.jpg alt="OG Blog"></p><p><img src=/images/posts/og/og_sample_blog_4.jpg alt="OG Blog"></p><p>我的文章大多偏技術面的文章, 這裡面有些是用到了流程圖, 看起來沒啥太大問題, 有些就沒那麼優了, 再來看看文章內沒有圖的狀況</p><p><img src=/images/posts/og/og_sample_blog_5.jpg alt="OG Blog"></p><p>自從用了這版本後, 覺得好像這樣會比較清楚一點, 與其去選一張跟內容沒那麼相關, 品質又沒保證的, 還不如使用標題來的直觀一點</p><p>但之前的小工具, 需要綁在git pre-commit, 我換台電腦就又得設定一次, 也是有點不方便, 重新來寫一個版本, 跑在heroku上, 反正文章沒那麼多, Facebook又不會常常跑來抓, Free dyno就夠用了</p><p>下面就來把這版本：<a href=https://github.com/julianshen/betterog>Better OG</a> 幾個實作來做一個介紹, 原始碼都在Github上, 因為都是用現成的package來簡單達成的, 所以我沒想把code整理當成一個可以直接發行的版本, 單純當範例, 大家有用到的片段可以直接拿去使用</p><h2 id=純文字的og-image>純文字的OG Image</h2><p>想達成的效果就跟前面提到這張圖一樣</p><p><img src=/images/posts/og/og_sample_blog_5.jpg alt="OG Blog"></p><h3 id=使用text2imghttpsgithubcomjulianshentext2img>使用<a href=https://github.com/julianshen/text2img>text2img</a></h3><p>這一部分算最簡單的, 就是前面的文章有提到的<a href=https://github.com/julianshen/text2img>text2img</a>, 它的設計也就是為了產生og:image, 所以很簡單就可以應用在這邊了, 我是用我自己改過的版本:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>bog</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BetterOG</span>) <span style=color:#a6e22e>drawText</span>(<span style=color:#a6e22e>text</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawURLEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>text</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>text</span> = string(<span style=color:#a6e22e>decoded</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>img</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>img</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bog</span>.<span style=color:#a6e22e>drawer</span>.<span style=color:#a6e22e>Draw</span>(<span style=color:#a6e22e>text</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>jpeg</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>img</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>jpeg</span>.<span style=color:#a6e22e>Options</span>{<span style=color:#a6e22e>Quality</span>: <span style=color:#ae81ff>90</span>}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>因為我是要直接放在URL上, 像<code>https://og.jln.co/t/W-ethuiomF3liKnnlKhheGlvcy1tb2NrLWFkYXB0ZXLngrpheGlvc-aPkOS-m-a4rOippueUqOeahOWBh-izh-aWmQ</code>, 所以文字部分就用base64先編碼過(必須要用RawURLEncoding)</p><h3 id=unit-test>Unit test</h3><p>這邊為了測試畫出來的文字是不是正確, 所以就引入了<a href=https://github.com/otiai10/gosseract>gosseract</a>, gosseract是<a href=https://github.com/tesseract-ocr/tessdoc>tesseract-ocr</a>的go封裝, <a href=https://github.com/tesseract-ocr/tessdoc>tesseract-ocr</a>算是很老牌的OCR了, 辨識率還不錯, 不過老實說, 這邊只是想玩玩gosseract XD</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestDrawText</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewServer</span>(<span style=color:#e6db74>&#34;:8888&#34;</span>, <span style=color:#a6e22e>text2img</span>.<span style=color:#a6e22e>Params</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>FontPath</span>: <span style=color:#e6db74>&#34;../../fonts/SourceHanSansTC-VF.ttf&#34;</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gosseract</span>.<span style=color:#a6e22e>NewClient</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>drawText</span>(<span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>URLEncoding</span>.<span style=color:#a6e22e>EncodeToString</span>([]byte(<span style=color:#e6db74>&#34;For testing&#34;</span>)))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>SetImageFromBytes</span>(<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>Bytes</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Text</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#e6db74>&#34;For testing&#34;</span>, <span style=color:#a6e22e>text</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=使用網頁截圖來當og-image>使用網頁截圖來當OG Image</h2><p>這種類型應該比較常在ptt分享文章上看到, 像這樣</p><p><img src=/images/posts/og/og_sample_ptt.jpg alt="OG ptt"></p><p>這也是不錯的做法</p><h3 id=使用chromedphttpsgithubcomchromedpchromedp來擷取網頁畫面>使用<a href=https://github.com/chromedp/chromedp>chromedp</a>來擷取網頁畫面</h3><p><a href=https://github.com/chromedp/chromedp>chromedp</a>是透過chrome debug protocol 來操作Chrome的, 這邊就很適合從程式來操作截取網頁畫面, 只是擷取畫面, 還算蠻簡單的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Capture</span>(<span style=color:#a6e22e>encodedurl</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>decoded</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawURLEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>encodedurl</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>decoded</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;capture URL:%s\n&#34;</span>, <span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewExecAllocator</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NoSandbox</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewContext</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>			<span style=color:#75715e>// chromedp.WithDebugf(log.Printf),
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buf</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Tasks</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>EmulateViewport</span>(<span style=color:#ae81ff>1200</span>, <span style=color:#ae81ff>630</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#a6e22e>url</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>FullScreenshotInViewport</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>buf</span>, <span style=color:#ae81ff>90</span>),
</span></span><span style=display:flex><span>		}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊要擷取的URL一樣是透過base64編碼完放在url傳過來的, 因為我們要的圖大小是1200x630, 所以這邊的View port就設定成那個大小, 有一個比較要特別注意的是, 跟原本chromdp範例不同的地方是, 這邊要用<code>ctx, _ := chromedp.NewExecAllocator(context.Background(), chromedp.NoSandbox)</code> <strong>&ldquo;NoSandbox&rdquo;</strong> 的模式來初始chrome, 要不然無法在heroku下跑</p><p>這邊並不是使用<code>chrome.FullScreenshot</code>來擷取畫面, 取而代之的是用自己寫的<code>FullScreenshotInViewport</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FullScreenshotInViewport</span>(<span style=color:#a6e22e>res</span> <span style=color:#f92672>*</span>[]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>quality</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>EmulateAction</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;res cannot be nil&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ActionFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>format</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>CaptureScreenshotFormatJpeg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// capture screenshot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>*</span><span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>CaptureScreenshot</span>().
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WithCaptureBeyondViewport</span>(<span style=color:#66d9ef>true</span>).
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WithFormat</span>(<span style=color:#a6e22e>format</span>).
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WithQuality</span>(int64(<span style=color:#a6e22e>quality</span>)).<span style=color:#a6e22e>WithClip</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Viewport</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>X</span>:      <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Y</span>:      <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Width</span>:  <span style=color:#ae81ff>1200</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Height</span>: <span style=color:#ae81ff>630</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Scale</span>:  <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>		}).<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其實這支是抄自<code>chrome.FullScreenshot</code>, 但不一樣的是<code>WithClip</code>這邊的寬高用的是1200x630, 這是因為原本<code>chrome.FullScreenshot</code>會抓整頁完整頁面, 要多長有多長, 結果寬度雖是1200, 但長度可能超長, 這樣的比例可能也會被Facebook視為要用小版面來顯示</p><h3 id=佈署到heroku>佈署到heroku</h3><p><a href=https://github.com/chromedp/chromedp>chromedp</a>是沒辦法單獨運作的, 必須要有chrome才可以正常運作, 如果要部屬到heroku, heroku的環境上是沒裝chrome的, 這該怎麼辦?</p><p>一種方式是建立自己的<a href=https://devcenter.heroku.com/articles/buildpacks#creating-a-buildpack>Build Pack</a>, <a href=https://developers.google.com/web/updates/2017/04/headless-chrome>裝個chrome跑headless mode</a>, 不過這條路太麻煩, 不是我選擇的路</p><p>一個是在heroku上用<a href=https://devcenter.heroku.com/articles/build-docker-images-heroku-yml>docker image來跑</a>, 這樣只要包裝好一個docker image就搞定了, 簡單</p><p>為了這目的, 可以選用<a href=https://github.com/chromedp/docker-headless-shell>Headless shell</a>這個docker image當作base image, 這個image已經等同包裝好一個headless chrome了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>FROM</span> <span style=color:#a6e22e>chromedp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>headless</span><span style=color:#f92672>-</span><span style=color:#a6e22e>shell</span>:<span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>Install</span> <span style=color:#a6e22e>dumb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>init</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>tini</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RUN</span> <span style=color:#a6e22e>apt</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>dumb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>init</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>RUN</span> <span style=color:#a6e22e>apt</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>tini</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;dumb-init&#34;</span>, <span style=color:#e6db74>&#34;--&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;tini&#34;</span>, <span style=color:#e6db74>&#34;--&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>CMD</span> [<span style=color:#e6db74>&#34;/path/to/your/program&#34;</span>]
</span></span></code></pre></div><p>這邊的<code>dumb-init</code>, <code>tini</code>是必須的, 因為這個container不只會跑一個procewss, 包含chrome是兩個, 所以不包這個的話, 在結束container時會有zombie process造成container無法被結束</p><h2 id=有黑貓就加分>有黑貓就加分!</h2><p>不過, 也不是每個網頁都像ptt那樣適合用截圖來做og:image, 後來想了一下, 我想要的大概介於兩者之間, 有文字, 但不太單調的版面, 像這樣</p><p><img src=/images/posts/og/og_sample_cat.jpg alt="OG cat"></p><p>那其實這也不難, 做一個網頁範本, 用前面的截圖的方法截出來就好了, 那這也是目前最後使用的版本</p><h2 id=小收尾>小收尾</h2><p>順便做了幾個小收尾</p><ol><li>除了Facebook bot跟Twitter bot外, 不可以抓到產生的圖, 這是為了以防有人偷用, 用UA去判斷</li><li>加上cache-control, cdn-cache-control header, 前面再擋一層cloudflare</li></ol><h2 id=碰到的問題>碰到的問題</h2><p>目前碰到的主要問題有兩個</p><ol><li>heroku的free dyno冷啟動至少要6秒, 如果網頁又太慢, 那很有可能造成Facebook bot或Twitter bot timeout</li><li>最最詭異的部分是, Facebook部分, 字形跑掉了, 比照前面那張貓圖跟下面這張, 會發現"Julian Shen"的字形跑掉了, 前面那個是Twitter抓出來的, 後者是Facebook, 明明就同一個URL, 同一個browser render, 如果直接看那張圖字形也是正常的, 但Facebook不知道哪抓來的靈異照片
<img src=/images/posts/og/og_sample_cat_2.jpg alt="OG cat"></li></ol></div></article><div class=pagination><ul class=inline-list><li><a href=/page/4/ class=btn>Previous</a></li><li><a href=/>1</a></li><li><a href=/page/2/>2</a></li><li><a href=/page/3/>3</a></li><li><a href=/page/4/>4</a></li><li><strong class=current-page>5</strong></li><li><a href=/page/6/>6</a></li><li><a href=/page/7/>7</a></li><li><a href=/page/8/>8</a></li><li><a href=/page/9/>9</a></li><li><a href=/page/10/>10</a></li><li><a href=/page/11/>11</a></li><li><a href=/page/12/>12</a></li><li><a href=/page/13/>13</a></li><li><a href=/page/14/>14</a></li><li><a href=/page/15/>15</a></li><li><a href=/page/16/>16</a></li><li><a href=/page/17/>17</a></li><li><a href=/page/18/>18</a></li><li><a href=/page/19/>19</a></li><li><a href=/page/20/>20</a></li><li><a href=/page/21/>21</a></li><li><a href=/page/22/>22</a></li><li><a href=/page/23/>23</a></li><li><a href=/page/24/>24</a></li><li><a href=/page/25/>25</a></li><li><a href=/page/26/>26</a></li><li><a href=/page/27/>27</a></li><li><a href=/page/28/>28</a></li><li><a href=/page/29/>29</a></li><li><a href=/page/30/>30</a></li><li><a href=/page/31/>31</a></li><li><a href=/page/32/>32</a></li><li><a href=/page/33/>33</a></li><li><a href=/page/34/>34</a></li><li><a href=/page/35/>35</a></li><li><a href=/page/36/>36</a></li><li><a href=/page/37/>37</a></li><li><a href=/page/38/>38</a></li><li><a href=/page/39/>39</a></li><li><a href=/page/40/>40</a></li><li><a href=/page/41/>41</a></li><li><a href=/page/42/>42</a></li><li><a href=/page/43/>43</a></li><li><a href=/page/44/>44</a></li><li><a href=/page/45/>45</a></li><li><a href=/page/46/>46</a></li><li><a href=/page/47/>47</a></li><li><a href=/page/48/>48</a></li><li><a href=/page/49/>49</a></li><li><a href=/page/50/>50</a></li><li><a href=/page/51/>51</a></li><li><a href=/page/52/>52</a></li><li><a href=/page/53/>53</a></li><li><a href=/page/54/>54</a></li><li><a href=/page/55/>55</a></li><li><a href=/page/56/>56</a></li><li><a href=/page/57/>57</a></li><li><a href=/page/58/>58</a></li><li><a href=/page/59/>59</a></li><li><a href=/page/60/>60</a></li><li><a href=/page/61/>61</a></li><li><a href=/page/62/>62</a></li><li><a href=/page/63/>63</a></li><li><a href=/page/64/>64</a></li><li><a href=/page/65/>65</a></li><li><a href=/page/66/>66</a></li><li><a href=/page/67/>67</a></li><li><a href=/page/68/>68</a></li><li><a href=/page/69/>69</a></li><li><a href=/page/70/>70</a></li><li><a href=/page/71/>71</a></li><li><a href=/page/72/>72</a></li><li><a href=/page/73/>73</a></li><li><a href=/page/74/>74</a></li><li><a href=/page/75/>75</a></li><li><a href=/page/76/>76</a></li><li><a href=/page/77/>77</a></li><li><a href=/page/6/ class=btn>Next</a></li></ul></div></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script><script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>