<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Le murmure de Julian</title><meta name=description content><meta property="og:title" content="Le murmure de Julian"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jln.co/"><meta property="og:image" content="https://blog.jln.co/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.jln.co/images/avatar.png"><meta name=twitter:title content="Le murmure de Julian"><meta name=twitter:description content><link rel=canonical href=https://blog.jln.co/><link rel=alternate type=application/rss+xml href=https://blog.jln.co/feed.xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.105.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post-index class=feature><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=entry-image><img src=/images/bkg2.jpg alt="Le murmure de Julian"></div><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>朱隸安貓囈語錄</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2017-04-16 18:15:44 +0000 UTC"><a href=/%E7%AD%86%E8%A8%98Vue.js-Slot%E7%9A%84%E6%87%89%E7%94%A8/>Apr 16, 2017</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~5 minutes</span></div><h1 class=entry-title><a href=/%E7%AD%86%E8%A8%98Vue.js-Slot%E7%9A%84%E6%87%89%E7%94%A8/ rel=bookmark title="[筆記][Vue.js] Slot的應用" itemprop=url>[筆記][Vue.js] Slot的應用</a></h1></header><div class=entry-content><p>Vue的component裡有一個還蠻好用的東西叫做<a href=https://vuejs.org/v2/guide/components.html#Content-Distribution-with-Slots>Slot</a>(文件<a href=https://vuejs.org/v2/guide/components.html#Content-Distribution-with-Slots>在此</a>), 尤其適用在開發複雜或巢狀的元件</p><p>那Slot是用在什麼樣的地方, 舉個例子, 假設我們有個元件叫做panel:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>panel</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span>&gt;Inside panel&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span>&gt;Panel content&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>panel</span>&gt;
</span></span></code></pre></div><p>Panel的定義可能會是這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;panel&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;div&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;&#39;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p><a href=https://jsfiddle.net/898f03os/0/>執行範例</a></p><p>簡單的說, 這邊template裡的slot會被拿來放前面例子<code>&lt;panel>&lt;/panel></code>裡面的<code>&lt;div></code></p><p>當然, 這也可以讓我們這個component裡面再放其他的component, 像是這樣的例子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>b-menu</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#f92672>b-menu-item</span>&gt;menu 1&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#f92672>b-menu-item</span>&gt;menu 2&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#f92672>b-menu-item</span>&gt;menu 3&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#f92672>b-menu-item</span>&gt;menu 4&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>b-menu</span>&gt;
</span></span></code></pre></div><p>實作上可以寫成這樣</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;b-menu&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;div&gt;&lt;ul&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/ul&gt;&lt;/div&gt;&#39;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;b-menu-item&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;li&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/li&gt;&#39;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p><a href=https://jsfiddle.net/898f03os/2/>執行範例</a></p><p>其實這範例看起來好像也沒啥必要寫成component(不過就ul/li), 當然, 實際上的應用可以再更複雜, 再來看一個更複雜的範例:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>b-menu</span>&gt;
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>b-menu-item</span> <span style=color:#a6e22e>title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;menu 1&#34;</span>&gt;Content 1&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>b-menu-item</span> <span style=color:#a6e22e>title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;menu 2&#34;</span>&gt;Content 2&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>b-menu-item</span> <span style=color:#a6e22e>title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;menu 3&#34;</span>&gt;Content 3&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span>	&lt;<span style=color:#f92672>b-menu-item</span> <span style=color:#a6e22e>title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;menu 4&#34;</span>&gt;Content 4&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>b-menu</span>&gt;
</span></span></code></pre></div><p>跟上面不一樣的是, 這次想render成的結果是像這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>ul</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>li</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a1&#34;</span>&gt;menu 1&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>li</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a2&#34;</span>&gt;menu 2&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>li</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a3&#34;</span>&gt;menu 3&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>li</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#a4&#34;</span>&gt;menu 4&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=color:#f92672>ul</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;a1&#34;</span>&gt;Content1&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;a2&#34;</span>&gt;Content2&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;a3&#34;</span>&gt;Content3&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;a4&#34;</span>&gt;Content4&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span></code></pre></div><p>這明顯被切成兩區了, title的部分顯示在<code>&lt;ul></code>內, 而content卻在另一區, 那這該怎麼做呢?</p><h3 id=取得slot內的子元件child-component>取得Slot內的子元件(Child component)</h3><p>上面的例子可以寫成這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;b-menu&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>  	<span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;div&gt;&lt;ul&gt;&lt;li v-for=&#34;(item,i) in items&#34;&gt;&lt;a :href=&#34;`#a${i+1}`&#34;&gt;{{item.title}}&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mounted</span> () {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span><span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$slots</span>.<span style=color:#66d9ef>default</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>item</span> =&gt; <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>componentInstance</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>false</span>).<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>item</span> =&gt; <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>componentInstance</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> [<span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>item</span>] <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>entries</span>()) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$set</span>(<span style=color:#a6e22e>item</span>, <span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#e6db74>&#39;a&#39;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>index</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;b-menu-item&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;div :id=&#34;id&#34;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;title&#39;</span>],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>要取得slot裡面的child nodes可以用<code>this.$slots.default</code>, 但這個包含所有的child nodes, 如果我們要的只是child components, 那可以檢查這個node是否包含<code>componentInstance</code></p><p>因此, 透過filter和map, 我們可以以<code>this.$slots.default.filter(item => item.componentInstance || false).map(item => item.componentInstance)</code>來取得child components, 在這個例子就包含所有的b-menu-item</p><p>這段程式的作法就是取得所有child components放入items這個資料欄位中, 而在template中有<code>&lt;li v-for="(item,i) in items"></code>利用items內的值來渲染<code>&lt;li></code>的部分</p><p>這邊有一點需要注意的是, 這段必須要跑在 <code>mounted()</code>不能在<code>created()</code>, 因為在<code>created()</code>裡面雖然可以用<code>this.$slots.default</code>來取得child nodes, 但這時候child nodes的componentInstace全部都是undefined, 因為這時候child components其實都還沒準備好</p><h3 id=處理動態內容>處理動態內容</h3><p><code>b-menu-item</code>當然也可以用<code>v-for</code>來動態渲染, 像是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>b-menu</span>&gt;
</span></span><span style=display:flex><span>   &lt;<span style=color:#f92672>b-menu-item</span> <span style=color:#a6e22e>v-for</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mItem in menuItems&#34;</span> <span style=color:#a6e22e>:title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mItem.title&#34;</span>&gt;{{mItem.content}}&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>b-menu</span>&gt;
</span></span></code></pre></div><p>這邊的menuItems如果是一個靜態的陣列下面例子, 不會有問題</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Vue</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>el</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#app&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>menuItems</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;menu 1&#39;</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;content 1&#39;</span>
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;menu 2&#39;</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;content 2&#39;</span>
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;menu 3&#39;</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>content</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;content 3&#39;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       ]
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>但如果它的內容是由一個async function所產生, 像是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Vue</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>el</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#app&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>menuItems</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mounted</span> () {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>doGetSomething</span>(<span style=color:#a6e22e>data</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>menuItems</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>你可能會發現畫面完全沒變化, 那是因為我們在<code>b-menu</code>的<code>mouted()</code>的時候去掃所有的child components, 而<code>menuItems</code>可能在mouted很之後才會被更新, 所以不會被重掃一次, <code>items</code>並不會被更新, 所以畫面也不會有變化, 因此必須要在<code>menuItems</code>資料被更新後再掃一次slot的child components</p><p>可以把b-menu改成這樣</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;b-menu&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>  	<span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;div&gt;&lt;ul&gt;&lt;li v-for=&#34;(item,i) in items&#34;&gt;&lt;a :href=&#34;`#a${i+1}`&#34;&gt;{{item.title}}&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>methods</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>updateItems</span> () {
</span></span><span style=display:flex><span>	  	<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span><span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$slots</span>.<span style=color:#66d9ef>default</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>item</span> =&gt; <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>componentInstance</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>false</span>).<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>item</span> =&gt; <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>componentInstance</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> [<span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>item</span>] <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>entries</span>()) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$set</span>(<span style=color:#a6e22e>item</span>, <span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#e6db74>&#39;a&#39;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>index</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mounted</span> () {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>updateItems</span>()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>這樣亦即是, 我們在更新完資料後必須要再呼叫一次<code>updateItems()</code></p><p>為了直接呼叫到b-menu的updateItems, 可以先替他加一個<code>ref="menu"</code>, 方便後面存取</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>b-menu</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;menu&#34;</span>&gt;
</span></span><span style=display:flex><span>   &lt;<span style=color:#f92672>b-menu-item</span> <span style=color:#a6e22e>v-for</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mItem in menuItems&#34;</span> <span style=color:#a6e22e>:title</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mItem.title&#34;</span>&gt;{{mItem.content}}&lt;/<span style=color:#f92672>b-menu-item</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>b-menu</span>&gt;
</span></span></code></pre></div><p>前面更新menuItems的程式可以改寫成這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Vue</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>el</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#app&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>menuItems</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mounted</span> () {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>doGetSomething</span>(<span style=color:#a6e22e>data</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>menuItems</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>$refs</span>.<span style=color:#a6e22e>menu</span>.<span style=color:#a6e22e>updateItems</span>()
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>這邊透過<code>vm.$refs.menu.updateItems()</code>來更新<code>items</code></p><p>但&mldr;.還是沒動靜呀&mldr;怎麼回事? 因為這時候menuItems才剛被更新, 它先去更新b-munu-item, 如果讓items更新後, 畫面要跟著更新, 就必須要在下一個DOM的更新週期, 也就是使用<code>$nextTick</code>, 如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Vue</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>el</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;#app&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>menuItems</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mounted</span> () {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>doGetSomething</span>(<span style=color:#a6e22e>data</span> =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>menuItems</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>$nextTick</span>(() =&gt; {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>$refs</span>.<span style=color:#a6e22e>menu</span>.<span style=color:#a6e22e>updateItems</span>()
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>這樣就沒問題了!</p><p>但對於一個元件來說, 這樣的設計並不是很好, 變成這個元件必須相依於使用它的程式, 還有沒更好的寫法?</p><h3 id=在子原件更新時呼叫父元件呢>在子原件更新時呼叫父元件呢?</h3><p>把<code>b-menu-item</code>這樣改寫:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;b-menu-item&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;div :id=&#34;id&#34;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;title&#39;</span>],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mounted</span> () {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$parent</span>.<span style=color:#a6e22e>updateItems</span>()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>這樣也是可行的, 當新的<code>b-menu-item</code>被加入slot中時, 就會呼叫一次updateItems</p><p>但這是有缺點的:</p><ol><li>每個child component會呼叫一次, 但實際上不需要被呼叫這麼多次, 有點浪費</li><li>這個子原件的設計變成會依賴父元件, 不易與用在其他元件內</li></ol><p>所以還是需要一個更好的方式</p><h3 id=mutationobserver>MutationObserver</h3><p>這時候就要借用HTML5的<a href=https://developer.mozilla.org/zh-TW/docs/Web/API/MutationObserver>MutationObserver</a>, 這個在Vuejs內部也是大量地被使用</p><p>使用<a href=https://developer.mozilla.org/zh-TW/docs/Web/API/MutationObserver>MutationObserver</a>, 我們可以把<code>b-menu</code>改成這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Vue</span>.<span style=color:#a6e22e>component</span>(<span style=color:#e6db74>&#39;b-menu&#39;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span> () {
</span></span><span style=display:flex><span>  	<span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>domObserver</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;div&gt;&lt;ul&gt;&lt;li v-for=&#34;(item,i) in items&#34;&gt;&lt;a :href=&#34;`#a${i+1}`&#34;&gt;{{item.title}}&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div ref=&#34;content&#34;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>methods</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>updateItems</span> () {
</span></span><span style=display:flex><span>	  	<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span><span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$slots</span>.<span style=color:#66d9ef>default</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>item</span> =&gt; <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>componentInstance</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>false</span>).<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>item</span> =&gt; <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>componentInstance</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> [<span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>item</span>] <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>entries</span>()) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>$set</span>(<span style=color:#a6e22e>item</span>, <span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#e6db74>&#39;a&#39;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>index</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mounted</span> () {
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>updateItems</span>()
</span></span><span style=display:flex><span>	 <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>vm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>
</span></span><span style=display:flex><span>	 <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>domObserver</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MutationObserver</span>((<span style=color:#a6e22e>mr</span>, <span style=color:#a6e22e>el</span>) =&gt; {
</span></span><span style=display:flex><span>		 <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>shouldUpdate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		 <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>m</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>mr</span>) {
</span></span><span style=display:flex><span>			 <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>addedNodes</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>removedNodes</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>				 <span style=color:#a6e22e>shouldUpdate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				 <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			 }
</span></span><span style=display:flex><span>		 }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		 <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>shouldUpdate</span>) {
</span></span><span style=display:flex><span>			 <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>updateItems</span>()
</span></span><span style=display:flex><span>		 }
</span></span><span style=display:flex><span>	 })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	 <span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>domObserver</span>.<span style=color:#a6e22e>observer</span>(<span style=color:#a6e22e>vm</span>.<span style=color:#a6e22e>$refs</span>.<span style=color:#a6e22e>content</span>, {<span style=color:#a6e22e>childList</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>subtree</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>})
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>藉由監控slot的父節點(parent node)的變化來確定是否要去更新items, 這樣一來就不用依賴其他人也可以做到自動更新了</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2017-04-15 12:46:27 +0000 UTC"><a href=/%E7%AD%86%E8%A8%98%E5%88%A9%E7%94%A8axios-mock-adapter%E7%82%BAaxios%E6%8F%90%E4%BE%9B%E6%B8%AC%E8%A9%A6%E7%94%A8%E7%9A%84%E5%81%87%E8%B3%87%E6%96%99/>Apr 15, 2017</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~2 minutes</span></div><h1 class=entry-title><a href=/%E7%AD%86%E8%A8%98%E5%88%A9%E7%94%A8axios-mock-adapter%E7%82%BAaxios%E6%8F%90%E4%BE%9B%E6%B8%AC%E8%A9%A6%E7%94%A8%E7%9A%84%E5%81%87%E8%B3%87%E6%96%99/ rel=bookmark title=[筆記]利用axios-mock-adapter為axios提供測試用的假資料 itemprop=url>[筆記]利用axios-mock-adapter為axios提供測試用的假資料</a></h1></header><div class=entry-content><p><a href=https://github.com/mzabriskie/axios>axios</a>是蠻好用的javascript http client, 不僅可以在browser上跑, 也可以在node.js上用, 而且Promise形態的API寫起來就比較好看, 如果搭配async/await的寫法, 看起來就更加漂亮了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>loadUser</span>(<span style=color:#a6e22e>uid</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>axios</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/user?ID=12345&#39;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>response</span> =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>response</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    .<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>error</span> =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>error</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>或是（async/await)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>loadUser</span>(<span style=color:#a6e22e>uid</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>axios</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/user?ID=12345&#39;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>但如果開發時期或是要做Unit testing需要用假資料來取代server api直接回傳呢? 目前我看到兩套方案, 一個是<a href=https://github.com/mzabriskie/axios>axios</a>作者做的<a href=https://github.com/mzabriskie/moxios>moxios</a>另外一個是<a href=https://github.com/ctimmerm/axios-mock-adapter>axios-mock-adapter</a>, <a href=https://github.com/mzabriskie/moxios>moxios</a>看起來好像比較適合在Unit testing時, 而我是想在開發過程中使用, 所以我選的是<a href=https://github.com/ctimmerm/axios-mock-adapter>axios-mock-adapter</a></p><p>使用<a href=https://github.com/ctimmerm/axios-mock-adapter>axios-mock-adapter</a>還蠻簡單的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>axios</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;axios&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>MockAdapter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;axios-mock-adapter&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>mock</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MockAdapter</span>(<span style=color:#a6e22e>axios</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mock</span>.<span style=color:#a6e22e>onGet</span>(<span style=color:#e6db74>&#39;/users&#39;</span>).<span style=color:#a6e22e>reply</span>(<span style=color:#ae81ff>200</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>users</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;John Smith&#39;</span> },
</span></span><span style=display:flex><span>    { <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;John Doe&#39;</span> }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>axios</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/users&#39;</span>)
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>response</span> =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>  })
</span></span></code></pre></div><p>創建uri跟假資料的對應很簡單, 基本上也就是&rsquo;on&rsquo;&lsquo;Method&rsquo;, 比如說<code>onGet</code>, <code>onPost</code>, 另外還有一個<code>onAny</code>可以處理所有的HTTP methods</p><p>做過mock後, axios呼叫這個uri所拿回來的資料通通就都會是假資料了, 這樣也不用為了塞假資料開發測試而去改動自己的程式</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2017-04-15 11:52:29 +0000 UTC"><a href=/%E7%AD%86%E8%A8%98Vue.js--Webpack-%E5%88%A4%E6%96%B7%E6%98%AF%E5%90%A6%E7%82%BA%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83/>Apr 15, 2017</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~2 minutes</span></div><h1 class=entry-title><a href=/%E7%AD%86%E8%A8%98Vue.js--Webpack-%E5%88%A4%E6%96%B7%E6%98%AF%E5%90%A6%E7%82%BA%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83/ rel=bookmark title="[筆記][Vue.js + Webpack] 判斷是否為開發環境" itemprop=url>[筆記][Vue.js + Webpack] 判斷是否為開發環境</a></h1></header><div class=entry-content><p>在開發的時候總會有一個需求是想在開發階段做跟生產環境不一樣的事, 像我自己的習慣是在做畫面時, 不見得後端資料和API都已經準備好了, 所以我會先以假的資料(mock data)來取代, 放上線後才是真正去抓server api</p><p>因此就會需要一個方法來判斷現在到底是不是在開發階段, 如果使用<a href=https://webpack.github.io/>webpack</a>來開發, 這件事就會變得很簡單, 最近一直在寫<a href=https://vuejs.org>Vue.js</a>, 這邊就有<a href=https://vuejs.org>Vue.js</a> (反正我也還不懂react.js, 哈)</p><p>用vue-cli建立一個以webpack為工作流程的專案很簡單:</p><pre tabindex=0><code>vue init webpack my-project
</code></pre><p>跑完後相關的檔案都幫你產生好了</p><p>要在你的程式裡面判斷目前是否是開發環境的話, 只要加入這樣的判斷:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NODE_ENV</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;development&#39;</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Hi!You are in dev env&#39;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>生產環境就把"development"換成"production"就好了</p><p>不過實際跑到瀏覽器上時, 如果你在developement console內直接下<code>console.log(process.env.NODE_ENV)</code>, 你會發現完全沒這東西, 這是因為process.env.NODE_ENV並不是活在client端, 而是webpack在建置過程(跑在node.js)中動了手腳做了轉換了</p><p>那這值是在哪邊被定義呢? 打開"build/webpack.dev.conf.js"這個檔案看, 你會發現:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>webpack</span>.<span style=color:#a6e22e>DefinePlugin</span>({
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;process.env&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>dev</span>.<span style=color:#a6e22e>env</span>
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>	...
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>以及"config/dev.env.js":</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>merge</span>(<span style=color:#a6e22e>prodEnv</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>NODE_ENV</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#34;development&#34;&#39;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2017-04-01 10:00:58 +0000 UTC"><a href=/Golang-Go%E7%9A%84httptest/>Apr 1, 2017</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~2 minutes</span></div><h1 class=entry-title><a href=/Golang-Go%E7%9A%84httptest/ rel=bookmark title="[Golang] Go的httptest" itemprop=url>[Golang] Go的httptest</a></h1></header><div class=entry-content><p>在標準的go package中除了已經內建了http相關的實作外, 還有一個<code>net/http/httptest</code>, 這的package是用來給寫http相關測試用的, 可分為測試http server (http handler)和http client的(提供mock server給client)</p><p>如果要測試http handler, 所需要的是ResponseRecorder, 基本上相關的也只需要兩個方法<code>NewRequest</code>, <code>NewRecorder</code>, 參照下面範例:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;net/http/httptest&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestHttpServer</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assert</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>handler</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;&lt;html&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httptest</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;http://example.com/foo&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httptest</span>.<span style=color:#a6e22e>NewRecorder</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#e6db74>&#34;text/html; charset=utf-8&#34;</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>body</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>範例中先用<code>NewRequest</code>假造出一個連接到<code>http://example.com/foo</code>的request, 而對於一個http handler來說的話, 所需要的參數一個是*Request, 另一個則是ResponseWriter了, ResponseWriter便可以由<code>NewRecorder</code>假冒, 再將這兩者傳給handler去處理, 並可以由<code>ResponseRecorder.Result</code>取得回傳內容來驗證</p><p>那如果是要測試http client呢?測client通常我們會需要mock server來偽造成真著server餵給client適當的假資料來測試, 以下是一個測試的範例:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestServer</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assert</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httptest</span>.<span style=color:#a6e22e>NewServer</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintln</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Hello, client&#34;</span>)
</span></span><span style=display:flex><span>        }))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ts</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ts</span>.<span style=color:#a6e22e>URL</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>greeting</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#e6db74>&#34;Hello, client\n&#34;</span>, string(<span style=color:#a6e22e>greeting</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>利用<code>httptest.NewServer</code>創建一個test server, 這邊的handler就看你需要利用什麼樣的假資料測試來做, 上面這例子只是用單純的http client來測, 回傳總是是"Hello, client", 但假設你是測試restful API, 那也可以準備一系列的JSON回傳, 你只要把<code>ts.URL</code>當作你的API endpoint給你的REST client的實作使用即可</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2017-03-25 20:55:24 +0000 UTC"><a href=/Java-Mockito%E7%9A%84doReturn%E5%92%8CthenReturn/>Mar 25, 2017</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/Java-Mockito%E7%9A%84doReturn%E5%92%8CthenReturn/ rel=bookmark title="[Java] Mockito的doReturn和thenReturn" itemprop=url>[Java] Mockito的doReturn和thenReturn</a></h1></header><div class=entry-content><p>在做測試時, 利用假資料來做測試還算是一個蠻常被利用的技巧, 除了可以減少測試中的變動因子, 維持測試的scope的穩定度, 避免因為非程式本身造成的問題影響測試外, 還有就是在有跟別人API的對接的場合, 在還沒實際的API測試時, 一樣可以測試介面實作有沒問題</p><p><a href=http://site.mockito.org/>Mockito</a>在這方面(mocking)算是一個很有趣的東西, 前陣子在做公司的東西時, 拿了Mockito做了一些unit tests, 就想要寫這一篇, 不過又一直拖著沒寫了 :P</p><p>如果對<a href=http://site.mockito.org/>Mockito</a>沒什麼接觸的話, 可以看一下他的<a href=http://site.mockito.org/>文件</a>, 並沒有很多很複雜的API, 初次看可能會覺得有點神奇, 不過, 這邊並不是要講它神奇的原理, 而是探討一下他的<code>thenReturn</code>和<code>doReturn</code></p><p>在<a href=http://site.mockito.org/>Mockito</a>中, 你要創立一個mock object是像這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// mock creation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>List mockedList <span style=color:#f92672>=</span> mock<span style=color:#f92672>(</span>List<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>上面這例子就會創造一個虛假的List object, 你可以說這個object擁有List的特性, 但他卻是個假貨!</p><p>針對mock object, 你可能會去做這樣一件事:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>when<span style=color:#f92672>(</span>mockedList<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>)).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;first&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// 或是:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>doReturn<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;first&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>when</span><span style=color:#f92672>(</span>mockedList<span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>上面這兩句話(好吧, 是兩行程式, 但Mockito實在太口語化了)在這狀況下是代表同一件事, 照理說應該也會有一樣的結果, 那為何要有兩種寫法呢?</p><p>這邊要注意一點是, &ldquo;Mock"這件事是針對object, 創建出來的object實例(instance), 並不是針對類別(Class), 因此當你使用<code>when(mockedList.get(0)).thenReturn("first")</code>指的是如果你呼叫了<code>mockedList.get(0)</code>會回傳"first&rdquo;, 但不代表你呼叫所有<code>List.get(0)</code>都是回傳"first", 利用了<code>mock</code>創建出來的實例, 真的是個假貨, 呼叫它任何的方法(method), 都不會真的呼叫到你真正在類別裡面定義的實作, 而是被導引到空殼去了</p><p>再回到兩種寫法的問題, 針對上述的mock object, 這兩種寫法都是沒問題的, 完全一模一樣, 但<a href=http://site.mockito.org/>Mockito</a>裡面還有另一種形式的mock, 叫做<code>Spy</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   List list <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedList<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>   List spy <span style=color:#f92672>=</span> spy<span style=color:#f92672>(</span>list<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//optionally, you can stub out some methods:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   when<span style=color:#f92672>(</span>spy<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>100<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//using the spy calls real methods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   spy<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;one&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   spy<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;two&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>mock是偽造了全部的東西, 或許就像是個天才雷普利, 但spy想做的只是偽造部分的內容, 以上面的例子來說, <code>spy.add</code>會呼叫到真正的方法(method) - <code>add</code>, 也就是這個list實際上會有"one"和"two"兩個東西, 但呼叫<code>size()</code>時回傳的會是100, 所以以下這例子會有問題</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#75715e>//optionally, you can stub out some methods:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   when<span style=color:#f92672>(</span>spy<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>100<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//using the spy calls real methods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   spy<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;one&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   spy<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;two&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   spy<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>spy<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>如果一般正常狀況, 這個list的大小正好是加入的大小（這邊為2), 但因為我們偽造了<code>size()</code>讓他回傳了100, 這邊就會有問題了, 因為<code>get</code>實際上呼叫到的會是"real method"</p><p>其實回來看when的語法的話, 會發現本身就是蠻神奇的了, <code>when(obj.method1()).thenReturn(anyObject())</code>, 照一般Java語法來看, 為什麼把obj.method1()的執行結果帶給when當參數？為何when的回傳結果呼叫了thenReturn之後我們呼叫<code>obj.method1()</code>都會是回傳我們指定的回傳值?</p><p>想知道? 問香蕉&mldr;.不是啦&mldr;這必須要知道Mockito的原理, 不過因為它是利用了很多很冷門的神奇技巧, 不在這邊探討範圍, 這邊只需要知道一件事, <code>when(obj.method1())</code>的確真的是呼叫了<code>obj.method1()</code>沒錯, 但對<code>obj = mock(MyClass.class)</code>來說, obj完全是沒作用的空殼, 所以呼叫了<code>obj.method1()</code>, 什麼事都不會發生的!</p><p>但對於Spy來說就不一樣了, Spy不是完全體的mock, 他是個代理, 最後還是會呼叫後面真正的method的, 因此如果碰到<code>when(obj.method1()).thenReturn(anyObject())</code>, <code>obj.method1()</code>絕對會起作用的, 但我們通常的目的就是想取代這個method的執行結果, 因此這樣會有副作用, 也就是當我們要假冒他前, 會先觸發一次, 就跟詐騙別人前先跑去通知警察一樣(什麼爛比喻), 這不是我們樂見的, 因此我們需要的就是<code>doReturn</code></p><p><code>doReturn("my result").when(obj).method1()</code>在這裡的when會再把obj mock一次, 以至於<code>method1()</code>暫時變成個空殼不會在這邊被觸發, 這樣就可以達到我們前面說的目的了, 但, 缺點是, when &mldr; thenReturn , 因為when可以先知道方法的回傳值型態, 因此<code>thenReturn</code>裡面放的值只能是那型態, 所以寫錯了, comoile time會抓出來, 但反過來用的<code>doReturn</code>, 它接的是<code>Object</code>, 並無法在compile time做檢查, 所以如果有出錯, 要到執行時期才會發現</p></div></article><div class=pagination><ul class=inline-list><li><a href=/page/4/ class=btn>Previous</a></li><li><a href=/>1</a></li><li><a href=/page/2/>2</a></li><li><a href=/page/3/>3</a></li><li><a href=/page/4/>4</a></li><li><strong class=current-page>5</strong></li><li><a href=/page/6/>6</a></li><li><a href=/page/7/>7</a></li><li><a href=/page/8/>8</a></li><li><a href=/page/9/>9</a></li><li><a href=/page/10/>10</a></li><li><a href=/page/11/>11</a></li><li><a href=/page/12/>12</a></li><li><a href=/page/13/>13</a></li><li><a href=/page/14/>14</a></li><li><a href=/page/15/>15</a></li><li><a href=/page/16/>16</a></li><li><a href=/page/17/>17</a></li><li><a href=/page/18/>18</a></li><li><a href=/page/19/>19</a></li><li><a href=/page/20/>20</a></li><li><a href=/page/21/>21</a></li><li><a href=/page/22/>22</a></li><li><a href=/page/23/>23</a></li><li><a href=/page/24/>24</a></li><li><a href=/page/25/>25</a></li><li><a href=/page/26/>26</a></li><li><a href=/page/27/>27</a></li><li><a href=/page/28/>28</a></li><li><a href=/page/29/>29</a></li><li><a href=/page/30/>30</a></li><li><a href=/page/31/>31</a></li><li><a href=/page/32/>32</a></li><li><a href=/page/33/>33</a></li><li><a href=/page/34/>34</a></li><li><a href=/page/35/>35</a></li><li><a href=/page/36/>36</a></li><li><a href=/page/37/>37</a></li><li><a href=/page/38/>38</a></li><li><a href=/page/39/>39</a></li><li><a href=/page/40/>40</a></li><li><a href=/page/41/>41</a></li><li><a href=/page/42/>42</a></li><li><a href=/page/43/>43</a></li><li><a href=/page/44/>44</a></li><li><a href=/page/45/>45</a></li><li><a href=/page/46/>46</a></li><li><a href=/page/47/>47</a></li><li><a href=/page/48/>48</a></li><li><a href=/page/49/>49</a></li><li><a href=/page/50/>50</a></li><li><a href=/page/51/>51</a></li><li><a href=/page/52/>52</a></li><li><a href=/page/53/>53</a></li><li><a href=/page/54/>54</a></li><li><a href=/page/55/>55</a></li><li><a href=/page/56/>56</a></li><li><a href=/page/57/>57</a></li><li><a href=/page/58/>58</a></li><li><a href=/page/59/>59</a></li><li><a href=/page/60/>60</a></li><li><a href=/page/61/>61</a></li><li><a href=/page/62/>62</a></li><li><a href=/page/63/>63</a></li><li><a href=/page/64/>64</a></li><li><a href=/page/65/>65</a></li><li><a href=/page/66/>66</a></li><li><a href=/page/67/>67</a></li><li><a href=/page/68/>68</a></li><li><a href=/page/69/>69</a></li><li><a href=/page/70/>70</a></li><li><a href=/page/71/>71</a></li><li><a href=/page/72/>72</a></li><li><a href=/page/73/>73</a></li><li><a href=/page/74/>74</a></li><li><a href=/page/75/>75</a></li><li><a href=/page/6/ class=btn>Next</a></li></ul></div></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>