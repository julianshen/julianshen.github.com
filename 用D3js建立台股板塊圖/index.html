<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>用D3js建立台股板塊圖 &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="用D3js建立台股板塊圖"><meta property="og:description" content="這題目瑣碎的東西太多了, 所以這篇打算只是做個紀錄, 做這東西原因是看到Finviz這個板塊圖覺得還蠻有趣的, 想說該怎去做到這樣的圖表 一眼就可以"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.jln.co/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/"><meta property="og:image" content="https://og.jln.co/jlns1/55SoRDNqc-W7uueri-WPsOiCoeadv-WhiuWclg"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-09-17T12:20:38+08:00"><meta property="article:modified_time" content="2021-09-17T12:20:38+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://og.jln.co/jlns1/55SoRDNqc-W7uueri-WPsOiCoeadv-WhiuWclg"><meta name=twitter:title content="用D3js建立台股板塊圖"><meta name=twitter:description content="這題目瑣碎的東西太多了, 所以這篇打算只是做個紀錄, 做這東西原因是看到Finviz這個板塊圖覺得還蠻有趣的, 想說該怎去做到這樣的圖表 一眼就可以"><link rel=canonical href=https://blog.jln.co/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.118.2"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div id=main role=main><article class=hentry><header class=header-title><div class=header-title-wrap><h1 class=entry-title><a href=/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/ rel=bookmark title=用D3js建立台股板塊圖>用D3js建立台股板塊圖</a></h1><h2><span class="entry-date date published"><time datetime="2021-09-17 12:20:38 +0800 +0800">September 17, 2021</time></span></h2><p class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~6 minutes</p></div></header><div class=entry-content><p>這題目瑣碎的東西太多了, 所以這篇打算只是做個紀錄, 做這東西原因是看到<a href="https://finviz.com/map.ashx?t=sec_all">Finviz</a>這個板塊圖覺得還蠻有趣的, 想說該怎去做到這樣的圖表</p><p><img src=/images/posts/2021-09-17-12-25-23.png alt=stockmap></p><p>一眼就可以大略看市場的狀況, 感覺還蠻酷的, 查了一下, 這東西叫<a href=https://en.wikipedia.org/wiki/Treemapping>Treemapping</a>, 想到資料視覺化, 我是先想到<a href=https://d3js.org/>D3.js</a>, 雖然說<a href=https://www.highcharts.com/>Highcharts</a>也可以達到一樣的目的, 不過<a href=https://d3js.org/>D3.js</a>使用上跟jQuery類似, 比較簡單, 所以選擇它來實現</p><p>先給結果<a href=https://fviz.jln.co/marketmap>https://fviz.jln.co/marketmap</a></p><p><img src=/images/posts/2021-09-17-12-45-59.png alt=f></p><p>這邊使用到的東西有:</p><ul><li>D3.js</li><li>Next.js (deploy to GitHub page)</li></ul><p>純粹靜態網頁, 沒資料庫, 不過目前資料只抓到2021/09/14, 定期抓資料的部分還懶得弄</p><h2 id=資料來源>資料來源</h2><p>這邊所需要的資料有幾個:</p><ul><li>上市股票的收盤資訊</li><li>上櫃股票的收盤資訊</li><li>各股所屬的分類資訊</li></ul><p>雖然都是容易爬的到的資料, 但兩個市場資料格式不是那麼的統一</p><p>抓取集中市場的歷史資料用這個 URL : &ldquo;<a href="https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&amp;date=%25s&amp;type=ALL&_=%25s%22">https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&amp;date=%s&amp;type=ALL&_=%s"</a> , date的格式用"20060102"這樣, &ldquo;_&ldquo;可以用timestamp即可, 我要的當然是json, 會比csv來的好處理點</p><p>個股的交易資訊在<code>data9</code>這個欄位, 欄位定義是<code>fields9</code>, 所以用<code>jq</code>來看一下</p><pre tabindex=0><code>curl &#34;https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&amp;date=20210910&amp;type=ALL&amp;_=1631369120214&#34; | jq &#34;.fields9&#34;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 3122k    0 3122k    0     0  1526k      0 --:--:--  0:00:02 --:--:-- 1526k
[
  &#34;證券代號&#34;,
  &#34;證券名稱&#34;,
  &#34;成交股數&#34;,
  &#34;成交筆數&#34;,
  &#34;成交金額&#34;,
  &#34;開盤價&#34;,
  &#34;最高價&#34;,
  &#34;最低價&#34;,
  &#34;收盤價&#34;,
  &#34;漲跌(+/-)&#34;,
  &#34;漲跌價差&#34;,
  &#34;最後揭示買價&#34;,
  &#34;最後揭示買量&#34;,
  &#34;最後揭示賣價&#34;,
  &#34;最後揭示賣量&#34;,
  &#34;本益比&#34;
]
</code></pre><p>來看一下<code>.data9</code>內的單筆資料, 基本上就是都放到array去, 算好處理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;9944&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;新麗&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;92,813&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;53&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;1,950,673&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.05&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.10&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;20.85&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.10&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&lt;p style= color:red&gt;+&lt;/p&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;0.10&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;20.75&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.15&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;23.19&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span></code></pre></div><p>這邊"漲跌(+/-)&ldquo;的部分, 其實不是只有+和-, 而居然是html tags, 包含四種狀況, +/-/ /X, +/-很好懂, 就是漲跟跌, 空白就是平盤了, X的狀況通常發生在除權息, 增減資這類狀況</p><p>那櫃檯市場呢? URL是這個<code>https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&amp;d=110/09/01&_=1631603049</code>, 日期格式跟集中市場不同, 是用&rdquo;/&ldquo;隔開, 並且是民國紀年, 這邊資料也是array放在<code>aaData</code>這欄位</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[<span style=color:#e6db74>&#34;9960&#34;</span>,<span style=color:#e6db74>&#34;\u9081\u9054\u5eb7&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;+0.35&#34;</span>,<span style=color:#e6db74>&#34;27.00&#34;</span>,<span style=color:#e6db74>&#34;27.25&#34;</span>,<span style=color:#e6db74>&#34;26.85&#34;</span>,<span style=color:#e6db74>&#34;27.06&#34;</span>,<span style=color:#e6db74>&#34;56,004&#34;</span>,<span style=color:#e6db74>&#34;1,515,312&#34;</span>,<span style=color:#e6db74>&#34;37&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;27.15&#34;</span>,<span style=color:#e6db74>&#34;5&#34;</span>,<span style=color:#e6db74>&#34;33,592,500&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;29.80&#34;</span>,<span style=color:#e6db74>&#34;24.40&#34;</span>]
</span></span></code></pre></div><p>那個股基本資料呢?這邊就神奇了, 居然有Open API document: <a href=https://openapi.twse.com.tw/v1/swagger.json>https://openapi.twse.com.tw/v1/swagger.json</a>, 可以用&rdquo;/v1/opendata/t187ap03_L"取得基本資料, 這邊雖然也有API可以取得當日交易資訊, 但只有當日並無歷史資料</p><p>上櫃股票的資料也有一樣的東西, 在 <a href=https://www.tpex.org.tw/openapi/swagger.json>https://www.tpex.org.tw/openapi/swagger.json</a></p><p>抓到的分類類別是代號, 所以要對應到正確的類別名稱可以用這表:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Categories</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;01&#34;</span>: <span style=color:#e6db74>&#34;水泥&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;02&#34;</span>: <span style=color:#e6db74>&#34;食品&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;03&#34;</span>: <span style=color:#e6db74>&#34;塑膠&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;04&#34;</span>: <span style=color:#e6db74>&#34;紡織纖維&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;05&#34;</span>: <span style=color:#e6db74>&#34;電機機械&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;06&#34;</span>: <span style=color:#e6db74>&#34;電器電纜&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;21&#34;</span>: <span style=color:#e6db74>&#34;化工&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;22&#34;</span>: <span style=color:#e6db74>&#34;生技&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;08&#34;</span>: <span style=color:#e6db74>&#34;玻璃陶瓷&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;09&#34;</span>: <span style=color:#e6db74>&#34;造紙&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;10&#34;</span>: <span style=color:#e6db74>&#34;鋼鐵&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;11&#34;</span>: <span style=color:#e6db74>&#34;橡膠&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;12&#34;</span>: <span style=color:#e6db74>&#34;汽車&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;24&#34;</span>: <span style=color:#e6db74>&#34;半導體&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;25&#34;</span>: <span style=color:#e6db74>&#34;電腦及週邊&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;26&#34;</span>: <span style=color:#e6db74>&#34;光電&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;27&#34;</span>: <span style=color:#e6db74>&#34;通信網路&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;28&#34;</span>: <span style=color:#e6db74>&#34;電子零組件&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;29&#34;</span>: <span style=color:#e6db74>&#34;電子通路&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;30&#34;</span>: <span style=color:#e6db74>&#34;資訊服務&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;31&#34;</span>: <span style=color:#e6db74>&#34;其他電子&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;14&#34;</span>: <span style=color:#e6db74>&#34;建材營造&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;15&#34;</span>: <span style=color:#e6db74>&#34;航運&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;16&#34;</span>: <span style=color:#e6db74>&#34;觀光&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;17&#34;</span>: <span style=color:#e6db74>&#34;金融保險&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;18&#34;</span>: <span style=color:#e6db74>&#34;貿易百貨&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;23&#34;</span>: <span style=color:#e6db74>&#34;油電燃氣&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;19&#34;</span>: <span style=color:#e6db74>&#34;綜合&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;20&#34;</span>: <span style=color:#e6db74>&#34;其他&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;32&#34;</span>: <span style=color:#e6db74>&#34;文創&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;33&#34;</span>: <span style=color:#e6db74>&#34;農業科技&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;34&#34;</span>: <span style=color:#e6db74>&#34;電商&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;80&#34;</span>: <span style=color:#e6db74>&#34;管理股票&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;91&#34;</span>: <span style=color:#e6db74>&#34;存託憑證&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>把以上資料, 整合起來, 我需要的是這樣的資料:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;台股版塊&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;children&#34;</span>: [{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;集中市場&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;children&#34;</span>: [{
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;水泥&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;children&#34;</span>: [{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Code&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;台泥&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;TradeVolume&#34;</span>: <span style=color:#e6db74>&#34;14853294&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Transaction&#34;</span>: <span style=color:#e6db74>&#34;6367&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;TradeValue&#34;</span>: <span style=color:#e6db74>&#34;715327703&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;OpeningPrice&#34;</span>: <span style=color:#e6db74>&#34;48.35&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;HighestPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;LowestPrice&#34;</span>: <span style=color:#e6db74>&#34;47.85&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;ClosingPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Change&#34;</span>: <span style=color:#e6db74>&#34;-0.05&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Time&#34;</span>: <span style=color:#e6db74>&#34;2021-09-01T00:00:00+08:00&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }]
</span></span><span style=display:flex><span>        }]
</span></span><span style=display:flex><span>    }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>顧名思義, Treemap就是一個樹狀的結構而來的, 因此需要的資料結構就需要有個階層, 這邊設計成 &ldquo;台股板塊->市場別->分類->個股&rdquo;</p><h2 id=d3js--react-js>D3.js + React JS</h2><p>因為我用Next.js, 就想要把這個treemap包裝在一個react component</p><p>使用D3.js要先引入這幾個packages (我用typescript開發):</p><ul><li>@types/d3</li><li>@types/d3-hierarchy</li><li>d3</li><li>d3-hierarchy</li></ul><p><code>d3-hierarchy</code>是用來畫treemap的, 只用d3基本功能是不需要含進來的</p><p>先給這個Treemap的component一個殼:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Treemap</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>width</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>height</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>date</span>:<span style=color:#66d9ef>Date</span> }) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svgRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dataFile</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getFullYear</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> 
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> (<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getMonth</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) 
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getDate</span>().<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.json&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>renderTreemap</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>select</span>(<span style=color:#a6e22e>svgRef</span>.<span style=color:#a6e22e>current</span>).<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;font&#34;</span>, <span style=color:#e6db74>&#34;10px sans-serif&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>width</span>).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;*&#34;</span>).<span style=color:#a6e22e>remove</span>();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stockData</span>:<span style=color:#66d9ef>StockData</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>stockData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>dataFile</span>) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>StockData</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;text&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#34;本日無資料, 請按左上角按鈕選取時間&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;x&#34;</span>, <span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#ae81ff>22</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;white&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>useEffect</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>renderTreemap</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>Box</span>&gt;
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>svg</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>svgRef</span>} /&gt;
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>Box</span>&gt;
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Treemap</span>
</span></span></code></pre></div><p>d3的用法跟jQuery類似, 因此這邊跟React包裝一起的方法也很簡單, 就是用<code>useRef</code>給它有個reference可以select, 這邊要畫圖, 所以就包到一個svg去, 實際render出來的也是svg</p><p>抓取資料可以用<code>d3.json(dataFile)</code>, 其實也有<code>d3.csv</code>, 有點類似用<code>fetch</code></p><p>Treemap的實做就稍微有點複雜了, 可以參考這邊 &ldquo;<a href=https://observablehq.com/@d3/nested-treemap>Nested Treemap</a>&rdquo;, 這篇也不錯: &ldquo;<a href=http://blog.infographics.tw/2015/10/d3js-tutorial-treemap-and-budget/>D3.js 實戰 － 利用 Treemap Layout 將政府預算視覺化</a>&rdquo;, 這邊我使用了交易量跟交易總額去做面積跟排序</p><h2 id=加上tooltip>加上Tooltip</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>data</span>(<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>leaves</span>())
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>enter</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;y&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>h</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>;
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;black&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;fill&#34;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>ccolor</span>(<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>data</span>))
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseover&#39;</span>, (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>)<span style=color:#f92672>=&gt;</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mouseOver</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>);
</span></span><span style=display:flex><span>    }).<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseleave&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tooltip</span>().<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;opacity&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>透過<code>on('mouseover')</code>和<code>on('mouseleave')</code>就可以來加上tooltip的效果</p><h2 id=發佈到github-pages>發佈到Github pages</h2><p>next.js由於ssg, ssr的關係, 需要跑個server, 但其實也有機會發布成全靜態網頁(只要沒需要有在server跑的部分), 步驟如下:</p><ul><li>next build</li><li>next export</li></ul><p>結果就會在<code>out/</code>目錄, 拿這個目錄的內容放github pages就可以了</p><p>最後附上寫這東西時來搗亂的傢伙</p><p><img src=/images/posts/2021-09-17-13-43-04.png alt></p><footer class=entry-meta><span class=entry-tags></span><div class=social-share><ul class="socialcount socialcount-small inline-list"><li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jln.co%2f%25E7%2594%25A8D3js%25E5%25BB%25BA%25E7%25AB%258B%25E5%258F%25B0%25E8%2582%25A1%25E6%259D%25BF%25E5%25A1%258A%25E5%259C%2596%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i> Like</span></a></li><li class=twitter><a href="https://twitter.com/intent/tweet?text=https%3a%2f%2fblog.jln.co%2f%25E7%2594%25A8D3js%25E5%25BB%25BA%25E7%25AB%258B%25E5%258F%25B0%25E8%2582%25A1%25E6%259D%25BF%25E5%25A1%258A%25E5%259C%2596%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i> Tweet</span></a></li><li class=line><a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2fblog.jln.co%2f%25E7%2594%25A8D3js%25E5%25BB%25BA%25E7%25AB%258B%25E5%258F%25B0%25E8%2582%25A1%25E6%259D%25BF%25E5%25A1%258A%25E5%259C%2596%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li></ul></div></footer></div><section id=disqus_thread><div class=fb-comments data-href=https://blog.jln.co/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/ data-numposts=5 data-width></div></section></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>