<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>[Android] Firebase + WebRTC on Android &#8211; Le murmure de Julian</title>
<meta name="description" content="朱隸安貓囈語錄">
<meta name="keywords" content="Firebase, Android, mobiledev, WebRTC, websocket, autobahn">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.jln.co/images/posts/webrtc.png">
<meta name="twitter:title" content="[Android] Firebase + WebRTC on Android">
<meta name="twitter:description" content="朱隸安貓囈語錄">
<meta name="twitter:creator" content="@jlnshen">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="[Android] Firebase + WebRTC on Android">
<meta property="og:description" content="朱隸安貓囈語錄">
<meta property="og:url" content="http://blog.jln.co/android-firebase-+-webrtc-on-android/">
<meta property="og:site_name" content="Le murmure de Julian">
<meta name="og:image" content="http://blog.jln.co/images/posts/webrtc.png">
<meta name="google-site-verification" content="Fwa4TQMXvroZpNT7rrwHzdf-rWBe1RDuTu75Enx_DWA">



<link rel="canonical" href="http://blog.jln.co/android-firebase-+-webrtc-on-android/">
<link href="http://blog.jln.co/feed.xml" type="application/atom+xml" rel="alternate" title="Le murmure de Julian Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://blog.jln.co/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://blog.jln.co/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://blog.jln.co/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.jln.co/images/apple-touch-icon-144x144-precomposed.png">



  
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1789797875470932",
        enable_page_level_ads: true
    });
    </script>
  

</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://blog.jln.co/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://blog.jln.co/images/avatar.png" alt="Julian Shen photo" class="author-photo">
					<h4>Julian Shen</h4>
					<p>software deverloper</p>
				</li>
				<li>
					<a href="mailto:julianshen22@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/jlnshen"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/julianshen"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				<li>
					<a href="https://linkedin.com/in/julianshen"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/julianshen"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="https://instagram.com/julianshen"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				<li>
					<a href="https://www.flickr.com/photos/julianshen"><i class="fa fa-fw fa-flickr"></i> Flickr</a>
				</li>
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://blog.jln.co/posts/">All Posts</a></li>
				<li><a href="http://blog.jln.co/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="http://blog.jln.co/android-firebase-+-webrtc-on-android/" rel="bookmark" title="[Android] Firebase + WebRTC on Android">[Android] Firebase + WebRTC on Android</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2016-11-29T17:39:41+08:00">November 29, 2016</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~3 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p><a href="https://webrtc.org/">WebRTC</a>是一個支援瀏覽器的即時影音對話的架構, 算是一個業界標(W3C,IETF), 最近由於想做一個有影音通話的應用, 就研究了一下這東西</p>

<p>如果只是想嘗試一下<a href="https://webrtc.org/">WebRTC</a>, 是可以直接是可以直接試<a href="https://appr.tc/">AppRTC</a>這個Google的範例, 不過這個是Web的版本, 我想要做的是
手機的版本(Android, iOS), <a href="https://appr.tc/">AppRTC</a>其實也有Android的版本可搭配</p>

<p>為了熟悉一下整個用WebRTC建立video call的流程, 因此我就決定改一下這個Android版本, 原本Google的版本是透過Web Socket</p>

<p>至於流程與架構我會建議看這影片:</p>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/HS1eKPL4f1o" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>如果不想看太長, 就看這個:</p>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/nDPlGcoArdM" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>把Web RTC那段換成Firebase(好, 其實我蠻後悔選Firebase來實作的)其實就是把Signaling這段給換掉, 而這段流程是(節錄自影片):</p>

<p><img src="/images/posts/webrtc.png" alt="" /></p>

<p>這部分其實就是交換兩邊的SDP和ICE candidate的過程, 詳細可以參考<a href="http://blog.mozilla.com.tw/posts/3261/webrtc-%E7%9B%B8%E9%97%9C%E7%B8%AE%E5%AF%AB%E5%90%8D%E8%A9%9E%E7%B0%A1%E4%BB%8B">這邊:WebRTC 相關縮寫名詞簡介</a></p>

<p>結果的source code放在<a href="https://github.com/julianshen/apprtc-android-demo">這邊 : apprtc-android-demo</a></p>

<h3 id="building-webrtc-lib-on-android">Building WebRTC lib on Android</h3>

<p>其實現在寫WebRTC的應用的話, 也不用從頭實作, Google老早就把它實作在<a href="http://chromium.org">Chromium</a>裡面了, 也可以單獨build出library用</p>

<p>這邊有官方的<a href="https://webrtc.org/native-code/android/">如何建置出Android版本的Web RTC library</a>, 不過, 不要照著這份文件做呀, 不然頭髮會白好幾根, 可能還build不太起來,
找了一堆網路上人家的建議也都是不要直接build, 直接用人家build好現成的, 不過, 現成的雖然有一些, 但大多是過時的, API跟現今的也不太一樣, 如果
要套用到現在的Android版本AppRTC的source code內, 大多都沒辦法用</p>

<p>所幸找到這個<a href="https://github.com/pristineio/webrtc-build-scripts/tree/master/android">build script: pristineio/webrtc-build-scripts</a>,
這個從下載最新的source code到build出library一律包辦, 用法也很簡單, 只要執行下面的:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">source </span>android/build.sh
install_dependencies
get_webrtc
build_apprtc
</code></pre>
</div>

<p>簡單明暸, 但…有幾個問題, 第一個是只能在Linux下build, 因此在Mac跟Windows下要透過<a href="https://www.vagrantup.com/">Vagrant</a>這類的工具,
而且對硬體需求也很高, 我的2012年中版的Macbook Pro retina實在是跑不動, 後來跑去Digital Ocean租了台VM來build, 本以為最便宜的可以勝任,
後來發現, 至少要4G RAM, 硬碟要20G以上的instance(哭哭, 浪費好多時間)</p>

<p>build出來後, 所需要的東西包含了libjingle_peerconnection.jar和libjingle_peerconnection_so.so, 把這幾個備份起來就是了, 待會build apk需要用</p>

<h3 id="apprtc-android-source-codes">AppRTC 範例的Android source codes</h3>

<p>Android的範例的source codes<a href="https://chromium.googlesource.com/external/webrtc/+/master/webrtc/examples/androidapp/">可以在這邊下載</a></p>

<p>不過這並不是Android studio的project格式, 因此需要用匯入的方式, 或是可以直接fork<a href="https://github.com/julianshen/apprtc-android-demo">我的版本</a>去改,
由於原本的版本使用了Web socket做singaling的管道, 因此需要<a href="http://autobahn.ws/">Autobahn</a>,	但你切記絕對不能用<a href="http://autobahn.ws/">Autobahn</a>官方最新的jar檔,
而是要用Google放在third_party裡面那個autobanh.jar(啊, 我到現在才發現名字有些許不同), 這邊的差異是, 原本<a href="http://autobahn.ws/">Autobahn</a>是沒有支援SSL的websocket的,
但AppRTC的websocket則是要透過SSL來連接</p>

<p>把jar跟so檔放到對應的目錄去後, 記得改一下app目錄下的build.gradle加入 (因為import產生的不會幫你加):</p>

<div class="language-gradle highlighter-rouge"><pre class="highlight"><code><span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="nf">fileTree</span><span class="o">(</span><span class="nl">dir:</span> <span class="s1">'libs'</span><span class="o">,</span> <span class="nl">include:</span> <span class="o">[</span><span class="s1">'*.jar'</span><span class="o">])</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="firebase">加上firebase</h3>

<p>除了原本的Webcoket和Direct connect兩種方式外, 為了跑一次他的流程我多加了Firebase的部分, 利用它的realtime database來做Signaling這部分,
至於怎樣開始開發firebase, 就參考一下他的<a href="https://firebase.google.com/docs/database/android/start/">官方文件</a>吧</p>

<h3 id="signaling">Signaling的實作</h3>

<h4 id="callactivity">CallActivity</h4>

<p>選擇哪種signaling的方式是在CallActivity裡面依據roomId來看使用哪一個signaling client, 程式碼如下:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Create connection client. Use DirectRTCClient if room name is an IP otherwise use the</span>
    <span class="c1">// standard WebSocketRTCClient.</span>
    <span class="k">if</span><span class="o">(</span><span class="s">"firebase"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">roomId</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"firebase"</span><span class="o">);</span>
      <span class="n">appRtcClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FirebaseRTCClient</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">loopback</span> <span class="o">||</span> <span class="o">!</span><span class="n">DirectRTCClient</span><span class="o">.</span><span class="na">IP_PATTERN</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">roomId</span><span class="o">).</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">appRtcClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocketRTCClient</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Using DirectRTCClient because room name looks like an IP."</span><span class="o">);</span>
      <span class="n">appRtcClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DirectRTCClient</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>原本有WebSocketRTCClient和DirectRTCClient, 如果是IP的話就用DirectRTCClient,這邊我多加一個FirebaseRTCClient, 只要roomId是firebase就會使用這個(我偷懶)</p>

<h4 id="firebasertcclient">FirebaseRTCClient</h4>

<p>XXXRTCClient這部分實作了signaling的部分, 因此我參考了WebSocketRTCClient和DirectRTCClient的內容來寫FirebaseRTCClient</p>

<p>跟WebSocketRTCClinet一樣, 它必須實作AppRTCClient, AppRTCClient這個Interface定義如下:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * AppRTCClient is the interface representing an AppRTC client.
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AppRTCClient</span> <span class="o">{</span>
  <span class="cm">/**
   * Struct holding the connection parameters of an AppRTC room.
   */</span>
  <span class="kd">class</span> <span class="nc">RoomConnectionParameters</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">roomUrl</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">roomId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">loopback</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">RoomConnectionParameters</span><span class="o">(</span><span class="n">String</span> <span class="n">roomUrl</span><span class="o">,</span> <span class="n">String</span> <span class="n">roomId</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">loopback</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">roomUrl</span> <span class="o">=</span> <span class="n">roomUrl</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">roomId</span> <span class="o">=</span> <span class="n">roomId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">loopback</span> <span class="o">=</span> <span class="n">loopback</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Asynchronously connect to an AppRTC room URL using supplied connection
   * parameters. Once connection is established onConnectedToRoom()
   * callback with room parameters is invoked.
   */</span>
  <span class="kt">void</span> <span class="nf">connectToRoom</span><span class="o">(</span><span class="n">RoomConnectionParameters</span> <span class="n">connectionParameters</span><span class="o">);</span>

  <span class="cm">/**
   * Send offer SDP to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendOfferSdp</span><span class="o">(</span><span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">sdp</span><span class="o">);</span>

  <span class="cm">/**
   * Send answer SDP to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendAnswerSdp</span><span class="o">(</span><span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">sdp</span><span class="o">);</span>

  <span class="cm">/**
   * Send Ice candidate to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendLocalIceCandidate</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span> <span class="n">candidate</span><span class="o">);</span>

  <span class="cm">/**
   * Send removed ICE candidates to the other participant.
   */</span>
  <span class="kt">void</span> <span class="nf">sendLocalIceCandidateRemovals</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span><span class="o">[]</span> <span class="n">candidates</span><span class="o">);</span>

  <span class="cm">/**
   * Disconnect from room.
   */</span>
  <span class="kt">void</span> <span class="nf">disconnectFromRoom</span><span class="o">();</span>

  <span class="cm">/**
   * Struct holding the signaling parameters of an AppRTC room.
   */</span>
  <span class="kd">class</span> <span class="nc">SignalingParameters</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="n">iceServers</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">initiator</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">clientId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">wssUrl</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">wssPostUrl</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">offerSdp</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IceCandidate</span><span class="o">&gt;</span> <span class="n">iceCandidates</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SignalingParameters</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="n">iceServers</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">initiator</span><span class="o">,</span>
        <span class="n">String</span> <span class="n">clientId</span><span class="o">,</span> <span class="n">String</span> <span class="n">wssUrl</span><span class="o">,</span> <span class="n">String</span> <span class="n">wssPostUrl</span><span class="o">,</span> <span class="n">SessionDescription</span> <span class="n">offerSdp</span><span class="o">,</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">IceCandidate</span><span class="o">&gt;</span> <span class="n">iceCandidates</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">iceServers</span> <span class="o">=</span> <span class="n">iceServers</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">initiator</span> <span class="o">=</span> <span class="n">initiator</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">clientId</span> <span class="o">=</span> <span class="n">clientId</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">wssUrl</span> <span class="o">=</span> <span class="n">wssUrl</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">wssPostUrl</span> <span class="o">=</span> <span class="n">wssPostUrl</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">offerSdp</span> <span class="o">=</span> <span class="n">offerSdp</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">iceCandidates</span> <span class="o">=</span> <span class="n">iceCandidates</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Callback interface for messages delivered on signaling channel.
   *
   * &lt;p&gt;Methods are guaranteed to be invoked on the UI thread of |activity|.
   */</span>
  <span class="kd">interface</span> <span class="nc">SignalingEvents</span> <span class="o">{</span>
    <span class="cm">/**
     * Callback fired once the room's signaling parameters
     * SignalingParameters are extracted.
     */</span>
    <span class="kt">void</span> <span class="nf">onConnectedToRoom</span><span class="o">(</span><span class="kd">final</span> <span class="n">SignalingParameters</span> <span class="n">params</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once remote SDP is received.
     */</span>
    <span class="kt">void</span> <span class="nf">onRemoteDescription</span><span class="o">(</span><span class="kd">final</span> <span class="n">SessionDescription</span> <span class="n">sdp</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once remote Ice candidate is received.
     */</span>
    <span class="kt">void</span> <span class="nf">onRemoteIceCandidate</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span> <span class="n">candidate</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once remote Ice candidate removals are received.
     */</span>
    <span class="kt">void</span> <span class="nf">onRemoteIceCandidatesRemoved</span><span class="o">(</span><span class="kd">final</span> <span class="n">IceCandidate</span><span class="o">[]</span> <span class="n">candidates</span><span class="o">);</span>

    <span class="cm">/**
     * Callback fired once channel is closed.
     */</span>
    <span class="kt">void</span> <span class="nf">onChannelClose</span><span class="o">();</span>

    <span class="cm">/**
     * Callback fired once channel error happened.
     */</span>
    <span class="kt">void</span> <span class="nf">onChannelError</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">description</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>主要就是定義了如何處理connect, disconnect, 還有怎麼去註冊SDP和ICE candidate, 在確定好連接成功後, AppRTCClient要負責呼叫onConnectedToRoom來通知
CallActivity已經可以準備建立video call的後續流程, 且要負責處理如果Signal server(這邊是firebase)有傳來遠端的SDP跟ICE candidate, 要負責呼叫SignalingEvents對應的處理
(這邊一樣會叫到CallActivity, 而CallActivity則會使用PeerConnectionClient來處理需要傳遞給PeerConnection相關的參數)</p>

<p>這邊用Firebase處理Signaling的方式是監聽某一個key的改變, 有新的裝置連接, 註冊SDP, ICE Candidate, 就寫到這下面去, 這其實不是一個很好的方式,
因為這下面只要有值的改變, 就會觸發, 不像是WebSocket那個版本是一來一往的API calls, 而且你不知道每次觸發被更動的是哪一部分, 一開始發生了好幾次PeerConnection重複註冊SDP才讓我發現因為這原因被重複呼叫的問題</p>

<h3 id="turn-server">TURN server</h3>

<p>WebRTC是P2P的, 因此如果不具備穿牆能力的話, 在牆外就會被擋掉, 一開始我本來想說試驗P2P而不走TURN Server穿牆的(因為我一時也懶得架一台), 結果測試時老是連不上, 後來才發現我阿呆,
我的測試環境是一台實體手機, 另一台是電腦上跑模擬器, 本以為兩個(手機, 電腦)是同一個區網沒問題, 後來才想到模擬器是在另一個虛擬網路, 因此還是有需要TURN server</p>

<p>如果不想架一台, 要怎辦? 用Google免錢的, 他們做了這個demo, 一定有! 因此就偷看了一下WebRTCClient的code跟傳輸內容,發現它跟https://networktraversal.googleapis.com/v1alpha/iceconfig?key=AIzaSyAJdh2HkajseEIltlZ3SIXO02Tze9sO3NY
去要TURN server list, 所以基本上只要照copy下面這段就好:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>   <span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="nf">requestTurnServers</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">JSONException</span> <span class="o">{</span>
        <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;</span> <span class="n">turnServers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">&gt;();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Request TURN from: "</span> <span class="o">+</span> <span class="n">url</span><span class="o">);</span>
        <span class="n">HttpURLConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">openConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s">"REFERER"</span><span class="o">,</span> <span class="s">"https://appr.tc"</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="n">TURN_HTTP_TIMEOUT_MS</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="n">TURN_HTTP_TIMEOUT_MS</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">responseCode</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">responseCode</span> <span class="o">!=</span> <span class="mi">200</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Non-200 response when requesting TURN server from "</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s">" : "</span>
                    <span class="o">+</span> <span class="n">connection</span><span class="o">.</span><span class="na">getHeaderField</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">InputStream</span> <span class="n">responseStream</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">drainStream</span><span class="o">(</span><span class="n">responseStream</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"TURN response: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">);</span>
        <span class="n">JSONObject</span> <span class="n">responseJSON</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="n">JSONArray</span> <span class="n">iceServers</span> <span class="o">=</span> <span class="n">responseJSON</span><span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"iceServers"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iceServers</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">JSONObject</span> <span class="n">server</span> <span class="o">=</span> <span class="n">iceServers</span><span class="o">.</span><span class="na">getJSONObject</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">JSONArray</span> <span class="n">turnUrls</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"urls"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="o">?</span> <span class="n">server</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">credential</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"credential"</span><span class="o">)</span> <span class="o">?</span> <span class="n">server</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"credential"</span><span class="o">)</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">turnUrls</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">turnUrl</span> <span class="o">=</span> <span class="n">turnUrls</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="n">turnServers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PeerConnection</span><span class="o">.</span><span class="na">IceServer</span><span class="o">(</span><span class="n">turnUrl</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="n">credential</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">turnServers</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Return the contents of an InputStream as a String.</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">drainStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">"\\A"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>把這邊拿來的list當ICE candidate, 就可以成功透過Google的TURN server去穿牆了(長久之計還是自己架一台吧)</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://blog.jln.co/tags/#Firebase" title="Pages tagged Firebase" class="tag"><span class="term">Firebase</span></a><a href="http://blog.jln.co/tags/#Android" title="Pages tagged Android" class="tag"><span class="term">Android</span></a><a href="http://blog.jln.co/tags/#mobiledev" title="Pages tagged mobiledev" class="tag"><span class="term">mobiledev</span></a><a href="http://blog.jln.co/tags/#WebRTC" title="Pages tagged WebRTC" class="tag"><span class="term">WebRTC</span></a><a href="http://blog.jln.co/tags/#websocket" title="Pages tagged websocket" class="tag"><span class="term">websocket</span></a><a href="http://blog.jln.co/tags/#autobahn" title="Pages tagged autobahn" class="tag"><span class="term">autobahn</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.jln.co/android-firebase-+-webrtc-on-android/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://blog.jln.co/android-firebase-+-webrtc-on-android/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://blog.jln.co/android-firebase-+-webrtc-on-android/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://blog.jln.co/rate-limit-with-go-and-gin/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://blog.jln.co/rss-for-ptt/" title="RSS for Ptt">RSS for Ptt</a></h3>
      <p>最近才發現, ptt的rss功能好像拿掉了, 這樣好像就不能拿feedly之類的來訂閱版面內容, 反正我自己有寫了一個[gopttcrawler](https://github.com/julianshen/gopttcrawler)所幸自己來寫一個吧!source cod...&hellip; <a href="http://blog.jln.co/rss-for-ptt/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://blog.jln.co/swift-%E6%BC%AB%E7%95%AB%E7%88%AC%E8%9F%B2/" title="[Swift] 漫畫爬蟲">[Swift] 漫畫爬蟲</a></h4>
        <span>Published on February 07, 2017</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://blog.jln.co/go-bleve-%E8%87%AA%E5%B8%B6%E5%85%A8%E6%96%87%E6%90%9C%E5%B0%8B/" title="[Go] Bleve - 自帶全文搜尋">[Go] Bleve - 自帶全文搜尋</a></h4>
        <span>Published on February 07, 2017</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Julian Shen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://blog.jln.co/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://blog.jln.co/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79243751-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'julianshen'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
