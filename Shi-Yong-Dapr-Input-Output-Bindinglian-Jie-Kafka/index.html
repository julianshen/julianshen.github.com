<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>使用Dapr Input/Output Binding連接Kafka &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="使用Dapr Input/Output Binding連接Kafka"><meta property="og:description" content="在Dapr元件有一種叫做Binding的元件(component)讓你的app跟外部系統做一個連結的, 這元件可分為兩類: Input BIndings: 用來接受外部事件"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.jln.co/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/"><meta property="og:image" content="https://og.jln.co/jlns1/5L2_55SoRGFwciBJbnB1dO-8j091dHB1dCBCaW5kaW5n6YCj5o6lS2Fma2E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-11-13T13:11:27+08:00"><meta property="article:modified_time" content="2022-11-13T13:11:27+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://og.jln.co/jlns1/5L2_55SoRGFwciBJbnB1dO-8j091dHB1dCBCaW5kaW5n6YCj5o6lS2Fma2E"><meta name=twitter:title content="使用Dapr Input/Output Binding連接Kafka"><meta name=twitter:description content="在Dapr元件有一種叫做Binding的元件(component)讓你的app跟外部系統做一個連結的, 這元件可分為兩類: Input BIndings: 用來接受外部事件"><link rel=canonical href=https://blog.jln.co/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.105.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div id=main role=main><article class=hentry><header class=header-title><div class=header-title-wrap><h1 class=entry-title><a href=/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/ rel=bookmark title="使用Dapr Input/Output Binding連接Kafka">使用Dapr Input/Output Binding連接Kafka</a></h1><h2><span class="entry-date date published"><time datetime="2022-11-13 13:11:27 +0800 +0800">November 13, 2022</time></span></h2><p class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</p></div></header><div class=entry-content><p>在Dapr元件有一種叫做Binding的元件(component)讓你的app跟外部系統做一個連結的, 這元件可分為兩類:</p><ol><li>Input BIndings: 用來接受外部事件的觸發,像是Webhook, 從Queue來的events, 甚至是人家新發的Tweets, 應該都可以歸為這一類</li><li>Ouput Bindings: 呼叫外部系統的動作,命名為Outpiut其實會讓人誤以為是資料的輸出,但其實,他不只可以用在資料輸出,呼叫外部系統的動作都可以包含在內, 舉個例子, <a href=https://github.com/dapr/components-contrib/tree/master/bindings/graphql>GraphQL 的Output binding</a>定義了兩個操作(Operations), 一個是QueryOperation, 一個是MutationOperation, 熟悉GraphQL的應該知道,MutationOperation一般才是應用在資料操作,而Query感覺就跟輸出比較無關了</li></ol><p>一開始我也有點搞不清楚這個模式目的在做啥的, 要接受事件觸發,我們有pub sub了,而state store本身就用在資料輸出, 感覺的確有點重複,但由上述兩點來看,其實Binding定義的範圍廣泛多了,它並不特定限制在Queue或是資料庫</p><p>但有個東西同時支援了Pub sub, input binding, output binding, 一開始我是看Kafka這應用,才讓我覺得有點錯亂,<a href=dapr-raw-payload-pub-sub>前一篇</a>有講過了怎實作Subscriber, 這邊來比較一下, 利用Input binding的話,會有什麼不一樣?</p><h3 id=建立binding元件>建立Binding元件</h3><p><img src alt=post/images/55875EA9-6C5C-48BB-8289-FF95B5CB5409.jpeg></p><p>要用Kafka來觸發我們服務(如上圖),跟寫Subscriber一樣,我們需要在<code>~/.dapr/components</code>裡先建立好元件, 假設我們新增一個<code>kafka-binding.yaml</code>, 內容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>dapr.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Component</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-binding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bindings.kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>brokers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>localhost:9092</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>topics</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>mytopic</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumerGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>group1</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>publishTopic</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>mytopic</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authRequired</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;false&#34;</span>
</span></span></code></pre></div><p>上面這個其實已經是定義好input和output binding了,topics定義的是input binding要聽取事件的topic, 而publishTopic定義的則是Output binding要輸出資料的目標</p><h3 id=實作input-binding>實作Input binding</h3><p>跟實做subscriber差不多, Input binding也是實作一個webhook讓Dapr打進來而已, 這邊假設Kafka會收到的資料會是一個數字</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dataBinding</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>data</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Status</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>POST</span>(<span style=color:#e6db74>&#34;/kafka-binding&#34;</span>, <span style=color:#a6e22e>dataBinding</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>OPTIONS</span>(<span style=color:#e6db74>&#34;/kafka-binding&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Status</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:6003&#34;</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊幾個重點:</p><ol><li>endpoint path跟你的binding名稱一樣, 當然這可以在元件設定那邊改</li><li>OPTIONS有點像是讓Dapr確認你有沒支援這個binding的health endpoint, 在程式一開始跑就會被call, 這邊只要回OK, 其實都好</li><li>跟pub sub不一樣的是, 這邊會收到的格式不一定會是cloudevent, 除非publisher那邊過來的就是cloudevent, 因此, tracing應該是追蹤不到才是</li></ol><h3 id=實做output-binding>實做Output binding</h3><p>那如何實作跟剛剛的Input binding匹配的Output binding呢? 範例如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dapr</span> <span style=color:#e6db74>&#34;github.com/dapr/go-sdk/client&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BINDING_NAME</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;kafka-binding&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BINDING_OPERATION</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;create&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>5000</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Seed</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixMicro</span>())
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dataId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>1000</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>NewClient</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>InvokeBindingRequest</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>BINDING_NAME</span>, <span style=color:#a6e22e>Operation</span>: <span style=color:#a6e22e>BINDING_OPERATION</span>, <span style=color:#a6e22e>Data</span>: []byte(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InvokeOutputBinding</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sending message: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊重點在於:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>InvokeBindingRequest</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>BINDING_NAME</span>, <span style=color:#a6e22e>Operation</span>: <span style=color:#a6e22e>BINDING_OPERATION</span>, <span style=color:#a6e22e>Data</span>: []byte(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InvokeOutputBinding</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span></code></pre></div><p>雖說是"Output" binding, 但這邊用的名字是"Invoke", 跟Output沒啥相關, Operation則是元件訂的, Kafka binding只定義一個"create", 就是讓你送訊息用的, Data則是要傳送的資料, 以Byte array表示</p><h3 id=用subscriber接收output-binding來的事件>用subscriber接收output binding來的事件</h3><p>這邊就不用多作解釋了, 從前面不難發現, 它接的就是raw payload, 這部分可以參考 <a href=dapr-raw-payload-pub-sub>前一篇</a></p><p>那啥時該用哪一種呢? 以Kafka這範例來說, 我是認為如果publisher跟subscriber都是自己實做的話, 應該是要選用pub sub, 用cloud events的話, 可以享受到distributed tracing帶來的好處, 如果不是, 差異應該不大, 都蠻簡單實作的</p><footer class=entry-meta><span class=entry-tags></span><div class=social-share><ul class="socialcount socialcount-small inline-list"><li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jln.co%2fShi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i> Like</span></a></li><li class=twitter><a href="https://twitter.com/intent/tweet?text=https%3a%2f%2fblog.jln.co%2fShi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i> Tweet</span></a></li><li class=line><a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2fblog.jln.co%2fShi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li></ul></div></footer></div><section id=disqus_thread><div class=fb-comments data-href=https://blog.jln.co/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/ data-numposts=5 data-width></div></section></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>