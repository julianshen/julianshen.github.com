<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>優化 Open Graph Image &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="優化 Open Graph Image"><meta property="og:description" content="在之前一篇寫用Hugo打造blog有提到, 寫了一個小工具來產生open graph image, 但由於這個是一個command line工具, 而我又是把它放在 git pre-commit 去"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.jln.co/%E5%84%AA%E5%8C%96-Open-Graph-Image/"><meta property="og:image" content="https://og.jln.co/jlns1/5YSq5YyWIE9wZW4gR3JhcGggSW1hZ2U"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-08-09T20:24:52+08:00"><meta property="article:modified_time" content="2021-08-09T20:24:52+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://og.jln.co/jlns1/5YSq5YyWIE9wZW4gR3JhcGggSW1hZ2U"><meta name=twitter:title content="優化 Open Graph Image"><meta name=twitter:description content="在之前一篇寫用Hugo打造blog有提到, 寫了一個小工具來產生open graph image, 但由於這個是一個command line工具, 而我又是把它放在 git pre-commit 去"><link rel=canonical href=https://blog.jln.co/%E5%84%AA%E5%8C%96-Open-Graph-Image/><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.115.1"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div id=main role=main><article class=hentry><header class=header-title><div class=header-title-wrap><h1 class=entry-title><a href=/%E5%84%AA%E5%8C%96-Open-Graph-Image/ rel=bookmark title="優化 Open Graph Image">優化 Open Graph Image</a></h1><h2><span class="entry-date date published"><time datetime="2021-08-09 20:24:52 +0800 +0800">August 9, 2021</time></span></h2><p class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~7 minutes</p></div></header><div class=entry-content><p>在<a href=http://blog.jln.co/%E7%94%A8Hugo-GitHub-Actions%E6%89%93%E9%80%A0Blog/>之前一篇</a>寫用Hugo打造blog有提到, 寫了一個<a href=https://github.com/julianshen/myblog_hugo/tree/master/ogp>小工具來產生open graph image</a>, 但由於這個是一個command line工具, 而我又是把它放在 git pre-commit 去觸發並寫回檔案, 感覺不是那麼乾淨, 因此我又有另一個想法想把它寫成一個服務, 順便又思考了一下, 怎樣的圖片比較適合OG(Open Graph)</p><h2 id=為什麼要設定-open-graph-image>為什麼要設定 Open Graph Image</h2><p>這邊並沒有要探討<a href=https://ogp.me/>Open Graph</a>是什麼, 怎麼去使用, 這應該可以找到其他相關的文章或是參考官網 <a href=https://ope.me/>https://ope.me/</a></p><p>目前OG會影響到的, 大概就是被分享到社群的文章/網頁, Facebook跟Twitter都支援OG來產生分享到Timeline上的預覽, Twitter則是另外支援它自己的<a href=https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/abouts-cards>Twitter Card</a>, 而這其中 og:image 會影響到分享後的版面</p><p>首先, 這邊先介紹一下工具, 如果要先預覽Facebook分享出去的結果可以使用Facebook提供的 <a href=https://developers.facebook.com/tools/debug/>分享偵錯工具</a>, Twitter部分則可使用<a href=https://cards-dev.twitter.com/validator>Card validator</a></p><p>先來看看沒設定og:image的版面是怎樣一個狀況?</p><p><img src=/images/posts/og/og_sample_no_image.jpg alt="OG No Image"></p><p><img src=/images/posts/og/tc_sample_no_image.jpg alt="Twitter card No Image"></p><p>前面一個是分享到Facebook上的版面, 後一個則是在Twitter上會看到的, 很明顯的版面偏小, 不起眼, 分享出去後應該也引不起使用者點擊的慾望</p><p>這邊Twitter跟Facebook不太一樣的地方是, Facebook決定大小版面是以og:image的大小來決定的, 大版面的圖片需要有1200x630的解析度, 但對Twitter來說, 你如果設定Twitter card的型別是 <strong>&ldquo;summary_large_image&rdquo;</strong> , 那就會選擇使用大版面來顯示, 因此如果圖不是很大的話, 會像下個範例:</p><p><img src=/images/posts/og/og_sample_small.jpg alt="OG Small"></p><p><img src=/images/posts/og/tc_sample_small.jpg alt="Twitter card small Image"></p><p>這邊Twitter card使用的是 <strong>&ldquo;summary_large_image&rdquo;</strong> , 因此可以看到結果(第二張), 版面是較大的版面, 但圖片的部分就糊的有點慘了, 而且, 重點被截到了, Facebook圖雖沒那麼糊, 但版面依然很小</p><p>現在應該很多網站都有注意使用了大圖來做為og:image了, 效果就像是這樣:</p><p><img src=/images/posts/og/og_sample_big_prod.jpg alt="OG Big"></p><p>這樣版面是大得很明顯了, 但似乎有點問題, 這邊用的是LOGO, 但它賣的是"【JOYOUNG 九陽】LINE FRIENDS系列真空悶燒罐 熊大", 沒商品圖片, 我不知道大家是怎看, 至少, 不吸引我</p><p>再來看另一個例子:</p><p><img src=/images/posts/og/og_sample_pchome.jpg alt="OG PCHOME"></p><p>看的到商品, 但部分字被遮住了, 而且"限時優惠"這個是有時效性的, 被分享出去的圖片是不會被改變的</p><p>那我自己之前的blog文章呢? 我最早設定的邏輯是這樣的, 如果文章內有圖, 就挑第一張圖, 把它放大到1200x630的規格, 如果沒有圖, 就拿標題做一張圖(前面提到的<a href=https://github.com/julianshen/myblog_hugo/tree/master/ogp>小工具</a>)</p><p><img src=/images/posts/og/og_sample_blog_1.jpg alt="OG Blog"></p><p><img src=/images/posts/og/og_sample_blog_2.jpg alt="OG Blog"></p><p><img src=/images/posts/og/og_sample_blog_3.jpg alt="OG Blog"></p><p><img src=/images/posts/og/og_sample_blog_4.jpg alt="OG Blog"></p><p>我的文章大多偏技術面的文章, 這裡面有些是用到了流程圖, 看起來沒啥太大問題, 有些就沒那麼優了, 再來看看文章內沒有圖的狀況</p><p><img src=/images/posts/og/og_sample_blog_5.jpg alt="OG Blog"></p><p>自從用了這版本後, 覺得好像這樣會比較清楚一點, 與其去選一張跟內容沒那麼相關, 品質又沒保證的, 還不如使用標題來的直觀一點</p><p>但之前的小工具, 需要綁在git pre-commit, 我換台電腦就又得設定一次, 也是有點不方便, 重新來寫一個版本, 跑在heroku上, 反正文章沒那麼多, Facebook又不會常常跑來抓, Free dyno就夠用了</p><p>下面就來把這版本：<a href=https://github.com/julianshen/betterog>Better OG</a> 幾個實作來做一個介紹, 原始碼都在Github上, 因為都是用現成的package來簡單達成的, 所以我沒想把code整理當成一個可以直接發行的版本, 單純當範例, 大家有用到的片段可以直接拿去使用</p><h2 id=純文字的og-image>純文字的OG Image</h2><p>想達成的效果就跟前面提到這張圖一樣</p><p><img src=/images/posts/og/og_sample_blog_5.jpg alt="OG Blog"></p><h3 id=使用text2imghttpsgithubcomjulianshentext2img>使用<a href=https://github.com/julianshen/text2img>text2img</a></h3><p>這一部分算最簡單的, 就是前面的文章有提到的<a href=https://github.com/julianshen/text2img>text2img</a>, 它的設計也就是為了產生og:image, 所以很簡單就可以應用在這邊了, 我是用我自己改過的版本:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>bog</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BetterOG</span>) <span style=color:#a6e22e>drawText</span>(<span style=color:#a6e22e>text</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawURLEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>text</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>text</span> = string(<span style=color:#a6e22e>decoded</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>img</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>img</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bog</span>.<span style=color:#a6e22e>drawer</span>.<span style=color:#a6e22e>Draw</span>(<span style=color:#a6e22e>text</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>jpeg</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>img</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>jpeg</span>.<span style=color:#a6e22e>Options</span>{<span style=color:#a6e22e>Quality</span>: <span style=color:#ae81ff>90</span>}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>因為我是要直接放在URL上, 像<code>https://og.jln.co/t/W-ethuiomF3liKnnlKhheGlvcy1tb2NrLWFkYXB0ZXLngrpheGlvc-aPkOS-m-a4rOippueUqOeahOWBh-izh-aWmQ</code>, 所以文字部分就用base64先編碼過(必須要用RawURLEncoding)</p><h3 id=unit-test>Unit test</h3><p>這邊為了測試畫出來的文字是不是正確, 所以就引入了<a href=https://github.com/otiai10/gosseract>gosseract</a>, gosseract是<a href=https://github.com/tesseract-ocr/tessdoc>tesseract-ocr</a>的go封裝, <a href=https://github.com/tesseract-ocr/tessdoc>tesseract-ocr</a>算是很老牌的OCR了, 辨識率還不錯, 不過老實說, 這邊只是想玩玩gosseract XD</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestDrawText</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewServer</span>(<span style=color:#e6db74>&#34;:8888&#34;</span>, <span style=color:#a6e22e>text2img</span>.<span style=color:#a6e22e>Params</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>FontPath</span>: <span style=color:#e6db74>&#34;../../fonts/SourceHanSansTC-VF.ttf&#34;</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gosseract</span>.<span style=color:#a6e22e>NewClient</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>drawText</span>(<span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>URLEncoding</span>.<span style=color:#a6e22e>EncodeToString</span>([]byte(<span style=color:#e6db74>&#34;For testing&#34;</span>)))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>SetImageFromBytes</span>(<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>Bytes</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Text</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#e6db74>&#34;For testing&#34;</span>, <span style=color:#a6e22e>text</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=使用網頁截圖來當og-image>使用網頁截圖來當OG Image</h2><p>這種類型應該比較常在ptt分享文章上看到, 像這樣</p><p><img src=/images/posts/og/og_sample_ptt.jpg alt="OG ptt"></p><p>這也是不錯的做法</p><h3 id=使用chromedphttpsgithubcomchromedpchromedp來擷取網頁畫面>使用<a href=https://github.com/chromedp/chromedp>chromedp</a>來擷取網頁畫面</h3><p><a href=https://github.com/chromedp/chromedp>chromedp</a>是透過chrome debug protocol 來操作Chrome的, 這邊就很適合從程式來操作截取網頁畫面, 只是擷取畫面, 還算蠻簡單的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Capture</span>(<span style=color:#a6e22e>encodedurl</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>decoded</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawURLEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>encodedurl</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>decoded</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;capture URL:%s\n&#34;</span>, <span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewExecAllocator</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NoSandbox</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewContext</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>			<span style=color:#75715e>// chromedp.WithDebugf(log.Printf),
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buf</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Tasks</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>EmulateViewport</span>(<span style=color:#ae81ff>1200</span>, <span style=color:#ae81ff>630</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#a6e22e>url</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>FullScreenshotInViewport</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>buf</span>, <span style=color:#ae81ff>90</span>),
</span></span><span style=display:flex><span>		}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊要擷取的URL一樣是透過base64編碼完放在url傳過來的, 因為我們要的圖大小是1200x630, 所以這邊的View port就設定成那個大小, 有一個比較要特別注意的是, 跟原本chromdp範例不同的地方是, 這邊要用<code>ctx, _ := chromedp.NewExecAllocator(context.Background(), chromedp.NoSandbox)</code> <strong>&ldquo;NoSandbox&rdquo;</strong> 的模式來初始chrome, 要不然無法在heroku下跑</p><p>這邊並不是使用<code>chrome.FullScreenshot</code>來擷取畫面, 取而代之的是用自己寫的<code>FullScreenshotInViewport</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FullScreenshotInViewport</span>(<span style=color:#a6e22e>res</span> <span style=color:#f92672>*</span>[]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>quality</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>EmulateAction</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#e6db74>&#34;res cannot be nil&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ActionFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>format</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>CaptureScreenshotFormatJpeg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// capture screenshot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>*</span><span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>CaptureScreenshot</span>().
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WithCaptureBeyondViewport</span>(<span style=color:#66d9ef>true</span>).
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WithFormat</span>(<span style=color:#a6e22e>format</span>).
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WithQuality</span>(int64(<span style=color:#a6e22e>quality</span>)).<span style=color:#a6e22e>WithClip</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Viewport</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>X</span>:      <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Y</span>:      <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Width</span>:  <span style=color:#ae81ff>1200</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Height</span>: <span style=color:#ae81ff>630</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Scale</span>:  <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>		}).<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其實這支是抄自<code>chrome.FullScreenshot</code>, 但不一樣的是<code>WithClip</code>這邊的寬高用的是1200x630, 這是因為原本<code>chrome.FullScreenshot</code>會抓整頁完整頁面, 要多長有多長, 結果寬度雖是1200, 但長度可能超長, 這樣的比例可能也會被Facebook視為要用小版面來顯示</p><h3 id=佈署到heroku>佈署到heroku</h3><p><a href=https://github.com/chromedp/chromedp>chromedp</a>是沒辦法單獨運作的, 必須要有chrome才可以正常運作, 如果要部屬到heroku, heroku的環境上是沒裝chrome的, 這該怎麼辦?</p><p>一種方式是建立自己的<a href=https://devcenter.heroku.com/articles/buildpacks#creating-a-buildpack>Build Pack</a>, <a href=https://developers.google.com/web/updates/2017/04/headless-chrome>裝個chrome跑headless mode</a>, 不過這條路太麻煩, 不是我選擇的路</p><p>一個是在heroku上用<a href=https://devcenter.heroku.com/articles/build-docker-images-heroku-yml>docker image來跑</a>, 這樣只要包裝好一個docker image就搞定了, 簡單</p><p>為了這目的, 可以選用<a href=https://github.com/chromedp/docker-headless-shell>Headless shell</a>這個docker image當作base image, 這個image已經等同包裝好一個headless chrome了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>FROM</span> <span style=color:#a6e22e>chromedp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>headless</span><span style=color:#f92672>-</span><span style=color:#a6e22e>shell</span>:<span style=color:#a6e22e>latest</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>Install</span> <span style=color:#a6e22e>dumb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>init</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>tini</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RUN</span> <span style=color:#a6e22e>apt</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>dumb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>init</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>RUN</span> <span style=color:#a6e22e>apt</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>tini</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;dumb-init&#34;</span>, <span style=color:#e6db74>&#34;--&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;tini&#34;</span>, <span style=color:#e6db74>&#34;--&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>CMD</span> [<span style=color:#e6db74>&#34;/path/to/your/program&#34;</span>]
</span></span></code></pre></div><p>這邊的<code>dumb-init</code>, <code>tini</code>是必須的, 因為這個container不只會跑一個procewss, 包含chrome是兩個, 所以不包這個的話, 在結束container時會有zombie process造成container無法被結束</p><h2 id=有黑貓就加分>有黑貓就加分!</h2><p>不過, 也不是每個網頁都像ptt那樣適合用截圖來做og:image, 後來想了一下, 我想要的大概介於兩者之間, 有文字, 但不太單調的版面, 像這樣</p><p><img src=/images/posts/og/og_sample_cat.jpg alt="OG cat"></p><p>那其實這也不難, 做一個網頁範本, 用前面的截圖的方法截出來就好了, 那這也是目前最後使用的版本</p><h2 id=小收尾>小收尾</h2><p>順便做了幾個小收尾</p><ol><li>除了Facebook bot跟Twitter bot外, 不可以抓到產生的圖, 這是為了以防有人偷用, 用UA去判斷</li><li>加上cache-control, cdn-cache-control header, 前面再擋一層cloudflare</li></ol><h2 id=碰到的問題>碰到的問題</h2><p>目前碰到的主要問題有兩個</p><ol><li>heroku的free dyno冷啟動至少要6秒, 如果網頁又太慢, 那很有可能造成Facebook bot或Twitter bot timeout</li><li>最最詭異的部分是, Facebook部分, 字形跑掉了, 比照前面那張貓圖跟下面這張, 會發現"Julian Shen"的字形跑掉了, 前面那個是Twitter抓出來的, 後者是Facebook, 明明就同一個URL, 同一個browser render, 如果直接看那張圖字形也是正常的, 但Facebook不知道哪抓來的靈異照片
<img src=/images/posts/og/og_sample_cat_2.jpg alt="OG cat"></li></ol><footer class=entry-meta><span class=entry-tags></span><div class=social-share><ul class="socialcount socialcount-small inline-list"><li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jln.co%2f%25E5%2584%25AA%25E5%258C%2596-Open-Graph-Image%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i> Like</span></a></li><li class=twitter><a href="https://twitter.com/intent/tweet?text=https%3a%2f%2fblog.jln.co%2f%25E5%2584%25AA%25E5%258C%2596-Open-Graph-Image%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i> Tweet</span></a></li><li class=line><a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2fblog.jln.co%2f%25E5%2584%25AA%25E5%258C%2596-Open-Graph-Image%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li></ul></div></footer></div><section id=disqus_thread><div class=fb-comments data-href=https://blog.jln.co/%E5%84%AA%E5%8C%96-Open-Graph-Image/ data-numposts=5 data-width></div></section></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>