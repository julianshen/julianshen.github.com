<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>使用 Chromedp 爬取動態網站資料 &#8211; Le murmure de Julian</title>
<meta name=description content><meta property="og:url" content="https://blog.jln.co/Shi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao/"><meta property="og:site_name" content="Le murmure de Julian"><meta property="og:title" content="使用 Chromedp 爬取動態網站資料"><meta property="og:description" content="在現代的網頁開發中，JavaScript 驅動的動態網站變得越來越普遍，這對使用傳統 HTML 解析的爬蟲工具帶來了挑戰。傳統的方法不再適用，因為網頁的"><meta property="og:locale" content="zh_tw"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-06-30T01:02:25+08:00"><meta property="article:modified_time" content="2024-06-30T01:02:25+08:00"><meta property="og:image" content="https://og.jln.co/jlns1/5L2_55SoIENocm9tZWRwIOeIrOWPluWLleaFi-e2suermeizh-aWmQ"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://og.jln.co/jlns1/5L2_55SoIENocm9tZWRwIOeIrOWPluWLleaFi-e2suermeizh-aWmQ"><meta name=twitter:title content="使用 Chromedp 爬取動態網站資料"><meta name=twitter:description content="在現代的網頁開發中，JavaScript 驅動的動態網站變得越來越普遍，這對使用傳統 HTML 解析的爬蟲工具帶來了挑戰。傳統的方法不再適用，因為網頁的"><link rel=canonical href=https://blog.jln.co/Shi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao/><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.128.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script><link rel="shortcut icon" href=/favicon.png></head><body id=post><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div id=main role=main><article class=hentry><header class=header-title><div class=header-title-wrap><h1 class=entry-title><a href=/Shi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao/ rel=bookmark title="使用 Chromedp 爬取動態網站資料">使用 Chromedp 爬取動態網站資料</a></h1><h2><span class="entry-date date published"><time datetime="2024-06-30 01:02:25 +0800 +0800">June 30, 2024</time></span></h2><p class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</p></div></header><div class=entry-content><p>在現代的網頁開發中，JavaScript 驅動的動態網站變得越來越普遍，這對使用傳統 HTML 解析的爬蟲工具帶來了挑戰。傳統的方法不再適用，因為網頁的內容必須在執行 JavaScript 後才會生成。解析這種網站需要更多前端的知識。</p><p>chromedp 是一個用 Go 語言編寫的工具包，它通過 Chrome 的 DevTools 協議進行無頭瀏覽器(Headless Browser)自動化，使開發者能夠程式化地控制 Chrome 瀏覽器，方便地爬取和解析動態生成的內容。本文將介紹如何使用 chromedp 來建立一個簡單的網路爬蟲。</p><p>##基本原理</p><p>chromedp 主要通過與 Chrome 瀏覽器的 DevTools 協議通信來實現其功能。這使得開發者可以模擬使用者操作，例如導航到網頁、點擊按鈕、填寫表單以及提取動態載入的內容。這些操作在無頭模式（Headless mode）下進行，瀏覽器界面不可見，從而提高效能和資源利用效率。透過這種方式，chromedp 可以處理傳統 HTML 解析工具無法處理的情況，特別是在處理動態生成的內容時。</p><h2 id=簡單範例程式碼>簡單範例程式碼</h2><p>以下是一個使用 chromedp 爬取網站資料的簡單範例，這個範例展示了如何導航到一個網站、選擇一些元素、提交表單並提取所需的數據：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;github.com/chromedp/chromedp&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#75715e>// 建立 context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 分配瀏覽器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> = <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewExecAllocator</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>DefaultExecAllocatorOptions</span>[:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 建立具有timeout 30秒的 context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> = <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 執行任務
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>res</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#e6db74>&#34;https://example.com&#34;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitVisible</span>(<span style=color:#e6db74>`body`</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SendKeys</span>(<span style=color:#e6db74>`input[name=&#34;q&#34;]`</span>, <span style=color:#e6db74>&#34;chromedp&#34;</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Click</span>(<span style=color:#e6db74>`input[type=&#34;submit&#34;]`</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitVisible</span>(<span style=color:#e6db74>`#result-stats`</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Text</span>(<span style=color:#e6db74>`#result-stats`</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Search Result Stats:&#34;</span>, <span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在這個範例中，我們建立了一個 chromedp 任務，它會導航到 example.com，等待頁面載入完成後，在搜尋框中輸入 &ldquo;chromedp&rdquo;，點擊提交按鈕，然後等待搜尋結果統計資訊的元素可見，並提取該資訊。這是一個基本範例，展示了如何使用 chromedp 進行基本的網頁互動和數據提取。你可以根據需要擴展此範例以實現更複雜的爬蟲功能。</p><p>接下來我們用一個更實用的案例來實作，以下範例展示如何使用 chromedp 爬取中華職棒（CPBL）的賽程表，此網站由 Vue.js 實作。</p><h2 id=解析文件>解析文件</h2><p>中華職棒賽程網站的網址是 <a href=https://cpbl.com.tw/schedule>https://cpbl.com.tw/schedule</a>。首先，我們用檢視網頁原始碼（View page source）來看看，可以發現裡面找不到任何賽程資料。另外，我們還能發現這段程式碼：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Vue</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>el</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;#Center&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mixins</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>mixin</span>],
</span></span></code></pre></div><p>以及另一段用來取得賽程資訊的程式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>$</span>.<span style=color:#a6e22e>ajax</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/schedule/getgamedatas&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>filterData</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RequestVerificationToken</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PzmpuUOvS4z2zH_QhwgFQYTzVC82b0n2QH30wEOJ12kOWA6zeq0Yn7_6d2v_o-ZTWuNPe3HjrqsMqAHp9sL0F5KB4KM1:5jgubJ0tGDTK3cLm2JU7_bCw9JqLOG8j8yeNiWDhR4nnTACLXerDqmzB5chZv-iqY8m1ep6IirI3hAwRCPfNTU6jO_E1&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>success</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>result</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Success</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_this</span>.<span style=color:#a6e22e>gameDatas</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>GameDatas</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_this</span>.<span style=color:#a6e22e>getGames</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>res</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>res</span>);
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>complete</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#34;body&#34;</span>).<span style=color:#a6e22e>unblock</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>很明顯這是一個用 Vue.js 寫的網頁。我們當然可以試著去打它的 API，但看到那串 Token，可能做了某些保護，使用 chromedp 的方式可能更簡單。</p><p>那怎麼開始解析呢？用 ChatGPT 或許是一個好方法，打開 Chrome 的開發人員工具，在 Elements 那邊可以看到已經是最終的網頁結果，試著把它存成一個檔案並詢問 ChatGPT：</p><p><img src=/images/posts/chrgpt-1.png alt></p><p>資料結構也可以順便請它設計一下:</p><p><img src=/images/posts/chrgpt-2.png alt></p><p>這當然只能當作一開始的參考，後面也可以請它幫你直接寫程式。不過，我試了一下，它寫出來的只能當範例，不能產出正確的結果，但拿來作為基礎修改其實也不錯用。</p><p>先定義一下需求，我們需要寫一個函數，可以輸入年月和比賽種類來取得賽程資訊。</p><p>依照這些資訊，先來寫一個比較粗略的版本來實驗一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Game</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>No</span>       <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;no&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Year</span>     <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;year&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Month</span>    <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;month&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Day</span>      <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;day&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Home</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;home&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Away</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;away&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Ballpark</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;ballpark&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getGameNodes</span>(<span style=color:#a6e22e>nodes</span> <span style=color:#f92672>*</span>[]<span style=color:#f92672>*</span><span style=color:#a6e22e>cdp</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ActionFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctxWithTimeout</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>900</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Nodes</span>(<span style=color:#e6db74>&#34;div.game&#34;</span>, <span style=color:#a6e22e>nodes</span>).<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>ctxWithTimeout</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>dom</span>.<span style=color:#a6e22e>RequestChildNodes</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>NodeID</span>).<span style=color:#a6e22e>WithDepth</span>(<span style=color:#ae81ff>6</span>).<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>ctxWithTimeout</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span> })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectMonth</span>(<span style=color:#a6e22e>month</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>QueryAction</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#e6db74>&#34;div.item.month select&#34;</span>, <span style=color:#a6e22e>month</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQueryAll</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectYear</span>(<span style=color:#a6e22e>year</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>QueryAction</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#e6db74>&#34;div.item.year select&#34;</span>, <span style=color:#a6e22e>year</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQueryAll</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectGameType</span>(<span style=color:#a6e22e>gtype</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#e6db74>&#34;div.item.game_type select&#34;</span>, <span style=color:#a6e22e>gtype</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQueryAll</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>fetchGamesByMonth</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>year</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>month</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>Game</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>selectMonth</span>(<span style=color:#a6e22e>month</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitVisible</span>(<span style=color:#e6db74>&#34;div.ScheduleGroup&#34;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>800</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>cdp</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mn</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Text</span>(<span style=color:#e6db74>&#34;.date_selected .date&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mn</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getGameNodes</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nodes</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>games</span> []<span style=color:#a6e22e>Game</span> = make([]<span style=color:#a6e22e>Game</span>, len(<span style=color:#a6e22e>nodes</span>))
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>No</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Trim</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>NodeValue</span>, <span style=color:#e6db74>&#34; &#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Ballpark</span> = <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>NodeValue</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Year</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>year</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>monthInt</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>month</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Month</span> = <span style=color:#a6e22e>monthInt</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dataDate</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Parent</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>AttributeValue</span>(<span style=color:#e6db74>&#34;data-date&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>day</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>dataDate</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Day</span> = <span style=color:#a6e22e>day</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Away</span> = <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>AttributeValue</span>(<span style=color:#e6db74>&#34;title&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Home</span> = <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>2</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>AttributeValue</span>(<span style=color:#e6db74>&#34;title&#34;</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>games</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這個版本程式碼很粗略但可用，主要使用 NodeValue 和 AttributeValue 來取值。這種方法的問題在於，這些 chromedp 呼叫每一個都需要與 Chrome 通信，而這是通過 Chrome DevTools Protocol 來實現的。Chrome DevTools Protocol 使用 WebSocket 進行通信，這樣頻繁來回不僅效率低，穩定性也較差。</p><p>下面這個範例是從 ChatGPT 學來的方法再優化的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// FetchSchedule fetches the schedule from CPBL website based on the year, month, and game type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FetchSchedule</span>(<span style=color:#a6e22e>year</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>month</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>gameType</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>GameSchedule</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>schedules</span> []<span style=color:#a6e22e>GameSchedule</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// Define the URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;https://cpbl.com.tw/schedule&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// Run chromedp tasks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#a6e22e>url</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitReady</span>(<span style=color:#e6db74>`.ScheduleTableList`</span>), <span style=color:#75715e>// Wait for year select to be ready
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;document.querySelector(&#39;#Center&#39;).__vue__.filters.kindCode = &#39;%s&#39;&#34;</span>, <span style=color:#a6e22e>gameType</span>), <span style=color:#66d9ef>nil</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;document.querySelector(&#39;#Center&#39;).__vue__.calendar.year = %d&#34;</span>, <span style=color:#a6e22e>year</span>), <span style=color:#66d9ef>nil</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitReady</span>(<span style=color:#e6db74>`.ScheduleTableList`</span>), <span style=color:#75715e>// Wait for year select to be ready
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;document.querySelector(&#39;#Center&#39;).__vue__.calendar.month = %d&#34;</span>, <span style=color:#a6e22e>month</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>), <span style=color:#66d9ef>nil</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#e6db74>`document.querySelector(&#39;#Center&#39;).__vue__.getGameDatas()`</span>, <span style=color:#66d9ef>nil</span>), <span style=color:#75715e>// Wait for table to be visible
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>), <span style=color:#75715e>// Wait for table to load
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   (() =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    let schedules = [];
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    document.querySelectorAll(&#39;.ScheduleTable tbody .date&#39;).forEach(dateDiv =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     let date = dateDiv.innerText.trim();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     let parent = dateDiv.parentNode;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     parent.querySelectorAll(&#39;.game&#39;).forEach(gameDiv =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let location = gameDiv.querySelector(&#39;.place&#39;) ? gameDiv.querySelector(&#39;.place&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let game_no = gameDiv.querySelector(&#39;.game_no&#39;) ? gameDiv.querySelector(&#39;.game_no&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let away_team = gameDiv.querySelector(&#39;.team.away span&#39;) ? gameDiv.querySelector(&#39;.team.away span&#39;).title.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let home_team = gameDiv.querySelector(&#39;.team.home span&#39;) ? gameDiv.querySelector(&#39;.team.home span&#39;).title.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let score = gameDiv.querySelector(&#39;.score&#39;) ? gameDiv.querySelector(&#39;.score&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let remark = gameDiv.querySelector(&#39;.remark .note div&#39;) ? gameDiv.querySelector(&#39;.remark .note div&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      schedules.push({ date, location, game_no, away_team, home_team, score, remark });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return schedules;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   })()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  `</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>schedules</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>schedules</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這個版本大量使用 chromedp.Evaluate 來內嵌 JavaScript 程式碼直接在網頁執行。這樣可讀性更好，且避免了頻繁與 Chrome 通信。這種方法更高效且穩定。</p><footer class=entry-meta><span class=entry-tags></span><div class=social-share><ul class="socialcount socialcount-small inline-list"><li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jln.co%2fShi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i> Like</span></a></li><li class=twitter><a href="https://twitter.com/intent/tweet?text=https%3a%2f%2fblog.jln.co%2fShi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i> Tweet</span></a></li><li class=line><a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2fblog.jln.co%2fShi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li></ul></div></footer></div><section id=disqus_thread><div class=fb-comments data-href=https://blog.jln.co/Shi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao/ data-numposts=5 data-width></div></section></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script><script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>