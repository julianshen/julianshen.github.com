<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>在 Next.js 實作 Feature Toggles &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="在 Next.js 實作 Feature Toggles"><meta property="og:description" content="之前一直有在思考, 如果把 Feature toggles或Feature flags帶入開發流程可以有甚麼幫助, 先撇開A/B Test不談(因為這還是要配合產品"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.jln.co/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/"><meta property="og:image" content="https://og.jln.co/jlns1/5ZyoIE5leHTvvI5qcyDlr6bkvZwgRmVhdHVyZSBUb2dnbGU"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-09-01T14:13:25+08:00"><meta property="article:modified_time" content="2021-09-01T14:13:25+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://og.jln.co/jlns1/5ZyoIE5leHTvvI5qcyDlr6bkvZwgRmVhdHVyZSBUb2dnbGU"><meta name=twitter:title content="在 Next.js 實作 Feature Toggles"><meta name=twitter:description content="之前一直有在思考, 如果把 Feature toggles或Feature flags帶入開發流程可以有甚麼幫助, 先撇開A/B Test不談(因為這還是要配合產品"><link rel=canonical href=https://blog.jln.co/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.119.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div id=main role=main><article class=hentry><header class=header-title><div class=header-title-wrap><h1 class=entry-title><a href=/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/ rel=bookmark title="在 Next.js 實作 Feature Toggles">在 Next.js 實作 Feature Toggles</a></h1><h2><span class="entry-date date published"><time datetime="2021-09-01 14:13:25 +0800 +0800">September 1, 2021</time></span></h2><p class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~8 minutes</p></div></header><div class=entry-content><p>之前一直有在思考, 如果把 Feature toggles或Feature flags帶入開發流程可以有甚麼幫助, 先撇開A/B Test不談(因為這還是要配合產品策略考量), 在一個開發Sprint週期時間越來越短下, 一個feature的完成通常也需要跨越多個sprints, 如果加上某些可能需要配合event時間推出的功能, 這對release也是會帶來一些挑戰, 理想化的狀況就是最新的程式碼一直都在, 測試沒問題後開個開關就可以打開, 甚或搭配一些技巧可以讓QA也能夠在生產環境驗證還沒release的功能</p><p>需要feature toggles的場合, 可能前後端都會有機會, 不過, 我想了一下, 後端還是可以從API版本或是其他方法隱藏未釋出功能, 而從前端一次隱藏整個功能區塊或是整個頁面, 或許是一個比較好開始切入的部分</p><p>先來介紹一下Feature toggle好了</p><h2 id=feature-toggles>Feature Toggles</h2><p>Feature Toggles (又名Feature Flags)是一個應該算是常見的軟體開發方式, 藉由開關旗標(flag)來開啟或隱藏程式中的功能, 土法一點, 你是可以自訂一個布林變數, 在release之前去打開或關閉它(true or false), 當然這樣彈性比較小, 理想上當然會希望可以彈性隨時開關</p><p>根據Martin Fowler這篇<a href=https://martinfowler.com/bliki/FeatureToggle.html>FeatureToggle</a>以及Pete Hodgson先生寫的這篇: <a href=https://www.martinfowler.com/articles/feature-toggles.html>Feature Toggles (aka Feature Flags)</a>, Feature toggles根據用途可以分做不同種類(後面那篇介紹比較詳細):</p><ol><li>Release Toggles: 這就如同前面講的, 開關或隱藏程式中功能, 或許是還未完成之功能, 可以搭配 trunk-based development服用, 通常Release toggles的變動頻率應該要是相當小的, 也可能等功能穩定後就會被拿掉</li><li>Experiment Toggles: 用在做A/B Test實驗, 會需要經過一些條件判斷來做啟用或禁用, 通常會根據request的資訊有變動</li><li>Ops Toggles: 用在跟系統運維相關, 比如說系統問題臨時需要下架, 需要上公告頁面, 或是像這種狀況需要下架某些功能(一個想法: 或許可以搭配系統監控使用)</li><li>Permission Toggles: 用在限定特定使用者可以使用, 或許直覺會想到是針對有權限控制的功能, 不過其實還可以用在Campaign/Event相關功能, 如果需要提早內部做dog fooding, 或許就可以考量beta user whitelist的作法, 搭配Permission Toggles</li></ol><p>類別只是一種定義而已, 真正使用狀況或許會更複雜搭配, 也可能需要考慮flags之間的相依性跟連動關係, 不過這篇並不是要討論這部分, 這篇會以簡單的實現Release toggle來先做探討</p><p>關於feature toggles資源跟相關探討也可參考 <a href=https://featureflags.io/>The Hub for Feature Flag Driven Development</a></p><h2 id=feature-toggles的解決方案>Feature toggles的解決方案</h2><p>有人提出方法, 就會有人提出解決方案和產品, Feature toggles相關的產品其實非常多, 商業產品有:</p><ol><li><a href=https://launchdarkly.com/about-us/>LaunchDarkly</a></li><li><a href=https://www.getunleash.io/plans>Unleash</a></li><li><a href=https://happykit.dev/>HappyKit</a></li></ol><p>另外也可以找到不少Open source的</p><ol><li><a href=https://www.togglz.org/>Togglez</a> (Java)</li><li><a href=https://ff4j.github.io>FF4J</a> (Java)</li><li><a href="https://twitter.github.io/finagle/guide/Configuration.html#:~:text=Feature%20toggles%20are%20a%20commonly%20used%20mechanism%20for,rollout%20functionality%20in%20a%20measured%20and%20controlled%20manner.">Finagle</a> (Finagle有內建, 不過不好用)</li><li><a href=https://github.com/AntoineAugusti/feature-flags>Feature Flags API for Go</a> (Go)</li></ol><p>你可以從<a href=https://featureflags.io/>The Hub for Feature Flag Driven Development</a>找到一大堆</p><p>但這些絕大部分作法是把feature toggles的設定集中管理, 不管是放在資料庫, 或是有一個server來提供(後面也是放資料庫)</p><p>個人是覺得, Feature toggles並不是主角, 而是跑龍套的, 應該盡可能的輕量化, 做成獨立系統有點多了, 在Cloud native (k8s native)時代, 考慮用檔案來存設定(搭配ConfigMap), 加上lib, 應該是相對輕量的作法</p><p>因此針對這想法, 我在Next.js上做了幾個做法來驗證, 這邊把我的作法跟碰到的狀況做一個紀錄</p><h2 id=基本設計>基本設計</h2><p>首先, 我先想了一下, 我在Next.js上要怎使用Feature toggles比較合適, 搭配tag應該是最為易讀的方式, 像是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>WithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature1&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>div</span>&gt;<span style=color:#a6e22e>This</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>feature</span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>WithFeature</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span></code></pre></div><p>用一個區塊包藏住需要開關的部分, 再由讀取到的設定做為開關</p><p>另一個想到的方式是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>PageWithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature3&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>PageWithFeature</span>&gt;
</span></span></code></pre></div><p>這種跟前一種的不同是, 如果功能未打開, 區塊就不會顯示, 但整頁的其他部分還會顯示, 但第二種應用在, 整頁都是新功能, 不想因為提早被發現URL而露出, 所以功能未打開的情況需要顯示404</p><p>另外config的設計希望是一個yaml檔案給程式去讀取, 像這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>features</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature1</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature2</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature3</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>offline</span>: <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><h2 id=使用custom-app跟react-context來做一個通用設計>使用Custom App跟React context來做一個通用設計</h2><p>為何說是通用設計? 這邊是希望每個需要用到toggle的頁面不用自已寫載入設定的部分(後面會講個範例是有需要的), 而是只要直接用 <code>&lt;WithFeature feature="feature1"></code> 就好</p><p>Next.js有支援<a href=https://nextjs.org/docs/advanced-features/custom-app>&ldquo;Custom <code>App</code>&rdquo;</a>, 所以我們載入config的部分可以直接放在"<code>_app.tsx</code>" 或 &ldquo;<code>_app.jsx</code>&ldquo;內就可以讓所有頁面共用(詳細請參考文件)載入部分的程式碼, 另外還得搭配<a href=https://reactjs.org/docs/context.html>React context</a>才能順利的把設定下傳到component</p><p>首先, 我們需要先來設計一個<code>Context</code>用來傳遞設定給<code>WithFeature</code>的元件(Component)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createContext</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeatureMap</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>key</span>:<span style=color:#66d9ef>string</span>]<span style=color:#f92672>:</span><span style=color:#66d9ef>boolean</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FeatureContext</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createContext</span>({<span style=color:#a6e22e>features</span><span style=color:#f92672>:</span> {} <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>FeatureMap</span>})
</span></span></code></pre></div><p>這邊設計很單純, 假設每個feature都是true或false的開關, 前面的config yaml也是這樣的</p><p>在<code>_app.tsx</code>我們則需要有這東西:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../context/featurecontext&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>MyApp</span>({ <span style=color:#a6e22e>Component</span>, <span style=color:#a6e22e>pageProps</span> }<span style=color:#f92672>:</span> <span style=color:#a6e22e>AppProps</span>) {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>FeatureContext.Provider</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>features</span>:<span style=color:#66d9ef>pageProps.features</span>}}&gt;&lt;<span style=color:#f92672>Component</span> {<span style=color:#a6e22e>...pageProps</span>}/&gt;&lt;/<span style=color:#f92672>FeatureContext.Provider</span>&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊是把pageProps裡的features給帶到<code>FeatureContext</code>以讓後面的可以讀到, 那pageProps是又哪裡來的? 這邊我們就得去實作<code>app.getInitialProps</code>了, 這個在每個page初始化都會呼叫到它, 並把它產生的pageProps給餵到前面那個function</p><p>那是不是就可以把下面這段直接放到<code>getInitialProps</code>就可以取得feature flags的設定了呢?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
</span></span></code></pre></div><p>答案是"不行!!&rdquo;, 為何? 因為在Next.js的設計上:</p><ol><li><code>getInitialProps</code>是會有可能在client(瀏覽器), server跑</li><li>除非你頁面實作上有<code>getServerSideProps</code>, <code>getInitialProps</code>才會總是在server端跑</li><li>只有<code>getServerSideProps</code>,<code>getStaticProps</code>才可使用server端(node.js)API, 例如讀檔 (還有一個則是API, 但API實做不同, 我不規在此類)</li><li><code>getServerSideProps</code>只設計給頁面的實作使用, 所以每頁有自己的 <code>getServerSideProps</code>, 但 App沒<code>getServerSideProps</code></li></ol><p>因為client跟server都會有機會呼叫到, 如果要讓它們能夠共用, 那就只有做一個API給它, 我們在<code>page/api</code>目錄底下開一個<code>features.tsx</code>的檔案, 內容是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>NextApiResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>YAML</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;yaml&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Features</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>key</span>:<span style=color:#66d9ef>string</span>]<span style=color:#f92672>:</span><span style=color:#66d9ef>boolean</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handler</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextApiRequest</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>: <span style=color:#66d9ef>NextApiResponse</span>&lt;<span style=color:#f92672>Features</span>&gt;
</span></span><span style=display:flex><span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>features</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>Features</span>)
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>那我們<code>getInitialProps</code>就可以這樣寫:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>MyApp</span>.<span style=color:#a6e22e>getInitialProps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>appContext</span>: <span style=color:#66d9ef>AppContext</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>appProps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>App</span>.<span style=color:#a6e22e>getInitialProps</span>(<span style=color:#a6e22e>appContext</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>appContext</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>req</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>?</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#34;x-forwarded-host&#34;</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#34;host&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>:</span> window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>host</span>;
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>`http://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>host</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/api/features`</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>features</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>json</span>()
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>appProps</span>.<span style=color:#a6e22e>pageProps</span>[<span style=color:#e6db74>&#39;features&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>features</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> { ...<span style=color:#a6e22e>appProps</span> }
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>這邊有一點需要注意的, 雖然用<code>fetch</code>, 但它client端, server端用的是不一樣的, 雖然是長一樣的API, 所以這邊的URL是不可以用相對路徑的("<code>/api/features</code>&rdquo;), 原因就是在server端只有相對路徑是無法知道實際要呼叫哪裡, 所以這邊還是組出一個完整的URL來使用(不過這實做有點不是很好, 需要改, 當PoC就算了 :p)</p><p>所以<code>WithFeature</code>就可以長這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ReactNode</span>, <span style=color:#a6e22e>useContext</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../context/featurecontext&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeaturesProps</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>children?</span>:<span style=color:#66d9ef>ReactNode</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>feature?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>WithFeature</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>FeaturesProps</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>features</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>useContext</span>(<span style=color:#a6e22e>FeatureContext</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>features</span>[<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span>]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>            &lt;&gt;{<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>children</span>}&lt;/&gt;)   
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> &lt;&gt;&lt;/&gt;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>WithFeature</span>
</span></span></code></pre></div><p>因為<code>features</code>是放在<code>FeatureContext</code>中, 所以我們可以透過<code>useContext</code>來取值</p><p>這作法不算難, 而且也蠻好運用, 只要在每個需要的頁面自行運用<code>WithFeature</code>即可, 但缺點是甚麼? 基本上它算是CSR(Client side rendering), 而且要甚麼flag都是透過API跟server要, 會被看的一清二楚外, 或許可能還有方法偽造以至於你的功能提早被發現</p><h2 id=ssr-server-side-rendering的作法>SSR (Server Side Rendering)的作法</h2><p>Next.js強大的地方就是它有<a href=https://nextjs.org/docs/basic-features/data-fetching>支援SSR(Sever side rendering)和SSG(Server side generation)</a>, 兩者的好處就是在server端就把頁面內容給產生好</p><p>假設我們有一頁叫做<code>Post3</code>, 實作是這樣的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextPage</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>GetServerSideProps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Link</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/link&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>YAML</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;yaml&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>WithFeature</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../components/feature2&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PageWithFeature</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../components/feature3&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Params</span> <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Props</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>features</span>: <span style=color:#66d9ef>any</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Post3</span>:<span style=color:#66d9ef>NextPage</span>&lt;<span style=color:#f92672>Props</span>&gt; <span style=color:#f92672>=</span> (<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>Props</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>FeatureContext.Provider</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>features</span>:<span style=color:#66d9ef>props.features</span>}}&gt;
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>PageWithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature3&#34;</span>&gt;
</span></span><span style=display:flex><span>                &lt;<span style=color:#f92672>WithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature4&#34;</span>&gt;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>feature</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>                &lt;/<span style=color:#f92672>WithFeature</span>&gt;                
</span></span><span style=display:flex><span>                &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
</span></span><span style=display:flex><span>            &lt;/<span style=color:#f92672>PageWithFeature</span>&gt;
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>FeatureContext.Provider</span>&gt;
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Post3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getServerSideProps</span>:<span style=color:#66d9ef>GetServerSideProps</span>&lt;<span style=color:#f92672>Props</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>Params</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>ctx</span>) <span style=color:#f92672>=&gt;</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>features</span>: <span style=color:#66d9ef>config.features</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這頁面可以透過<code>/post3</code>來存取它, 這個頁面由於實做了<code>getServerSideProps</code>, 因此Next.js會使用SSR的模式, 這邊<code>getServerSideProps</code>就可以直接讀檔案了</p><p>但使用SSR這方法的話, 缺點就是</p><ol><li>每個頁面都得自己把讀config加入<code>getServerSideProps</code></li><li>也都需要自己把內容包在Context Provider如<code>&lt;FeatureContext.Provider value={{features:props.features}}></code></li></ol><p>就等於很多頁面都會有重複的程式碼, 不是那麼簡潔漂亮, 但優點應是內容在server端就已經先處理好了</p><h2 id=pagewithfeature>PageWithFeature</h2><p>上面有偷偷藏一個<code>PageWithFeature</code>, 這個實做可以是這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ReactNode</span>, <span style=color:#a6e22e>useContext</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> Error <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/error&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../context/featurecontext&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Offline</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./offline&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeaturesProps</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>features?</span>:<span style=color:#66d9ef>any</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>children?</span>:<span style=color:#66d9ef>ReactNode</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>feature?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PageWithFeature</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>FeaturesProps</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>features</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>useContext</span>(<span style=color:#a6e22e>FeatureContext</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span>[<span style=color:#e6db74>&#39;offline&#39;</span>]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Offline</span>&gt;&lt;/<span style=color:#f92672>Offline</span>&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>features</span>[<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span>]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>            &lt;&gt;{<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>children</span>}&lt;/&gt;)   
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Error</span> <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>=</span>{<span style=color:#ae81ff>404</span>} /&gt;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>PageWithFeature</span>
</span></span></code></pre></div><p>用途有兩個:</p><ol><li>Disable時導到404頁面</li><li>如果是系統下架狀態下, 導到一個暫時停止服務頁面(這邊用另一個component來解決)</li></ol><h2 id=開發流程上的思考>開發流程上的思考</h2><p>Atlassian這篇介紹<a href=https://www.atlassian.com/continuous-delivery/principles/feature-flags>Feature flags</a>裡有張圖, 我覺得蠻有趣的, 可以做為開發流程上的一個參考:
<img src="https://wac-cdn.atlassian.com/dam/jcr:cc55dc99-ddf4-4e61-a989-db6446cfef3c/Feature%20Flag-Driven%20Development@2x.png?cdnVersion=1785" alt></p><p>Facebook這篇<a href=https://engineering.fb.com/2017/08/31/web/rapid-release-at-massive-scale/>Rapid release at massive scale</a>, 雖然跟Feature flags關係比較不大, 但也蠻有參考價值的</p><footer class=entry-meta><span class=entry-tags></span><div class=social-share><ul class="socialcount socialcount-small inline-list"><li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jln.co%2f%25E5%259C%25A8-Next.js-%25E5%25AF%25A6%25E4%25BD%259C-Feature-Toggles%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i> Like</span></a></li><li class=twitter><a href="https://twitter.com/intent/tweet?text=https%3a%2f%2fblog.jln.co%2f%25E5%259C%25A8-Next.js-%25E5%25AF%25A6%25E4%25BD%259C-Feature-Toggles%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i> Tweet</span></a></li><li class=line><a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2fblog.jln.co%2f%25E5%259C%25A8-Next.js-%25E5%25AF%25A6%25E4%25BD%259C-Feature-Toggles%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li></ul></div></footer></div><section id=disqus_thread><div class=fb-comments data-href=https://blog.jln.co/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/ data-numposts=5 data-width></div></section></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>