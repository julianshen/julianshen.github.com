<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]-->
<head>
<meta charset=utf-8>
<title>用GORM取用PostGIS的geometry資料 &#8211; Le murmure de Julian</title>
<meta name=description content>
<meta property="og:title" content="用GORM取用PostGIS的geometry資料">
<meta property="og:description" content="PostGIS 是讓PostgresSQL可以支援地理資訊資料的一個擴充, 而geometry是PostGIS定義來儲存地理資料的資料型態, 包含了座標點(P">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.jln.co/%E7%94%A8GORM%E5%8F%96%E7%94%A8PostGIS%E7%9A%84geometry%E8%B3%87%E6%96%99/"><meta property="og:image" content="https://og.jln.co/jlns1/55SoR09STeWPlueUqFBvc3RHSVPnmoRnZW9tZXRyeeizh-aWmQ"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-10-29T23:58:47+08:00">
<meta property="article:modified_time" content="2021-10-29T23:58:47+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://og.jln.co/jlns1/55SoR09STeWPlueUqFBvc3RHSVPnmoRnZW9tZXRyeeizh-aWmQ">
<meta name=twitter:title content="用GORM取用PostGIS的geometry資料">
<meta name=twitter:description content="PostGIS 是讓PostgresSQL可以支援地理資訊資料的一個擴充, 而geometry是PostGIS定義來儲存地理資料的資料型態, 包含了座標點(P">
<link rel=canonical href=https://blog.jln.co/%E7%94%A8GORM%E5%8F%96%E7%94%A8PostGIS%E7%9A%84geometry%E8%B3%87%E6%96%99/>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href=/css/main.css>
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css>
<meta http-equiv=cleartype content="on">
<meta name=generator content="Hugo 0.89.4">
<script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png>
</head>
<body id=post>
<nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block>
<button class=dl-trigger>Open Menu</button>
<ul class=dl-menu>
<li><a href=/>Home</a></li>
<li>
<a href=#>About</a>
<ul class=dl-submenu>
<li>
<img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo>
<h4>Julian Shen</h4>
<p>Softward developer</p>
</li>
<li>
<a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a>
</li>
<li>
<a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
</li>
<li>
<a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a>
</li>
<li>
<a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a>
</li>
</ul>
</li>
<li>
<a href=#>Posts</a>
<ul class=dl-submenu>
<li><a href=/post/>All Posts</a></li>
<li><a href=/tags/>All Tags</a></li>
</ul>
</li>
<li><a href=/></a></li>
</ul>
</nav>
<div id=main role=main>
<article class=hentry>
<header class=header-title>
<div class=header-title-wrap>
<h1 class=entry-title><a href=/%E7%94%A8GORM%E5%8F%96%E7%94%A8PostGIS%E7%9A%84geometry%E8%B3%87%E6%96%99/ rel=bookmark title=用GORM取用PostGIS的geometry資料>用GORM取用PostGIS的geometry資料</a></h1>
<h2><span class="entry-date date published"><time datetime="2021-10-29 23:58:47 +0800 +0800">October 29, 2021</time></span></h2>
<p class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~2 minutes
</p>
</div>
</header>
<div class=entry-content>
<p><a href=https://postgis.net/>PostGIS</a> 是讓PostgresSQL可以支援地理資訊資料的一個擴充, 而<a href=https://www.postgis.net/workshops/postgis-intro/geometries.html>geometry</a>是<a href=https://postgis.net/>PostGIS</a>定義來儲存地理資料的資料型態, 包含了座標點(POINT), 線, 多邊形等等</p>
<p>而<a href=https://gorm.io/>GORM</a>則是Golang界算蠻有名的ORM套件, 支援了蠻多不同的關聯式資料庫</p>
<p>不過<a href=https://gorm.io/>GORM</a>是沒有直接支援PostGIS的geometry這個資料型態的, 畢竟geometry並非一般SQL標準的資料型別, 因此如果要讓<a href=https://gorm.io/>GORM</a>可以來存取geometry, 就得使用它所提供的<a href=https://gorm.io/docs/data_types.html>Customize Data Type</a></p>
<p>要存取這種自訂的資料型別, 需要實做<code>Scanner</code>和<code>Valuer</code>這兩個介面:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Scanner</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#75715e>// Scan assigns a value from a database driver.
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// The src value will be of one of the following types:
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    int64
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    float64
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    bool
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    []byte
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    string
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    time.Time
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    nil - for NULL values
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// An error should be returned if the value cannot be stored
</span><span style=color:#75715e></span>	<span style=color:#75715e>// without loss of information.
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// Reference types such as []byte are only valid until the next call to Scan
</span><span style=color:#75715e></span>	<span style=color:#75715e>// and should not be retained. Their underlying memory is owned by the driver.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// If retention is necessary, copy their values before the next call to Scan.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Scan</span>(<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Valuer</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#75715e>// Value returns a driver Value.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// Value must not panic.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Value</span>() (<span style=color:#a6e22e>Value</span>, <span style=color:#66d9ef>error</span>)
}
</code></pre></div><p>那在實做前, 可以先來看看geometry實際存到資料庫是長怎麼樣? 它長的就會像是一串這樣的文字<code>0101000020E61000001E64C73CEA905EC09CD6C962A7C84240</code>, 看起來就是十六進位編碼過的文字, 根據<a href=http://postgis.net/docs/using_postgis_dbmanagement.html#PostGIS_Geography>文件</a>, 它是經過EWKB編碼過的(EWKB是Postgis從<a href=https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry>WKB</a>延伸來的), 然後編碼過的binary資料再轉成Hex字串</p>
<p>這部分的解碼, 可以不用自己寫, 使用open source的好處就是可以踩在前人的肩膀上, 可以利用<a href=https://github.com/twpayne/go-geom>go-goem</a>來幫我們處理這件事, 這邊以處理座標點為例 (採用常見的<a href=https://spatialreference.org/ref/epsg/4326/>EPSG:4326</a>座標系統), 定義一個叫做<code>GeoPoint</code>的型別給GORM使用, 而這個型別的實作可以是這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GeoPoint</span> <span style=color:#a6e22e>geom</span>.<span style=color:#a6e22e>Point</span>

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GeoPoint</span>) <span style=color:#a6e22e>Scan</span>(<span style=color:#a6e22e>val</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>pt</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ewkbhex</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#a6e22e>val</span>.(<span style=color:#66d9ef>string</span>))

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pt</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>geom</span>.<span style=color:#a6e22e>Point</span>); <span style=color:#a6e22e>ok</span> {
			<span style=color:#f92672>*</span><span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>GeoPoint</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>)
		} <span style=color:#66d9ef>else</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprint</span>(<span style=color:#e6db74>&#34;Failed to unmarshal geometry:&#34;</span>, <span style=color:#a6e22e>val</span>))
		}
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#a6e22e>GeoPoint</span>) <span style=color:#a6e22e>Value</span>() (<span style=color:#a6e22e>driver</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>pt</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>g</span>
	<span style=color:#a6e22e>toPt</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ewkbhex</span>.<span style=color:#a6e22e>Encode</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>geom</span>.<span style=color:#a6e22e>Point</span>)(<span style=color:#a6e22e>pt</span>).<span style=color:#a6e22e>SetSRID</span>(<span style=color:#ae81ff>4326</span>), <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>)

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>toPt</span>, <span style=color:#a6e22e>err</span>
}

</code></pre></div><p>其實非常簡單的利用了<a href=https://github.com/twpayne/go-geom>go-goem</a>提供的<code>ewkbhex</code>來編解碼而已</p>
<footer class=entry-meta>
<span class=entry-tags></span>
<div class=social-share>
<ul class="socialcount socialcount-small inline-list">
<li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jln.co%2f%25E7%2594%25A8GORM%25E5%258F%2596%25E7%2594%25A8PostGIS%25E7%259A%2584geometry%25E8%25B3%2587%25E6%2596%2599%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i> Like</span></a></li>
<li class=twitter><a href="https://twitter.com/intent/tweet?text=https%3a%2f%2fblog.jln.co%2f%25E7%2594%25A8GORM%25E5%258F%2596%25E7%2594%25A8PostGIS%25E7%259A%2584geometry%25E8%25B3%2587%25E6%2596%2599%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
<li class=line><a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2fblog.jln.co%2f%25E7%2594%25A8GORM%25E5%258F%2596%25E7%2594%25A8PostGIS%25E7%259A%2584geometry%25E8%25B3%2587%25E6%2596%2599%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li>
</ul>
</div>
</footer>
</div>
<section id=disqus_thread><div class=fb-comments data-href=https://blog.jln.co/%E7%94%A8GORM%E5%8F%96%E7%94%A8PostGIS%E7%9A%84geometry%E8%B3%87%E6%96%99/ data-numposts=5 data-width></div></section>
</article>
</div>
<div class=footer-wrapper>
<footer role=contentinfo>
<span> Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span>
</footer>
</div>
<script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-79243751-1','auto'),ga('send','pageview'))</script>
<div id=fb-root></div>
<script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script>
</body>
</html>