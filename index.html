<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>朱隸安貓囈語錄 &#8211; Le murmure de Julian</title>
<meta name="description" content="朱隸安貓囈語錄">
<meta name="keywords" content="java, android, julianshen, backend, blog, golang, swift">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://blog.jln.co/images/bkg2.jpg">

<meta name="twitter:title" content="朱隸安貓囈語錄">
<meta name="twitter:description" content="朱隸安貓囈語錄">
<meta name="twitter:creator" content="@jlnshen">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="朱隸安貓囈語錄">
<meta property="og:description" content="朱隸安貓囈語錄">
<meta property="og:url" content="http://blog.jln.co/">
<meta property="og:site_name" content="Le murmure de Julian">
<meta name="og:image" content="http://blog.jln.co/images/avatar.png">
<meta name="google-site-verification" content="Fwa4TQMXvroZpNT7rrwHzdf-rWBe1RDuTu75Enx_DWA">



<link rel="canonical" href="http://blog.jln.co/">
<link href="http://blog.jln.co/feed.xml" type="application/atom+xml" rel="alternate" title="Le murmure de Julian Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://blog.jln.co/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://blog.jln.co/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://blog.jln.co/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.jln.co/images/apple-touch-icon-144x144-precomposed.png">



  
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1789797875470932",
        enable_page_level_ads: true
    });
    </script>
  

</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://blog.jln.co/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://blog.jln.co/images/avatar.png" alt="Julian Shen photo" class="author-photo">
					<h4>Julian Shen</h4>
					<p>software deverloper</p>
				</li>
				<li>
					<a href="mailto:julianshen22@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/jlnshen"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/julianshen"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				<li>
					<a href="https://linkedin.com/in/julianshen"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/julianshen"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="https://instagram.com/julianshen"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				<li>
					<a href="https://www.flickr.com/photos/julianshen"><i class="fa fa-fw fa-flickr"></i> Flickr</a>
				</li>
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://blog.jln.co/posts/">All Posts</a></li>
				<li><a href="http://blog.jln.co/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="http://blog.jln.co/images/bkg2.jpg" alt="朱隸安貓囈語錄">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Le murmure de Julian</h1>
      <h2>朱隸安貓囈語錄</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-10-17T20:38:54+08:00"><a href="http://blog.jln.co/%E5%9C%A8ubuntu%E4%B8%8Bmount-box.com%E7%9A%84%E5%85%A7%E5%AE%B9/">October 17, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/%E5%9C%A8ubuntu%E4%B8%8Bmount-box.com%E7%9A%84%E5%85%A7%E5%AE%B9/" rel="bookmark" title="在Ubuntu下mount box.com的內容" itemprop="url">在Ubuntu下mount box.com的內容</a></h1>
    
  </header>
  <div class="entry-content">
    <p>雖然很久沒用box.com的服務了, 不過既然老婆大人問起, 就來寫一下這解法吧</p>

<p>box.com是一個像Dropbox一樣的網路磁碟, 不過它目標客戶跟Dropbox不同, 是比較傾向企業用戶, 可以讓用戶很簡單的分享檔案,
存取box.com除了一般使用Web介面的方式外, 還有其他的方式, 像是透過它的REST API, 另外還有一種就是透過WebDav, 
如果要寫程式去存取它, 一般可以用這兩種方式, 用REST稍微複雜一點, 還要搞定OAuth2的部分, 但透過WebDav的話就簡單多了, 可以掛載成為你作業系統底下的目錄, 當本地檔案來處理</p>

<h4 id="davfs2">安裝davfs2</h4>

<p>首先, 你會需要的是davfs2, 在Ubuntu下用apt-get安裝:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>sudo apt-get install davfs2
</code></pre>
</div>

<h4 id="section">設定帳號密碼</h4>

<p>修改<code class="highlighter-rouge">/etc/davfs2/secrets</code>, 加入</p>

<div class="highlighter-rouge"><pre class="highlight"><code>https://dav.box.com/dav box.com帳號 密碼
</code></pre>
</div>

<h4 id="section-1">掛載</h4>

<p>執行底下指令掛載</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo mkdir /mnt/box.com
sudo -t davfs https://dav.box.com/dav /mnt/box.com
</code></pre>
</div>

<p>成功之後,就會在/mnt/box.com底下看到你的檔案了(包含人家分享給你協作的檔案根目錄), 之後當本地端檔案存取即可, 設定好auto mount即可在開機後掛載</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-10-06T23:10:04+08:00"><a href="http://blog.jln.co/%E7%AD%86%E8%A8%98-ios%E9%96%8B%E7%99%BC-%E4%BD%BF%E7%94%A8mapkit%E5%81%9A%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84%E9%A3%9B%E8%A1%8C%E5%8B%95%E7%95%AB/">October 06, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/%E7%AD%86%E8%A8%98-ios%E9%96%8B%E7%99%BC-%E4%BD%BF%E7%94%A8mapkit%E5%81%9A%E4%B8%80%E5%80%8B%E7%B0%A1%E5%96%AE%E7%9A%84%E9%A3%9B%E8%A1%8C%E5%8B%95%E7%95%AB/" rel="bookmark" title="[筆記][ios開發] 使用MapKit做一個簡單的飛行動畫" itemprop="url">[筆記][ios開發] 使用MapKit做一個簡單的飛行動畫</a></h1>
    
  </header>
  <div class="entry-content">
    <p>小時候很喜歡Indiana Jones系列的電影, 對於它裡面的地圖片段也一直覺得很有趣</p>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/FhoPTyMUgX0" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>如果這樣的動畫, 用在遊記類的blog上, 應該也蠻酷的, 但好像也沒一個比較好的工具, 因此想說用MapKit來實作一個試試</p>

<h3 id="section">功能需求</h3>

<p>先來定義一個簡單的功能需求</p>

<ol>
  <li>在起點跟終點畫一條連結線</li>
  <li>一架飛機延這條線飛到終點</li>
  <li>地圖視角跟著飛機走</li>
</ol>

<h3 id="section-1">實作</h3>

<h4 id="section-2">在起點跟終點畫一條連結線</h4>

<p>這部份要用到MKGeodesicPolyline, 給它兩個點, 它就會自動連結成一條線, 但這條線並不是完美的直線, 因為地球表面是曲面的, 所以它是一條弧線</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>

<span class="n">geodesicPolyline</span> <span class="o">=</span> <span class="kt">MKGeodesicPolyline</span><span class="p">(</span><span class="nv">coordinates</span><span class="p">:</span> <span class="n">coords</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">geodesicPolyline</span><span class="o">!.</span><span class="n">pointCount</span><span class="p">)</span>
<span class="n">mapView</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">geodesicPolyline</span><span class="o">!</span><span class="p">)</span>
</code></pre>
</div>

<p>這邊coors只要給訂起始點跟終點的位置就好, 印出pointCount就會發現它把經由的點都補足了(實際上印出來的會多出2很多很多)</p>

<p>MKGeodesicPolyline裡的參數coordinates是一個UnsafeMutablePointer, 在Swift 3之前要寫成&amp;coords, 但在Swift 3大改之後, “&amp;”就不需要了</p>

<p>由於MKGeodesicPolyline是一個Overlay, 因此最後只需要用mapView.add (Swift 3之前是addOverlay)加入mapView就可以了, 但加入之後, 會發現, 這條線根本沒被畫出來, 那是因為少寫了一部分</p>

<p>在MapView裡面要畫出Overlay, 就必須要跟MapView說怎麼畫出這個Overlay, 這就要實作MKMapViewDelegate裡的mapView(_ mapView: MKMapView, rendererFor overlay: MKOverlay)</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">mapView</span><span class="p">(</span><span class="n">_</span> <span class="nv">mapView</span><span class="p">:</span> <span class="kt">MKMapView</span><span class="p">,</span> <span class="n">rendererFor</span> <span class="nv">overlay</span><span class="p">:</span> <span class="kt">MKOverlay</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">MKOverlayRenderer</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">polyline</span> <span class="o">=</span> <span class="n">overlay</span> <span class="k">as?</span> <span class="kt">MKPolyline</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">MKOverlayRenderer</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">let</span> <span class="nv">renderer</span> <span class="o">=</span> <span class="kt">MKPolylineRenderer</span><span class="p">(</span><span class="nv">polyline</span><span class="p">:</span> <span class="n">polyline</span><span class="p">)</span>
    <span class="n">renderer</span><span class="o">.</span><span class="n">lineWidth</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">renderer</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">renderer</span><span class="o">.</span><span class="n">strokeColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="o">.</span><span class="n">blue</span>
    
    <span class="k">return</span> <span class="n">renderer</span>
<span class="p">}</span>
</code></pre>
</div>

<p>由於我們是要畫Poly line, 因此這邊回傳給它一個MKPolylineRenderer, 線寬是3.0, 線的顏色是藍色(alpha = 0.5)</p>

<p>這樣就可以很完美的畫出那條線了</p>

<h4 id="section-3">在地圖上畫出飛機</h4>

<p>這部份就要借重到MKPointAnnotation</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">thePlane</span> <span class="o">=</span> <span class="kt">MKPointAnnotation</span><span class="p">()</span>
<span class="n">thePlane</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">start</span> <span class="c1">//給定起始座標</span>
        
<span class="n">mapView</span><span class="o">.</span><span class="nf">addAnnotation</span><span class="p">(</span><span class="n">thePlane</span><span class="p">)</span>
</code></pre>
</div>

<p>一樣, 這邊如果沒告訴MapView怎畫這Annotation, 它是會用預設的取代, 因此我們一樣要去實作MKMapViewDelegate</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">mapView</span><span class="p">(</span><span class="n">_</span> <span class="nv">mapView</span><span class="p">:</span> <span class="kt">MKMapView</span><span class="p">,</span> <span class="n">viewFor</span> <span class="nv">annotation</span><span class="p">:</span> <span class="kt">MKAnnotation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">MKAnnotationView</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">planeIdentifier</span> <span class="o">=</span> <span class="s">"Plane"</span>
    
    <span class="k">let</span> <span class="nv">annotationView</span> <span class="o">=</span> <span class="n">mapView</span><span class="o">.</span><span class="nf">dequeueReusableAnnotationView</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="n">planeIdentifier</span><span class="p">)</span>
        <span class="p">??</span> <span class="kt">MKAnnotationView</span><span class="p">(</span><span class="nv">annotation</span><span class="p">:</span> <span class="n">annotation</span><span class="p">,</span> <span class="nv">reuseIdentifier</span><span class="p">:</span> <span class="n">planeIdentifier</span><span class="p">)</span>
    
    <span class="n">annotationView</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="kt">UIImage</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"ic_flight_48pt"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">annotationView</span>
<span class="p">}</span>
</code></pre>
</div>

<p>這邊用一個UIImage來指定飛機的圖標</p>

<h4 id="section-4">地圖視角</h4>

<p>把飛機置於地圖正中央, 我們才看得到他, 因此, 需要設定可視的區域, 包含中心點跟範圍, 如下:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">span</span> <span class="o">=</span> <span class="kt">MKCoordinateSpanMake</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">region1</span> <span class="o">=</span> <span class="kt">MKCoordinateRegion</span><span class="p">(</span><span class="nv">center</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span> <span class="nv">span</span><span class="p">:</span> <span class="n">span</span><span class="p">)</span>
<span class="k">self</span><span class="o">.</span><span class="n">mapView</span><span class="o">.</span><span class="nf">setRegion</span><span class="p">(</span><span class="n">region1</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="section-5">沿著線飛</h4>

<p>這時候要利用到 perform(#selector(updatePlane), with: self, afterDelay: 0.4) 讓它每隔0.4秒去更新一次飛機位置, 直到到終點為止, 當然也要一直更新region, 以讓飛機維持在正中央</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">updatePlane</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">planePositionIndex</span> <span class="o">=</span> <span class="n">planePositionIndex</span> <span class="o">+</span> <span class="n">step</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">planePositionIndex</span> <span class="o">&gt;=</span> <span class="n">geodesicPolyline</span><span class="o">!.</span><span class="n">pointCount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//plane has reached end, stop moving</span>
        <span class="n">planePositionIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">let</span> <span class="nv">s</span> <span class="o">=</span> <span class="mf">8.0</span>
    
    <span class="k">let</span> <span class="nv">nextMapPoint</span> <span class="o">=</span> <span class="n">geodesicPolyline</span><span class="p">?</span><span class="o">.</span><span class="nf">points</span><span class="p">()[</span><span class="n">planePositionIndex</span><span class="p">]</span>

    <span class="n">thePlane</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">=</span> <span class="kt">MKCoordinateForMapPoint</span><span class="p">(</span><span class="n">nextMapPoint</span><span class="o">!</span><span class="p">)</span> 
    <span class="n">mapView</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="kt">MKCoordinateRegionMake</span><span class="p">(</span><span class="n">thePlane</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="kt">MKCoordinateSpan</span><span class="p">(</span><span class="nv">latitudeDelta</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="nv">longitudeDelta</span><span class="p">:</span> <span class="n">s</span><span class="p">))</span>

    <span class="nf">perform</span><span class="p">(</span><span class="kd">#selector(</span><span class="nf">updatePlane</span><span class="kd">)</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">afterDelay</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="section-6">結果</h3>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/GSAd1Vygkhw" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>這邊有幾個缺點尚待改進</p>

<ol>
  <li>飛機閃爍</li>
  <li>如果把可視區域範圍縮小, 或是位置更新過快, 就會造成地圖來不及載入的現象(可能需要預跑幾次將map tile載入cache內)</li>
  <li>飛機頭永遠保持往上, 應該要朝著線方向轉</li>
</ol>

<h3 id="section-7">完整程式碼</h3>

<noscript><pre>//
//  ViewController.swift
//  mapanitest
//
//  Created by Julian Shen on 2016/10/4.
//  Copyright © 2016年 cowbay.wtf. All rights reserved.
//

import UIKit
import MapKit
import LocationPickerViewController

class ViewController: UIViewController, MKMapViewDelegate {
    @IBOutlet weak var mapView: MKMapView!
    
    
    var planePositionIndex:Int = 0
    var geodesicPolyline:MKGeodesicPolyline?
    let thePlane = MKPointAnnotation()
    var startloc, endloc: CLLocationCoordinate2D?
    var step:Int = 50
    
    override func viewDidLoad() {
        super.viewDidLoad()
        // Do any additional setup after loading the view, typically from a nib.
        print(&quot;view did load&quot;)
        
        mapView.delegate = self
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    func updatePlane() {
        planePositionIndex = planePositionIndex + step;
        
        if (planePositionIndex &gt;= geodesicPolyline!.pointCount)
        {
            //plane has reached end, stop moving
            planePositionIndex = 0
            return;
        }
        
        let s = 8.0
        
        let nextMapPoint = geodesicPolyline?.points()[planePositionIndex]
        
        thePlane.coordinate = MKCoordinateForMapPoint(nextMapPoint!)
        
        mapView.region = MKCoordinateRegionMake(thePlane.coordinate, MKCoordinateSpan(latitudeDelta: s, longitudeDelta: s))

        perform(#selector(updatePlane), with: self, afterDelay: 0.4)
    }
    
    func mapView(_ mapView: MKMapView, rendererFor overlay: MKOverlay) -&gt; MKOverlayRenderer {
        guard let polyline = overlay as? MKPolyline else {
            return MKOverlayRenderer()
        }
        
        let renderer = MKPolylineRenderer(polyline: polyline)
        renderer.lineWidth = 3.0
        renderer.alpha = 0.5
        renderer.strokeColor = UIColor.blue
        
        return renderer
    }
    
    func mapView(_ mapView: MKMapView, viewFor annotation: MKAnnotation) -&gt; MKAnnotationView? {
        let planeIdentifier = &quot;Plane&quot;
        
        let annotationView = mapView.dequeueReusableAnnotationView(withIdentifier: planeIdentifier)
            ?? MKAnnotationView(annotation: annotation, reuseIdentifier: planeIdentifier)
        
        annotationView.image = UIImage(named: &quot;ic_flight_48pt&quot;)
        
        return annotationView
    }
    
    @IBAction func pickLocation(_ sender: AnyObject) {
        let button = sender as! UIButton
        
        
        let locationPicker = LocationPicker()
        locationPicker.pickCompletion = { (pickedLocationItem) in
            // Do something with the location the user picked.
            print(pickedLocationItem.coordinate)
            print(button.accessibilityIdentifier)
            
            let coord = pickedLocationItem.coordinate!
            
            if button.accessibilityIdentifier == &quot;startloc&quot; {
                self.startloc = CLLocationCoordinate2D(latitude: coord.latitude, longitude: coord.longitude)
            } else if button.accessibilityIdentifier == &quot;endloc&quot; {
                self.endloc = CLLocationCoordinate2D(latitude: coord.latitude, longitude: coord.longitude)
            }
        }
        locationPicker.addBarButtons()
        
        let navigationController = UINavigationController(rootViewController: locationPicker)
            present(navigationController, animated: true) {
        }

        
    }
    
    @IBAction func displayPath(_ sender: AnyObject) {
        guard let sl = startloc else {
            print(&quot;error: no startloc&quot;)
            return
        }
        
        guard let el = endloc else {
            print(&quot;error: no endloc&quot;)
            return
        }
        
        let coordinates = [sl, el]
        
        if let gl = geodesicPolyline {
            mapView.remove(gl)
        }
        
        geodesicPolyline = MKGeodesicPolyline(coordinates: coordinates, count: 2)
        
        print(geodesicPolyline!.pointCount)
        step = geodesicPolyline!.pointCount/(Int)(20/0.4)
        mapView.add(geodesicPolyline!)
        
        thePlane.coordinate = sl
        
        mapView.addAnnotation(thePlane)
        
        UIView.animate(withDuration: 1.5) {
            let span = MKCoordinateSpanMake(8.0, 8.0)
            let region1 = MKCoordinateRegion(center: sl, span: span)
            self.mapView.setRegion(region1, animated: true)
            
            self.perform(#selector(self.updatePlane), with: self, afterDelay: 0.4)
        }
    }
}

</pre></noscript>
<script src="https://gist.github.com/julianshen/229f4ac32b3893816bd7636b96fe6f7d.js"> </script>


  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-10-04T23:41:22+08:00"><a href="http://blog.jln.co/%E4%B8%80%E4%BA%9B%E5%81%9A%E7%88%AC%E8%9F%B2%E7%9A%84%E5%B7%A5%E5%85%B7%E8%88%87%E6%96%B9%E6%B3%95/">October 04, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~4 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/%E4%B8%80%E4%BA%9B%E5%81%9A%E7%88%AC%E8%9F%B2%E7%9A%84%E5%B7%A5%E5%85%B7%E8%88%87%E6%96%B9%E6%B3%95/" rel="bookmark" title="一些做爬蟲的工具與方法" itemprop="url">一些做爬蟲的工具與方法</a></h1>
    
  </header>
  <div class="entry-content">
    <p>之前寫了一些爬蟲, 想說來補一篇這樣的文章好了</p>

<p>可能是之前”所謂”的大數據(Big Data)太過流行, 以至於網路爬蟲好像是一種顯學, 隨便Google一下都可以找到一堆用python加上<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/#">BeautifulSoup</a>
相關的文章, 這可能也是因為, 現在網路上的資料, Open data的, 提供API的, 在比例上還是非常的少數, 但網頁的數量真的多到很難統計(想到早期還真是屈指可數)
要取得網頁內的內容, 解析HTML, 做字串的處理就是一個必要的基礎, 這也難怪python + <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/#">BeautifulSoup</a>
一直廣泛的被採用</p>

<p>不過, 當你真的去寫一個爬蟲, 突然就會發現了, 代誌不是這麼單純呀, 不是去抓個html回來解析一下就有自己想要的資料了呀, 而是會發現, 怎麼大家正正當當的網頁不寫,
一堆奇技淫巧, 繞來繞去的, 網頁廣告內容也一堆, 很多網頁都很難抓到自己想要的資料呀!!!</p>

<p>真的來說, 做爬蟲是一種Hacking的活動, 天下網頁萬萬種, 為了總總不同的目的, 早已不是幾個簡單的html標籤就做出來的了, 還搭配了很多程式的技巧在內,
因此要從裡面萃取資料出來, 常常還真的是要無所不用其極</p>

<h3 id="section">那到底做爬蟲會先需要懂什麼?</h3>

<ol>
  <li>HTML</li>
  <li>CSS</li>
  <li>DOM</li>
  <li>DOM Selectors</li>
  <li>Javascript</li>
  <li>Regular Expression (正規表示式)</li>
  <li>Chrome dev tool</li>
  <li>Curl</li>
</ol>

<p>以上這幾個東西可能是基本必須懂得, 而不是程式語言, 那反而其次, 很多程式語言都有很好的能力跟工具來做, 另外需要具備的是耐心, 眼力, 直覺, 和運氣</p>

<p>底下就拿我之前弄過的幾個東西當範例, 由於我寫比較多Go和nodejs, 所以就不用(主流的)Python來做範例了</p>

<h3 id="section-1">範例一 : 文章內容分析 (如新聞, 部落格文章等等)</h3>

<p>這應該是比較常見的應用, 單純抓取文章內容去做分析, 常碰到的麻煩是現在網站放了大大小小的(補釘)廣告, 那些跟內容不相干, 也不會是我們想拿來分析的目標</p>

<p>底下這個範例是從Yahoo! News的RSS抓取新聞文章連結, 再從這些連結的文章內找出關鍵字:</p>

<noscript><pre>package main

import (
	&quot;fmt&quot;

	&quot;github.com/SlyMarbo/rss&quot;
	&quot;github.com/julianshen/go-readability&quot;
	&quot;github.com/parnurzeal/gorequest&quot;
	&quot;github.com/yanyiwu/gojieba&quot;
)

func main() {
	x := gojieba.NewJieba()
	defer x.Free()

	feed, err := rss.Fetch(&quot;https://tw.news.yahoo.com/rss/finance&quot;)
	if err != nil {
		// handle error.
		fmt.Println(err)
		panic(1)
	}

	request := gorequest.New()
	for _, item := range feed.Items {
		_, body, err := request.Get(item.Link).End()

		if err == nil {
			doc, err := readability.NewDocument(body)

			if err == nil {
				keywords := x.ExtractWithWeight(doc.Text(), 5)
				fmt.Println(keywords)
			}
		}
	}
}</pre></noscript>
<script src="https://gist.github.com/julianshen/2c21aa1e83e1e7b20f0d2560600383f2.js"> </script>

<p>這段code非常的簡單, 主要也只用到以下這幾種東西:</p>

<ol>
  <li>rss parser</li>
  <li><a href="https://github.com/mauidude/go-readability">go-readability</a></li>
  <li><a href="https://github.com/yanyiwu/gojieba">結巴</a></li>
</ol>

<p>簡單的來說就是先從rss內找出所有新聞的連結再一個個去爬, 然後用<a href="https://github.com/mauidude/go-readability">go-readability</a>精簡出網頁內文, 再用<a href="https://github.com/yanyiwu/gojieba">結巴</a>取出關鍵字</p>

<h4 id="readability">readability</h4>

<p>這一個library以往的用途就是清除不必要的html tags跟內容(像是廣告), 只留下易讀的內文（純文字), 以這個例子來說, 這是一個最適合的工具了</p>

<p>最早的readability應該是<a href="https://www.readability.com/arc90/">arc90</a>這人開源出來的, 最早應該是javascript的版本, 
但就算你不是用javascript, 它老早也被翻唱成其他語言的版本了, 像是:</p>

<ol>
  <li>Python - <a href="https://github.com/timbertson/python-readability">python-readability</a></li>
  <li>Node.js - <a href="https://github.com/luin/readability">node.js readability</a></li>
  <li>Java - <a href="https://github.com/wuman/JReadability">JReadability</a> 和  <a href="https://github.com/karussell/snacktory">snacktory</a></li>
  <li>Go - <a href="https://github.com/mauidude/go-readability">go-readability</a></li>
</ol>

<h4 id="jieba">結巴 jieba</h4>

<p><a href="https://github.com/fxsjy/jieba">結巴 jieba</a> 是一個用在做中文分詞的工具, 英文每個單詞都是用空白分開的, 但中文就不是那麼回事了, <a href="https://github.com/fxsjy/jieba">結巴 jieba</a> 可以幫忙作掉這部份的工作, 這可以拿來做文章分析或是找關鍵字用</p>

<p>一樣有好幾種語言的版本 - Java, C++, Node.js, Erlang, R, iOS, PHP, C#, Go (參照結巴的說明內文), 算蠻齊全的了</p>

<h3 id="bilibili">範例二 : 抓取Bilibili的視訊檔位址</h3>

<p>這個範例稍微做了點弊, 但還是從頭把分析過程來講一下好了</p>

<p>Bilibili視頻網頁長得就像這樣: <a href="http://www.bilibili.com/video/av6467776/">範例 - http://www.bilibili.com/video/av6467776/</a></p>

<p>先簡單的從網址猜一下….”av6467776”應該是某個ID之類的東西, 再進一步, ID可能就是這個”6467776”</p>

<p>接下來我們就需要借助一下<a href="https://developer.chrome.com/devtools">Chrome的”開發人員工具”</a>, 這是一個強大也重要的工具, 不要只傻傻的用View source而已, View source能看到的也只有原始HTML的內容</p>

<p>開了網頁後, 用Ctrl+Shift+I (windows)或是Cmd+Opt+I (mac)打開他, 打開後先選到elements, 像這樣:</p>

<p><img src="/images/posts/crw_1.jpg" alt="Chrome devtools elements" /></p>

<p>這邊標示了四個部分, 先點選了<strong>1</strong>, 再用滑鼠游標點你想知道的元件(以這邊來說是那個視訊框 <strong>2</strong> 的地方), 然後他就會幫你跳到相關的HTML位置（如<strong>3</strong>), 而<strong>4</strong>所標示出的是css屬性</p>

<p>把object這部份點開, 果然, 在flashvars那邊我們可以找到”cid=10519268&amp;aid=6467776&amp;pre_ad=0”這樣的字串, 表示”6467776”的確是某種叫aid的東西,
但, 這不代表找到結案了!! 我們再用curl檢查一下:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl http://www.bilibili.com/video/av6467776/ --compressed
</code></pre>
</div>

<p>抓原始的html檔來比對一下(可以把這指令的輸出存成檔案在來看會方便點), 怎麼沒”object”這標籤呀?到哪去了?可見剛剛那段html是某段javascript去產生的</p>

<p>再回頭看DevTools上object那段, 可以發現它是一個div包起來的, 這div的class是scontent, id是bofqi, 再回頭去看原始的HTML, 整段也只有一個這樣的block, 內容是這樣:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"scontent"</span> <span class="na">id=</span><span class="s">"bofqi"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'player_placeholder'</span> <span class="na">class=</span><span class="s">'player'</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">'text/javascript'</span><span class="nt">&gt;</span><span class="nx">EmbedPlayer</span><span class="p">(</span><span class="s1">'player'</span><span class="p">,</span> <span class="s2">"http://static.hdslb.com/play.swf"</span><span class="p">,</span> <span class="s2">"cid=10519268&amp;aid=6467776&amp;pre_ad=0"</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>OK, 這邊就很容易可以確定從scontent這區塊就可以找到兩個id - aid和cid , 但這能做什麼用? 還不知道</p>

<p>接著切換到Network那邊去, 然後再重新整理一下頁面:</p>

<p><img src="/images/posts/crw_2.jpg" alt="Chrome devtools network" /></p>

<p>左下角的部分是瀏覽器在畫出這個頁面所載入的內容跟檔案, 一開使用時序排序的, 當然你可以用其他方式排序, 這邊就是可以挖寶的地方了</p>

<p>先看到上面那一堆長長短短的線, 這是瀏覽器載入檔案的時間線, 點選這邊可以只看特定時間區間的部分, 最後面可以發現有一條長長的藍線, 那可能就是視訊檔了(因為通常較大), 因此我們可知這視訊檔的URL是</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http://61.221.181.215/ws.acgvideo.com/3/46/10519268-1.flv?wsTime=1475663926&amp;wsSecret2=893ba83b8f13d8700d2ae0cddab96c55&amp;oi=3699654085&amp;rate=0&amp;wshc_tag=0&amp;wsts_tag=57f467b8&amp;wsid_tag=dc843dc5&amp;wsiphost=ipdbm
</code></pre>
</div>

<p>但這串怎麼來的, 依我們手上只有兩個id的資訊是拼湊不起來的, 它一定從某個地方由這兩個id轉換出來的(合理的猜測), 因此, 我們可以再把aid, cid拿去搜尋檔案(點選檔案列表那區塊, 按ctrl-f或command-f開搜尋框)</p>

<p>一個個看, 找出可能的檔案, 由於aid可以找出22個結果而cid只有10個, 從cid開始找起會比較簡單點, 這邊篩選出幾個可能性:</p>

<ol>
  <li>http://interface.bilibili.com/player?id=cid:10519268&amp;aid=6467776 - 回傳是一個xml, 有一些相關資訊, 但沒影片位址</li>
  <li>http://interface.bilibili.com/playurl?accel=1&amp;cid=10519268&amp;player=1&amp;ts=1475635126&amp;sign=e1e2ae9d2d34e4be94f46f77a4a107ce - 從這回傳裡面有個durl &gt; url, 跟上面url比對, 似乎就是他了, 後面再來講這段</li>
  <li>http://comment.bilibili.com/playtag,10519268 - 這應該是”看过该视频的还喜欢”裡的內容</li>
  <li>http://comment.bilibili.com/10519268.xml - 喔喔喔, 看起來這就是彈幕檔喔!</li>
  <li>http://comment.bilibili.com/recommendnew,6467776 - 這似乎是推薦視頻的內容</li>
  <li>http://api.bilibili.com/x/tag/archive/tags?jsonp=jsonp&amp;aid=6467776&amp;nomid=1 - 看起來這是tag</li>
</ol>

<p>看來, <strong>2</strong> 應該就是我們所要的了, 不過這邊有兩個麻煩, 一個是…我討厭XML!!!!!不過這好像還好, 似乎有個HTML5版本, 點點看好了, 果不其然, 發現另一個:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>https://interface.bilibili.com/playurl?cid=10519268&amp;appkey=6f90a59ac58a4123&amp;otype=json&amp;type=flv&amp;quality=3&amp;sign=571f239a0a3d4c304e8ea0e0f255992a
</code></pre>
</div>

<p>表示我們是可以用otype=json來抓取json格式的, 但後面這個更麻煩了, 那個sign是什麼東西? 從他有個appkey來看, 合理的猜測, 他是某種API的signature, 通常這種東西的規則是把所有的參數先依名字排序成新的query string, 加上某個secret, 再算出他的MD5即是他的sign</p>

<p>但如果真是這樣, 這下有點麻煩, 到哪裡找這個secret, 不過凡走過必有痕跡, 這串既然是由瀏覽器端產生的, 那應該會在哪裡找到點線索, 或許可以先用appkey的內容去每個javascript檔案搜尋吧</p>

<p>不過, 不出所料, 找不到, 那, 還有一個可能性, 它寫在flash內, 從上面抓到的資訊來看, 他的flash檔案應該是: http://static.hdslb.com/play.swf</p>

<p>可以把它抓回來反編譯(decompile), 有個工具叫<a href="https://www.free-decompiler.com/flash/">JPEX Flash decompiler</a>的, 可以做到這件事</p>

<p><img src="/images/posts/crw_3.jpg" alt="JPEX" /></p>

<p>在script裡面有它的程式原始碼, 應該可以在裡面找到, 不過有點辛苦, 因為你也沒辦法從appkey找到那個secret, 這邊直接跳轉答案, 應該就如同截圖所示是”com.bilibili.interfaces.getSign”這邊, 只是被混淆到很難看, 看得很頭痛, 會短命的</p>

<p>理論上, 把這段源碼翻譯一遍後應該就解決了, 但一來我看不太懂action script, 二來我實在懶得看, 想偷懶, 有沒作弊的方法? 凡走過必留下痕跡嘛, 一定還會有前人走過這條路, 所以直接把”6f90a59ac58a4123”這串appkey拿去搜尋, 果然, 找到secret了, 寫個程式驗證一下, 果然是沒錯的</p>

<noscript><pre>package main

import (
	&quot;crypto/md5&quot;
	&quot;encoding/json&quot;
	&quot;errors&quot;
	&quot;fmt&quot;
	&quot;io&quot;
	&quot;log&quot;
	&quot;regexp&quot;
	&quot;sort&quot;
	&quot;strings&quot;

	&quot;github.com/PuerkitoBio/goquery&quot;
	&quot;github.com/parnurzeal/gorequest&quot;
)

type DocId struct {
	CID string
	AID string
}

const (
	APP_KEY  = &quot;6f90a59ac58a4123&quot;
	APP_SEC  = &quot;0bfd84cc3940035173f35e6777508326&quot;
	BASE_URL = &quot;https://interface.bilibili.com/playurl&quot;
)

func signParam(param map[string]string) {
	param[&quot;appkey&quot;] = APP_KEY

	keys := make([]string, len(param))

	i := 0
	for k, _ := range param {
		keys[i] = k
		i++
	}

	sort.Strings(keys)

	data := &quot;&quot;
	for _, v := range keys {
		if data != &quot;&quot; {
			data += &quot;&amp;&quot;
		}
		data += v + &quot;=&quot; + param[v]
	}
	data += APP_SEC
	param[&quot;sign&quot;] = fmt.Sprintf(&quot;%x&quot;, md5.Sum([]byte(data)))
}

func parseId(id string) (*DocId, error) {
	url := fmt.Sprintf(&quot;http://www.bilibili.com/video/av%s&quot;, id)
	doc, err := goquery.NewDocument(url)

	if err != nil {
		return nil, err
	}

	sel := doc.Find(&quot;.scontent&gt;script&quot;)
	if sel != nil {
		script := sel.Text()
		regex := regexp.MustCompile(&quot;cid=(\\d+)&amp;aid=(\\d+)&amp;pre_ad=.*&quot;)

		result := regex.FindStringSubmatch(script)
		if result == nil {
			return nil, errors.New(&quot;ID not found&quot;)
		}

		var id DocId
		id.CID = result[1]
		id.AID = result[2]

		return &amp;id, nil
	} else {
		return nil, errors.New(&quot;ID not found&quot;)
	}
}

func GrabVideoUrl(aid string) (string, error) {
	id, err := parseId(aid)

	if err != nil {
		return &quot;&quot;, err
	}

	var param map[string]string = make(map[string]string)
	param[&quot;cid&quot;] = id.CID
	param[&quot;otype&quot;] = &quot;json&quot;
	param[&quot;type&quot;] = &quot;mp4&quot;
	param[&quot;quality&quot;] = &quot;3&quot;

	signParam(param)

	data := &quot;&quot;
	for k, v := range param {
		if data != &quot;&quot; {
			data += &quot;&amp;&quot;
		}
		data += k + &quot;=&quot; + v
	}

	url := fmt.Sprintf(&quot;%s?%s&quot;, BASE_URL, data)
	request := gorequest.New()
	_, body, errs := request.Get(url).End()

	if errs != nil &amp;&amp; len(errs) &gt; 0 {
		return &quot;&quot;, errs[0]
	}

	//log.Println(body)
	dec := json.NewDecoder(strings.NewReader(body))
	video_url := &quot;&quot;
	for {
		t, err := dec.Token()
		if err == io.EOF {
			break
		}

		if err != nil {
			return &quot;&quot;, err
		}
		//fmt.Printf(&quot;%T: %v&quot;, t, t)
		if t == &quot;url&quot; {
			t, err := dec.Token()
			if err != nil {
				return &quot;&quot;, err
			}
			video_url = fmt.Sprintf(&quot;%v&quot;, t)
		}

		//fmt.Printf(&quot;\n&quot;)
	}

	return video_url, nil
}

func main() {
	//url := &quot;http://www.bilibili.com/video/av6467776/&quot;
	url, _ := GrabVideoUrl(&quot;6467776&quot;)
	log.Println(url)
}
</pre></noscript>
<script src="https://gist.github.com/julianshen/137c3584ef805ae5cf74147ae737b697.js"> </script>

<h3 id="http8dramacom">範例三: <a href="http://8drama.com">楓林網</a></h3>

<p><a href="http://8drama.com">楓林網</a>是一個非法的電視劇來源, 有相當齊全的電視劇內容, 我這個是之前寫的一個工具了, 可以把一整部劇可以抓回本地端, 原始碼跟使用方法在這:</p>

<ul>
  <li><a href="https://github.com/julianshen/d8">d8 - https://github.com/julianshen/d8</a></li>
</ul>

<p>這邊就不再說明怎麼使用它了, 主要著重它是怎做出來的, 這一個跟上面幾個不一樣的地方在於我是用nodejs寫的, 之所以用nodejs是有原因的, 後面再解釋, 主要的程式碼在<a href="https://github.com/julianshen/d8/blob/master/88.js">88.js</a></p>

<p>楓林網的電視劇集的網址長成這樣: http://8drama.com/178372/ , 當然178372又是ID了, 但它裡面所有的東西ID長得都是一個樣, 一整部劇跟單一集的ID都是同一個格式, 所以是無法從ID判斷出他是哪類</p>

<p>一樣打開Chrome DevTools, 點選到每一集的列表區塊, 我們可以發現在”&lt;div class="entry-content rich-content"&gt;“裡面的&lt;td&gt;可以找到每一集的URL, 而他的格式都是http://8drama.com/(ID), 所以我們可以輕易的用regular expression分辨出來</p>

<p>接下來就要掃每一集的內容把影片檔找出來了</p>

<p>當然可以用前面的方法試試看, 不過那方法在這邊沒啥用, 因為這邊影片的網址編碼是用好多亂七八糟的javascript堆積起來, 沒記錯的話, 我是從<a href="http://8drama.com/play5/video.js">video.js</a>找到線索的(這有點時間之前做的了, 有點沒印象了)</p>

<p>所以該怎麼面對那一大段javascript的code呢? 這就是我這工具為何選nodejs的原因了, 抄過來就好了!!! 去除掉跟瀏覽器相關的部分, 它就是不折不扣nodejs可以跑的程式碼, 所以這也就是<a href="https://github.com/julianshen/d8/blob/master/88.js">88.js</a>一些怪怪程式碼的由來</p>

<p>除了這版本外, 我本來也有想要做一個Java的版本, 做了一半, 用Java也是可以用類似的技巧, 不過就得要導入Javascript的runtime了, 而我採用的是<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino">Mozilla Rhino</a></p>

<h3 id="section-2">更進階一點的</h3>

<p>做爬蟲大部分的時間都是要跟html, javascript, css這類的東西搏鬥, 但其實很多東西本來就是原本瀏覽器就會處理的, 因此如果可以直接用瀏覽器或甚至是WebKit來處理, 可以處理的事應該就會多一點, 這時候就可以利用所謂的Headless browser來簡化, 這種東西本來是用在網頁自動化測試的, 不過, 用在這應用也一樣強大, 這類的解決方案有:</p>

<ol>
  <li><a href="http://phantomjs.org/">Phantomjs</a> - 這是以WebKit為基礎的, 我比較常用</li>
  <li><a href="http://slimerjs.org/">Slimerjs</a> - 這是以Mozilla Geco為基礎的</li>
  <li><a href="http://www.seleniumhq.org/">Selenium</a></li>
  <li><a href="https://github.com/sourcegraph/webloop">Webloop</a> - Go版本的</li>
</ol>

<p>關於<a href="http://phantomjs.org/">Phantomjs</a>的應用, 我很久之前已經有寫過一篇了:</p>

<p><a href="http://blog.jln.co/颱風天的宅code教學-抓漫畫/">颱風天的宅code教學: 抓漫畫</a></p>

<h3 id="android">Android上呢?</h3>

<p>Java上, 大多是用<a href="https://jsoup.org/">jsoup</a>來解析html的, 像我之前這篇:</p>

<p><a href="http://blog.jln.co/android-土製play-store-api/">[Android] 土製Play store API</a></p>

<p>當然應該也是可以用Webkit/WebView做成headless的解決方案, 不過這部份我目前還沒試過, 留待以後有機會再試吧</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-30T21:47:36+08:00"><a href="http://blog.jln.co/android-%E4%BD%BF%E7%94%A8retrofit%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8Dman-in-the-middle%E6%94%BB%E6%93%8A/">September 30, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/android-%E4%BD%BF%E7%94%A8retrofit%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8Dman-in-the-middle%E6%94%BB%E6%93%8A/" rel="bookmark" title="[Android] 使用Retrofit如何避免Man in the middle攻擊" itemprop="url">[Android] 使用Retrofit如何避免Man in the middle攻擊</a></h1>
    
  </header>
  <div class="entry-content">
    <p>前幾天看到朋友寫如何用<a href="https://www.charlesproxy.com">Charles Proxy</a>來debug REST API, 
突然就想到了這個問題, <a href="https://www.charlesproxy.com">Charles Proxy</a>是一個不錯的工具, 我自己也蠻常用的
, 除了可以用來debug HTTP以外, 其實HTTPS也可以(參照<a href="https://www.charlesproxy.com/documentation/proxying/ssl-proxying/">SSL proxying</a>)
, 只要在手機上安裝好它的SSL certificate即可</p>

<p>不過這不是這篇要講的重點, 這種debugging的方式原理即是用Proxy作為一個中間人來紀錄HTTP/HTTPS的傳輸內容
, 這也帶來一個問題, 也就是你的資料是可以這樣簡單的暴露出去, 這種即是所謂的MITM (Man in the middle) 中間人攻擊</p>

<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.js"></script>
<div class="mermaid">
graph LR;
    Client--&gt;Proxy[Proxy - Middle man];
    Proxy[Proxy - Middle man]--&gt;Client;
    Proxy[Proxy - Middle man]--&gt;Server;
    Server--&gt;Proxy[Proxy - Middle man];
</div>

<p>一般來說, 用了SSL/HTTPS後, 也不是那麼容易安插一個中間人的 ,像<a href="https://www.charlesproxy.com">Charles Proxy</a>這樣的東西,
還是需要使用者自己去手機上的安全性設定裝信任憑證(trusted certificate), 一般常見的問題反而來自於開發者本身
, 很多人常以為走了HTTPS就安全了, 卻常常為了debug方便, 或是省錢用Self-signed certificate 而去覆寫了系統預設的
X509TrustManager, 以至於整個檢查機制被跳過, 真的漏洞都來自於人的惰性,
更多資訊可以參考:</p>

<ol>
  <li><a href="https://security.tencent.com/index.php/blog/msg/41">窃听风暴： Android平台https嗅探劫持漏洞</a></li>
  <li><a href="http://yaq.qq.com/blog/13">Android安全之Https中间人攻击漏洞</a></li>
  <li><a href="http://www.droidsec.cn/android-https中间人劫持漏洞浅析/">Android HTTPS中间人劫持漏洞浅析</a></li>
  <li><a href="http://blog.csdn.net/u013107656/article/details/52036158">Android客户端安全 -&gt; HTTPS敏感数据劫持漏洞</a></li>
  <li><a href="http://pingguohe.net/2016/02/26/Android-App-secure-ssl.html">Android App 安全的HTTPS 通信</a></li>
  <li><a href="http://devco.re/blog/2014/08/15/ssl-mishandling-on-mobile-app-development/">手機應用程式開發上被忽略的 SSL 處理</a></li>
  <li><a href="https://blog.heckel.xyz/2013/07/01/how-to-use-mitmproxy-to-read-and-modify-https-traffic-of-your-phone/">How To: Use mitmproxy to read and modify HTTPS traffic</a></li>
  <li><a href="http://www.7xter.com/2015/07/intercepting-android-ssl-traffic.html">INTERCEPTING ANDROID SSL / HTTPS TRAFFIC</a></li>
</ol>

<p>該避免去寫的, 就該避掉, 以免產生不必要的漏洞, 但不過也有可能碰到使用者的手機被(有意/無意)安裝了攻擊者的憑證到系統的信任憑證中, 
那麼碰到這種, 應用程式本身該如何保護自己?</p>

<p>這邊有兩個方式可以採用 -</p>

<ol>
  <li>certificate pinning</li>
  <li>在程式中寫死certificate</li>
</ol>

<p>以下的範例以Android最紅, 常被使用的<a href="https://square.github.io/retrofit/">Retrofit</a>為範例(雖說是<a href="https://square.github.io/retrofit/">Retrofit</a>, 但其實是在<a href="https://github.com/square/okhttp">okhttp</a>動的手腳)</p>

<h4 id="certificate-pinning">Certificate Pinning</h4>

<p>或叫<a href="https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning">HTTP Public Key Pinning (HPKP)</a>, 
簡單的說, 就是在程式內綁定Certificate的public key, 如果今天中間人存在, certificate不同了, 連接就不會成功</p>

<p>先來看範例</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">certificatePinner</span><span class="o">(</span><span class="k">new</span> <span class="n">CertificatePinner</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"cdn.rawgit.com"</span><span class="o">,</span> <span class="s">"sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U="</span><span class="o">).</span><span class="na">build</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">Retrofit</span> <span class="n">retrofit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Retrofit</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">"https://cdn.rawgit.com/julianshen/cpblschedule/"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addConverterFactory</span><span class="o">(</span><span class="n">GsonConverterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
        <span class="o">.</span><span class="na">client</span><span class="o">(</span><span class="n">client</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</div>

<p>這邊所動的手腳(<del>跟Retrofit沒啥鳥關係</del>)是在OkHttpClient上加上一個CertificatePinner,
利用了certificate pinner加上了一個host name跟public key的對應,
以這例子來說: <strong>“sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=”</strong> 這個public key對應的是 <strong>“cdn.rawgit.com”</strong>
, 因此碰到”cdn.rawgit.com”來的url, 會檢查public key是否符合,
這邊public key的參數字串是要以”sha1/”或”sha256/”開始的, 依使用的演算法而不同</p>

<p>但又要怎取得這串”天書”呢?</p>

<p>很簡單, 首先確認你的電腦裡面有沒安裝openssl , 有的話就用以下的指令:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>openssl s_client -connect cdn.rawgit.com:443 -servername cdn.rawgit.com | openssl x509 -pubkey -noout | openssl rsa -pubin -outform der | openssl
dgst -sha256 -binary | openssl enc -base64
</code></pre>
</div>

<p>最後產生的內容如下</p>

<div class="highlighter-rouge"><pre class="highlight"><code>depth=2 /C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
verify error:num=20:unable to get local issuer certificate
verify return:0
writing RSA key
p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=
</code></pre>
</div>

<p>所以我們要填的參數就是 <strong>“sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=”</strong></p>

<p>關於HPKP的openssl相關的指令可以參考<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Public_Key_Pinning">Public Key Pinning</a></p>

<p>如果你用<a href="https://www.charlesproxy.com">Charles Proxy</a>當中間人來測試這段程式的話, 你會得到下面這樣的exception</p>

<div class="highlighter-rouge"><pre class="highlight"><code>javax.net.ssl.SSLPeerUnverifiedException: Certificate pinning failure!
                                            Peer certificate chain:
                                            sha256/ENlqFHtfARof3AK50Hbc1sj47M5hWhc5kQ5Z2vyfxq4=: CN=rawgit.com,OU=PositiveSSL Multi-Domain,OU=Domain Control Validated
                                            sha256/mXmLzo8k5ANwi11PlLSW/b4OC/Anjw1OeACDyZxD/WM=: C=NZ,ST=Auckland,L=Auckland,O=XK72 Ltd,OU=http://charlesproxy.com/ssl,CN=Charles Proxy Custom Root Certificate (built on Jlnmbp-retina.local\, 11 十二月 2015)
                                            Pinned certificates for cdn.rawgit.com:
                                            sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=
</code></pre>
</div>

<h4 id="certificate">在程式中寫死certificate</h4>

<p>這方法聽起來暴力了一點, 但原理其實跟前一個沒啥太大差別, 只是一個寫死public key一個寫死certificate</p>

<p>一樣先來看個範例:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">String</span> <span class="n">cert</span> <span class="o">=</span> <span class="s">""</span>
        <span class="o">+</span><span class="s">"-----BEGIN CERTIFICATE-----\n"</span>
        <span class="o">+</span><span class="s">"MIIFdjCCBF6gAwIBAgIRAPbTBHdHHseM4hArA7n6uREwDQYJKoZIhvcNAQELBQAw\n"</span>
        <span class="o">+</span><span class="s">"gZAxCzAJBgNVBAYTAkdCMRswGQYDVQQIExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAO\n"</span>
        <span class="o">+</span><span class="s">"BgNVBAcTB1NhbGZvcmQxGjAYBgNVBAoTEUNPTU9ETyBDQSBMaW1pdGVkMTYwNAYD\n"</span>
        <span class="o">+</span><span class="s">"VQQDEy1DT01PRE8gUlNBIERvbWFpbiBWYWxpZGF0aW9uIFNlY3VyZSBTZXJ2ZXIg\n"</span>
        <span class="o">+</span><span class="s">"Q0EwHhcNMTYwMTAxMDAwMDAwWhcNMTcwMTEzMjM1OTU5WjBbMSEwHwYDVQQLExhE\n"</span>
        <span class="o">+</span><span class="s">"b21haW4gQ29udHJvbCBWYWxpZGF0ZWQxITAfBgNVBAsTGFBvc2l0aXZlU1NMIE11\n"</span>
        <span class="o">+</span><span class="s">"bHRpLURvbWFpbjETMBEGA1UEAxMKcmF3Z2l0LmNvbTCCASIwDQYJKoZIhvcNAQEB\n"</span>
        <span class="o">+</span><span class="s">"BQADggEPADCCAQoCggEBALD2sUNSYp2R+mSEMF2qKvMS780qTkltvqP4rwEGKOLV\n"</span>
        <span class="o">+</span><span class="s">"rR5QQWo8vzSlgZvxVsguRHi0pPBtVAH794L43tD+IuyQlDlNU2qc1aMqBkn3S2wN\n"</span>
        <span class="o">+</span><span class="s">"Way8BS9w80pgeFnObZiFJtPI9pdwcB72Bgq8Nlc25oVrDVWr/Q8nLIKS/9FkNs+C\n"</span>
        <span class="o">+</span><span class="s">"MPU00vGFZSFbR7s15ORj9+qPCskWZcHpQ+m9EKmZD3IVKj3QQyBD17cBoVkYoIpj\n"</span>
        <span class="o">+</span><span class="s">"I8/r+NfVfKetlsB7Pcv8P3yLFVFC4+PGrnW9TLZK9aRtbDTvjElXwCQIPK5B2fKw\n"</span>
        <span class="o">+</span><span class="s">"SJK26IJPDX0r1JkeuR53Afr509iEx3xAHcRz/kR5uo8CAwEAAaOCAf0wggH5MB8G\n"</span>
        <span class="o">+</span><span class="s">"A1UdIwQYMBaAFJCvajqUWgvYkOoSVnPfQ7Q6KNrnMB0GA1UdDgQWBBSI83Kqafo7\n"</span>
        <span class="o">+</span><span class="s">"kg9cmyT1vnceH4fAUjAOBgNVHQ8BAf8EBAMCBaAwDAYDVR0TAQH/BAIwADAdBgNV\n"</span>
        <span class="o">+</span><span class="s">"HSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwTwYDVR0gBEgwRjA6BgsrBgEEAbIx\n"</span>
        <span class="o">+</span><span class="s">"AQICBzArMCkGCCsGAQUFBwIBFh1odHRwczovL3NlY3VyZS5jb21vZG8uY29tL0NQ\n"</span>
        <span class="o">+</span><span class="s">"UzAIBgZngQwBAgEwVAYDVR0fBE0wSzBJoEegRYZDaHR0cDovL2NybC5jb21vZG9j\n"</span>
        <span class="o">+</span><span class="s">"YS5jb20vQ09NT0RPUlNBRG9tYWluVmFsaWRhdGlvblNlY3VyZVNlcnZlckNBLmNy\n"</span>
        <span class="o">+</span><span class="s">"bDCBhQYIKwYBBQUHAQEEeTB3ME8GCCsGAQUFBzAChkNodHRwOi8vY3J0LmNvbW9k\n"</span>
        <span class="o">+</span><span class="s">"b2NhLmNvbS9DT01PRE9SU0FEb21haW5WYWxpZGF0aW9uU2VjdXJlU2VydmVyQ0Eu\n"</span>
        <span class="o">+</span><span class="s">"Y3J0MCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5jb21vZG9jYS5jb20wSwYDVR0R\n"</span>
        <span class="o">+</span><span class="s">"BEQwQoIKcmF3Z2l0LmNvbYIVY2RuLW9yaWdpbi5yYXdnaXQuY29tgg5jZG4ucmF3\n"</span>
        <span class="o">+</span><span class="s">"Z2l0LmNvbYINcmF3Z2l0aHViLmNvbTANBgkqhkiG9w0BAQsFAAOCAQEASx3e6y9e\n"</span>
        <span class="o">+</span><span class="s">"9F67N5NIDausDHDL+/fz6uj2DDNJdaQvALAYDV8hKpz7+QGotlQfI042U2i83J7m\n"</span>
        <span class="o">+</span><span class="s">"DGZiKDpzaXa7IFfGiq6PFPUjntElHoU2E4vRb5LApg1sJ5YueYmRd3X7x0/jPYg6\n"</span>
        <span class="o">+</span><span class="s">"TiTtHyXOnlMuqL2FUYJM0BP7cMfOppvUF0R2zHUVA0rVHuLrSStg8bMg8aVUIkKg\n"</span>
        <span class="o">+</span><span class="s">"n3NS+eg4ofo95jaMRVykhLnylkYBk9dWBM6B19Yw7LgQd94MZSa+Xix4HxeFgvAM\n"</span>
        <span class="o">+</span><span class="s">"BF+oeDMaY7mEN4Xm5hnrIS1FElRDq/ckpDV8JVpR4SQqB+tzSZPPIiep8EvgRDzd\n"</span>
        <span class="o">+</span><span class="s">"2EkL187FF3MQ+w==\n"</span>
        <span class="o">+</span><span class="s">"-----END CERTIFICATE-----\n"</span><span class="o">;</span>

<span class="n">X509TrustManager</span> <span class="n">trustManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="n">CertificateFactory</span> <span class="n">certificateFactory</span> <span class="o">=</span> <span class="n">CertificateFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"X.509"</span><span class="o">);</span>
    <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Certificate</span><span class="o">&gt;</span> <span class="n">certificates</span> <span class="o">=</span> <span class="n">certificateFactory</span><span class="o">.</span><span class="na">generateCertificates</span><span class="o">(</span><span class="k">new</span> <span class="n">Buffer</span><span class="o">().</span><span class="na">writeUtf8</span><span class="o">(</span><span class="n">cert</span><span class="o">).</span><span class="na">inputStream</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">certificates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"expected non-empty set of trusted certificates"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"password"</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span> <span class="c1">// Any password will work.</span>
        <span class="n">KeyStore</span> <span class="n">keyStore</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">KeyStore</span><span class="o">.</span><span class="na">getDefaultType</span><span class="o">());</span>
        <span class="n">keyStore</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Certificate</span> <span class="n">certificate</span> <span class="o">:</span> <span class="n">certificates</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">certificateAlias</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">index</span><span class="o">++);</span>
            <span class="n">keyStore</span><span class="o">.</span><span class="na">setCertificateEntry</span><span class="o">(</span><span class="n">certificateAlias</span><span class="o">,</span> <span class="n">certificate</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">TrustManagerFactory</span> <span class="n">trustManagerFactory</span> <span class="o">=</span> <span class="n">TrustManagerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">TrustManagerFactory</span><span class="o">.</span><span class="na">getDefaultAlgorithm</span><span class="o">());</span>
        <span class="n">trustManagerFactory</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">keyStore</span><span class="o">);</span>

        <span class="n">TrustManager</span><span class="o">[]</span> <span class="n">trustManagers</span> <span class="o">=</span> <span class="n">trustManagerFactory</span><span class="o">.</span><span class="na">getTrustManagers</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">trustManagers</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!(</span><span class="n">trustManagers</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">instanceof</span> <span class="n">X509TrustManager</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unexpected default trust managers:"</span>
                    <span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">trustManagers</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">trustManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">X509TrustManager</span><span class="o">)</span> <span class="n">trustManagers</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>

        <span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span> <span class="n">SSLContext</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"TLS"</span><span class="o">);</span>
        <span class="n">sslContext</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">TrustManager</span><span class="o">[]</span> <span class="o">{</span> <span class="n">trustManager</span> <span class="o">},</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="n">sslContext</span><span class="o">.</span><span class="na">getSocketFactory</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CertificateException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">KeyStoreException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">KeyManagementException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>

<span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">sslSocketFactory</span><span class="o">(</span><span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">trustManager</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="n">Retrofit</span> <span class="n">retrofit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Retrofit</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">"https://cdn.rawgit.com/julianshen/cpblschedule/"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addConverterFactory</span><span class="o">(</span><span class="n">GsonConverterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
        <span class="o">.</span><span class="na">client</span><span class="o">(</span><span class="n">client</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</div>

<p>看到這麼長的東西大概就不會想看了吧?(老實說我也寫的很懶, 這邊要特別提到有用到一個Class叫做Buffer,這是來自於<a href="https://github.com/square/okio">okio</a>, 蠻方便的東西), 跟前一個不同的地方在於, 前一個利用了CertificatePinner,
而這一個則是改了sslSocketFactory的TrustManager(喂!!!前面不是隱約有提到這樣不太好?!),
這個TrustManager全部也只信任這一個certifcate, 如果碰到其他的, 就會發生以下的exception:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>javax.net.ssl.SSLHandshakeException: java.security.cert.CertPathValidatorException: Trust anchor for certification path not found.
        at com.android.org.conscrypt.OpenSSLSocketImpl.startHandshake(OpenSSLSocketImpl.java:328)
</code></pre>
</div>

<p>那, 上面那一大坨憑證資料是怎樣取得的? 方法其實差不多:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>openssl s_client -connect cdn.rawgit.com:443 -showcerts
</code></pre>
</div>

<p>會得到這樣的結果:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CONNECTED(00000003)
depth=2 /C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
verify error:num=20:unable to get local issuer certificate
verify return:0
---
Certificate chain
 0 s:/OU=Domain Control Validated/OU=PositiveSSL Multi-Domain/CN=rawgit.com
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
 1 s:/OU=Domain Control Validated/OU=PositiveSSL Multi-Domain/CN=rawgit.com
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
 2 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
 3 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
   i:/C=SE/O=AddTrust AB/OU=AddTrust External TTP Network/CN=AddTrust External CA Root
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIFdjCCBF6gAwIBAgIRAPbTBHdHHseM4hArA7n6uREwDQYJKoZIhvcNAQELBQAw
gZAxCzAJBgNVBAYTAkdCMRswGQYDVQQIExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAO
BgNVBAcTB1NhbGZvcmQxGjAYBgNVBAoTEUNPTU9ETyBDQSBMaW1pdGVkMTYwNAYD
VQQDEy1DT01PRE8gUlNBIERvbWFpbiBWYWxpZGF0aW9uIFNlY3VyZSBTZXJ2ZXIg
Q0EwHhcNMTYwMTAxMDAwMDAwWhcNMTcwMTEzMjM1OTU5WjBbMSEwHwYDVQQLExhE
b21haW4gQ29udHJvbCBWYWxpZGF0ZWQxITAfBgNVBAsTGFBvc2l0aXZlU1NMIE11
bHRpLURvbWFpbjETMBEGA1UEAxMKcmF3Z2l0LmNvbTCCASIwDQYJKoZIhvcNAQEB
BQADggEPADCCAQoCggEBALD2sUNSYp2R+mSEMF2qKvMS780qTkltvqP4rwEGKOLV
rR5QQWo8vzSlgZvxVsguRHi0pPBtVAH794L43tD+IuyQlDlNU2qc1aMqBkn3S2wN
Way8BS9w80pgeFnObZiFJtPI9pdwcB72Bgq8Nlc25oVrDVWr/Q8nLIKS/9FkNs+C
MPU00vGFZSFbR7s15ORj9+qPCskWZcHpQ+m9EKmZD3IVKj3QQyBD17cBoVkYoIpj
I8/r+NfVfKetlsB7Pcv8P3yLFVFC4+PGrnW9TLZK9aRtbDTvjElXwCQIPK5B2fKw
SJK26IJPDX0r1JkeuR53Afr509iEx3xAHcRz/kR5uo8CAwEAAaOCAf0wggH5MB8G
A1UdIwQYMBaAFJCvajqUWgvYkOoSVnPfQ7Q6KNrnMB0GA1UdDgQWBBSI83Kqafo7
kg9cmyT1vnceH4fAUjAOBgNVHQ8BAf8EBAMCBaAwDAYDVR0TAQH/BAIwADAdBgNV
HSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwTwYDVR0gBEgwRjA6BgsrBgEEAbIx
AQICBzArMCkGCCsGAQUFBwIBFh1odHRwczovL3NlY3VyZS5jb21vZG8uY29tL0NQ
UzAIBgZngQwBAgEwVAYDVR0fBE0wSzBJoEegRYZDaHR0cDovL2NybC5jb21vZG9j
YS5jb20vQ09NT0RPUlNBRG9tYWluVmFsaWRhdGlvblNlY3VyZVNlcnZlckNBLmNy
bDCBhQYIKwYBBQUHAQEEeTB3ME8GCCsGAQUFBzAChkNodHRwOi8vY3J0LmNvbW9k
b2NhLmNvbS9DT01PRE9SU0FEb21haW5WYWxpZGF0aW9uU2VjdXJlU2VydmVyQ0Eu
Y3J0MCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5jb21vZG9jYS5jb20wSwYDVR0R
BEQwQoIKcmF3Z2l0LmNvbYIVY2RuLW9yaWdpbi5yYXdnaXQuY29tgg5jZG4ucmF3
Z2l0LmNvbYINcmF3Z2l0aHViLmNvbTANBgkqhkiG9w0BAQsFAAOCAQEASx3e6y9e
9F67N5NIDausDHDL+/fz6uj2DDNJdaQvALAYDV8hKpz7+QGotlQfI042U2i83J7m
DGZiKDpzaXa7IFfGiq6PFPUjntElHoU2E4vRb5LApg1sJ5YueYmRd3X7x0/jPYg6
TiTtHyXOnlMuqL2FUYJM0BP7cMfOppvUF0R2zHUVA0rVHuLrSStg8bMg8aVUIkKg
n3NS+eg4ofo95jaMRVykhLnylkYBk9dWBM6B19Yw7LgQd94MZSa+Xix4HxeFgvAM
BF+oeDMaY7mEN4Xm5hnrIS1FElRDq/ckpDV8JVpR4SQqB+tzSZPPIiep8EvgRDzd
2EkL187FF3MQ+w==
-----END CERTIFICATE-----
subject=/OU=Domain Control Validated/OU=PositiveSSL Multi-Domain/CN=rawgit.com
issuer=/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
---
No client certificate CA names sent
---
SSL handshake has read 6716 bytes and written 456 bytes
---
New, TLSv1/SSLv3, Cipher is DHE-RSA-AES256-SHA
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1
    Cipher    : DHE-RSA-AES256-SHA
    Session-ID: ACFED5197F4B5F64DBAAC97A47380CD9283EFD1797E27EF43A215B06982698F4
    Session-ID-ctx: 
    Master-Key: 856DFB81C863F461FE75EE11E633EA5CAB3CD6683563F597F406EF19AB37CD3F45B4FE659AB8726F9291360CBE856F48
    Key-Arg   : None
    Start Time: 1475223830
    Timeout   : 300 (sec)
    Verify return code: 0 (ok)
---
</code></pre>
</div>

<p>BEGIN到END那段剪貼下來即是</p>

<h2 id="section">缺點</h2>

<p>這兩個方法有一個極大的缺點, 如果沒有解決方案還是最好別用(<del>啊講那麼多, 最後不能用?!</del>)
, 這缺點就是SSL Certificate是有時效性的, 因此server端的憑證是會換會改變的,
只要server端一換, 就可能造成client端的失效, 所以如果要使用這兩個方法,
前提必須先解決的是如何更新Client端要檢查的public key或certificate, 
這邊就不討論這部份的機制了, 這應該有很多方法可以來作才對</p>

<p>#好久沒寫關於Android的內容了</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-28T02:17:12+08:00"><a href="http://blog.jln.co/%E4%BD%BF%E7%94%A8aws-lambda%E5%92%8Cgithub%E4%BE%86%E6%8F%90%E4%BE%9B%E4%B8%AD%E8%8F%AF%E8%81%B7%E6%A3%92%E8%B3%BD%E7%A8%8B%E8%B3%87%E6%96%99/">September 28, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/%E4%BD%BF%E7%94%A8aws-lambda%E5%92%8Cgithub%E4%BE%86%E6%8F%90%E4%BE%9B%E4%B8%AD%E8%8F%AF%E8%81%B7%E6%A3%92%E8%B3%BD%E7%A8%8B%E8%B3%87%E6%96%99/" rel="bookmark" title="使用AWS lambda和Github來提供中華職棒賽程資料" itemprop="url">使用AWS lambda和Github來提供中華職棒賽程資料</a></h1>
    
  </header>
  <div class="entry-content">
    <p>不知不覺的突然就多出了兩天颱風假, 這颱風實在很威, 乒乒乓乓的, 不過, 也沒做什麼, 時間就快過完了, 現在才想到, 還是來寫點什麼, 嚴格說來這些東西並不完全是颱風假時弄的, 只是拖得有點久</p>

<p>起因是, 之前(很久…追朔到去年)想寫個App, 需要用到中華職棒賽程的資料, 拖了很久一直沒真的去做, 斷斷續續的, 最近才先把資料這部分補齊, 首先需求是:</p>

<ol>
  <li>當月之後的賽程資料, 但中華職棒並沒有API, 只有(很爛)的網頁, 因此資料勢必得從網頁去解析</li>
  <li>由Client app直接去解析html, 會比較麻煩(如果網站更新了, 就要更新App), 不是那麼可行</li>
  <li>不想花錢(或不想花太多錢)弄一個server, 更不用說還要考慮Scaling</li>
</ol>

<p>而賽程表這樣的資料的特性則是:</p>

<ol>
  <li>球季是3~10月</li>
  <li>資料內容除週一(休賽)外, 幾乎每天都會變, 但不會一兩個小時或幾分鐘就變一次</li>
  <li>變動的內容可能是:
    <ol>
      <li>比賽結束, 比數有更新</li>
      <li>延賽或停賽</li>
    </ol>
  </li>
  <li>一個月才幾十場比賽而已, 基本上不太需要有search或query的功能, 依據月份分類也就足夠了</li>
</ol>

<p>因此我採用的做法是:</p>

<ol>
  <li>利用AWS lambda定時解析中華職棒網站的資料</li>
  <li>資料以json格式存在github (使用Github api)</li>
  <li>Client透過CDN去要這些json的raw content</li>
</ol>

<h3 id="section">賽程解析</h3>

<p>這部分我是用Go + Goquery來寫的, source code在這邊: <a href="https://github.com/julianshen/cpblschedule">cpblschedule</a>, 這code沒啥整理過, 光解析這堆亂七八糟的html就夠頭痛囉, 就沒啥整理</p>

<p>我做成了一個package, 因此要使用可用下列指令先安裝:</p>

<p><code class="highlighter-rouge">go get -u github.com/julianshen/cpblschedule</code></p>

<p>裡面也很簡單就一個function而已, 因此要使用可以參考:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">import</span><span class="x"> </span><span class="s">"github.com/julianshen/cpblschedule"</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">matches</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">cpblschedule</span><span class="o">.</span><span class="n">ParseCPBLSchedule</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="x"> </span><span class="n">month</span><span class="p">)</span><span class="x">
    </span><span class="o">....</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h3 id="aws-lambda">AWS Lambda</h3>

<p>這邊就不介紹這東西是什麼了, 網路上文章一大堆, 基本上他是AWS一個severless的解決方案(這算廣告詞吧), 會使用這個的原因有二:</p>

<ol>
  <li>依我的用量應該是免費(事實證明, 其實還是要花點錢, 我忘了算網路傳輸的費用了, 不過這不多)</li>
  <li>可以用Cloud watch排程觸發</li>
</ol>

<p>不過有個小問題</p>

<div class="highlighter-rouge"><pre class="highlight"><code>**他不支援Go!!!!!**
</code></pre>
</div>

<p>而我上面那個解析的東東是go寫的, 那不就寫心酸的</p>

<p>所幸還有別的辦法,就是把程式編譯成執行檔, 然後用nodejs去包裝它, 不過這有點煩瑣, 所幸還有工具</p>

<p><a href="https://github.com/apex/apex">apex</a>, 這是讓你更簡單的去建立lambda function的工具, 而且他正好也可以幫你簡單做好上面所說的包裝</p>

<p>安裝及使用就看文件吧, 不特別說了, 但要如何用go寫一個lambda function handle呢?以下是範例:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"encoding/json"</span><span class="x">
	</span><span class="s">"github.com/apex/go-apex"</span><span class="x">
</span><span class="p">)</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">apex</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">event</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">RawMessage</span><span class="p">,</span><span class="x"> </span><span class="n">ctx</span><span class="x"> </span><span class="o">*</span><span class="n">apex</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="k">interface</span><span class="p">{},</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">dosomething</span><span class="p">()</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
	</span><span class="p">})</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h4 id="github-as-api-source">Github as API source</h4>

<p>資料既然變動不頻繁, 就用lambda定期產生然後把結果放到Github上就可了</p>

<p>Github API的Go的實做是Google放出來的<a href="https://github.com/google/go-github/">go-github</a>, 文件還蠻眼花撩亂的, 不過在這應用需要的API不多:</p>

<ol>
  <li>client.Repositories.GetContents - 取得內容</li>
  <li>client.Repositories.CreateFile - 創立一個新檔</li>
  <li>client.Repositories.UpdateFile - 更新某個檔</li>
</ol>

<p>之所以需要1的原因是要確認檔案是不是已經在repository裡面了, 如果沒有就用create, 如果有就拿SHA hash去更新內容</p>

<p>GetContents會把檔案內容一併給抓回來, 這可以用來在更新檔案前先比較, 如果不比較, 就算沒更動, API也會新增一個新的commit, 為了避免不要太誇張, 還是先比較一下好了</p>

<p>那之後client怎樣存取這些資料? 找到檔案, 選取raw就可以知道raw的url了, client每次就抓這個URL就好, 但為了避免過量地request湧到github, 因此透過一個CDN來存取可能會好一點</p>

<p>這時候就可以用<a href="http://rawgit.com">RawGit</a>, 這邊透過MaxCDN, 讓你可以去存取Github上的raw content, 而你的檔案的網址會是像這樣:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>https://cdn.rawgit.com/user/repo/tag/file
</code></pre>
</div>

<p>大致上就這樣</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    

    
    
      <li><strong class="current-page">1</strong></li>
    

    
    

    
    
    

    
      
        
        
        
        <li><a href="http://blog.jln.co/page2/">2</a></li>
      
    
      
        
        
        
        <li><a href="http://blog.jln.co/page3/">3</a></li>
      
    

    
    
      <li>…</li>
    

    
      <li><a href="http://blog.jln.co/page66/">66</a></li>
    

    
    
      <li><a href="http://blog.jln.co/page2/" class="btn">Next</a></li>
    
  </ul>
</div>


</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2016 Julian Shen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://blog.jln.co/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://blog.jln.co/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79243751-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


          

</body>
</html>