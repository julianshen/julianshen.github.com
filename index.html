<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]-->
<head>
<meta charset=utf-8>
<title>Le murmure de Julian</title>
<meta name=description content>
<meta property="og:title" content="Le murmure de Julian">
<meta property="og:description" content>
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.jln.co/"><meta property="og:image" content="https://blog.jln.co/images/avatar.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.jln.co/images/avatar.png">
<meta name=twitter:title content="Le murmure de Julian">
<meta name=twitter:description content>
<link rel=canonical href=https://blog.jln.co/>
<link href=https://blog.jln.co/feed.xml rel=alternate type=application/rss+xml title="Le murmure de Julian">
<link href=https://blog.jln.co/feed.xml rel=feed type=application/rss+xml title="Le murmure de Julian">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href=/css/main.css>
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css>
<meta http-equiv=cleartype content="on">
<meta name=generator content="Hugo 0.88.1">
<script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png>
</head>
<body id=post-index class=feature>
<nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block>
<button class=dl-trigger>Open Menu</button>
<ul class=dl-menu>
<li><a href=/>Home</a></li>
<li>
<a href=#>About</a>
<ul class=dl-submenu>
<li>
<img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo>
<h4>Julian Shen</h4>
<p>Softward developer</p>
</li>
<li>
<a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a>
</li>
<li>
<a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
</li>
<li>
<a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a>
</li>
<li>
<a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a>
</li>
</ul>
</li>
<li>
<a href=#>Posts</a>
<ul class=dl-submenu>
<li><a href=/post/>All Posts</a></li>
<li><a href=/tags/>All Tags</a></li>
</ul>
</li>
<li><a href=/></a></li>
</ul>
</nav>
<div class=entry-header>
<div class=entry-image>
<img src=/images/bkg2.jpg alt="Le murmure de Julian">
</div>
<div class=header-title>
<div class=header-title-wrap>
<h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1>
<h2>
朱隸安貓囈語錄
</h2>
</div>
</div>
</div>
<div id=main role=main>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-10-30 00:35:14 +0800 +0800"><a href=/%E7%A7%BB%E5%8B%95wsl%E6%98%A0%E5%83%8F%E5%88%B0%E5%8F%A6%E4%B8%80%E5%80%8B%E7%A3%81%E7%A2%9F/>Oct 30, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~2 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E7%A7%BB%E5%8B%95wsl%E6%98%A0%E5%83%8F%E5%88%B0%E5%8F%A6%E4%B8%80%E5%80%8B%E7%A3%81%E7%A2%9F/ rel=bookmark title=移動wsl映像到另一個磁碟 itemprop=url>移動wsl映像到另一個磁碟</a></h1>
</header>
<div class=entry-content>
<p><a href=https://docs.microsoft.com/zh-tw/windows/wsl/about>WSL</a> 當作開發環境固然方便好用的, 但也吃蠻大空間的, 最近在開發的東西, 需要跑一個postgresql, 裝不少資料, 吃掉我蠻多硬碟空間的, 偏偏我SSD就只有小小的512G (好吧, 的確寒酸到不像開發者的電腦), 一下子就吃滿滿了, 所以就必須要把這個給搬到我另一個比較大的磁碟救急(說是救急的意思是, 預期它會吃上1TB, 不過這又是會碰到一個問題, 之後再解了)</p>
<p>WSL新開的映像檔都是放在<code>C:</code>(畢竟不是謎片,不會自動住到D槽&mldr;咦?!), 要把它搬家的話, 需要先把它export出來, export的方法很簡單:</p>
<pre tabindex=0><code>wsl --shutdown
wsl --export Ubuntu-20.04 d:\ubuntuback.tar
</code></pre><p>先shutdown是想保險一點, 所以也先把相關的視窗(像是Terminal, VSCode)都關一關, 如果映像檔很大, 這預期要做非常久, 像我這個有200G以上, 放下去, 基本上我就去看電視不管它了, 當然也要確保一下你目標硬碟夠大, 這邊<code>Ubuntu-20.04</code>是我要備份的目標, 如果不知道名字是啥可以用<code>wsl -l</code>查詢</p>
<p>export完之後, 接著就用:</p>
<pre tabindex=0><code>wsl --import Ubuntu20dev e:\wsl\dev D:\ubuntuback.tar
</code></pre><p>這邊<code>Ubuntu20dev</code>是新的名字, 不要跟舊的重複了, import完後就可以用<code>wsl -d Ubuntu20dev</code> 登入進去玩了</p>
<p>不過登入後, 咦, 等一下, 怎麼會是用root? 之前舊的並不是呀! 要解決這個問題, 新增這個檔案<code>/etc/wsl.conf</code>, 裡面內容是</p>
<pre tabindex=0><code>[user]
default=yourloginname
</code></pre><p>把wsl再shutdown之後再重新進來就不會是root了</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-10-29 23:58:47 +0800 +0800"><a href=/%E7%94%A8GORM%E5%8F%96%E7%94%A8PostGIS%E7%9A%84geometry%E8%B3%87%E6%96%99/>Oct 29, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~2 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E7%94%A8GORM%E5%8F%96%E7%94%A8PostGIS%E7%9A%84geometry%E8%B3%87%E6%96%99/ rel=bookmark title=用GORM取用PostGIS的geometry資料 itemprop=url>用GORM取用PostGIS的geometry資料</a></h1>
</header>
<div class=entry-content>
<p><a href=https://postgis.net/>PostGIS</a> 是讓PostgresSQL可以支援地理資訊資料的一個擴充, 而<a href=https://www.postgis.net/workshops/postgis-intro/geometries.html>geometry</a>是<a href=https://postgis.net/>PostGIS</a>定義來儲存地理資料的資料型態, 包含了座標點(POINT), 線, 多邊形等等</p>
<p>而<a href=https://gorm.io/>GORM</a>則是Golang界算蠻有名的ORM套件, 支援了蠻多不同的關聯式資料庫</p>
<p>不過<a href=https://gorm.io/>GORM</a>是沒有直接支援PostGIS的geometry這個資料型態的, 畢竟geometry並非一般SQL標準的資料型別, 因此如果要讓<a href=https://gorm.io/>GORM</a>可以來存取geometry, 就得使用它所提供的<a href=https://gorm.io/docs/data_types.html>Customize Data Type</a></p>
<p>要存取這種自訂的資料型別, 需要實做<code>Scanner</code>和<code>Valuer</code>這兩個介面:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Scanner</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#75715e>// Scan assigns a value from a database driver.
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// The src value will be of one of the following types:
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    int64
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    float64
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    bool
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    []byte
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    string
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    time.Time
</span><span style=color:#75715e></span>	<span style=color:#75715e>//    nil - for NULL values
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// An error should be returned if the value cannot be stored
</span><span style=color:#75715e></span>	<span style=color:#75715e>// without loss of information.
</span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span><span style=color:#75715e></span>	<span style=color:#75715e>// Reference types such as []byte are only valid until the next call to Scan
</span><span style=color:#75715e></span>	<span style=color:#75715e>// and should not be retained. Their underlying memory is owned by the driver.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// If retention is necessary, copy their values before the next call to Scan.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Scan</span>(<span style=color:#a6e22e>src</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Valuer</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#75715e>// Value returns a driver Value.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// Value must not panic.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Value</span>() (<span style=color:#a6e22e>Value</span>, <span style=color:#66d9ef>error</span>)
}
</code></pre></div><p>那在實做前, 可以先來看看geometry實際存到資料庫是長怎麼樣? 它長的就會像是一串這樣的文字<code>0101000020E61000001E64C73CEA905EC09CD6C962A7C84240</code>, 看起來就是十六進位編碼過的文字, 根據<a href=http://postgis.net/docs/using_postgis_dbmanagement.html#PostGIS_Geography>文件</a>, 它是經過EWKB編碼過的(EWKB是Postgis從<a href=https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry>WKB</a>延伸來的), 然後編碼過的binary資料再轉成Hex字串</p>
<p>這部分的解碼, 可以不用自己寫, 使用open source的好處就是可以踩在前人的肩膀上, 可以利用<a href=https://github.com/twpayne/go-geom>go-goem</a>來幫我們處理這件事, 這邊以處理座標點為例 (採用常見的<a href=https://spatialreference.org/ref/epsg/4326/>EPSG:4326</a>座標系統), 定義一個叫做<code>GeoPoint</code>的型別給GORM使用, 而這個型別的實作可以是這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GeoPoint</span> <span style=color:#a6e22e>geom</span>.<span style=color:#a6e22e>Point</span>

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GeoPoint</span>) <span style=color:#a6e22e>Scan</span>(<span style=color:#a6e22e>val</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>pt</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ewkbhex</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#a6e22e>val</span>.(<span style=color:#66d9ef>string</span>))

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pt</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>geom</span>.<span style=color:#a6e22e>Point</span>); <span style=color:#a6e22e>ok</span> {
			<span style=color:#f92672>*</span><span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>GeoPoint</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>)
		} <span style=color:#66d9ef>else</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprint</span>(<span style=color:#e6db74>&#34;Failed to unmarshal geometry:&#34;</span>, <span style=color:#a6e22e>val</span>))
		}
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#a6e22e>GeoPoint</span>) <span style=color:#a6e22e>Value</span>() (<span style=color:#a6e22e>driver</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>pt</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>g</span>
	<span style=color:#a6e22e>toPt</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ewkbhex</span>.<span style=color:#a6e22e>Encode</span>((<span style=color:#f92672>*</span><span style=color:#a6e22e>geom</span>.<span style=color:#a6e22e>Point</span>)(<span style=color:#a6e22e>pt</span>).<span style=color:#a6e22e>SetSRID</span>(<span style=color:#ae81ff>4326</span>), <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>)

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>toPt</span>, <span style=color:#a6e22e>err</span>
}

</code></pre></div><p>其實非常簡單的利用了<a href=https://github.com/twpayne/go-geom>go-goem</a>提供的<code>ewkbhex</code>來編解碼而已</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-09-17 14:48:19 +0800 +0800"><a href=/%E4%BD%BF%E7%94%A8podman%E5%92%8Ckind%E5%BB%BA%E7%AB%8Bk8s%E6%B8%AC%E8%A9%A6%E7%92%B0%E5%A2%83/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~3 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E4%BD%BF%E7%94%A8podman%E5%92%8Ckind%E5%BB%BA%E7%AB%8Bk8s%E6%B8%AC%E8%A9%A6%E7%92%B0%E5%A2%83/ rel=bookmark title=使用podman和kind建立k8s測試環境 itemprop=url>使用podman和kind建立k8s測試環境</a></h1>
</header>
<div class=entry-content>
<p><a href=https://www.linuxadictos.com/zh-TW/Docker-%E6%A1%8C%E9%9D%A2%E5%B0%87%E4%B8%8D%E5%86%8D%E5%B0%8D%E4%BC%81%E6%A5%AD%E5%85%8D%E8%B2%BB%EF%BC%8C%E7%8F%BE%E5%9C%A8%E5%B0%87%E6%8C%89%E6%9C%88%E8%A8%82%E9%96%B1%E9%80%B2%E8%A1%8C%E7%AE%A1%E7%90%86.html>Docker Desktop要收錢了</a>, 雖然不是跟個人開發者收, 而且一家公司走向營利也合理, 但這作法說實在有點粗糙, 是時候改用不同的工具來玩了</p>
<p>現在在開發階段多多少少會需要在local有一個測試環境亂搞, 但一般的小電腦, 跑起Docker + K8S, 也沒辦法跑太多容器了, 能夠有盡量輕量化的東西當然最好, 在我的linux PC上, 我現在用的是podman + KIND (Windows下我還是用Docker desktop, 還沒切換過去)</p>
<h2 id=podman>Podman</h2>
<p><a href=https://podman.io/>Podman</a>是一個由Redhat開發的工具, 跟Docker最大的不同在於, 它沒需要跑一個daemon常駐在那邊, Docker desktop即使你沒跑任何container狀況下daemon還會在, <a href=https://podman.io/>Podman</a>則完全沒這問題</p>
<p>安裝的話請參考: <a href=https://podman.io/getting-started/installation>Podman Installation Instructions</a></p>
<p>安裝好後, 指令幾乎跟docker 類似, 像是 <code>docker ps</code>可以用<code>podman ps</code>取代, <code>docker run</code>可以用<code>podman run</code>取代, 幾乎沒太大問題</p>
<p>有些狀況, 會需要有docker daemon, 像是如果使用<a href=https://buildpacks.io/docs/tools/pack/>pack</a>, 由於<a href=https://buildpacks.io/docs/tools/pack/>pack</a>會需要呼叫docker daemon來建立image, 如果使用podman, 在這狀況就得跑一個service:</p>
<pre tabindex=0><code>podman system service --time=0 tcp:localhost:1234
</code></pre><p>這邊可以是tcp或是unix socket, 然後把DOCKER HOST改指到這邊來就好了</p>
<h2 id=kindhttpskindsigsk8sio><a href=https://kind.sigs.k8s.io/>kind</a></h2>
<p><a href=https://kind.sigs.k8s.io/>kind</a>是一個讓你建立local K8S cluster的工具, 其他類似的還有<a href=https://microk8s.io/>MicroK8s</a>和<a href=https://github.com/kubernetes/minikube>MiniKube</a></p>
<p>為何選<a href=https://kind.sigs.k8s.io/>kind</a>? 有時候會需要模擬多個nodes的cluster環境, 不管是MicoK8s還是MiniKube, 在單機建立出的k8s都只有一個node, 但<a href=https://kind.sigs.k8s.io/>kind</a>卻可以在單機建立出多nodes的環境</p>
<p>在Mac下可以用Homebrew安裝:</p>
<pre tabindex=0><code>brew install kind
</code></pre><p>建立一個cluster很簡單, 只要執行</p>
<pre tabindex=0><code>kind create cluster
</code></pre><p>如果你是要用<a href=https://podman.io/>Podman</a>也可以</p>
<pre tabindex=0><code>KIND_EXPERIMENTAL_PROVIDER=podman kind create cluster
</code></pre><p>但第一次使用podman建立會發生一個問題:</p>
<pre tabindex=0><code>KIND_EXPERIMENTAL_PROVIDER=podman kind create cluster
using podman due to KIND_EXPERIMENTAL_PROVIDER
enabling experimental podman provider
Creating cluster &quot;kind&quot; ...
 ✗ Ensuring node image (kindest/node:v1.21.1) 🖼 
ERROR: failed to create cluster: failed to pull image &quot;kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6&quot;: command &quot;podman pull kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6&quot; failed with error: exit status 125
Command Output: Error: short-name resolution enforced but cannot prompt without a TTY
</code></pre><p>這是由於podman在pull image時碰到short name(像是java, ubuntu, fedora這類的), 它會請你從<code>/etc/containers/registries.conf</code>裡面設的search host挑一個是可以找到這個image的host, 但在kind跳不出來給你挑, 這時候只要看哪個pull不下來(像這邊是<code>kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6</code>)就自己手動執行一次</p>
<pre tabindex=0><code>podman pull kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6
</code></pre><p>一次就好, 之後它會記起來, 這時候再來跑kind就沒問題了</p>
<p>要毀掉一個cluster也很簡單</p>
<pre tabindex=0><code>kind delete cluster
</code></pre><p>雖然文件上有說支援<a href=https://kind.sigs.k8s.io/docs/user/rootless/>Rootless</a>, 不過實際上試, 要排除的問題還很多, 不建議使用</p>
<p>如果你需要用<code>kubectl</code>或是<a href=https://k8slens.dev/>Lens</a>去存取建立出來的cluster, 那可以輸出kubeconfig</p>
<pre tabindex=0><code>kind export kubeconfig
</code></pre><p>那, 說好的多肉&mldr;喔&mldr;多nodes環境呢? 建立以下這樣的config(例如檔名叫config.yaml):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Cluster</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kind.x-k8s.io/v1alpha4</span>
<span style=color:#f92672>nodes</span>:
- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>control-plane</span>
- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>worker</span>
- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>worker</span>
- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>worker</span>
</code></pre></div><p>然後用<code>kind create cluster --config config.yaml</code>就可以建立出一個4 nodes (一個control plane, 三個worker)的環境了(在單機)</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-09-17 14:21:09 +0800 +0800"><a href=/%E4%B8%8D%E5%AF%ABDockerfile%E5%BB%BA%E7%AB%8Bdocker-Image/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~1 minute
</span>
</div>
<h1 class=entry-title><a href=/%E4%B8%8D%E5%AF%ABDockerfile%E5%BB%BA%E7%AB%8Bdocker-Image/ rel=bookmark title="不寫Dockerfile建立docker Image" itemprop=url>不寫Dockerfile建立docker Image</a></h1>
</header>
<div class=entry-content>
<p>人都是懶的, 尤其如果拿同樣的工具, 開發不同的service, 又要部屬到cloud native環境, 免不了要一直重複寫類似的Dockerfile來建立docker image, 有沒懶方法?</p>
<p>有, 就是<a href=https://buildpacks.io/>Cloud native buildpacks</a>, 有用過<a href=https://www.heroku.com/>Heroku</a>的應該會有點耳熟, 對, 就是那個buildpacks, 只是把它變成一個標準</p>
<p>首先, 你需要的是<a href=https://buildpacks.io/docs/tools/pack/>pack</a>這工具, 在mac底下可以用 brew安裝</p>
<pre tabindex=0><code>brew install buildpacks/tap/pack
</code></pre><p>Windows下可以用scoop</p>
<pre tabindex=0><code>scoop install pack
</code></pre><p>安裝好後, 可以執行:</p>
<pre tabindex=0><code>pack builder suggest
</code></pre><p>來看看有甚麼buildpacks 可以用</p>
<pre tabindex=0><code>Suggested builders:
    Google:                gcr.io/buildpacks/builder:v1      Ubuntu 18 base image with buildpacks for .NET, Go, Java, Node.js, and Python
    Heroku:                heroku/buildpacks:18              Base builder for Heroku-18 stack, based on ubuntu:18.04 base image
    Heroku:                heroku/buildpacks:20              Base builder for Heroku-20 stack, based on ubuntu:20.04 base image
    Paketo Buildpacks:     paketobuildpacks/builder:base     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, Python, Ruby, NGINX and Procfile
    Paketo Buildpacks:     paketobuildpacks/builder:full     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, Python, PHP, Ruby, Apache HTTPD, NGINX and Procfile
    Paketo Buildpacks:     paketobuildpacks/builder:tiny     Tiny base image (bionic build image, distroless-like run image) with buildpacks for Java Native Image and Go
</code></pre><p>看你使用的開發語言或框架, 選擇適合的buildpack, 比如說像是node.js或是go, 只要簡單的在你的project底下執行:</p>
<pre tabindex=0><code>pack build image_name --builder gcr.io/buildpacks/builder:v1
</code></pre><p>就可以建立出一個名為<code>image_name</code>的docker image了, 而且建置過程都是自動偵測</p>
<p>不過當然沒辦法適用所有的狀況, 如果你有不同的語言不同的需求, 其實也可以自建buildpack喔</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-09-17 12:20:38 +0800 +0800"><a href=/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~6 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/ rel=bookmark title=用D3js建立台股板塊圖 itemprop=url>用D3js建立台股板塊圖</a></h1>
</header>
<div class=entry-content>
<p>這題目瑣碎的東西太多了, 所以這篇打算只是做個紀錄, 做這東西原因是看到<a href="https://finviz.com/map.ashx?t=sec_all">Finviz</a>這個板塊圖覺得還蠻有趣的, 想說該怎去做到這樣的圖表</p>
<p><img src=/images/posts/2021-09-17-12-25-23.png alt=stockmap></p>
<p>一眼就可以大略看市場的狀況, 感覺還蠻酷的, 查了一下, 這東西叫<a href=https://en.wikipedia.org/wiki/Treemapping>Treemapping</a>, 想到資料視覺化, 我是先想到<a href=https://d3js.org/>D3.js</a>, 雖然說<a href=https://www.highcharts.com/>Highcharts</a>也可以達到一樣的目的, 不過<a href=https://d3js.org/>D3.js</a>使用上跟jQuery類似, 比較簡單, 所以選擇它來實現</p>
<p>先給結果<a href=https://fviz.jln.co/marketmap>https://fviz.jln.co/marketmap</a></p>
<p><img src=/images/posts/2021-09-17-12-45-59.png alt=f></p>
<p>這邊使用到的東西有:</p>
<ul>
<li>D3.js</li>
<li>Next.js (deploy to GitHub page)</li>
</ul>
<p>純粹靜態網頁, 沒資料庫, 不過目前資料只抓到2021/09/14, 定期抓資料的部分還懶得弄</p>
<h2 id=資料來源>資料來源</h2>
<p>這邊所需要的資料有幾個:</p>
<ul>
<li>上市股票的收盤資訊</li>
<li>上櫃股票的收盤資訊</li>
<li>各股所屬的分類資訊</li>
</ul>
<p>雖然都是容易爬的到的資料, 但兩個市場資料格式不是那麼的統一</p>
<p>抓取集中市場的歷史資料用這個 URL : &ldquo;<a href="https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date=%25s&type=ALL&_=%25s%22">https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date=%s&type=ALL&_=%s"</a> , date的格式用"20060102"這樣, &ldquo;_&ldquo;可以用timestamp即可, 我要的當然是json, 會比csv來的好處理點</p>
<p>個股的交易資訊在<code>data9</code>這個欄位, 欄位定義是<code>fields9</code>, 所以用<code>jq</code>來看一下</p>
<pre tabindex=0><code>curl &quot;https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&amp;date=20210910&amp;type=ALL&amp;_=1631369120214&quot; | jq &quot;.fields9&quot;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 3122k    0 3122k    0     0  1526k      0 --:--:--  0:00:02 --:--:-- 1526k
[
  &quot;證券代號&quot;,
  &quot;證券名稱&quot;,
  &quot;成交股數&quot;,
  &quot;成交筆數&quot;,
  &quot;成交金額&quot;,
  &quot;開盤價&quot;,
  &quot;最高價&quot;,
  &quot;最低價&quot;,
  &quot;收盤價&quot;,
  &quot;漲跌(+/-)&quot;,
  &quot;漲跌價差&quot;,
  &quot;最後揭示買價&quot;,
  &quot;最後揭示買量&quot;,
  &quot;最後揭示賣價&quot;,
  &quot;最後揭示賣量&quot;,
  &quot;本益比&quot;
]
</code></pre><p>來看一下<code>.data9</code>內的單筆資料, 基本上就是都放到array去, 算好處理</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
    <span style=color:#e6db74>&#34;9944&#34;</span>,
    <span style=color:#e6db74>&#34;新麗&#34;</span>,
    <span style=color:#e6db74>&#34;92,813&#34;</span>,
    <span style=color:#e6db74>&#34;53&#34;</span>,
    <span style=color:#e6db74>&#34;1,950,673&#34;</span>,
    <span style=color:#e6db74>&#34;21.05&#34;</span>,
    <span style=color:#e6db74>&#34;21.10&#34;</span>,
    <span style=color:#e6db74>&#34;20.85&#34;</span>,
    <span style=color:#e6db74>&#34;21.10&#34;</span>,
    <span style=color:#e6db74>&#34;&lt;p style= color:red&gt;+&lt;/p&gt;&#34;</span>,
    <span style=color:#e6db74>&#34;0.10&#34;</span>,
    <span style=color:#e6db74>&#34;20.75&#34;</span>,
    <span style=color:#e6db74>&#34;2&#34;</span>,
    <span style=color:#e6db74>&#34;21.15&#34;</span>,
    <span style=color:#e6db74>&#34;3&#34;</span>,
    <span style=color:#e6db74>&#34;23.19&#34;</span>
  ]
</code></pre></div><p>這邊"漲跌(+/-)&ldquo;的部分, 其實不是只有+和-, 而居然是html tags, 包含四種狀況, +/-/ /X, +/-很好懂, 就是漲跟跌, 空白就是平盤了, X的狀況通常發生在除權息, 增減資這類狀況</p>
<p>那櫃檯市場呢? URL是這個<code>https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&d=110/09/01&_=1631603049</code>, 日期格式跟集中市場不同, 是用&rdquo;/&ldquo;隔開, 並且是民國紀年, 這邊資料也是array放在<code>aaData</code>這欄位</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[<span style=color:#e6db74>&#34;9960&#34;</span>,<span style=color:#e6db74>&#34;\u9081\u9054\u5eb7&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;+0.35&#34;</span>,<span style=color:#e6db74>&#34;27.00&#34;</span>,<span style=color:#e6db74>&#34;27.25&#34;</span>,<span style=color:#e6db74>&#34;26.85&#34;</span>,<span style=color:#e6db74>&#34;27.06&#34;</span>,<span style=color:#e6db74>&#34;56,004&#34;</span>,<span style=color:#e6db74>&#34;1,515,312&#34;</span>,<span style=color:#e6db74>&#34;37&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;27.15&#34;</span>,<span style=color:#e6db74>&#34;5&#34;</span>,<span style=color:#e6db74>&#34;33,592,500&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;29.80&#34;</span>,<span style=color:#e6db74>&#34;24.40&#34;</span>]
</code></pre></div><p>那個股基本資料呢?這邊就神奇了, 居然有Open API document: <a href=https://openapi.twse.com.tw/v1/swagger.json>https://openapi.twse.com.tw/v1/swagger.json</a>, 可以用&rdquo;/v1/opendata/t187ap03_L"取得基本資料, 這邊雖然也有API可以取得當日交易資訊, 但只有當日並無歷史資料</p>
<p>上櫃股票的資料也有一樣的東西, 在 <a href=https://www.tpex.org.tw/openapi/swagger.json>https://www.tpex.org.tw/openapi/swagger.json</a></p>
<p>抓到的分類類別是代號, 所以要對應到正確的類別名稱可以用這表:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Categories</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
	<span style=color:#e6db74>&#34;01&#34;</span>: <span style=color:#e6db74>&#34;水泥&#34;</span>,
	<span style=color:#e6db74>&#34;02&#34;</span>: <span style=color:#e6db74>&#34;食品&#34;</span>,
	<span style=color:#e6db74>&#34;03&#34;</span>: <span style=color:#e6db74>&#34;塑膠&#34;</span>,
	<span style=color:#e6db74>&#34;04&#34;</span>: <span style=color:#e6db74>&#34;紡織纖維&#34;</span>,
	<span style=color:#e6db74>&#34;05&#34;</span>: <span style=color:#e6db74>&#34;電機機械&#34;</span>,
	<span style=color:#e6db74>&#34;06&#34;</span>: <span style=color:#e6db74>&#34;電器電纜&#34;</span>,
	<span style=color:#e6db74>&#34;21&#34;</span>: <span style=color:#e6db74>&#34;化工&#34;</span>,
	<span style=color:#e6db74>&#34;22&#34;</span>: <span style=color:#e6db74>&#34;生技&#34;</span>,
	<span style=color:#e6db74>&#34;08&#34;</span>: <span style=color:#e6db74>&#34;玻璃陶瓷&#34;</span>,
	<span style=color:#e6db74>&#34;09&#34;</span>: <span style=color:#e6db74>&#34;造紙&#34;</span>,
	<span style=color:#e6db74>&#34;10&#34;</span>: <span style=color:#e6db74>&#34;鋼鐵&#34;</span>,
	<span style=color:#e6db74>&#34;11&#34;</span>: <span style=color:#e6db74>&#34;橡膠&#34;</span>,
	<span style=color:#e6db74>&#34;12&#34;</span>: <span style=color:#e6db74>&#34;汽車&#34;</span>,
	<span style=color:#e6db74>&#34;24&#34;</span>: <span style=color:#e6db74>&#34;半導體&#34;</span>,
	<span style=color:#e6db74>&#34;25&#34;</span>: <span style=color:#e6db74>&#34;電腦及週邊&#34;</span>,
	<span style=color:#e6db74>&#34;26&#34;</span>: <span style=color:#e6db74>&#34;光電&#34;</span>,
	<span style=color:#e6db74>&#34;27&#34;</span>: <span style=color:#e6db74>&#34;通信網路&#34;</span>,
	<span style=color:#e6db74>&#34;28&#34;</span>: <span style=color:#e6db74>&#34;電子零組件&#34;</span>,
	<span style=color:#e6db74>&#34;29&#34;</span>: <span style=color:#e6db74>&#34;電子通路&#34;</span>,
	<span style=color:#e6db74>&#34;30&#34;</span>: <span style=color:#e6db74>&#34;資訊服務&#34;</span>,
	<span style=color:#e6db74>&#34;31&#34;</span>: <span style=color:#e6db74>&#34;其他電子&#34;</span>,
	<span style=color:#e6db74>&#34;14&#34;</span>: <span style=color:#e6db74>&#34;建材營造&#34;</span>,
	<span style=color:#e6db74>&#34;15&#34;</span>: <span style=color:#e6db74>&#34;航運&#34;</span>,
	<span style=color:#e6db74>&#34;16&#34;</span>: <span style=color:#e6db74>&#34;觀光&#34;</span>,
	<span style=color:#e6db74>&#34;17&#34;</span>: <span style=color:#e6db74>&#34;金融保險&#34;</span>,
	<span style=color:#e6db74>&#34;18&#34;</span>: <span style=color:#e6db74>&#34;貿易百貨&#34;</span>,
	<span style=color:#e6db74>&#34;23&#34;</span>: <span style=color:#e6db74>&#34;油電燃氣&#34;</span>,
	<span style=color:#e6db74>&#34;19&#34;</span>: <span style=color:#e6db74>&#34;綜合&#34;</span>,
	<span style=color:#e6db74>&#34;20&#34;</span>: <span style=color:#e6db74>&#34;其他&#34;</span>,
	<span style=color:#e6db74>&#34;32&#34;</span>: <span style=color:#e6db74>&#34;文創&#34;</span>,
	<span style=color:#e6db74>&#34;33&#34;</span>: <span style=color:#e6db74>&#34;農業科技&#34;</span>,
	<span style=color:#e6db74>&#34;34&#34;</span>: <span style=color:#e6db74>&#34;電商&#34;</span>,
	<span style=color:#e6db74>&#34;80&#34;</span>: <span style=color:#e6db74>&#34;管理股票&#34;</span>,
	<span style=color:#e6db74>&#34;91&#34;</span>: <span style=color:#e6db74>&#34;存託憑證&#34;</span>,
}
</code></pre></div><p>把以上資料, 整合起來, 我需要的是這樣的資料:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;台股版塊&#34;</span>,
    <span style=color:#f92672>&#34;children&#34;</span>: [{
        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;集中市場&#34;</span>,
        <span style=color:#f92672>&#34;children&#34;</span>: [{
            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;水泥&#34;</span>,
            <span style=color:#f92672>&#34;children&#34;</span>: [{
                <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
                <span style=color:#f92672>&#34;data&#34;</span>: {
                    <span style=color:#f92672>&#34;Code&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
                    <span style=color:#f92672>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;台泥&#34;</span>,
                    <span style=color:#f92672>&#34;TradeVolume&#34;</span>: <span style=color:#e6db74>&#34;14853294&#34;</span>,
                    <span style=color:#f92672>&#34;Transaction&#34;</span>: <span style=color:#e6db74>&#34;6367&#34;</span>,
                    <span style=color:#f92672>&#34;TradeValue&#34;</span>: <span style=color:#e6db74>&#34;715327703&#34;</span>,
                    <span style=color:#f92672>&#34;OpeningPrice&#34;</span>: <span style=color:#e6db74>&#34;48.35&#34;</span>,
                    <span style=color:#f92672>&#34;HighestPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
                    <span style=color:#f92672>&#34;LowestPrice&#34;</span>: <span style=color:#e6db74>&#34;47.85&#34;</span>,
                    <span style=color:#f92672>&#34;ClosingPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
                    <span style=color:#f92672>&#34;Change&#34;</span>: <span style=color:#e6db74>&#34;-0.05&#34;</span>,
                    <span style=color:#f92672>&#34;Time&#34;</span>: <span style=color:#e6db74>&#34;2021-09-01T00:00:00+08:00&#34;</span>
                }
            }]
        }]
    }]
}
</code></pre></div><p>顧名思義, Treemap就是一個樹狀的結構而來的, 因此需要的資料結構就需要有個階層, 這邊設計成 &ldquo;台股板塊->市場別->分類->個股&rdquo;</p>
<h2 id=d3js--react-js>D3.js + React JS</h2>
<p>因為我用Next.js, 就想要把這個treemap包裝在一個react component</p>
<p>使用D3.js要先引入這幾個packages (我用typescript開發):</p>
<ul>
<li>@types/d3</li>
<li>@types/d3-hierarchy</li>
<li>d3</li>
<li>d3-hierarchy</li>
</ul>
<p><code>d3-hierarchy</code>是用來畫treemap的, 只用d3基本功能是不需要含進來的</p>
<p>先給這個Treemap的component一個殼:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Treemap</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>width</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>height</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>date</span>:<span style=color:#66d9ef>Date</span> }) <span style=color:#f92672>=&gt;</span> {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svgRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#66d9ef>null</span>);
    
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dataFile</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getFullYear</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> 
      <span style=color:#f92672>+</span> (<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getMonth</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) 
      <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getDate</span>().<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.json&#34;</span>;

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>renderTreemap</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>select</span>(<span style=color:#a6e22e>svgRef</span>.<span style=color:#a6e22e>current</span>).<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;font&#34;</span>, <span style=color:#e6db74>&#34;10px sans-serif&#34;</span>);
        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>width</span>).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>height</span>);
        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;*&#34;</span>).<span style=color:#a6e22e>remove</span>();
        
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stockData</span>:<span style=color:#66d9ef>StockData</span>

        <span style=color:#66d9ef>try</span> {
            <span style=color:#a6e22e>stockData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>dataFile</span>) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>StockData</span>;
        } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>e</span>) {
            <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;text&#34;</span>)
                .<span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#34;本日無資料, 請按左上角按鈕選取時間&#34;</span>)
                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;x&#34;</span>, <span style=color:#ae81ff>6</span>)
                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#ae81ff>22</span>)
                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;white&#34;</span>);
            <span style=color:#66d9ef>return</span>;
        }
    };

    <span style=color:#a6e22e>useEffect</span>(() <span style=color:#f92672>=&gt;</span> {
        <span style=color:#a6e22e>renderTreemap</span>();
    });
    
    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>Box</span>&gt;
            &lt;<span style=color:#f92672>svg</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>svgRef</span>} /&gt;
        &lt;/<span style=color:#f92672>Box</span>&gt;
      );
}

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Treemap</span>
</code></pre></div><p>d3的用法跟jQuery類似, 因此這邊跟React包裝一起的方法也很簡單, 就是用<code>useRef</code>給它有個reference可以select, 這邊要畫圖, 所以就包到一個svg去, 實際render出來的也是svg</p>
<p>抓取資料可以用<code>d3.json(dataFile)</code>, 其實也有<code>d3.csv</code>, 有點類似用<code>fetch</code></p>
<p>Treemap的實做就稍微有點複雜了, 可以參考這邊 &ldquo;<a href=https://observablehq.com/@d3/nested-treemap>Nested Treemap</a>&rdquo;, 這篇也不錯: &ldquo;<a href=http://blog.infographics.tw/2015/10/d3js-tutorial-treemap-and-budget/>D3.js 實戰 － 利用 Treemap Layout 將政府預算視覺化</a>&rdquo;, 這邊我使用了交易量跟交易總額去做面積跟排序</p>
<h2 id=加上tooltip>加上Tooltip</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
    .<span style=color:#a6e22e>data</span>(<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>leaves</span>())
    .<span style=color:#a6e22e>enter</span>()
    .<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;y&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; })
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { 
            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>h</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; 
            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>;
        })
    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;black&#34;</span>)
    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;fill&#34;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>ccolor</span>(<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>data</span>))
    .<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseover&#39;</span>, (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>)<span style=color:#f92672>=&gt;</span>{
        <span style=color:#a6e22e>mouseOver</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>);
    }).<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseleave&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
        <span style=color:#a6e22e>tooltip</span>().<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;opacity&#34;</span>, <span style=color:#ae81ff>0</span>);
    });
</code></pre></div><p>透過<code>on('mouseover')</code>和<code>on('mouseleave')</code>就可以來加上tooltip的效果</p>
<h2 id=發佈到github-pages>發佈到Github pages</h2>
<p>next.js由於ssg, ssr的關係, 需要跑個server, 但其實也有機會發布成全靜態網頁(只要沒需要有在server跑的部分), 步驟如下:</p>
<ul>
<li>next build</li>
<li>next export</li>
</ul>
<p>結果就會在<code>out/</code>目錄, 拿這個目錄的內容放github pages就可以了</p>
<p>最後附上寫這東西時來搗亂的傢伙</p>
<p><img src=/images/posts/2021-09-17-13-43-04.png alt></p>
</div>
</article>
<div class=pagination>
<ul class=inline-list>
<li><strong class=current-page>1</strong></li>
<li><a href=/page/2/>2</a></li>
<li><a href=/page/3/>3</a></li>
<li><a href=/page/4/>4</a></li>
<li><a href=/page/5/>5</a></li>
<li><a href=/page/6/>6</a></li>
<li><a href=/page/7/>7</a></li>
<li><a href=/page/8/>8</a></li>
<li><a href=/page/9/>9</a></li>
<li><a href=/page/10/>10</a></li>
<li><a href=/page/11/>11</a></li>
<li><a href=/page/12/>12</a></li>
<li><a href=/page/13/>13</a></li>
<li><a href=/page/14/>14</a></li>
<li><a href=/page/15/>15</a></li>
<li><a href=/page/16/>16</a></li>
<li><a href=/page/17/>17</a></li>
<li><a href=/page/18/>18</a></li>
<li><a href=/page/19/>19</a></li>
<li><a href=/page/20/>20</a></li>
<li><a href=/page/21/>21</a></li>
<li><a href=/page/22/>22</a></li>
<li><a href=/page/23/>23</a></li>
<li><a href=/page/24/>24</a></li>
<li><a href=/page/25/>25</a></li>
<li><a href=/page/26/>26</a></li>
<li><a href=/page/27/>27</a></li>
<li><a href=/page/28/>28</a></li>
<li><a href=/page/29/>29</a></li>
<li><a href=/page/30/>30</a></li>
<li><a href=/page/31/>31</a></li>
<li><a href=/page/32/>32</a></li>
<li><a href=/page/33/>33</a></li>
<li><a href=/page/34/>34</a></li>
<li><a href=/page/35/>35</a></li>
<li><a href=/page/36/>36</a></li>
<li><a href=/page/37/>37</a></li>
<li><a href=/page/38/>38</a></li>
<li><a href=/page/39/>39</a></li>
<li><a href=/page/40/>40</a></li>
<li><a href=/page/41/>41</a></li>
<li><a href=/page/42/>42</a></li>
<li><a href=/page/43/>43</a></li>
<li><a href=/page/44/>44</a></li>
<li><a href=/page/45/>45</a></li>
<li><a href=/page/46/>46</a></li>
<li><a href=/page/47/>47</a></li>
<li><a href=/page/48/>48</a></li>
<li><a href=/page/49/>49</a></li>
<li><a href=/page/50/>50</a></li>
<li><a href=/page/51/>51</a></li>
<li><a href=/page/52/>52</a></li>
<li><a href=/page/53/>53</a></li>
<li><a href=/page/54/>54</a></li>
<li><a href=/page/55/>55</a></li>
<li><a href=/page/56/>56</a></li>
<li><a href=/page/57/>57</a></li>
<li><a href=/page/58/>58</a></li>
<li><a href=/page/59/>59</a></li>
<li><a href=/page/60/>60</a></li>
<li><a href=/page/61/>61</a></li>
<li><a href=/page/62/>62</a></li>
<li><a href=/page/63/>63</a></li>
<li><a href=/page/64/>64</a></li>
<li><a href=/page/65/>65</a></li>
<li><a href=/page/66/>66</a></li>
<li><a href=/page/67/>67</a></li>
<li><a href=/page/68/>68</a></li>
<li><a href=/page/69/>69</a></li>
<li><a href=/page/70/>70</a></li>
<li><a href=/page/71/>71</a></li>
<li><a href=/page/72/>72</a></li>
<li><a href=/page/73/>73</a></li>
<li><a href=/page/74/>74</a></li>
<li><a href=/page/2/ class=btn>Next</a></li>
</ul>
</div>
</div>
<div class=footer-wrapper>
<footer role=contentinfo>
<span> Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span>
</footer>
</div>
<script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-79243751-1','auto'),ga('send','pageview'))</script>
<div id=fb-root></div>
<script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script>
</body>
</html>