<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Le murmure de Julian</title><meta name=description content><meta property="og:title" content="Le murmure de Julian"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jln.co/"><meta property="og:image" content="https://blog.jln.co/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.jln.co/images/avatar.png"><meta name=twitter:title content="Le murmure de Julian"><meta name=twitter:description content><link rel=canonical href=https://blog.jln.co/><link rel=alternate type=application/rss+xml href=https://blog.jln.co/feed.xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.105.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post-index class=feature><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=entry-image><img src=/images/bkg2.jpg alt="Le murmure de Julian"></div><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>朱隸安貓囈語錄</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-11-13 13:11:27 +0800 +0800"><a href=/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/>Nov 13, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/ rel=bookmark title="使用Dapr Input/Output Binding連接Kafka" itemprop=url>使用Dapr Input/Output Binding連接Kafka</a></h1></header><div class=entry-content><p>在Dapr元件有一種叫做Binding的元件(component)讓你的app跟外部系統做一個連結的, 這元件可分為兩類:</p><ol><li>Input BIndings: 用來接受外部事件的觸發,像是Webhook, 從Queue來的events, 甚至是人家新發的Tweets, 應該都可以歸為這一類</li><li>Ouput Bindings: 呼叫外部系統的動作,命名為Outpiut其實會讓人誤以為是資料的輸出,但其實,他不只可以用在資料輸出,呼叫外部系統的動作都可以包含在內, 舉個例子, <a href=https://github.com/dapr/components-contrib/tree/master/bindings/graphql>GraphQL 的Output binding</a>定義了兩個操作(Operations), 一個是QueryOperation, 一個是MutationOperation, 熟悉GraphQL的應該知道,MutationOperation一般才是應用在資料操作,而Query感覺就跟輸出比較無關了</li></ol><p>一開始我也有點搞不清楚這個模式目的在做啥的, 要接受事件觸發,我們有pub sub了,而state store本身就用在資料輸出, 感覺的確有點重複,但由上述兩點來看,其實Binding定義的範圍廣泛多了,它並不特定限制在Queue或是資料庫</p><p>但有個東西同時支援了Pub sub, input binding, output binding, 一開始我是看Kafka這應用,才讓我覺得有點錯亂,<a href=dapr-raw-payload-pub-sub>前一篇</a>有講過了怎實作Subscriber, 這邊來比較一下, 利用Input binding的話,會有什麼不一樣?</p><h3 id=建立binding元件>建立Binding元件</h3><p><img src alt=/post/images/55875EA9-6C5C-48BB-8289-FF95B5CB5409.jpeg></p><p>要用Kafka來觸發我們服務(如上圖),跟寫Subscriber一樣,我們需要在<code>~/.dapr/components</code>裡先建立好元件, 假設我們新增一個<code>kafka-binding.yaml</code>, 內容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>dapr.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Component</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-binding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bindings.kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>brokers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>localhost:9092</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>topics</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>mytopic</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumerGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>group1</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>publishTopic</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>mytopic</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authRequired</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;false&#34;</span>
</span></span></code></pre></div><p>上面這個其實已經是定義好input和output binding了,topics定義的是input binding要聽取事件的topic, 而publishTopic定義的則是Output binding要輸出資料的目標</p><h3 id=實作input-binding>實作Input binding</h3><p>跟實做subscriber差不多, Input binding也是實作一個webhook讓Dapr打進來而已, 這邊假設Kafka會收到的資料會是一個數字</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dataBinding</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>data</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Status</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>POST</span>(<span style=color:#e6db74>&#34;/kafka-binding&#34;</span>, <span style=color:#a6e22e>dataBinding</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>OPTIONS</span>(<span style=color:#e6db74>&#34;/kafka-binding&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Status</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:6003&#34;</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊幾個重點:</p><ol><li>endpoint path跟你的binding名稱一樣, 當然這可以在元件設定那邊改</li><li>OPTIONS有點像是讓Dapr確認你有沒支援這個binding的health endpoint, 在程式一開始跑就會被call, 這邊只要回OK, 其實都好</li><li>跟pub sub不一樣的是, 這邊會收到的格式不一定會是cloudevent, 除非publisher那邊過來的就是cloudevent, 因此, tracing應該是追蹤不到才是</li></ol><h3 id=實做output-binding>實做Output binding</h3><p>那如何實作跟剛剛的Input binding匹配的Output binding呢? 範例如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dapr</span> <span style=color:#e6db74>&#34;github.com/dapr/go-sdk/client&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BINDING_NAME</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;kafka-binding&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BINDING_OPERATION</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;create&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>5000</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Seed</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixMicro</span>())
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dataId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>1000</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>NewClient</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>InvokeBindingRequest</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>BINDING_NAME</span>, <span style=color:#a6e22e>Operation</span>: <span style=color:#a6e22e>BINDING_OPERATION</span>, <span style=color:#a6e22e>Data</span>: []byte(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InvokeOutputBinding</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sending message: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊重點在於:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>InvokeBindingRequest</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>BINDING_NAME</span>, <span style=color:#a6e22e>Operation</span>: <span style=color:#a6e22e>BINDING_OPERATION</span>, <span style=color:#a6e22e>Data</span>: []byte(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InvokeOutputBinding</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span></code></pre></div><p>雖說是"Output" binding, 但這邊用的名字是"Invoke", 跟Output沒啥相關, Operation則是元件訂的, Kafka binding只定義一個"create", 就是讓你送訊息用的, Data則是要傳送的資料, 以Byte array表示</p><h3 id=用subscriber接收output-binding來的事件>用subscriber接收output binding來的事件</h3><p>這邊就不用多作解釋了, 從前面不難發現, 它接的就是raw payload, 這部分可以參考 <a href=dapr-raw-payload-pub-sub>前一篇</a></p><p>那啥時該用哪一種呢? 以Kafka這範例來說, 我是認為如果publisher跟subscriber都是自己實做的話, 應該是要選用pub sub, 用cloud events的話, 可以享受到distributed tracing帶來的好處, 如果不是, 差異應該不大, 都蠻簡單實作的</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-11-10 13:57:03 +0800 +0800"><a href=/Hugo-Rang-Wen-Zhang-De-Urlbu-Yao-Shi-Zhong-Wen-Zi/>Nov 10, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~3 minutes</span></div><h1 class=entry-title><a href=/Hugo-Rang-Wen-Zhang-De-Urlbu-Yao-Shi-Zhong-Wen-Zi/ rel=bookmark title="[Hugo] 讓文章的URL不要是中文字" itemprop=url>[Hugo] 讓文章的URL不要是中文字</a></h1></header><div class=entry-content><p>在發表<a href=dapr-raw-payload-pub-sub>前一篇</a>時, <a href=https://www.evanlin.com/>Evan</a> 跟我說, &ldquo;能不能用slug把url改好看點?&rdquo;, 從開始寫blog來, 其實我也沒在意有沒人看, 所以SEO相關的也沒太在意, 但既然有人講了, 我就來弄一下吧</p><h3 id=prama-links的設定>Prama links的設定</h3><p>首先先來看看pramalinks設定的部分:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>permalinks</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>post</span> = <span style=color:#e6db74>&#34;/:slug/&#34;</span>
</span></span></code></pre></div><p>這邊就是用來設定你URL長相的地方, 我的原文都放在post目錄內, 所以我一開始的設定就是以slug當URL沒錯, 那怎還是有中文呢?</p><h3 id=archetypes-初始文章的設定>Archetypes, 初始文章的設定</h3><p>當你用<code>hugo new filename</code>, 他會拿<code>themes/[theme_name]/archetypes/default.md</code>當範本來建立初始文章, 像我原本的設定是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>date</span>: {{ <span style=color:#ae81ff>.Date }}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>title</span>: <span style=color:#e6db74>&#34;{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>images</span>: 
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#34;https://og.jln.co/jlns1/{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title | base64Encode | replaceRE &#34;</span><span style=color:#ae81ff>=+$&#34; &#34;&#34; | replaceRE &#34;\\+&#34; &#34;-&#34; | replaceRE &#34;/&#34; &#34;_&#34;}}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>draft</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>slug是沒設定的, 不過它似乎應該會用title去算slug, 所以在Paramlinks那邊沒啥影響, 但其實你也可以加一行變成:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>date</span>: {{ <span style=color:#ae81ff>.Date }}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>title</span>: <span style=color:#e6db74>&#34;{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>slug</span>: <span style=color:#e6db74>&#34;{{ anchorize .Name | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>images</span>: 
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#34;https://og.jln.co/jlns1/{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title | base64Encode | replaceRE &#34;</span><span style=color:#ae81ff>=+$&#34; &#34;&#34; | replaceRE &#34;\\+&#34; &#34;-&#34; | replaceRE &#34;/&#34; &#34;_&#34;}}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>draft</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>anchorize是可以把"This is a cat"轉成"this-is-a-cat", 其實這兩段效果差不多, 問題在, 不支援中文, 因此像是"這是中文 Chinese", 其實翻成的是"這是中文-chinese", 如果再把這段放到url, unicode url並不是很好看</p><p>找了半天, 並不是很好用, 本來想寫個wrapper script來做新建文章好了, 然後自動加入比較好看的slug, 但轉念一想, 何不直接改Hugo?何不直接改Hugo?何不直接改Hugo? (回音持續)</p><h3 id=支援中文的slug轉換的go-module>支援中文的slug轉換的go module</h3><p>推薦這個<a href=https://github.com/gosimple/slug>github.com/gosimple/slug</a>, 這不只支援中文, 很多語言都有!用法也很簡單:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gosimple/slug&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>someText</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>slug</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#e6db74>&#34;影師&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>someText</span>) <span style=color:#75715e>// Will print: &#34;ying-shi&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>(以上範例來自它github)它很貼心的幫你把中文字轉成拼音了, 這用來做url感覺還蠻適合的呀!</p><h3 id=修改hugo>修改Hugo</h3><p>那我要加在Hugo哪裡呢?前面說到<code>anchorize</code>, 那其實仿效它做一個<code>slugify</code>不就好了, 那也容易知道要改哪, 抄<code>anchorize</code>就對了</p><p>要改的只有兩個檔:</p><ul><li>tpl/urls/init.go</li><li>tpl/urls/urls.go</li></ul><p>在<code>tpl/urls/urls.go</code>加入:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ns</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Namespace</span>) <span style=color:#a6e22e>Slugify</span>(<span style=color:#a6e22e>s</span> <span style=color:#a6e22e>any</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ss</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cast</span>.<span style=color:#a6e22e>ToStringE</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>slug</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>ss</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然後在<code>tpl/urls/init.go</code>的<code>init()</code>內加入:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>ns</span>.<span style=color:#a6e22e>AddMethodMapping</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Slugify</span>,
</span></span><span style=display:flex><span>    []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;slugify&#34;</span>},
</span></span><span style=display:flex><span>    [][<span style=color:#ae81ff>2</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>`</span><span style=color:#75715e>{{</span> <span style=color:#e6db74>&#34;This is a title&#34;</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>slugify</span> <span style=color:#75715e>}}</span><span style=color:#e6db74>`</span>, <span style=color:#e6db74>`this-is-a-title`</span>},
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>重新建置安裝好後, 就可以把<code>Archetypes</code>改成:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>date</span>: {{ <span style=color:#ae81ff>.Date }}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>title</span>: <span style=color:#e6db74>&#34;{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>slug</span>: <span style=color:#e6db74>&#34;{{ slugify .Name | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>images</span>: 
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#34;https://og.jln.co/jlns1/{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title | base64Encode | replaceRE &#34;</span><span style=color:#ae81ff>=+$&#34; &#34;&#34; | replaceRE &#34;\\+&#34; &#34;-&#34; | replaceRE &#34;/&#34; &#34;_&#34;}}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>draft</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>搞定! 結果寫這些code五分鐘, 但卻花了五十分鐘找方法呀, 果然Open source還是自己改來用最快</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-11-08 00:33:12 +0800 +0800"><a href=/dapr-raw-payload-pub-sub/>Nov 8, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/dapr-raw-payload-pub-sub/ rel=bookmark title="用Go實作Dapr的rawPayload Subscriber" itemprop=url>用Go實作Dapr的rawPayload Subscriber</a></h1></header><div class=entry-content><p>本來沒預計寫這篇的, 不過後來想想, 本來想寫的篇幅太大, 先寫這篇幫後面內容暖身, 後續相關內容會再更新到下面連結:</p><ol><li><a href=Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka>使用Dapr Input/Output Binding連接Kafka</a></li></ol><p>這篇並不是要寫怎用go實做Dapr的pubsub, 不完全是, 實做pubsub部分請參考<a href=https://docs.dapr.io/developing-applications/building-blocks/pubsub/howto-publish-subscribe/>官方文件</a>, 基本的Dapr的publisher跟subscriber是用所謂CloudEvent的格式在傳遞, 用CloudEvent的好處是, 由於CloudEvent會幫忙夾帶一些metadata, 因此也就可以實現分散式追蹤(Tracing)的功能, 但缺點就是無法支援一些原本寫好的legacy publisher或subscriber, 所幸Dapr的pubsub還是支援raw payload可以讓你自組你的訊息格式</p><p>在開始之前, 為了測試實做, 我這邊採用了Kafka, 但由於Dapr把實做封裝得不錯, 所以其實也不一定要用Kafka, 不過支援了Kraft之後的Kafka, 由於可以去掉對zoo keeper的依賴, 所以算蠻簡單裝的</p><h3 id=安裝kafka>安裝Kafka</h3><p>使用docker跑Kafka, 應該是最簡單的方式, 只要執行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --name kafka-zkless -p 9092:9092 -e LOG_DIR<span style=color:#f92672>=</span>/tmp/logs quay.io/strimzi/kafka:latest-kafka-2.8.1-amd64 /bin/sh -c <span style=color:#e6db74>&#39;export CLUSTER_ID=$(bin/kafka-storage.sh random-uuid) &amp;&amp; bin/kafka-storage.sh format -t $CLUSTER_ID -c config/kraft/server.properties &amp;&amp; bin/kafka-server-start.sh config/kraft/server.properties&#39;</span>
</span></span></code></pre></div><p>這樣Kafka就可以順利活起來了, 完全不需要跑zoo keeper&mldr;喔耶&mldr;</p><p>建議也可以順便跑一下<a href=https://github.com/dushixiang/kafka-map>Kafka map</a>, 這樣待會可以直接發event來測試</p><h3 id=新增kafka-component>新增Kafka component</h3><p>有了Kafka後, 我們需要在Dapr新增這個component 才可以讓Dapr應用程式使用, 在<code>~/.dape/components</code>底下加一個檔案(可叫做kafka.yaml),內容是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>dapr.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Component</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-pubsub</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>pubsub.kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>brokers</span> <span style=color:#75715e># Required. Kafka broker connection setting</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;localhost:9092&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumerGroup</span> <span style=color:#75715e># Optional. Used for input bindings.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;group1&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authType</span> <span style=color:#75715e># Required.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;none&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>disableTls</span> <span style=color:#75715e># Optional. Disable TLS. This is not safe for production!! You should read the `Mutual TLS` section for how to use TLS.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>內容就不多做解釋了, 官方文件會有更清楚的說明, 這邊先說明, 這新增上去後, 我們會多一個pubsub component叫做<code>kafka-pubsub</code>, 這名字寫程式會用到囉</p><h3 id=寫個subscriber來接收事件event吧>寫個subscriber來接收事件(event)吧</h3><p><a href=https://docs.dapr.io/developing-applications/building-blocks/pubsub/pubsub-raw/>官方文件</a>其實有寫如何寫一個接收raw payload的subscriber, 但不像其他文件一樣有多種語言範例, 只有Python, PHP兩種</p><p><img src=/post/images/20221108224329.png alt></p><p>但其實, 如上圖, Dapr用sidecar的作法, 簡化了寫pubsub的複雜度, 而且減低了對語言的依賴, 也不像是Istio是從系統的角度設計, 算是有點有趣的作法, 你不用理解pubsub, 也不用特別知道你是用Kafka, NATS, 或者是RabbitMQ, 寫法都一樣, 不囉嗦, 直接看code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/base64&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Subscription</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PubsubName</span> <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;pubsubname&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span>      <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;topic&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Route</span>      <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;route,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Metadata</span>   <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Event</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;topic&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Data</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;data_base64&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sub</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Subscription</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PubsubName</span>: <span style=color:#e6db74>&#34;kafka-pubsub&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span>:      <span style=color:#e6db74>&#34;myevent&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Route</span>:      <span style=color:#e6db74>&#34;create&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Metadata</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;rawPayload&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/dapr/subscribe&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, []<span style=color:#f92672>*</span><span style=color:#a6e22e>Subscription</span>{<span style=color:#a6e22e>sub</span>})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>POST</span>(<span style=color:#e6db74>&#34;/create&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>event</span> <span style=color:#a6e22e>Event</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Body</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawStdEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Data</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>decoded</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;success&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:6002&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>咦, 這不像是在寫subscriber呀, 倒像是一個web service, 沒錯, 實際上的subscribe的部分被封裝在Dapr內了, Dapr等於收到Event後會打給我們的程式</p><p>那他怎知道要收到哪個queue哪個topic要打到哪個endpoint? 很簡單, 你只要有一個叫做<code>/dapr/subscribe</code>的endpoint, 在開始執行後, Dapr會自行打這endpoint了解你希望幫忙它收哪些event, 這邊我們希望收的 PubsubName (這邊是我們剛剛加的<code>kafka-pubsub</code>), 另外我們希望收<code>myevent</code>這個topic, 然後我們會希望收到event後打<code>/create</code>這個endpoint, 這有個好處, 你換成另一個完全不一樣的方案, 比如說Redis, 是不需要重新改code的</p><p>那我們在<code>/create</code>會收到甚麼呢?基本上就是包裝成CloudEvent的資料結構, 不對, 我們不是要收raw payload嗎?別急, 它只是收到後幫你包裝, 你的raw payload是被base64編碼好好地放在欄位<code>data_base64</code>中</p><p>這邊我特別沒用任何Dapr SDK, 然後也用gin來寫(Dapr的sdk裡用的是Gorilla),主要是為了展示, 這簡單到不用SDK呀(其實sdk也還沒支援raw payload subscriber相關的呀 XD)</p><h3 id=執行>執行</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dapr run --app-id subs --app-port <span style=color:#ae81ff>6002</span> --dapr-http-port <span style=color:#ae81ff>3601</span> --dapr-grpc-port <span style=color:#ae81ff>60001</span> --log-level debug go run main.go
</span></span></code></pre></div><p>指令如上, 可以設定log level把debug訊息打開, 這邊有一點需要注意的, 這浪費我半天的青春, app port一定要設對, 我們程式內用<code>6002</code>那麼這邊的app port就要是<code>6002</code>, 不然Dapr不但會不知道要打事件給你, 連一開始的設定都拿不到(就是打<code>dapr/subscribe</code>)</p><h3 id=測試>測試</h3><p>測試方式很簡單, 如果你剛剛有裝Kafka map, 去那個topic發送一個訊息(按Produce message), 看有沒收到一樣的訊息就可以了</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-11-02 22:01:38 +0800 +0800"><a href=/%E5%9C%A8%E8%88%87%E4%B8%96%E9%9A%94%E7%B5%95%E7%9A%84%E7%92%B0%E5%A2%83%E5%AE%89%E8%A3%9DDapr%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83/>Nov 2, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~2 minutes</span></div><h1 class=entry-title><a href=/%E5%9C%A8%E8%88%87%E4%B8%96%E9%9A%94%E7%B5%95%E7%9A%84%E7%92%B0%E5%A2%83%E5%AE%89%E8%A3%9DDapr%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83/ rel=bookmark title=在與世隔絕的環境安裝Dapr開發環境 itemprop=url>在與世隔絕的環境安裝Dapr開發環境</a></h1></header><div class=entry-content><p>這邊的與世隔絕當然不是真的與世隔絕啦! 我指的是無法連上外面的docker registry的環境, 例如docker hub或是quay.io, 開發環境指的是你要在local可以用來開發測試的standalone模式</p><p>首先, 你要先裝好docker(或podman)</p><h3 id=如果有private-registry>如果有private registry</h3><p>有幾個images會需要放到registry裡面的, 像是</p><ul><li>dapr</li><li>3rdparty/redis</li><li>3rdparty/zipkin</li><li>placement</li><li>daprd</li></ul><p>列表可以在 <a href="https://github.com/orgs/dapr/packages?repo_name=dapr">這邊</a> 找到 (這邊的是放在github上的)</p><p>接著安裝dapr cli, 如果可以直接連上internet, 那就用官方文件的做法:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | DAPR_INSTALL_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$HOME<span style=color:#e6db74>/dapr&#34;</span> /bin/bash
</span></span></code></pre></div><p>但如果不行呢? 那就想辦法到<a href=https://github.com/dapr/cli/releases/tag/v1.9.1>github上下載</a>cli回來安裝</p><p>因為要從private history來安裝dapr, 所以在<code>dapr init</code>要多下一個參數, 像是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dapr init --image-registry MY_REGISTRY_URL
</span></span></code></pre></div><p>這樣就會從你private registry抓回來裝了</p><p>但如果連private registry都沒辦法放上相關的image呢?</p><h3 id=不依靠docker-registry安裝>不依靠docker registry安裝</h3><p>Dapr很貼心呀! 還有<a href=https://github.com/dapr/installer-bundle/releases>install bundle</a>, 可以想辦法先去前一個連結裝bundle回來</p><p>這個bundle裡面已經有個dapr cli了, 所以解開後, 把dapr複製到你要的目錄, 例如:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo cp ./dapr /usr/local/bin
</span></span></code></pre></div><p>現在我們就有cli可以用了, 但images怎辦? bundle裡面其實就包含有相關的image的tar檔了, 所以把init方式改成:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dapr init --from-dir . -s
</span></span></code></pre></div><p>這樣就會用local image安裝了, 這邊多加了個<code>-s</code>表示是slim mode, 沒有redis, 沒zipkin的, 因為local images沒有放, 但如果自己需要(比如說要寫state store需要redis), 那就要自己去加component</p><p>以redis當state store為例: 假設我們需要一個redis來當state store, 且這redis我們預先跑在本機, port為為6379, 此store名稱為mystore, 我們可以在<code>~/.dapr/components/</code>這目錄加上一個mystore.yaml,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>dapr.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Component</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mystore</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>state.redis</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>redisHost</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>localhost:6379</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>redisPassword</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>actorStateStore</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>這樣我們就有一個名叫mystore的state store了, 不只state store, 其他也可以如法炮製</p><h4 id=那如果想用podman取代docker呢>那如果想用podman取代docker呢?</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dapr init --from-dir . -s --container-runtime podman
</span></span></code></pre></div></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-10-08 16:10:26 +0800 +0800"><a href=/%E7%94%A8Varnish%E4%BE%86%E5%BF%AB%E5%8F%96minio%E4%B8%8A%E7%9A%84%E7%89%A9%E4%BB%B6/>Oct 8, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/%E7%94%A8Varnish%E4%BE%86%E5%BF%AB%E5%8F%96minio%E4%B8%8A%E7%9A%84%E7%89%A9%E4%BB%B6/ rel=bookmark title=用Varnish來快取minio上的物件 itemprop=url>用Varnish來快取minio上的物件</a></h1></header><div class=entry-content><p>剛好想說要用Varish來做一下Minio(S3)的cache, 研究了一下順便做個紀錄</p><p>先在Ubuntu上裝來試試, 可以用<code>apt</code> 來安裝：</p><pre tabindex=0><code>apt install varnish
</code></pre><p>在Ubuntu 20.04上(WSL用的版本)是6.2.1的版本, 最新版應該是7.2, 不過沒差, 做法都一樣</p><p>Varnish預設的設定在<code>/etc/varnish/default.vcl</code>, 打開這檔案你就可以看到像這樣的內容:</p><pre tabindex=0><code class=language-vcl data-lang=vcl>vcl 4.0;

# Default backend definition. Set this to point to your content server.
backend default {
    .host = &#34;127.0.0.1&#34;;
}
sub vcl_recv {
    # Happens before we check if we have this in cache already.
    #
    # Typically you clean up the request here, removing cookies you don&#39;t need,
    # rewriting the request, etc.
}

sub vcl_backend_response {
    # Happens after we have read the response headers from the backend.
    #
    # Here you clean the response headers, removing silly Set-Cookie headers
    # and other mistakes your backend does.
}

sub vcl_deliver {
    # Happens when we have all the pieces we need, and are about to send the
    # response to the client.
    #
    # You can do accounting or modifying the final object here.
}
</code></pre><p>Varnish的設定檔用的是一種叫做vcl的語言, 它會被Varnish先compile過後才會被使用, 所以改好這檔案後, 如果你跑 <code>sudo system start varnish</code> (這是WSL2上用的, 其他地方可能就是<code>systemctl</code>), 如果你寫錯了, 一開始跑就可以發現出錯了</p><p>以上面那個例子來說, 它會預設快取你local上的web server</p><p>但如果是要連接Minio (S3)是不夠的, 因為如果單純把backend設成 Minio server, 那client還是會需要access key和secret key才可以存取, 如果你希望讓它跟存取靜態網站一樣, 那你可以能會希望把這兩個設定放在後端</p><p>Vanish出場是沒支援可以call S3 API的, 這時候就要透過一個<a href=https://github.com/xcir/libvmod-awsrest>VMOD - AWSRest</a>, 這VMOD是可以在你去backend (Minio/S3) 拿資料前先幫你用你的access key, secret key算好簽章(signature), 所以我們要先安裝這個VMOD</p><p>安裝VMOD你會先需要<code>libvarnishapi-dev</code>, 可以用<code>apt install libvarnishapi-dev</code>來安裝, 另外AWSRest還會需要mhash, 你還會需要安裝<code>apt-get install libmhash-dev</code></p><p>裝好後, 從 <a href=https://github.com/xcir/libvmod-awsrest>https://github.com/xcir/libvmod-awsrest</a> 抓取最新的source code, 進入目錄後執行</p><pre tabindex=0><code>./autogen.sh
./configure
make
sudo make install
</code></pre><p>沒意外的話就可以完成安裝, 要確認是不是已經安裝好了, 我們可以在default.vcl加上</p><pre tabindex=0><code class=language-vcl data-lang=vcl>vcl 4.0;
import awsrest;

# ....
</code></pre><p>重啟varnish有成功, 表示應該是沒啥問題才對</p><p>我在我本地端電腦跑了個Minio, port為9000, 有一個bucket叫做<code>mmmbux</code>, 裡面有個檔案, key為<code>20220101/a.c</code>, access key為<code>TGhYs2FYBGMYueAz</code>, secrect key為<code>IM2SgF7LxIlZVbeo3Vv7OdQzA7pnZFB1</code>, Varnish則是跑在port 6081上</p><p>首先我們來看看怎讓client/browser在不用提供access key/secret key的狀況下可以存取物件</p><pre tabindex=0><code class=language-vcl data-lang=vcl>vcl 4.0;
import awsrest;

backend default {
    .host = &#34;127.0.0.1&#34;;
    .port = &#34;9000&#34;;
}

sub vcl_recv {
    set req.http.host = &#34;127.0.0.1&#34;;
    awsrest.v4_generic(
        service           = &#34;s3&#34;,
        region            = &#34;ap-northeast-1&#34;,
        access_key        = &#34;TGhYs2FYBGMYueAz&#34;,
        secret_key        = &#34;IM2SgF7LxIlZVbeo3Vv7OdQzA7pnZFB1&#34;,
        signed_headers    = &#34;host;&#34;,
        canonical_headers = &#34;host:&#34; + req.http.host + awsrest.lf()
    );
}
</code></pre><p>Ok, 其實就很簡單的在vcl_recv上加上那幾行就好, 這時候你就可以用 <code>http://localhost:6081/mmmbux/20220101/a.c</code> 來存取 <code>mmmbux</code> 這bucket上 <code>2022/0101/a.c</code> 這個檔案了</p><p>那, 如果我不想把bucket name當作url的一部分呢?</p><pre tabindex=0><code class=language-vcl data-lang=vcl>sub vcl_recv {
    set req.http.host = &#34;127.0.0.1&#34;;
    set req.url = &#34;mmmbux/&#34; + req.url
    awsrest.v4_generic(
        service           = &#34;s3&#34;,
        region            = &#34;ap-northeast-1&#34;,
        access_key        = &#34;TGhYs2FYBGMYueAz&#34;,
        secret_key        = &#34;IM2SgF7LxIlZVbeo3Vv7OdQzA7pnZFB1&#34;,
        signed_headers    = &#34;host;&#34;,
        canonical_headers = &#34;host:&#34; + req.http.host + awsrest.lf()
    );
}
</code></pre><p>上面這段就是把你進來的url加上<code>mmmbux/</code>當新的url, 這樣做的話, 你的新url就會是 <code>http://localhost:6081/20220101/a.c</code></p><p>那如果我想進一步, 把它變成 <code>http://localhost:6081/files/20220101/a.c</code> 呢?</p><pre tabindex=0><code class=language-vcl data-lang=vcl>sub vcl_recv {
    set req.http.host = &#34;127.0.0.1&#34;;
    
    if (req.url ~ &#34;^/files/&#34;) {
        set req.url = regsub(req.url, &#34;^/files/&#34;, &#34;/mmmbux/&#34;);
        awsrest.v4_generic(
          service           = &#34;s3&#34;,
          region            = &#34;ap-northeast-1&#34;,
          access_key        = &#34;TGhYs2FYBGMYueAz&#34;,
          secret_key        = &#34;IM2SgF7LxIlZVbeo3Vv7OdQzA7pnZFB1&#34;,
          signed_headers    = &#34;host;&#34;,
          canonical_headers = &#34;host:&#34; + req.http.host + awsrest.lf()
        );
    } else {
        return(synth(404));
    }
}
</code></pre><p>上面這段就是把<code>/files/</code>後面的都到 <code>mmmbux</code>這bucket去抓, 然後其他目錄都回傳 <code>404 Not found</code></p><p>那如果我想要用docker跑也要有這VMod呢? 我把這Dockerfile的範例放在<a href=https://github.com/julianshen/varnish-awsrest-docker>https://github.com/julianshen/varnish-awsrest-docker</a>, Varnish 官方的docker image有提供 <code>install-vmod</code> 這script讓你安裝vmod, 所以只需要給它awsrest的tarball: <a href=https://github.com/xcir/libvmod-awsrest/archive/refs/tags/v70.12.tar.gz>https://github.com/xcir/libvmod-awsrest/archive/refs/tags/v70.12.tar.gz</a> 即可, 我做了一個現成的image放在<code>quay.io/jlnshen/varnish-awsrest</code></p></div></article><div class=pagination><ul class=inline-list><li><strong class=current-page>1</strong></li><li><a href=/page/2/>2</a></li><li><a href=/page/3/>3</a></li><li><a href=/page/4/>4</a></li><li><a href=/page/5/>5</a></li><li><a href=/page/6/>6</a></li><li><a href=/page/7/>7</a></li><li><a href=/page/8/>8</a></li><li><a href=/page/9/>9</a></li><li><a href=/page/10/>10</a></li><li><a href=/page/11/>11</a></li><li><a href=/page/12/>12</a></li><li><a href=/page/13/>13</a></li><li><a href=/page/14/>14</a></li><li><a href=/page/15/>15</a></li><li><a href=/page/16/>16</a></li><li><a href=/page/17/>17</a></li><li><a href=/page/18/>18</a></li><li><a href=/page/19/>19</a></li><li><a href=/page/20/>20</a></li><li><a href=/page/21/>21</a></li><li><a href=/page/22/>22</a></li><li><a href=/page/23/>23</a></li><li><a href=/page/24/>24</a></li><li><a href=/page/25/>25</a></li><li><a href=/page/26/>26</a></li><li><a href=/page/27/>27</a></li><li><a href=/page/28/>28</a></li><li><a href=/page/29/>29</a></li><li><a href=/page/30/>30</a></li><li><a href=/page/31/>31</a></li><li><a href=/page/32/>32</a></li><li><a href=/page/33/>33</a></li><li><a href=/page/34/>34</a></li><li><a href=/page/35/>35</a></li><li><a href=/page/36/>36</a></li><li><a href=/page/37/>37</a></li><li><a href=/page/38/>38</a></li><li><a href=/page/39/>39</a></li><li><a href=/page/40/>40</a></li><li><a href=/page/41/>41</a></li><li><a href=/page/42/>42</a></li><li><a href=/page/43/>43</a></li><li><a href=/page/44/>44</a></li><li><a href=/page/45/>45</a></li><li><a href=/page/46/>46</a></li><li><a href=/page/47/>47</a></li><li><a href=/page/48/>48</a></li><li><a href=/page/49/>49</a></li><li><a href=/page/50/>50</a></li><li><a href=/page/51/>51</a></li><li><a href=/page/52/>52</a></li><li><a href=/page/53/>53</a></li><li><a href=/page/54/>54</a></li><li><a href=/page/55/>55</a></li><li><a href=/page/56/>56</a></li><li><a href=/page/57/>57</a></li><li><a href=/page/58/>58</a></li><li><a href=/page/59/>59</a></li><li><a href=/page/60/>60</a></li><li><a href=/page/61/>61</a></li><li><a href=/page/62/>62</a></li><li><a href=/page/63/>63</a></li><li><a href=/page/64/>64</a></li><li><a href=/page/65/>65</a></li><li><a href=/page/66/>66</a></li><li><a href=/page/67/>67</a></li><li><a href=/page/68/>68</a></li><li><a href=/page/69/>69</a></li><li><a href=/page/70/>70</a></li><li><a href=/page/71/>71</a></li><li><a href=/page/72/>72</a></li><li><a href=/page/73/>73</a></li><li><a href=/page/74/>74</a></li><li><a href=/page/75/>75</a></li><li><a href=/page/76/>76</a></li><li><a href=/page/2/ class=btn>Next</a></li></ul></div></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>