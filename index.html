<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Le murmure de Julian</title><meta name=description content><meta property="og:url" content="https://blog.jln.co/"><meta property="og:site_name" content="Le murmure de Julian"><meta property="og:title" content="Le murmure de Julian"><meta property="og:locale" content="zh_tw"><meta property="og:type" content="website"><meta property="og:image" content="https://blog.jln.co/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.jln.co/images/avatar.png"><meta name=twitter:title content="Le murmure de Julian"><link rel=canonical href=https://blog.jln.co/><link rel=alternate type=application/rss+xml href=https://blog.jln.co/feed.xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.149.1"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script><link rel="shortcut icon" href=/favicon.png></head><body id=post-index class=feature><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=entry-image><img src=/images/bkg2.jpg alt="Le murmure de Julian"></div><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>朱隸安貓囈語錄</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2025-09-08 00:09:34 +0800 +0800"><a href=/Shi-Yong-Chrome-Devtools-Yuan-Duan-Zhen-Cuo-Electron-Ying-Yong-Cheng-Shi/>Sep 8, 2025</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~3 minutes</span></div><h1 class=entry-title><a href=/Shi-Yong-Chrome-Devtools-Yuan-Duan-Zhen-Cuo-Electron-Ying-Yong-Cheng-Shi/ rel=bookmark title="使用 Chrome DevTools 遠端偵錯 Electron 應用程式" itemprop=url>使用 Chrome DevTools 遠端偵錯 Electron 應用程式</a></h1></header><div class=entry-content><p>Electron 讓開發者可以使用 Web 技術（HTML、CSS、JavaScript）來建立桌面應用程式。然而，在開發過程中，對主程序（main process）進行偵錯可能會比渲染程序（renderer process）稍微複雜一些。本文將介紹如何利用 <strong>Chrome DevTools</strong> 的強大功能，透過幾個關鍵的命令列參數來遠端偵錯你的 Electron 應用程式。</p><h2 id=為什麼需要遠端偵錯>為什麼需要遠端偵錯？</h2><p>渲染程序就像是網頁，你可以直接在視窗上按右鍵選擇「檢查」來開啟 DevTools。但主程序則是在後台運行，沒有可視化的介面。這時，我們就需要一種方法，將主程序的執行環境與一個獨立的偵錯工具連接起來。</p><p>這就是 <strong>Chrome DevTools</strong> 的「遠端偵錯」功能發揮作用的地方。透過特定的命令列參數，我們可以在啟動 Electron 應用程式時，開啟一個偵錯伺服器，然後再用 Chrome 瀏覽器去連接這個伺服器。</p><h2 id=關鍵命令列參數>關鍵命令列參數</h2><p>以下是三個最常用的命令列參數，它們各自有不同的用途：</p><h3 id=1--inspect>1. <code>-inspect</code></h3><p>這個參數會在啟動時，在指定的通訊埠上開啟一個偵錯伺服器。</p><p><strong>用法：</strong></p><pre tabindex=0><code>electron --inspect=5858 your_app.js
</code></pre><p><strong>說明：</strong></p><ul><li><code>-inspect</code> 會告訴 Electron 應用程式，在啟動時啟動一個偵錯伺服器。</li><li><code>=5858</code> 指定了伺服器將在 <strong>5858</strong> 這個通訊埠上監聽。如果沒有指定通訊埠，它會自動選擇一個可用的通訊埠。</li><li>當應用程式啟動後，你可以在 Chrome 瀏覽器中打開 <code>chrome://inspect</code> 頁面，然後在「Remote Target」部分找到你的應用程式，點擊 <strong>inspect</strong> 即可開始偵錯。</li></ul><p><strong>應用場景：</strong></p><ul><li><strong>即時偵錯：</strong> 適合在應用程式正常運行時，需要檢查變數、調用堆棧、或是執行一些程式碼片段的情況。</li><li><strong>不中斷啟動：</strong> 應用程式會正常啟動，不會在第一行程式碼處暫停。</li></ul><h3 id=2--inspect-brk>2. <code>-inspect-brk</code></h3><p>這個參數的功能與 <code>--inspect</code> 類似，但它會在應用程式的第一行程式碼處暫停執行，直到你連接偵錯器為止。</p><p><strong>用法：</strong></p><pre tabindex=0><code>electron --inspect-brk=5858 your_app.js
</code></pre><p><strong>說明：</strong></p><ul><li><code>-inspect-brk</code> 是 <strong>inspect</strong> 和 <strong>break</strong> 的組合。</li><li>當應用程式啟動時，它會在 <code>your_app.js</code> 的第一行程式碼（通常是 <code>require</code> 語句或函數定義）處暫停。</li><li>這讓你可以在程式碼開始執行之前，設定中斷點（breakpoints），以便逐步追蹤程式碼的執行流程。</li></ul><p><strong>應用場景：</strong></p><ul><li><strong>啟動時偵錯：</strong> 適合需要追蹤應用程式啟動時的行為、檢查初始化流程中的變數、或是尋找啟動時的錯誤。</li><li><strong>精準控制：</strong> 確保你不會錯過任何關鍵的程式碼執行時刻。</li></ul><h3 id=3--remote-debugging-port>3. <code>-remote-debugging-port</code></h3><p>這個參數並不是用來偵錯主程序的，它的主要目的是用來為渲染程序啟用遠端偵錯功能。</p><p><strong>用法：</strong></p><pre tabindex=0><code>electron --remote-debugging-port=9222 your_app.js
</code></pre><p><strong>說明：</strong></p><ul><li><code>-remote-debugging-port</code> 會讓所有 <strong>渲染程序</strong> (包括主視窗和任何新建立的視窗) 都在指定的通訊埠上開啟遠端偵錯。</li><li>這在某些情況下非常有用，例如你無法直接右鍵點擊視窗來開啟 DevTools，或是需要從外部腳本控制多個渲染程序的偵錯。</li><li>當你使用這個參數後，可以在 <code>chrome://inspect</code> 頁面中看到所有渲染程序的「Target」列表。</li></ul><p><strong>應用場景：</strong></p><ul><li><strong>多視窗偵錯：</strong> 如果你的應用程式有多個渲染程序視窗，這個參數可以幫助你統一管理它們的偵錯。</li><li><strong>自動化測試：</strong> 許多自動化測試工具會利用這個參數來控制瀏覽器行為。</li></ul><h2 id=總結與分析>總結與分析</h2><table><thead><tr><th>參數</th><th>偵錯目標</th><th>是否中斷啟動</th><th>用途</th></tr></thead><tbody><tr><td><code>--inspect</code></td><td><strong>主程序</strong></td><td><strong>否</strong></td><td>適合即時偵錯、檢查運行中的變數。</td></tr><tr><td><code>--inspect-brk</code></td><td><strong>主程序</strong></td><td><strong>是</strong></td><td>適合啟動時偵錯、追蹤初始化流程。</td></tr><tr><td><code>--remote-debugging-port</code></td><td><strong>渲染程序</strong></td><td><strong>否</strong></td><td>適合多視窗偵錯、自動化測試。</td></tr></tbody></table><p><strong>結論：</strong></p><ul><li>如果你只是想在應用程式運行時看看主程序發生了什麼，使用 <strong><code>-inspect</code></strong> 就足夠了。</li><li>如果你想在主程序啟動的當下就開始追蹤，以便抓住啟動時的錯誤，<strong><code>-inspect-brk</code></strong> 則是你的最佳選擇。</li><li>如果你需要對無法直接開啟 DevTools 的渲染程序進行偵錯，或是希望對多個視窗進行偵錯，請使用 <strong><code>-remote-debugging-port</code></strong>。</li></ul><p>希望這篇文章能幫助你更好地使用 Chrome DevTools 來遠端偵錯你的 Electron 應用程式！</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2024-06-30 01:02:25 +0800 +0800"><a href=/Shi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao/>Jun 30, 2024</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/Shi-Yong-Chromedp-Pa-Qu-Dong-Tai-Wang-Zhan-Zi-Liao/ rel=bookmark title="使用 Chromedp 爬取動態網站資料" itemprop=url>使用 Chromedp 爬取動態網站資料</a></h1></header><div class=entry-content><p>在現代的網頁開發中，JavaScript 驅動的動態網站變得越來越普遍，這對使用傳統 HTML 解析的爬蟲工具帶來了挑戰。傳統的方法不再適用，因為網頁的內容必須在執行 JavaScript 後才會生成。解析這種網站需要更多前端的知識。</p><p>chromedp 是一個用 Go 語言編寫的工具包，它通過 Chrome 的 DevTools 協議進行無頭瀏覽器(Headless Browser)自動化，使開發者能夠程式化地控制 Chrome 瀏覽器，方便地爬取和解析動態生成的內容。本文將介紹如何使用 chromedp 來建立一個簡單的網路爬蟲。</p><h2 id=基本原理>基本原理</h2><p>chromedp 主要通過與 Chrome 瀏覽器的 DevTools 協議通信來實現其功能。這使得開發者可以模擬使用者操作，例如導航到網頁、點擊按鈕、填寫表單以及提取動態載入的內容。這些操作在無頭模式（Headless mode）下進行，瀏覽器界面不可見，從而提高效能和資源利用效率。透過這種方式，chromedp 可以處理傳統 HTML 解析工具無法處理的情況，特別是在處理動態生成的內容時。</p><h2 id=簡單範例程式碼>簡單範例程式碼</h2><p>以下是一個使用 chromedp 爬取網站資料的簡單範例，這個範例展示了如何導航到一個網站、選擇一些元素、提交表單並提取所需的數據：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;github.com/chromedp/chromedp&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span> <span style=color:#75715e>// 建立 context</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 分配瀏覽器</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> = <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewExecAllocator</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>DefaultExecAllocatorOptions</span>[:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 建立具有timeout 30秒的 context</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> = <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// 執行任務</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>res</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#e6db74>&#34;https://example.com&#34;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitVisible</span>(<span style=color:#e6db74>`body`</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SendKeys</span>(<span style=color:#e6db74>`input[name=&#34;q&#34;]`</span>, <span style=color:#e6db74>&#34;chromedp&#34;</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Click</span>(<span style=color:#e6db74>`input[type=&#34;submit&#34;]`</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitVisible</span>(<span style=color:#e6db74>`#result-stats`</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Text</span>(<span style=color:#e6db74>`#result-stats`</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQuery</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Search Result Stats:&#34;</span>, <span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在這個範例中，我們建立了一個 chromedp 任務，它會導航到 example.com，等待頁面載入完成後，在搜尋框中輸入 &ldquo;chromedp&rdquo;，點擊提交按鈕，然後等待搜尋結果統計資訊的元素可見，並提取該資訊。這是一個基本範例，展示了如何使用 chromedp 進行基本的網頁互動和數據提取。你可以根據需要擴展此範例以實現更複雜的爬蟲功能。</p><p>接下來我們用一個更實用的案例來實作，以下範例展示如何使用 chromedp 爬取中華職棒（CPBL）的賽程表，此網站由 Vue.js 實作。</p><h2 id=解析文件>解析文件</h2><p>中華職棒賽程網站的網址是 <a href=https://cpbl.com.tw/schedule>https://cpbl.com.tw/schedule</a>。首先，我們用檢視網頁原始碼（View page source）來看看，可以發現裡面找不到任何賽程資料。另外，我們還能發現這段程式碼：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Vue</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>el</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;#Center&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mixins</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>mixin</span>],
</span></span></code></pre></div><p>以及另一段用來取得賽程資訊的程式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>$</span>.<span style=color:#a6e22e>ajax</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/schedule/getgamedatas&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>filterData</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RequestVerificationToken</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PzmpuUOvS4z2zH_QhwgFQYTzVC82b0n2QH30wEOJ12kOWA6zeq0Yn7_6d2v_o-ZTWuNPe3HjrqsMqAHp9sL0F5KB4KM1:5jgubJ0tGDTK3cLm2JU7_bCw9JqLOG8j8yeNiWDhR4nnTACLXerDqmzB5chZv-iqY8m1ep6IirI3hAwRCPfNTU6jO_E1&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>success</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>result</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Success</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_this</span>.<span style=color:#a6e22e>gameDatas</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>GameDatas</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_this</span>.<span style=color:#a6e22e>getGames</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>res</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>res</span>);
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>complete</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#34;body&#34;</span>).<span style=color:#a6e22e>unblock</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>很明顯這是一個用 Vue.js 寫的網頁。我們當然可以試著去打它的 API，但看到那串 Token，可能做了某些保護，使用 chromedp 的方式可能更簡單。</p><p>那怎麼開始解析呢？用 ChatGPT 或許是一個好方法，打開 Chrome 的開發人員工具，在 Elements 那邊可以看到已經是最終的網頁結果，試著把它存成一個檔案並詢問 ChatGPT：</p><p><img src=/images/posts/chrgpt-1.png alt></p><p>資料結構也可以順便請它設計一下:</p><p><img src=/images/posts/chrgpt-2.png alt></p><p>這當然只能當作一開始的參考，後面也可以請它幫你直接寫程式。不過，我試了一下，它寫出來的只能當範例，不能產出正確的結果，但拿來作為基礎修改其實也不錯用。</p><p>先定義一下需求，我們需要寫一個函數，可以輸入年月和比賽種類來取得賽程資訊。</p><p>依照這些資訊，先來寫一個比較粗略的版本來實驗一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Game</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>No</span>       <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;no&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Year</span>     <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;year&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Month</span>    <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;month&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Day</span>      <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;day&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Home</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;home&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Away</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;away&#34;`</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Ballpark</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;ballpark&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getGameNodes</span>(<span style=color:#a6e22e>nodes</span> <span style=color:#f92672>*</span>[]<span style=color:#f92672>*</span><span style=color:#a6e22e>cdp</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ActionFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctxWithTimeout</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#ae81ff>900</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Nodes</span>(<span style=color:#e6db74>&#34;div.game&#34;</span>, <span style=color:#a6e22e>nodes</span>).<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>ctxWithTimeout</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>dom</span>.<span style=color:#a6e22e>RequestChildNodes</span>(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>NodeID</span>).<span style=color:#a6e22e>WithDepth</span>(<span style=color:#ae81ff>6</span>).<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>ctxWithTimeout</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span> })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectMonth</span>(<span style=color:#a6e22e>month</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>QueryAction</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#e6db74>&#34;div.item.month select&#34;</span>, <span style=color:#a6e22e>month</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQueryAll</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectYear</span>(<span style=color:#a6e22e>year</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>QueryAction</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#e6db74>&#34;div.item.year select&#34;</span>, <span style=color:#a6e22e>year</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQueryAll</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>selectGameType</span>(<span style=color:#a6e22e>gtype</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>SetValue</span>(<span style=color:#e6db74>&#34;div.item.game_type select&#34;</span>, <span style=color:#a6e22e>gtype</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ByQueryAll</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>fetchGamesByMonth</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>year</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>month</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>Game</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>selectMonth</span>(<span style=color:#a6e22e>month</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitVisible</span>(<span style=color:#e6db74>&#34;div.ScheduleGroup&#34;</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>800</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>cdp</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mn</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Text</span>(<span style=color:#e6db74>&#34;.date_selected .date&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mn</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getGameNodes</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nodes</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>games</span> []<span style=color:#a6e22e>Game</span> = make([]<span style=color:#a6e22e>Game</span>, len(<span style=color:#a6e22e>nodes</span>))
</span></span><span style=display:flex><span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>No</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Trim</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>NodeValue</span>, <span style=color:#e6db74>&#34; &#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Ballpark</span> = <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>NodeValue</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Year</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>year</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>monthInt</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>month</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Month</span> = <span style=color:#a6e22e>monthInt</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dataDate</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Parent</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>AttributeValue</span>(<span style=color:#e6db74>&#34;data-date&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>day</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>dataDate</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Day</span> = <span style=color:#a6e22e>day</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Away</span> = <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>AttributeValue</span>(<span style=color:#e6db74>&#34;title&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>games</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Home</span> = <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>2</span>].<span style=color:#a6e22e>Children</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>AttributeValue</span>(<span style=color:#e6db74>&#34;title&#34;</span>)
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>games</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這個版本程式碼很粗略但可用，主要使用 NodeValue 和 AttributeValue 來取值。這種方法的問題在於，這些 chromedp 呼叫每一個都需要與 Chrome 通信，而這是通過 Chrome DevTools Protocol 來實現的。Chrome DevTools Protocol 使用 WebSocket 進行通信，這樣頻繁來回不僅效率低，穩定性也較差。</p><p>下面這個範例是從 ChatGPT 學來的方法再優化的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// FetchSchedule fetches the schedule from CPBL website based on the year, month, and game type</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FetchSchedule</span>(<span style=color:#a6e22e>year</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>month</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>gameType</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#a6e22e>GameSchedule</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>schedules</span> []<span style=color:#a6e22e>GameSchedule</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// Define the URL</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;https://cpbl.com.tw/schedule&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>// Run chromedp tasks</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#a6e22e>url</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitReady</span>(<span style=color:#e6db74>`.ScheduleTableList`</span>), <span style=color:#75715e>// Wait for year select to be ready</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;document.querySelector(&#39;#Center&#39;).__vue__.filters.kindCode = &#39;%s&#39;&#34;</span>, <span style=color:#a6e22e>gameType</span>), <span style=color:#66d9ef>nil</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;document.querySelector(&#39;#Center&#39;).__vue__.calendar.year = %d&#34;</span>, <span style=color:#a6e22e>year</span>), <span style=color:#66d9ef>nil</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>WaitReady</span>(<span style=color:#e6db74>`.ScheduleTableList`</span>), <span style=color:#75715e>// Wait for year select to be ready</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;document.querySelector(&#39;#Center&#39;).__vue__.calendar.month = %d&#34;</span>, <span style=color:#a6e22e>month</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>), <span style=color:#66d9ef>nil</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#e6db74>`document.querySelector(&#39;#Center&#39;).__vue__.getGameDatas()`</span>, <span style=color:#66d9ef>nil</span>), <span style=color:#75715e>// Wait for table to be visible</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>), <span style=color:#75715e>// Wait for table to load</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Evaluate</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   (() =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    let schedules = [];
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    document.querySelectorAll(&#39;.ScheduleTable tbody .date&#39;).forEach(dateDiv =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     let date = dateDiv.innerText.trim();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     let parent = dateDiv.parentNode;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     parent.querySelectorAll(&#39;.game&#39;).forEach(gameDiv =&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let location = gameDiv.querySelector(&#39;.place&#39;) ? gameDiv.querySelector(&#39;.place&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let game_no = gameDiv.querySelector(&#39;.game_no&#39;) ? gameDiv.querySelector(&#39;.game_no&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let away_team = gameDiv.querySelector(&#39;.team.away span&#39;) ? gameDiv.querySelector(&#39;.team.away span&#39;).title.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let home_team = gameDiv.querySelector(&#39;.team.home span&#39;) ? gameDiv.querySelector(&#39;.team.home span&#39;).title.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let score = gameDiv.querySelector(&#39;.score&#39;) ? gameDiv.querySelector(&#39;.score&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      let remark = gameDiv.querySelector(&#39;.remark .note div&#39;) ? gameDiv.querySelector(&#39;.remark .note div&#39;).innerText.trim() : &#39;&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      schedules.push({ date, location, game_no, away_team, home_team, score, remark });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    });
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return schedules;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   })()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  `</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>schedules</span>),
</span></span><span style=display:flex><span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>schedules</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這個版本大量使用 chromedp.Evaluate 來內嵌 JavaScript 程式碼直接在網頁執行。這樣可讀性更好，且避免了頻繁與 Chrome 通信。這種方法更高效且穩定。</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2023-09-24 12:02:37 +0800 +0800"><a href=/Da-Xiao-Zhong-Yao-Ma-Ni-Xu-Yao-Shi-Mo-Yang-De-Rong-Qi-Ying-Xiang-Distroless-Chisel-Pack/>Sep 24, 2023</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~9 minutes</span></div><h1 class=entry-title><a href=/Da-Xiao-Zhong-Yao-Ma-Ni-Xu-Yao-Shi-Mo-Yang-De-Rong-Qi-Ying-Xiang-Distroless-Chisel-Pack/ rel=bookmark title=大小重要嗎？你需要什麼樣的容器映像？distroless,chisel,pack itemprop=url>大小重要嗎？你需要什麼樣的容器映像？distroless,chisel,pack</a></h1></header><div class=entry-content><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/nFDAK8NY4JY?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>為什麼用這開場? 跟要講的內容有啥關係? 其實&mldr;沒有&mldr;.只是剛剛看完Continental第一集, 又覺得基哥講這句很帥!!!</p><blockquote><p>&ldquo;What do you need?&rdquo;</p><p>&ldquo;Small and smaller&rdquo;</p></blockquote><p>容器化技術玩多了後, 可能會有人跟你說, 容器的映像檔越小越好, 小到一個極致是最完美的, 所以曾經(現在還有嗎?)有一度, 以alpine基底的映像檔很流行, 但到底要小到多小才夠? 而且建置這個, 就有點像調酒一樣, 放入了基酒(Base image)後, 你還會在上面一層層往上疊加東西, 而且你要加的東西, OS的套件管理又會幫你加一大堆依賴套件(Dependencies), 當你疊了一堆有的沒的之後, 就算你基酒再純粹, 出來的東西還是會很混濁(很肥)</p><p>所以, 大小是有關係的嗎? 大部分的人知道要"小", 但不是每個人都想過, 為何要小? 要把它做的小小的, 不外乎幾個原因:</p><ol><li>傳輸成本: 尤其現在大多流行用Kubernetes管理容器, 當節點(node)失效時, 容器常常需要在節點中搬移, 大的映像需要更多的傳輸頻寬跟時間讓節點從container registry下載下來, 以致於會需要花更多的時間來重建容器, 拉長系統回復的時間</li><li>安全性: 一個映像中裝越多不同的套件, 碰上套件的安全漏洞機率越高, 另外如果安裝了shell就給了人可以去執行一些程式的機會(甚至很多映像其實是以root權限在執行), 如果裡面又有了package manager, 就又可以進去任意安裝軟體, 甚至如果裡面包了一些敏感的設定檔, 資料, server certificate, 那就更增加敏感資料給別人拿走的機率</li><li>可維護性: 這跟2是有關的, 當你套件越多, 碰到安全漏洞需要patch的頻率越高, 尤其如果是base image, 很多應用程式的映像都仰賴於你, 當你更新時, 他們勢必也要一起更新到最新版本</li></ol><p>所以我的看法是, 要追求的應該不是"minimal", 而是"optimal", 只包入自己所需要的就好, 不需要的東西通通塞進去不是一件好事</p><p>那, 我們需要的是怎樣的image? 需要怎樣的base image? 我覺得這要拆兩部份來看 &ndash; <strong>Build</strong>和<strong>Runtime</strong>, 大部分的程式語言, 在建置(Build)時, 需要的東西總是比之後執行的時候來得多, 像java在單元測試時需要一些額外的jar檔, 這些在執行階段是不需要的(也不需要javac), nodejs也是有一些dev only的套件在執行時期是不需要的, go在建置後,那個單一執行檔也就夠了, 很多東西都不需要跟著一起被包入container image之中, 但大部分的人其實不太知道要用<a href=https://docs.docker.com/build/building/multi-stage/>Multi-stage build</a>, 把<strong>Build</strong>和<strong>Runtime</strong> 給分開, 一旦分開了, runtime所需要的基底(base image)就可以使用很精簡的版本, 而build time則可以用比較完整的程式建置環境, 所以關鍵點會在於 <a href=https://docs.docker.com/build/building/multi-stage/>Multi-stage build</a> 的使用</p><h2 id=distroless><a href=https://github.com/GoogleContainerTools/distroless>Distroless</a></h2><p><a href=https://github.com/GoogleContainerTools/distroless>Distroless</a>是一組由Google所維護的base images, 旨在提供一些不包含像是shell和package manager 這類的不必要的東西的映像給執行階段(Runtime)使用, 以增進容器安全性, 它是基於debian建置而來的, 在基於debian 11和debian 12兩種基礎上, 並提供static, base, cc, java, python, nodejs相關runtime的image</p><p>那怎樣利用這一系列的image? 這是拿來當作base image來使用的, 而且就是拿來當runtime base image來使用的, 先以go當例子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>FROM golang:1.21 as build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>WORKDIR /go/src/app</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>COPY . .</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN go mod download</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN go vet -v</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN go test -v</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN CGO_ENABLED=0 go build -o /go/bin/app</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>FROM gcr.io/distroless/static-debian11</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>COPY --from=build /go/bin/app /</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>CMD [&#34;/app&#34;]</span>
</span></span></code></pre></div><p>這例子很清楚的就是一個multi-stage build, 用<code>golang:1.21</code>當作build image, 而用static distroless作為base image, 因為go建置出來的是一個static binary, 不需要有其他依賴, 所以用這最小的版本就足夠了</p><p>那再看看java:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>FROM openjdk:11-jdk-slim-bullseye AS build-env</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>COPY . /app/examples</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>WORKDIR /app</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN javac examples/*.java</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN jar cfe main.jar examples.HelloJava examples/*.class </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>FROM gcr.io/distroless/java11-debian11</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>COPY --from=build-env /app /app</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>WORKDIR /app</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>CMD [&#34;main.jar&#34;]</span>
</span></span></code></pre></div><p>他就必須要用到distroless/java11-debian了,因為這版才有java runtime (JVM), 另外, 既然是Google出品, 可以搭配Bazel用也一點不意外, <a href=https://github.com/GoogleContainerTools/distroless/blob/main/examples/java/BUILD>這邊可以看範例</a></p><p>說到大小, distroless的映像最小的 <code>gcr.io/distroless/static-debian12</code> 只有大約2MB, 用<a href=https://github.com/wagoodman/dive>dive</a>把它拆解來看, 其實裡面也沒啥東西, 光一個zoneinfo就佔掉1.7MB:</p><p><img src=/images/posts/distroless-static.png alt></p><p>相對於alpine感覺好像的確小很多</p><p><img src=/images/posts/alpine-dive.png alt></p><p>但其實仔細看一下, 這大小是有點不太公平, <code>gcr.io/distroless/static-debian12</code>不像 alpine內包了 busybox, apk, musl libc, 對於可以static compile的語言像是go, rust, 用static其實就夠了, 但有蠻多還是要libc的, 所以要比應該也是要用<code>gcr.io/distroless/base-debian12</code> 這個包入libc6的版本來比</p><p><img src=/images/posts/distroless-base.png alt></p><p>不意外的, 光glibc就吃掉大部分了, 相較之下alpine還是比較小, 可見, 小不是它的重點, 如果要的是安全, 不包額外的套件, non-root, no shell & package manager才是這類的base image的賣點之一</p><p>那談到安全, 我們也來跟alpine來做個相比好了, 這邊用<a href=https://github.com/anchore/grype>grype</a>這套弱掃工具來掃描各自的最新版本(latest):</p><p>首先來個alpine的:</p><p><img src=/images/posts/alpine-grype.png alt></p><p>完全都沒有, 好棒棒! 至少在這最基本的版本還蠻乾淨的, 那接下來就distroless static:</p><p><img src=/images/posts/distroless-static-grype.png alt></p><p>這也沒有, 不過如果真掃得出來就神奇了啦&mldr;因為這包幾乎完全沒有東西呀, 那接下來看distroless base:</p><p><img src=/images/posts/distroless-base-grype.png alt></p><p>哇~~ GG, High&mldr;won&rsquo;t fix&mldr;果然是libc6, 那其他基於這個的就不用太看下去了, 不過, 這樣比並不見得公平, 那只是我現在掃有掃到這些, 隨時都有可能會有新的漏洞, 也會有新的修復, 真正要比可能就是更新這些漏洞修復到底多快, 可能比較實在</p><p>有沒其他的缺點? 由於基於debian, 所以只能用debian套件, 安全性更新應該就相依於debian了, 另外因為沒package manager的關係(連deb都沒喔), 除了他提供的幾個image外, 你如果想在上面加別的套件, 舉個例, 如果你用到了libffmpeg, 你要怎弄出一個image是有含有ffmpeg的? 目前應該只能透過Bazel, 有興趣的話, 可以參考JAVA image的<a href=https://github.com/GoogleContainerTools/distroless/blob/main/java/BUILD>BUILD</a>, 不過Bazel會有點入門的門檻就是</p><p>不過其實如果是像go這種static build的, 用<code>gcr.io/distroless/static-debian12</code>反而應該不會是最佳的, 我們用它的範例做一個版本來分析一下:</p><p><img src=/images/posts/go-static-distroless.png alt></p><p>大小是4.2MB, 大概就是多加上build出來的檔案1.8MB而已, 很小, 沒多餘的東西, 其實蠻好的呀, 不過你如果把Dockerfile改成:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>FROM golang:1.18 as build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>WORKDIR /go/src/app</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>COPY . .</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN go mod download</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN go vet -v</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN go test -v</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>RUN CGO_ENABLED=0 go build -o /go/bin/app</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>FROM scratch</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>COPY --from=build /go/bin/app /</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>CMD [&#34;/app&#34;]</span>
</span></span></code></pre></div><p>再來看看結果:</p><p><img src=/images/posts/go-static-scratch.png alt></p><p>怎回事?只有1.8MB, 對, 只有app本身那1.8MB, 什麼其他東西都沒有, 這應該是更簡潔的, 因為用了scratch, 就是一個完全空的映像, 這樣其實就能跑了(其實容器下就是Linux呀), 所以像是go, 應該用scratch會比distroless來得好, 不過其實這範例還少了點東西, 還是需要包入zone info跟ca, 這樣時區才不會錯, ssl連線也才可以正常, 不過這應該還不到2MB才對</p><h2 id=ubi-micro-and-buildah>UBI Micro and Buildah</h2><p>Google搞了個distroless, Linux發行商們怎會吞得下這口氣呢? RedHat的做法就是UBI Micro這個distroless的image</p><p>RedHat這做法有點不一樣是, 他只丟一個相當於Google的distroless base, 裡面沒套件管理員, 可以算是一種distroless, 如果要安裝套件, 則靠buildah和yum, 這點倒是有點有趣, 來個範例看看怎來建置一個java image好了:</p><p><img src=/images/posts/buildahh1.png alt>
<img src=/images/posts/buildahh2.png alt></p><p>首先我們要把ubi micro給掛載到目錄去, 所以我們要透過<code>buildah unshare</code>進入到root模式, <code>buildah from</code>的作用跟Dockerfile裡的<code>from</code>的作用類似, 就是我們要以某個image當做基底來建置, 這範例就是ubi micro, 然後我們透過<code>buildah mount</code>把這個新的image給掛載到一個目錄去</p><p>接下來就簡單了, 基本上你要放啥東西到這個image, 就只要把檔案放到那目錄下就好了, 所以就算裡面沒包裹套件管理, 那我們其實只要用 <code>yum install --installroot $micromout</code> 就可以把套件裝到目錄不用在裝套件管理員到image內了</p><p>做完之後, 我們要記得 <code>buildah umount</code>和<code>buildah commit $microcontainer java-headless-11</code>, 這樣我們就可以有一個叫<code>java-headless-11</code>的新image</p><p>但, 怎那麼肥? 有沒搞錯, 將近600MB, 一般大部分的java image了不起也只有3xxMB, <code>gcr.io/distroless/java17-debian12</code>更是只有228MB, 這也就是這方法的缺點, yum會幫你管好依賴, 但其實很多東西也不用到完全, 像這個例子, 裡面光locale就有225MB, 這扣掉後也是頂多3xx MB, 去研究了一下, Google distroless的java也是沒包全部的local, 因此還是可以再瘦, 但就不在這邊討論, 因此, 的確, 使用套件管理來裝, 有些不必要的依賴可能也就混入了</p><p>不過, buildah提供了一個Dockerfile以外建置container image一個不錯的方法, 比起Google Distroless用Bazel應該會好上手很多</p><h2 id=ubuntu-chisel>Ubuntu Chisel</h2><p>這做法我還沒很深入去看, 可以參考: <a href=https://ubuntu.com/blog/chiselled-containers-perfect-gift-cloud-applications>Chiselled Ubuntu: the perfect present for your containerised and cloud applications</a>, 或是下一段影片</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/RMqjQ_i9eP0?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>GitHub: <a href=https://github.com/canonical/chisel>https://github.com/canonical/chisel</a>
原來似乎就是從package著手在取出自己要的, 結合scratch, 不過我還沒搞懂它切割縫合的做法, 這邊就先不多做解釋</p><h2 id=其他的distroless>其他的Distroless</h2><p>像是Microsoft也有<a href=https://github.com/microsoft/marinara>Marinara</a>, 它是以Microsoft CBL-Mariner 2.0為基礎去製作Distroless image, 以它做出的 <code>mcr.microsoft.com/openjdk/jdk:17-distroless</code>, 我掃不到有啥安全漏洞, 蠻優秀的, 也只有三百多妹嘎</p><h2 id=buildpack>Buildpack</h2><p>我之前也有<a href=https://blog.jln.co/%E4%B8%8D%E5%AF%ABDockerfile%E5%BB%BA%E7%AB%8Bdocker-Image/>介紹過Buildpacks</a>, 雖然這跟這話題好像關係不大, 不過, 它其實也有一個<code>paketobuildpacks/builder-jammy-tiny</code>的builder可以讓你build出比較小的image, 使用方法如下</p><pre tabindex=0><code>pack build myimage --builder paketobuildpacks/builder-jammy-tiny --path .
</code></pre><p>如果應用程式如果是寫好後建置成container image, 不太會需要裝額外的套件的話, 找一個適當的build image來建置程式, 然後基於一個適當的runtime來建置成image, 這樣一個簡單的multi-stage Dockerfile就可以做到了, 但用這方式的話, base image更版的話就要再去更新Dockerfile, 其實也是有點不方便, 如果把這整個封裝在buildpacks內, 應該也是不錯的做法, 這樣如果有需要更新base image的話, 用<code>pack</code>來rebuild應該就簡單多了, 應該找時間來研究一下怎建buildpack</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2023-09-19 01:38:36 +0800 +0800"><a href=/Yong-Natslai-Shi-Xian-Fen-San-Shi-Wei-Fu-Wu/>Sep 19, 2023</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/Yong-Natslai-Shi-Xian-Fen-San-Shi-Wei-Fu-Wu/ rel=bookmark title=用NATS來實現分散式微服務 itemprop=url>用NATS來實現分散式微服務</a></h1></header><div class=entry-content><p>在近幾年, 微服務(Micro service)架構大部分的人應該不陌生了, 不管是面試, 實戰, 應該都已經聽到快爛了, 不過, 這篇來講講一個基於NATS的做法</p><p>首先, 先來了解一下<a href=https://nats.io/about/>NATS到底是啥東西?</a>簡單來說, 它是一個輕量(Container image只有小小的18MB), 高效, 且安全的訊息佇列(Message Queue), 就基本的Pub/Sub用法來說, 它也的確像是這樣, 很容易就會把它跟Kafka, RabbitMQ等等歸為同一類, 那, 如果要談用Message Queue做微服務的溝通核心, 那有啥好講的? 不就是像是發佈訂閱(Pub Sub), 做成非同步架構, 那有啥好講的?</p><p>在微服務架構下, 要完成一件事, 各微服務之間的溝通是非常吃重的, 一般來說比較直覺的方式就是制定介面(API)來當作各微服務間溝通的協議, 微服務之間透過呼叫API的方式來與另一個服務做溝通, 不管是透過REST API或是透過gRPC, 這都屬於同步(Synchronized)的溝通方式, 也就是任一次呼叫在一定時間內都會預期有回覆(或錯誤)</p><p>再另一種方式就是利用Message Queue做成非同步的做法, 也就是呼叫方把訊息發佈到Message Queue內, 再由另一方訂閱方把訊息收去處理, 因為每次呼叫並不會需要預期有回應的結果, 呼叫方把訊息發佈後, 就不理了, 所以也就不會造成程式的阻塞, 適合需要處理很久的操作, 缺點就是呼叫方不容易拿到執行結果</p><p>如果只是要講後者, 那這篇講到這邊差不多就可以下課了(那我還寫幹嘛), 其實NATS的目標應該不僅止于Message queue, 由網站上寫的<a href=https://nats.io/about/>有關NATS的相關內容</a>, 可以知道它目標是作分散式應用程式的中樞神經系統, 所以其實除了非同步的方式外, 也可以識做成同步架構</p><h2 id=request-reply>Request-Reply</h2><p>前面有說到, 微服務間的溝通方式, 其中一種就是一個微服務透過API呼叫另一個微服務, 而這個API可以預期的狀況是:</p><ol><li>成功並取得結果</li><li>失敗並取得錯誤相關訊息</li><li>在等待一段時間後(timeout), 呼叫失敗</li></ol><p>NATS也提供機制讓你達成這樣的結果, 雖然NATS的基本就是Pub Sub, 但還是提供了Request/Reply的做法</p><p>不多囉唆, 先看一下程式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>urls</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>subj</span>, <span style=color:#a6e22e>payload</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>], []byte(<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#a6e22e>subj</span>, <span style=color:#a6e22e>payload</span>, <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>LastError</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%v for request&#34;</span>, <span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>LastError</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%v for request&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>上頭這隻程式是一個 <strong>&ldquo;requester&rdquo;</strong>, 他把請求送到一個NATS subject, 並且等待並接收回傳訊息, 其實看起來就跟一個publisher沒啥兩樣, 差別就是他會卡在那邊等待回應(或timeout)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>    <span style=color:#75715e>//Responder</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nc</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>urls</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>subj</span>, <span style=color:#a6e22e>reply</span>, <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>1</span>], <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>QueueSubscribe</span>(<span style=color:#a6e22e>subj</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>queueName</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>msg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats</span>.<span style=color:#a6e22e>Msg</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printMsg</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Respond</span>([]byte(<span style=color:#a6e22e>reply</span>))
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>nc</span>.<span style=color:#a6e22e>Flush</span>()
</span></span></code></pre></div><p>上面則是相對於 <strong>&ldquo;requester&rdquo;</strong> 的 <strong>&ldquo;responder&rdquo;</strong> , 其實跟個subscriber差不多, 就是把訊息接回來處理,多一個回傳的動作(<code>msg.Respond([]byte(reply))</code>)而已, 從抽象角度來看, 跟我們直接拿REST API實作有點類似:
<img src=/images/posts/restapi.png alt></p><p>但實際上, 他的做法比較是這樣的:</p><p><img src=/images/posts/reqresp.png alt></p><p>好像不太意外, 但這樣有啥好處, 我不就直接寫rest不就好了? 我們先來看一下負載平衡的做法好了:</p><p><img src=/images/posts/lbrrr.png alt></p><p>在這做法下, NATS其實就擔當起load balancer這角色了, 其實, 不知道你有沒注意到, 他也兼顧了service discovery的角色, 傳統你呼叫一個API service, 你必須先知道他的endpoint, 但在這邊你只要知道subject就好了, 因為responder是在監聽著那個subject, 因此, 還可以變形成這樣:</p><p><img src=/images/posts/crosszoneee.png alt></p><p>就可以簡單的實現到跨區呼叫或故障轉移(failover)</p><h2 id=nats-service-api>NATS Service API</h2><p>這應該是一個美麗(?)的未來, 不久前看到這段影片, 其實也真的就不久, 三月放出來的影片, 離現在也沒多久</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/byHGNUqIONw?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>剛開始看到覺得, 頗酷的呀, 感覺就是在原本request/reply機制上再加上更多像是monitor和tracing的機制, 並讓它變得更像RPC call</p><p>但為了寫這篇時, 做實驗後發現, 他講的東西目前也都還沒push到main trunk去的樣子, 像是schema, 說有支援typescript也還沒, 還有<code>nats service</code>相關的指令也都還沒有, main裡面還沒找到相關的source code</p><p>所以這篇就沒打算寫太多了, 免得未來差異太大, 相關細節還是可以去看那段影片</p><p>先簡單來看一下程式會長成怎樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// GreeterServer is the server API for Greeter service.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GreeterServer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Sends a greeting</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SayHello</span>(<span style=color:#a6e22e>in</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HelloRequest</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>HelloReply</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>RegisterGreeterServer</span>(<span style=color:#a6e22e>conn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats_go</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#a6e22e>subject</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>greeter</span> <span style=color:#a6e22e>GreeterServer</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>srv</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>AddService</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:    <span style=color:#e6db74>&#34;greeter&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>grp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>AddGroup</span>(<span style=color:#a6e22e>subject</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>grp</span>.<span style=color:#a6e22e>AddEndpoint</span>(<span style=color:#e6db74>&#34;sayhello&#34;</span>, <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>HelloRequest</span>{}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Data</span>(), <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>greeter</span>.<span style=color:#a6e22e>SayHello</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>resp</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Respond</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	}))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GreeterClient</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>subject</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>nats_go</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewGreeterClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>nats_go</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#a6e22e>subject</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>GreeterClient</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>GreeterClient</span>{<span style=color:#a6e22e>subject</span>, <span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>conn</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GreeterClient</span>) <span style=color:#a6e22e>SayHello</span>(<span style=color:#a6e22e>in</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HelloRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>HelloReply</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Request</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>subject</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;.sayhello&#34;</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>reply</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>HelloReply</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Data</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>reply</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這段client/server的程式就跟request/reply的感覺差不多, 只是多了一些東西</p><p>其實我也試著想結合grpc跟這機制, 因此寫個<a href=https://github.com/julianshen/npc/>小工具叫NPC</a>, 所以以上的程式其實是由底下這個定義產生的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> go_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nnrpc/pb&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>// The greeting service definition.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// - version: 1.0.0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>service</span> Greeter {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#75715e>// Sends a greeting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>rpc</span> SayHello (HelloRequest) <span style=color:#66d9ef>returns</span> (HelloReply) {}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>// The request message containing the user&#39;s name.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>HelloRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> name <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>// The response message containing the greetings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>HelloReply</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>message</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>(這邊就不談怎寫protoc的plugin了)</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2023-07-07 21:27:41 +0800 +0800"><a href=/Dead-or-Alive-Are-You-Ready/>Jul 7, 2023</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~6 minutes</span></div><h1 class=entry-title><a href=/Dead-or-Alive-Are-You-Ready/ rel=bookmark title="Dead or Alive? Are You Ready?" itemprop=url>Dead or Alive? Are You Ready?</a></h1></header><div class=entry-content><p>這篇主要是要來講K8S上的liveness probe/readiness probe/startup probe, 這應該是比較不會被注意到的題目, 大家可能會想, 不過就是health check嘛, 有啥難的? </p><p>不過其實在K8S上面其實不是只有單單health check這麼簡單, 它上面有liveness probe, readiness probe, startup probe, 每一種都有它的不同作用, 如果沒特別注意各自特性, 其實也是有可能會碰到災難的, 首先來看看, 怎麼使用這三種不同的"探針"(翻成探針好像怪怪的, 但我想不到比較好的說法)</p><p>這個定義是針對Pod (Deployment &mldr;), 所以你的YAML可能會像這樣</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>test</span>: <span style=color:#ae81ff>liveness</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>liveness-http</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>liveness</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.k8s.io/liveness</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/server</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/healthz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>httpHeaders</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Custom-Header</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#ae81ff>Awesome</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>startupProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/healthz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>liveness-port</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/healthz</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>liveness-port</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>   
</span></span></code></pre></div><p>先說一下, 上面並不是一個好寫法, 三種Probe都用了同一個endpoint, 先不多做解釋, 看完應該就比較會清楚啥不好</p><p>不管哪一種, 都有三種檢查機制可以用:</p><ul><li>exec 執行一個特別的命令, status code是0則是成功</li><li>grpc 呼叫grpc來確認狀態(參考 <a href=https://grpc.github.io/grpc/core/md_doc_health-checking.html>https://grpc.github.io/grpc/core/md_doc_health-checking.html</a>)</li><li>httpGet 呼叫HTTP GET來確認狀態, HTTP status 200-400(以內)都算成功</li><li>tcpSocket 可以建立連線就表示沒問題</li></ul><p>就是選擇適合來確認你服務的健康狀態的來使用就好了(廢話)</p><p>那這三種有啥分別?</p><ul><li>livenessProbe 用來確認你的服務是不是還在"執行", 如果不是, pod就會被砍掉, 然後會依據restartPolicy的設定是不是要重啟你的pod</li><li>readinessProbe 活著(liveness)和準備好(readiness)差別在哪? 這邊的readiness指的是你的容器(container), 是不是已經"準備好提供服務"了, 如果是, 才會把請求(request)轉送到你的容器</li><li>startupProbe 特性其實接近livenessProbe, 但是是用在容器剛啟動時, 用來確認容器是否正常啟動, 如果檢查失敗(時間超過 initialDelaySeconds[<em>一開始等多久</em>] + failureThreshold[<em>失敗幾次</em>] × periodSeconds[<em>間隔多久重試</em>])一樣是砍掉pod, 然後會依據restartPolicy的設定是不是要重啟你的pod</li></ul><p>詳細點來說,</p><h2 id=啥時用livenessprobe>啥時用livenessProbe?</h2><p>俗語說的好, &ldquo;<strong><code>重開機治百病</code></strong>"(哪來的俗語呀?), 簡單的說, 如果你的容器卡住不動了, 怎麼搖都懷疑人生, 沒反應了, 需要透過重開, 重新投胎, 才能(有機會)恢復正常, 那就是livenessProbe可以發揮的地方了</p><p>這邊說的是卡住不動沒回應這類的, 所以像是你的程式碰到dead lock, 無窮迴圈而無法正常回應都算, 但程式結束, 不正常離開(像Java的uncaught RuntimeException?) 其實不用等到livenessProbe打失敗, 就會照restartPolicy來處理, 所以可以知道, 當發現有Pod重啟的情形, 應該就不外乎是自然死, 意外死, 還有就是因為livenessProbe打施打失敗被謀殺了</p><p>那&mldr;.</p><h3 id=該不該在livenessprobe去檢查相關的服務或資料庫有沒活著>該不該在livenessProbe去檢查相關的服務或資料庫有沒活著?</h3><p>不該!(張惠妹/周杰倫), 這還蠻常見的狀況, 就想說, 這health check 嘛, 我資料庫連不上, 當然就不健康囉, 所以就回傳了Failure了, Spring boot acuator的health endpoint也是會幫你檢查相關依賴的資源的狀況列入檢查(不過它有為Kubernetes有對應的做法啦, 後面再說)</p><p>這樣會導致啥狀況? 你明明服務還好好的, 然後只是資料庫連不上, 結果你的Pod就被砍了(好無辜), 然後只要資料庫還沒修好, 就一直復活一直死(好悲哀)</p><p>所以liveness的probe應該簡單到只是確認這個容器有沒被卡死, 資料庫連不上只是不能服務, 資料庫修好了還是可以繼續服務呀</p><h3 id=老是因為打livenessprobe時timeout被砍-那我是不是盡量把timeoutseconds盡量設的越大越好>老是因為打livenessProbe時timeout被砍, 那我是不是盡量把timeoutSeconds盡量設的越大越好?</h3><p>其實這檢查的目的只是要確認容器有沒被卡死, 所以livenessProbe應該盡可能越簡單越好, 不太適合去做一些需要大量運算或是複雜的事, 因為那可能會因為你的pod或node的繁忙程度去影響到它執行時間長短差距很大, 那如果因為這樣去調高timeout時間也不太合理, 因為也很難確定要多久才能確定它"真的被卡住了&rdquo;, 再加上你可能會因為頻繁做這些複雜運算(因為每periodSecond會被探測一次)影響系統效能(像是不要在livenessProbe實作內call DB query)</p><p>依據你livenessProbe正常會回應的時間再多給點應該就足夠了, 設非常大的話, 搞不好容器真的卡住了, 但卻反應慢了</p><h3 id=我可不可以不要設livenessprobe>我可不可以不要設livenessProbe</h3><p>為何不可? 前面一直說, 它只是用來偵測程式是不是被"卡住了", 如果沒被卡死的風險, 不需要靠重啟手段來回復的話, 那不用設是可以呀</p><h2 id=那啥時用readinessprobe呢>那啥時用readinessProbe呢?</h2><p>readinessProbe跟livenessProbe的差異在於會不會出人(Pod)命, readiness為success的話, 上游(Service)才會把請求(request)送來給我處理, 不然的話, 就會收不到(又是廢話), 所以從這邊就可以看出前面那題的答案了, liveness和readniess的檢查邏輯應該會不一樣的(所以不太適合同一個endpoint搞定)</p><h3 id=那要不要去檢查相關的服務或資料庫有沒活著>那要不要去檢查相關的服務或資料庫有沒活著?</h3><p>可以, 也建議, 因為如果後面的服務或資料庫死了, 表示請求送進來也會處理失敗, 那不如先把它擋在外面等到服務正常了</p><h2 id=startupprobe呢>startupProbe呢?</h2><p>這個通常用在啟動會很久的容器, 為了怕太早打livenessProbe, readinessProbe導致高失敗率(因為啟動很久, 太早打一定都失敗的), 所以用這個probe來確認容器成功後才真的去實施那兩個探測</p><p>容器啟動很久其實不是一個很好的practice, 所以這個其實也是萬不得以才在用, 如果啟動時間不長的話, 為probe設定initialDelaySeconds 就已經很足夠了</p><h2 id=誰去打這些probe的>誰去打這些Probe的?</h2><p>一個比較錯誤的想像是, Kubernetes在某個地方, control plane或那裡有個服務去打所有的probe, 其實不是, 這樣它會累死</p><p>其實是由每個node的kubelet來負責, 當被加入一個Pod時, kubelet就會為這些probe每個都起一個go routine來根據設定的規則做檢查(感覺這設計沒太好, 會起不少go routine)</p><p>可以參考kubelet的<a href=https://github.com/kubernetes/kubernetes/blob/7581ae812327fc8218204f678143a6f116cad931/pkg/kubelet/prober/prober_manager.go#L169-L213>實做細節</a></p><p>這樣其實比較合理啦, 每個node的kubelet就顧自己家後院就好</p><h2 id=spring-boot-acuator的kubernetes-probes>Spring boot acuator的Kubernetes Probes</h2><p>Spring boot acuator預設的health endpoint是<code>/actuator/health</code>, 但這其實不好一體適用於liveness和readiness</p><p>Spring boot要用<code>/actuator/health/liveness</code>在livenessProbe而<code>/actuator/health/readiness</code>在readinessProbe, 可以參考<a href=https://docs.spring.io/spring-boot/docs/2.3.0.RELEASE/reference/html/production-ready-features.html#production-ready-kubernetes-probes>這篇&mldr;.</a></p></div></article><div class=pagination><ul class=inline-list><li><strong class=current-page>1</strong></li><li><a href=/page/2/>2</a></li><li><a href=/page/3/>3</a></li><li><a href=/page/4/>4</a></li><li><a href=/page/5/>5</a></li><li><a href=/page/6/>6</a></li><li><a href=/page/7/>7</a></li><li><a href=/page/8/>8</a></li><li><a href=/page/9/>9</a></li><li><a href=/page/10/>10</a></li><li><a href=/page/11/>11</a></li><li><a href=/page/12/>12</a></li><li><a href=/page/13/>13</a></li><li><a href=/page/14/>14</a></li><li><a href=/page/15/>15</a></li><li><a href=/page/16/>16</a></li><li><a href=/page/17/>17</a></li><li><a href=/page/18/>18</a></li><li><a href=/page/19/>19</a></li><li><a href=/page/20/>20</a></li><li><a href=/page/21/>21</a></li><li><a href=/page/22/>22</a></li><li><a href=/page/23/>23</a></li><li><a href=/page/24/>24</a></li><li><a href=/page/25/>25</a></li><li><a href=/page/26/>26</a></li><li><a href=/page/27/>27</a></li><li><a href=/page/28/>28</a></li><li><a href=/page/29/>29</a></li><li><a href=/page/30/>30</a></li><li><a href=/page/31/>31</a></li><li><a href=/page/32/>32</a></li><li><a href=/page/33/>33</a></li><li><a href=/page/34/>34</a></li><li><a href=/page/35/>35</a></li><li><a href=/page/36/>36</a></li><li><a href=/page/37/>37</a></li><li><a href=/page/38/>38</a></li><li><a href=/page/39/>39</a></li><li><a href=/page/40/>40</a></li><li><a href=/page/41/>41</a></li><li><a href=/page/42/>42</a></li><li><a href=/page/43/>43</a></li><li><a href=/page/44/>44</a></li><li><a href=/page/45/>45</a></li><li><a href=/page/46/>46</a></li><li><a href=/page/47/>47</a></li><li><a href=/page/48/>48</a></li><li><a href=/page/49/>49</a></li><li><a href=/page/50/>50</a></li><li><a href=/page/51/>51</a></li><li><a href=/page/52/>52</a></li><li><a href=/page/53/>53</a></li><li><a href=/page/54/>54</a></li><li><a href=/page/55/>55</a></li><li><a href=/page/56/>56</a></li><li><a href=/page/57/>57</a></li><li><a href=/page/58/>58</a></li><li><a href=/page/59/>59</a></li><li><a href=/page/60/>60</a></li><li><a href=/page/61/>61</a></li><li><a href=/page/62/>62</a></li><li><a href=/page/63/>63</a></li><li><a href=/page/64/>64</a></li><li><a href=/page/65/>65</a></li><li><a href=/page/66/>66</a></li><li><a href=/page/67/>67</a></li><li><a href=/page/68/>68</a></li><li><a href=/page/69/>69</a></li><li><a href=/page/70/>70</a></li><li><a href=/page/71/>71</a></li><li><a href=/page/72/>72</a></li><li><a href=/page/73/>73</a></li><li><a href=/page/74/>74</a></li><li><a href=/page/75/>75</a></li><li><a href=/page/76/>76</a></li><li><a href=/page/77/>77</a></li><li><a href=/page/2/ class=btn>Next</a></li></ul></div></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script><script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>