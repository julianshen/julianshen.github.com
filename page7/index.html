<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>朱隸安貓囈語錄 &#8211; Le murmure de Julian</title>
<meta name="description" content="朱隸安貓囈語錄">
<meta name="keywords" content="java, android, julianshen, backend, blog, golang, swift">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://blog.jln.co/images/bkg2.jpg">

<meta name="twitter:title" content="朱隸安貓囈語錄">
<meta name="twitter:description" content="朱隸安貓囈語錄">
<meta name="twitter:creator" content="@jlnshen">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="朱隸安貓囈語錄">
<meta property="og:description" content="朱隸安貓囈語錄">
<meta property="og:url" content="http://blog.jln.co/page7/">
<meta property="og:site_name" content="Le murmure de Julian">
<meta name="og:image" content="http://blog.jln.co/images/avatar.png">
<meta name="google-site-verification" content="Fwa4TQMXvroZpNT7rrwHzdf-rWBe1RDuTu75Enx_DWA">



<link rel="canonical" href="http://blog.jln.co/page7/">
<link href="http://blog.jln.co/feed.xml" type="application/atom+xml" rel="alternate" title="Le murmure de Julian Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://blog.jln.co/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://blog.jln.co/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://blog.jln.co/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://blog.jln.co/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.jln.co/images/apple-touch-icon-144x144-precomposed.png">



  
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1789797875470932",
        enable_page_level_ads: true
    });
    </script>
  

</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://blog.jln.co/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://blog.jln.co/images/avatar.png" alt="Julian Shen photo" class="author-photo">
					<h4>Julian Shen</h4>
					<p>software deverloper</p>
				</li>
				<li>
					<a href="mailto:julianshen22@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/jlnshen"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/julianshen"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				<li>
					<a href="https://linkedin.com/in/julianshen"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/julianshen"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="https://instagram.com/julianshen"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				<li>
					<a href="https://www.flickr.com/photos/julianshen"><i class="fa fa-fw fa-flickr"></i> Flickr</a>
				</li>
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://blog.jln.co/posts/">All Posts</a></li>
				<li><a href="http://blog.jln.co/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="http://blog.jln.co/images/bkg2.jpg" alt="朱隸安貓囈語錄">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Le murmure de Julian</h1>
      <h2>朱隸安貓囈語錄</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-30T21:47:36+08:00"><a href="http://blog.jln.co/android-%E4%BD%BF%E7%94%A8retrofit%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8Dman-in-the-middle%E6%94%BB%E6%93%8A/">September 30, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/android-%E4%BD%BF%E7%94%A8retrofit%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8Dman-in-the-middle%E6%94%BB%E6%93%8A/" rel="bookmark" title="[Android] 使用Retrofit如何避免Man in the middle攻擊" itemprop="url">[Android] 使用Retrofit如何避免Man in the middle攻擊</a></h1>
    
  </header>
  <div class="entry-content">
    <p>前幾天看到朋友寫如何用<a href="https://www.charlesproxy.com">Charles Proxy</a>來debug REST API, 
突然就想到了這個問題, <a href="https://www.charlesproxy.com">Charles Proxy</a>是一個不錯的工具, 我自己也蠻常用的
, 除了可以用來debug HTTP以外, 其實HTTPS也可以(參照<a href="https://www.charlesproxy.com/documentation/proxying/ssl-proxying/">SSL proxying</a>)
, 只要在手機上安裝好它的SSL certificate即可</p>

<p>不過這不是這篇要講的重點, 這種debugging的方式原理即是用Proxy作為一個中間人來紀錄HTTP/HTTPS的傳輸內容
, 這也帶來一個問題, 也就是你的資料是可以這樣簡單的暴露出去, 這種即是所謂的MITM (Man in the middle) 中間人攻擊</p>

<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.js"></script>
<div class="mermaid">
graph LR;
    Client--&gt;Proxy[Proxy - Middle man];
    Proxy[Proxy - Middle man]--&gt;Client;
    Proxy[Proxy - Middle man]--&gt;Server;
    Server--&gt;Proxy[Proxy - Middle man];
</div>

<p>一般來說, 用了SSL/HTTPS後, 也不是那麼容易安插一個中間人的 ,像<a href="https://www.charlesproxy.com">Charles Proxy</a>這樣的東西,
還是需要使用者自己去手機上的安全性設定裝信任憑證(trusted certificate), 一般常見的問題反而來自於開發者本身
, 很多人常以為走了HTTPS就安全了, 卻常常為了debug方便, 或是省錢用Self-signed certificate 而去覆寫了系統預設的
X509TrustManager, 以至於整個檢查機制被跳過, 真的漏洞都來自於人的惰性,
更多資訊可以參考:</p>

<ol>
  <li><a href="https://security.tencent.com/index.php/blog/msg/41">窃听风暴： Android平台https嗅探劫持漏洞</a></li>
  <li><a href="http://yaq.qq.com/blog/13">Android安全之Https中间人攻击漏洞</a></li>
  <li><a href="http://www.droidsec.cn/android-https中间人劫持漏洞浅析/">Android HTTPS中间人劫持漏洞浅析</a></li>
  <li><a href="http://blog.csdn.net/u013107656/article/details/52036158">Android客户端安全 -&gt; HTTPS敏感数据劫持漏洞</a></li>
  <li><a href="http://pingguohe.net/2016/02/26/Android-App-secure-ssl.html">Android App 安全的HTTPS 通信</a></li>
  <li><a href="http://devco.re/blog/2014/08/15/ssl-mishandling-on-mobile-app-development/">手機應用程式開發上被忽略的 SSL 處理</a></li>
  <li><a href="https://blog.heckel.xyz/2013/07/01/how-to-use-mitmproxy-to-read-and-modify-https-traffic-of-your-phone/">How To: Use mitmproxy to read and modify HTTPS traffic</a></li>
  <li><a href="http://www.7xter.com/2015/07/intercepting-android-ssl-traffic.html">INTERCEPTING ANDROID SSL / HTTPS TRAFFIC</a></li>
</ol>

<p>該避免去寫的, 就該避掉, 以免產生不必要的漏洞, 但不過也有可能碰到使用者的手機被(有意/無意)安裝了攻擊者的憑證到系統的信任憑證中, 
那麼碰到這種, 應用程式本身該如何保護自己?</p>

<p>這邊有兩個方式可以採用 -</p>

<ol>
  <li>certificate pinning</li>
  <li>在程式中寫死certificate</li>
</ol>

<p>以下的範例以Android最紅, 常被使用的<a href="https://square.github.io/retrofit/">Retrofit</a>為範例(雖說是<a href="https://square.github.io/retrofit/">Retrofit</a>, 但其實是在<a href="https://github.com/square/okhttp">okhttp</a>動的手腳)</p>

<h4 id="certificate-pinning">Certificate Pinning</h4>

<p>或叫<a href="https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning">HTTP Public Key Pinning (HPKP)</a>, 
簡單的說, 就是在程式內綁定Certificate的public key, 如果今天中間人存在, certificate不同了, 連接就不會成功</p>

<p>先來看範例</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">certificatePinner</span><span class="o">(</span><span class="k">new</span> <span class="n">CertificatePinner</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"cdn.rawgit.com"</span><span class="o">,</span> <span class="s">"sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U="</span><span class="o">).</span><span class="na">build</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">Retrofit</span> <span class="n">retrofit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Retrofit</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">"https://cdn.rawgit.com/julianshen/cpblschedule/"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addConverterFactory</span><span class="o">(</span><span class="n">GsonConverterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
        <span class="o">.</span><span class="na">client</span><span class="o">(</span><span class="n">client</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</div>

<p>這邊所動的手腳(<del>跟Retrofit沒啥鳥關係</del>)是在OkHttpClient上加上一個CertificatePinner,
利用了certificate pinner加上了一個host name跟public key的對應,
以這例子來說: <strong>“sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=”</strong> 這個public key對應的是 <strong>“cdn.rawgit.com”</strong>
, 因此碰到”cdn.rawgit.com”來的url, 會檢查public key是否符合,
這邊public key的參數字串是要以”sha1/”或”sha256/”開始的, 依使用的演算法而不同</p>

<p>但又要怎取得這串”天書”呢?</p>

<p>很簡單, 首先確認你的電腦裡面有沒安裝openssl , 有的話就用以下的指令:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>openssl s_client -connect cdn.rawgit.com:443 -servername cdn.rawgit.com | openssl x509 -pubkey -noout | openssl rsa -pubin -outform der | openssl
dgst -sha256 -binary | openssl enc -base64
</code></pre>
</div>

<p>最後產生的內容如下</p>

<div class="highlighter-rouge"><pre class="highlight"><code>depth=2 /C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
verify error:num=20:unable to get local issuer certificate
verify return:0
writing RSA key
p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=
</code></pre>
</div>

<p>所以我們要填的參數就是 <strong>“sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=”</strong></p>

<p>關於HPKP的openssl相關的指令可以參考<a href="https://developer.mozilla.org/en-US/docs/Web/Security/Public_Key_Pinning">Public Key Pinning</a></p>

<p>如果你用<a href="https://www.charlesproxy.com">Charles Proxy</a>當中間人來測試這段程式的話, 你會得到下面這樣的exception</p>

<div class="highlighter-rouge"><pre class="highlight"><code>javax.net.ssl.SSLPeerUnverifiedException: Certificate pinning failure!
                                            Peer certificate chain:
                                            sha256/ENlqFHtfARof3AK50Hbc1sj47M5hWhc5kQ5Z2vyfxq4=: CN=rawgit.com,OU=PositiveSSL Multi-Domain,OU=Domain Control Validated
                                            sha256/mXmLzo8k5ANwi11PlLSW/b4OC/Anjw1OeACDyZxD/WM=: C=NZ,ST=Auckland,L=Auckland,O=XK72 Ltd,OU=http://charlesproxy.com/ssl,CN=Charles Proxy Custom Root Certificate (built on Jlnmbp-retina.local\, 11 十二月 2015)
                                            Pinned certificates for cdn.rawgit.com:
                                            sha256/p0962nIqD0mv1APQ1mgmRiuwrhZXBuj+t6dey/Adk0U=
</code></pre>
</div>

<h4 id="certificate">在程式中寫死certificate</h4>

<p>這方法聽起來暴力了一點, 但原理其實跟前一個沒啥太大差別, 只是一個寫死public key一個寫死certificate</p>

<p>一樣先來看個範例:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">String</span> <span class="n">cert</span> <span class="o">=</span> <span class="s">""</span>
        <span class="o">+</span><span class="s">"-----BEGIN CERTIFICATE-----\n"</span>
        <span class="o">+</span><span class="s">"MIIFdjCCBF6gAwIBAgIRAPbTBHdHHseM4hArA7n6uREwDQYJKoZIhvcNAQELBQAw\n"</span>
        <span class="o">+</span><span class="s">"gZAxCzAJBgNVBAYTAkdCMRswGQYDVQQIExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAO\n"</span>
        <span class="o">+</span><span class="s">"BgNVBAcTB1NhbGZvcmQxGjAYBgNVBAoTEUNPTU9ETyBDQSBMaW1pdGVkMTYwNAYD\n"</span>
        <span class="o">+</span><span class="s">"VQQDEy1DT01PRE8gUlNBIERvbWFpbiBWYWxpZGF0aW9uIFNlY3VyZSBTZXJ2ZXIg\n"</span>
        <span class="o">+</span><span class="s">"Q0EwHhcNMTYwMTAxMDAwMDAwWhcNMTcwMTEzMjM1OTU5WjBbMSEwHwYDVQQLExhE\n"</span>
        <span class="o">+</span><span class="s">"b21haW4gQ29udHJvbCBWYWxpZGF0ZWQxITAfBgNVBAsTGFBvc2l0aXZlU1NMIE11\n"</span>
        <span class="o">+</span><span class="s">"bHRpLURvbWFpbjETMBEGA1UEAxMKcmF3Z2l0LmNvbTCCASIwDQYJKoZIhvcNAQEB\n"</span>
        <span class="o">+</span><span class="s">"BQADggEPADCCAQoCggEBALD2sUNSYp2R+mSEMF2qKvMS780qTkltvqP4rwEGKOLV\n"</span>
        <span class="o">+</span><span class="s">"rR5QQWo8vzSlgZvxVsguRHi0pPBtVAH794L43tD+IuyQlDlNU2qc1aMqBkn3S2wN\n"</span>
        <span class="o">+</span><span class="s">"Way8BS9w80pgeFnObZiFJtPI9pdwcB72Bgq8Nlc25oVrDVWr/Q8nLIKS/9FkNs+C\n"</span>
        <span class="o">+</span><span class="s">"MPU00vGFZSFbR7s15ORj9+qPCskWZcHpQ+m9EKmZD3IVKj3QQyBD17cBoVkYoIpj\n"</span>
        <span class="o">+</span><span class="s">"I8/r+NfVfKetlsB7Pcv8P3yLFVFC4+PGrnW9TLZK9aRtbDTvjElXwCQIPK5B2fKw\n"</span>
        <span class="o">+</span><span class="s">"SJK26IJPDX0r1JkeuR53Afr509iEx3xAHcRz/kR5uo8CAwEAAaOCAf0wggH5MB8G\n"</span>
        <span class="o">+</span><span class="s">"A1UdIwQYMBaAFJCvajqUWgvYkOoSVnPfQ7Q6KNrnMB0GA1UdDgQWBBSI83Kqafo7\n"</span>
        <span class="o">+</span><span class="s">"kg9cmyT1vnceH4fAUjAOBgNVHQ8BAf8EBAMCBaAwDAYDVR0TAQH/BAIwADAdBgNV\n"</span>
        <span class="o">+</span><span class="s">"HSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwTwYDVR0gBEgwRjA6BgsrBgEEAbIx\n"</span>
        <span class="o">+</span><span class="s">"AQICBzArMCkGCCsGAQUFBwIBFh1odHRwczovL3NlY3VyZS5jb21vZG8uY29tL0NQ\n"</span>
        <span class="o">+</span><span class="s">"UzAIBgZngQwBAgEwVAYDVR0fBE0wSzBJoEegRYZDaHR0cDovL2NybC5jb21vZG9j\n"</span>
        <span class="o">+</span><span class="s">"YS5jb20vQ09NT0RPUlNBRG9tYWluVmFsaWRhdGlvblNlY3VyZVNlcnZlckNBLmNy\n"</span>
        <span class="o">+</span><span class="s">"bDCBhQYIKwYBBQUHAQEEeTB3ME8GCCsGAQUFBzAChkNodHRwOi8vY3J0LmNvbW9k\n"</span>
        <span class="o">+</span><span class="s">"b2NhLmNvbS9DT01PRE9SU0FEb21haW5WYWxpZGF0aW9uU2VjdXJlU2VydmVyQ0Eu\n"</span>
        <span class="o">+</span><span class="s">"Y3J0MCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5jb21vZG9jYS5jb20wSwYDVR0R\n"</span>
        <span class="o">+</span><span class="s">"BEQwQoIKcmF3Z2l0LmNvbYIVY2RuLW9yaWdpbi5yYXdnaXQuY29tgg5jZG4ucmF3\n"</span>
        <span class="o">+</span><span class="s">"Z2l0LmNvbYINcmF3Z2l0aHViLmNvbTANBgkqhkiG9w0BAQsFAAOCAQEASx3e6y9e\n"</span>
        <span class="o">+</span><span class="s">"9F67N5NIDausDHDL+/fz6uj2DDNJdaQvALAYDV8hKpz7+QGotlQfI042U2i83J7m\n"</span>
        <span class="o">+</span><span class="s">"DGZiKDpzaXa7IFfGiq6PFPUjntElHoU2E4vRb5LApg1sJ5YueYmRd3X7x0/jPYg6\n"</span>
        <span class="o">+</span><span class="s">"TiTtHyXOnlMuqL2FUYJM0BP7cMfOppvUF0R2zHUVA0rVHuLrSStg8bMg8aVUIkKg\n"</span>
        <span class="o">+</span><span class="s">"n3NS+eg4ofo95jaMRVykhLnylkYBk9dWBM6B19Yw7LgQd94MZSa+Xix4HxeFgvAM\n"</span>
        <span class="o">+</span><span class="s">"BF+oeDMaY7mEN4Xm5hnrIS1FElRDq/ckpDV8JVpR4SQqB+tzSZPPIiep8EvgRDzd\n"</span>
        <span class="o">+</span><span class="s">"2EkL187FF3MQ+w==\n"</span>
        <span class="o">+</span><span class="s">"-----END CERTIFICATE-----\n"</span><span class="o">;</span>

<span class="n">X509TrustManager</span> <span class="n">trustManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="n">CertificateFactory</span> <span class="n">certificateFactory</span> <span class="o">=</span> <span class="n">CertificateFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"X.509"</span><span class="o">);</span>
    <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Certificate</span><span class="o">&gt;</span> <span class="n">certificates</span> <span class="o">=</span> <span class="n">certificateFactory</span><span class="o">.</span><span class="na">generateCertificates</span><span class="o">(</span><span class="k">new</span> <span class="n">Buffer</span><span class="o">().</span><span class="na">writeUtf8</span><span class="o">(</span><span class="n">cert</span><span class="o">).</span><span class="na">inputStream</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">certificates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"expected non-empty set of trusted certificates"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"password"</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span> <span class="c1">// Any password will work.</span>
        <span class="n">KeyStore</span> <span class="n">keyStore</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">KeyStore</span><span class="o">.</span><span class="na">getDefaultType</span><span class="o">());</span>
        <span class="n">keyStore</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Certificate</span> <span class="n">certificate</span> <span class="o">:</span> <span class="n">certificates</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">certificateAlias</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">index</span><span class="o">++);</span>
            <span class="n">keyStore</span><span class="o">.</span><span class="na">setCertificateEntry</span><span class="o">(</span><span class="n">certificateAlias</span><span class="o">,</span> <span class="n">certificate</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">TrustManagerFactory</span> <span class="n">trustManagerFactory</span> <span class="o">=</span> <span class="n">TrustManagerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">TrustManagerFactory</span><span class="o">.</span><span class="na">getDefaultAlgorithm</span><span class="o">());</span>
        <span class="n">trustManagerFactory</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">keyStore</span><span class="o">);</span>

        <span class="n">TrustManager</span><span class="o">[]</span> <span class="n">trustManagers</span> <span class="o">=</span> <span class="n">trustManagerFactory</span><span class="o">.</span><span class="na">getTrustManagers</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">trustManagers</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!(</span><span class="n">trustManagers</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">instanceof</span> <span class="n">X509TrustManager</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unexpected default trust managers:"</span>
                    <span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">trustManagers</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">trustManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">X509TrustManager</span><span class="o">)</span> <span class="n">trustManagers</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>

        <span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span> <span class="n">SSLContext</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"TLS"</span><span class="o">);</span>
        <span class="n">sslContext</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">TrustManager</span><span class="o">[]</span> <span class="o">{</span> <span class="n">trustManager</span> <span class="o">},</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="n">sslContext</span><span class="o">.</span><span class="na">getSocketFactory</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CertificateException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">KeyStoreException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">KeyManagementException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>

<span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">sslSocketFactory</span><span class="o">(</span><span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">trustManager</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="n">Retrofit</span> <span class="n">retrofit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Retrofit</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">"https://cdn.rawgit.com/julianshen/cpblschedule/"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addConverterFactory</span><span class="o">(</span><span class="n">GsonConverterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
        <span class="o">.</span><span class="na">client</span><span class="o">(</span><span class="n">client</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</div>

<p>看到這麼長的東西大概就不會想看了吧?(老實說我也寫的很懶, 這邊要特別提到有用到一個Class叫做Buffer,這是來自於<a href="https://github.com/square/okio">okio</a>, 蠻方便的東西), 跟前一個不同的地方在於, 前一個利用了CertificatePinner,
而這一個則是改了sslSocketFactory的TrustManager(喂!!!前面不是隱約有提到這樣不太好?!),
這個TrustManager全部也只信任這一個certifcate, 如果碰到其他的, 就會發生以下的exception:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>javax.net.ssl.SSLHandshakeException: java.security.cert.CertPathValidatorException: Trust anchor for certification path not found.
        at com.android.org.conscrypt.OpenSSLSocketImpl.startHandshake(OpenSSLSocketImpl.java:328)
</code></pre>
</div>

<p>那, 上面那一大坨憑證資料是怎樣取得的? 方法其實差不多:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>openssl s_client -connect cdn.rawgit.com:443 -showcerts
</code></pre>
</div>

<p>會得到這樣的結果:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CONNECTED(00000003)
depth=2 /C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
verify error:num=20:unable to get local issuer certificate
verify return:0
---
Certificate chain
 0 s:/OU=Domain Control Validated/OU=PositiveSSL Multi-Domain/CN=rawgit.com
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
 1 s:/OU=Domain Control Validated/OU=PositiveSSL Multi-Domain/CN=rawgit.com
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
 2 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
   i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
 3 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Certification Authority
   i:/C=SE/O=AddTrust AB/OU=AddTrust External TTP Network/CN=AddTrust External CA Root
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIFdjCCBF6gAwIBAgIRAPbTBHdHHseM4hArA7n6uREwDQYJKoZIhvcNAQELBQAw
gZAxCzAJBgNVBAYTAkdCMRswGQYDVQQIExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAO
BgNVBAcTB1NhbGZvcmQxGjAYBgNVBAoTEUNPTU9ETyBDQSBMaW1pdGVkMTYwNAYD
VQQDEy1DT01PRE8gUlNBIERvbWFpbiBWYWxpZGF0aW9uIFNlY3VyZSBTZXJ2ZXIg
Q0EwHhcNMTYwMTAxMDAwMDAwWhcNMTcwMTEzMjM1OTU5WjBbMSEwHwYDVQQLExhE
b21haW4gQ29udHJvbCBWYWxpZGF0ZWQxITAfBgNVBAsTGFBvc2l0aXZlU1NMIE11
bHRpLURvbWFpbjETMBEGA1UEAxMKcmF3Z2l0LmNvbTCCASIwDQYJKoZIhvcNAQEB
BQADggEPADCCAQoCggEBALD2sUNSYp2R+mSEMF2qKvMS780qTkltvqP4rwEGKOLV
rR5QQWo8vzSlgZvxVsguRHi0pPBtVAH794L43tD+IuyQlDlNU2qc1aMqBkn3S2wN
Way8BS9w80pgeFnObZiFJtPI9pdwcB72Bgq8Nlc25oVrDVWr/Q8nLIKS/9FkNs+C
MPU00vGFZSFbR7s15ORj9+qPCskWZcHpQ+m9EKmZD3IVKj3QQyBD17cBoVkYoIpj
I8/r+NfVfKetlsB7Pcv8P3yLFVFC4+PGrnW9TLZK9aRtbDTvjElXwCQIPK5B2fKw
SJK26IJPDX0r1JkeuR53Afr509iEx3xAHcRz/kR5uo8CAwEAAaOCAf0wggH5MB8G
A1UdIwQYMBaAFJCvajqUWgvYkOoSVnPfQ7Q6KNrnMB0GA1UdDgQWBBSI83Kqafo7
kg9cmyT1vnceH4fAUjAOBgNVHQ8BAf8EBAMCBaAwDAYDVR0TAQH/BAIwADAdBgNV
HSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwTwYDVR0gBEgwRjA6BgsrBgEEAbIx
AQICBzArMCkGCCsGAQUFBwIBFh1odHRwczovL3NlY3VyZS5jb21vZG8uY29tL0NQ
UzAIBgZngQwBAgEwVAYDVR0fBE0wSzBJoEegRYZDaHR0cDovL2NybC5jb21vZG9j
YS5jb20vQ09NT0RPUlNBRG9tYWluVmFsaWRhdGlvblNlY3VyZVNlcnZlckNBLmNy
bDCBhQYIKwYBBQUHAQEEeTB3ME8GCCsGAQUFBzAChkNodHRwOi8vY3J0LmNvbW9k
b2NhLmNvbS9DT01PRE9SU0FEb21haW5WYWxpZGF0aW9uU2VjdXJlU2VydmVyQ0Eu
Y3J0MCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5jb21vZG9jYS5jb20wSwYDVR0R
BEQwQoIKcmF3Z2l0LmNvbYIVY2RuLW9yaWdpbi5yYXdnaXQuY29tgg5jZG4ucmF3
Z2l0LmNvbYINcmF3Z2l0aHViLmNvbTANBgkqhkiG9w0BAQsFAAOCAQEASx3e6y9e
9F67N5NIDausDHDL+/fz6uj2DDNJdaQvALAYDV8hKpz7+QGotlQfI042U2i83J7m
DGZiKDpzaXa7IFfGiq6PFPUjntElHoU2E4vRb5LApg1sJ5YueYmRd3X7x0/jPYg6
TiTtHyXOnlMuqL2FUYJM0BP7cMfOppvUF0R2zHUVA0rVHuLrSStg8bMg8aVUIkKg
n3NS+eg4ofo95jaMRVykhLnylkYBk9dWBM6B19Yw7LgQd94MZSa+Xix4HxeFgvAM
BF+oeDMaY7mEN4Xm5hnrIS1FElRDq/ckpDV8JVpR4SQqB+tzSZPPIiep8EvgRDzd
2EkL187FF3MQ+w==
-----END CERTIFICATE-----
subject=/OU=Domain Control Validated/OU=PositiveSSL Multi-Domain/CN=rawgit.com
issuer=/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO RSA Domain Validation Secure Server CA
---
No client certificate CA names sent
---
SSL handshake has read 6716 bytes and written 456 bytes
---
New, TLSv1/SSLv3, Cipher is DHE-RSA-AES256-SHA
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1
    Cipher    : DHE-RSA-AES256-SHA
    Session-ID: ACFED5197F4B5F64DBAAC97A47380CD9283EFD1797E27EF43A215B06982698F4
    Session-ID-ctx: 
    Master-Key: 856DFB81C863F461FE75EE11E633EA5CAB3CD6683563F597F406EF19AB37CD3F45B4FE659AB8726F9291360CBE856F48
    Key-Arg   : None
    Start Time: 1475223830
    Timeout   : 300 (sec)
    Verify return code: 0 (ok)
---
</code></pre>
</div>

<p>BEGIN到END那段剪貼下來即是</p>

<h2 id="section">缺點</h2>

<p>這兩個方法有一個極大的缺點, 如果沒有解決方案還是最好別用(<del>啊講那麼多, 最後不能用?!</del>)
, 這缺點就是SSL Certificate是有時效性的, 因此server端的憑證是會換會改變的,
只要server端一換, 就可能造成client端的失效, 所以如果要使用這兩個方法,
前提必須先解決的是如何更新Client端要檢查的public key或certificate, 
這邊就不討論這部份的機制了, 這應該有很多方法可以來作才對</p>

<p>#好久沒寫關於Android的內容了</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-28T02:17:12+08:00"><a href="http://blog.jln.co/%E4%BD%BF%E7%94%A8aws-lambda%E5%92%8Cgithub%E4%BE%86%E6%8F%90%E4%BE%9B%E4%B8%AD%E8%8F%AF%E8%81%B7%E6%A3%92%E8%B3%BD%E7%A8%8B%E8%B3%87%E6%96%99/">September 28, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/%E4%BD%BF%E7%94%A8aws-lambda%E5%92%8Cgithub%E4%BE%86%E6%8F%90%E4%BE%9B%E4%B8%AD%E8%8F%AF%E8%81%B7%E6%A3%92%E8%B3%BD%E7%A8%8B%E8%B3%87%E6%96%99/" rel="bookmark" title="使用AWS lambda和Github來提供中華職棒賽程資料" itemprop="url">使用AWS lambda和Github來提供中華職棒賽程資料</a></h1>
    
  </header>
  <div class="entry-content">
    <p>不知不覺的突然就多出了兩天颱風假, 這颱風實在很威, 乒乒乓乓的, 不過, 也沒做什麼, 時間就快過完了, 現在才想到, 還是來寫點什麼, 嚴格說來這些東西並不完全是颱風假時弄的, 只是拖得有點久</p>

<p>起因是, 之前(很久…追朔到去年)想寫個App, 需要用到中華職棒賽程的資料, 拖了很久一直沒真的去做, 斷斷續續的, 最近才先把資料這部分補齊, 首先需求是:</p>

<ol>
  <li>當月之後的賽程資料, 但中華職棒並沒有API, 只有(很爛)的網頁, 因此資料勢必得從網頁去解析</li>
  <li>由Client app直接去解析html, 會比較麻煩(如果網站更新了, 就要更新App), 不是那麼可行</li>
  <li>不想花錢(或不想花太多錢)弄一個server, 更不用說還要考慮Scaling</li>
</ol>

<p>而賽程表這樣的資料的特性則是:</p>

<ol>
  <li>球季是3~10月</li>
  <li>資料內容除週一(休賽)外, 幾乎每天都會變, 但不會一兩個小時或幾分鐘就變一次</li>
  <li>變動的內容可能是:
    <ol>
      <li>比賽結束, 比數有更新</li>
      <li>延賽或停賽</li>
    </ol>
  </li>
  <li>一個月才幾十場比賽而已, 基本上不太需要有search或query的功能, 依據月份分類也就足夠了</li>
</ol>

<p>因此我採用的做法是:</p>

<ol>
  <li>利用AWS lambda定時解析中華職棒網站的資料</li>
  <li>資料以json格式存在github (使用Github api)</li>
  <li>Client透過CDN去要這些json的raw content</li>
</ol>

<h3 id="section">賽程解析</h3>

<p>這部分我是用Go + Goquery來寫的, source code在這邊: <a href="https://github.com/julianshen/cpblschedule">cpblschedule</a>, 這code沒啥整理過, 光解析這堆亂七八糟的html就夠頭痛囉, 就沒啥整理</p>

<p>我做成了一個package, 因此要使用可用下列指令先安裝:</p>

<p><code class="highlighter-rouge">go get -u github.com/julianshen/cpblschedule</code></p>

<p>裡面也很簡單就一個function而已, 因此要使用可以參考:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">import</span><span class="x"> </span><span class="s">"github.com/julianshen/cpblschedule"</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">matches</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">cpblschedule</span><span class="o">.</span><span class="n">ParseCPBLSchedule</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="x"> </span><span class="n">month</span><span class="p">)</span><span class="x">
    </span><span class="o">....</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h3 id="aws-lambda">AWS Lambda</h3>

<p>這邊就不介紹這東西是什麼了, 網路上文章一大堆, 基本上他是AWS一個severless的解決方案(這算廣告詞吧), 會使用這個的原因有二:</p>

<ol>
  <li>依我的用量應該是免費(事實證明, 其實還是要花點錢, 我忘了算網路傳輸的費用了, 不過這不多)</li>
  <li>可以用Cloud watch排程觸發</li>
</ol>

<p>不過有個小問題</p>

<div class="highlighter-rouge"><pre class="highlight"><code>**他不支援Go!!!!!**
</code></pre>
</div>

<p>而我上面那個解析的東東是go寫的, 那不就寫心酸的</p>

<p>所幸還有別的辦法,就是把程式編譯成執行檔, 然後用nodejs去包裝它, 不過這有點煩瑣, 所幸還有工具</p>

<p><a href="https://github.com/apex/apex">apex</a>, 這是讓你更簡單的去建立lambda function的工具, 而且他正好也可以幫你簡單做好上面所說的包裝</p>

<p>安裝及使用就看文件吧, 不特別說了, 但要如何用go寫一個lambda function handle呢?以下是範例:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"encoding/json"</span><span class="x">
	</span><span class="s">"github.com/apex/go-apex"</span><span class="x">
</span><span class="p">)</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">apex</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">event</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">RawMessage</span><span class="p">,</span><span class="x"> </span><span class="n">ctx</span><span class="x"> </span><span class="o">*</span><span class="n">apex</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="k">interface</span><span class="p">{},</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">dosomething</span><span class="p">()</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
	</span><span class="p">})</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h4 id="github-as-api-source">Github as API source</h4>

<p>資料既然變動不頻繁, 就用lambda定期產生然後把結果放到Github上就可了</p>

<p>Github API的Go的實做是Google放出來的<a href="https://github.com/google/go-github/">go-github</a>, 文件還蠻眼花撩亂的, 不過在這應用需要的API不多:</p>

<ol>
  <li>client.Repositories.GetContents - 取得內容</li>
  <li>client.Repositories.CreateFile - 創立一個新檔</li>
  <li>client.Repositories.UpdateFile - 更新某個檔</li>
</ol>

<p>之所以需要1的原因是要確認檔案是不是已經在repository裡面了, 如果沒有就用create, 如果有就拿SHA hash去更新內容</p>

<p>GetContents會把檔案內容一併給抓回來, 這可以用來在更新檔案前先比較, 如果不比較, 就算沒更動, API也會新增一個新的commit, 為了避免不要太誇張, 還是先比較一下好了</p>

<p>那之後client怎樣存取這些資料? 找到檔案, 選取raw就可以知道raw的url了, client每次就抓這個URL就好, 但為了避免過量地request湧到github, 因此透過一個CDN來存取可能會好一點</p>

<p>這時候就可以用<a href="http://rawgit.com">RawGit</a>, 這邊透過MaxCDN, 讓你可以去存取Github上的raw content, 而你的檔案的網址會是像這樣:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>https://cdn.rawgit.com/user/repo/tag/file
</code></pre>
</div>

<p>大致上就這樣</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-18T22:41:43+08:00"><a href="http://blog.jln.co/%E7%AD%86%E8%A8%98-%E4%B8%AD%E7%A7%8B%E9%80%A3%E5%81%87%E5%B0%8F%E5%AF%A6%E9%A9%97/">September 18, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/%E7%AD%86%E8%A8%98-%E4%B8%AD%E7%A7%8B%E9%80%A3%E5%81%87%E5%B0%8F%E5%AF%A6%E9%A9%97/" rel="bookmark" title="[筆記] 中秋連假小實驗" itemprop="url">[筆記] 中秋連假小實驗</a></h1>
    
  </header>
  <div class="entry-content">
    <p>最近直播蠻火紅的, 直播服務也不少, 連Facebook都做了直播功能, 最近也跟人聊了不少這方面的東西, 所以想說趁中秋連假來自己研究看看, 只是中秋節連假雖然多, 做的事情還真是不少, 看電影, 打球, 打電動, 看球的, 又碰上颱風天, 不過還是先搞個簡單的雛形唄</p>

<h3 id="section">相關應用</h3>
<p>市面上有不少關於直播的應用, 應該說, 簡直是氾濫, 而且每一種人氣似乎都是很旺, 還不是很了解在旺啥的, 現在可能也不少人認為當個網紅就可以一炮而紅之類的</p>

<ul>
  <li>Live.me
    <ul>
      <li><img src="/images/posts/IMG_9517.PNG" alt="" /></li>
    </ul>
  </li>
  <li>小米直播
    <ul>
      <li><img src="/images/posts/IMG_9519.PNG" alt="" /></li>
      <li><img src="/images/posts/IMG_9520.PNG" alt="" /></li>
    </ul>
  </li>
  <li>17
    <ul>
      <li><img src="/images/posts/IMG_9521.PNG" alt="" /></li>
      <li><img src="/images/posts/IMG_9522.PNG" alt="" /></li>
    </ul>
  </li>
  <li>麥卡貝
    <ul>
      <li><img src="/images/posts/IMG_9523.PNG" alt="" /></li>
    </ul>
  </li>
</ul>

<p>這邊其實可以看出, 根本大同小異, 大多是賣肉…喔, 不是, 賣網紅, 後面故意舉了一個麥卡貝當例子, 它是稍微不一樣, 以賣直播節目像是運動比賽的轉播(嗚~~金鋒退休了). 而不是一般的UGC(User generated), 當然這邊也沒舉一般很流行的遊戲直播像是<a href="https://www.twitch.tv">Twitch</a>, 不過這類早已為大家所熟知了</p>

<p>不管是哪一種, 大部分的設計都是大同小異, 都是以單向直播為主, 輔以文字聊天室, 可以送個愛心或禮物, Facebook稍稍進階點, 會將直播過程錄製下來, 不只錄製節目, 還有過程中的互動, 不過大家都是蠻近似的</p>

<h3 id="section-1">基本原理</h3>
<p>如果照以上的功能設計, 簡單的可以畫成兩個部分, 一個是直播串流(Video Stream)的部分, 一個則是聊天室的部分, 大致上的後端可以以這兩個為核心</p>

<p>關於直播串流的技術部分, Facebook 曾分享了一篇關於他們做直播串流經驗的文章:</p>

<p><a href="https://code.facebook.com/posts/1653074404941839/under-the-hood-broadcasting-live-video-to-millions/">Under the hood: Broadcasting live video to millions</a></p>

<p>從這邊可以了解到, 串流需要能夠支撐到非常多人同時觀賞, 網紅可能數百到數千, 像是蘋果的發表會, 或是Google I/O, WWDC 這種會議則可能是數萬到數十萬, 所以服務的高並發, 高流量是可以預期的, 架構上也要能夠承受這樣的強度, 簡化的畫起來應該像是這樣:</p>

<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.js"></script>
<div class="mermaid">
graph LR;
    C[Client]--publish--&gt;M[Media Server];
    M--forward--&gt;E(Edge Server);
    M--forward--&gt;E2(Edge Server);
    M--forward--&gt;E3(Edge Server);
    E--&gt;V(Viewer);
    E--&gt;V2(Viewer);
    E2--&gt;V3(Viewer);
    E2--&gt;V4(Viewer);
    E3--&gt;CDN;
    CDN--&gt;V5(Viewer);
    CDN--&gt;V6(Viewer);
    CDN--&gt;V7(Viewer);
</div>

<p>Viewer不直接從Media Server取串流內容是考量到Media server通常要接收多個Client發佈的串流, 一個假設性的想法是, 對於UGC(User generated content), 主播應該遠少於觀眾, 假設就算一個服務可以吸引到百萬級別的觀眾, 同時線上的主播應該了不起是幾千個而已, 即便如此, Media server本身從Client接收發布的串流資料後, 可能還需要做轉碼(transcoding), 和轉送的動作, 尤其是轉碼是較為耗CPU資源的工作, 如果把主播跟觀眾放在同一個伺服器上, 除了影響品質外, 也會不方便擴充, 因此減少Media server上的”觀眾”(讓觀眾只是其他少數的edge servers), 便可以在觀眾增加時相對好擴充容量(增加edge的數量)</p>

<p>但大部分的狀況來說, 每個直播的觀眾不一定是非常大量, 在Facebook那篇文章內也有提到, 在小量觀眾的狀況下, 分流到多個edge的效率應該就沒那麼的好了, 反而這時候放在同一台server減少延遲會是更好的選擇</p>

<p>串流的通訊協定有不少, 像是<a href="https://en.wikipedia.org/wiki/Real-time_Transport_Protocol">RTP</a>, <a href="https://en.wikipedia.org/wiki/Real_Time_Streaming_Protocol">RTSP</a>, <a href="https://en.wikipedia.org/wiki/Real-Time_Messaging_Protocol">RTMP</a>, <a href="https://en.wikipedia.org/wiki/HTTP_Live_Streaming">HLS</a>, <a href="https://webrtc.org">WebRTC</a>等等, Facebook那篇文章主要提到的是<a href="https://en.wikipedia.org/wiki/Real-Time_Messaging_Protocol">RTMP</a>, <a href="https://en.wikipedia.org/wiki/HTTP_Live_Streaming">HLS</a>, 查了一下資料, 似乎這兩個也是目前比較主流做直播用的, 雖然WebRTC被討論的也蠻多的, 但似乎比較沒被應用在大量的直播, RTMP跟HLS都是可以透過HTTP來做傳輸(RTMP需要做封裝 - RTMPT), 讓他們具有穿越防火牆的優勢, 而HLS是以檔案為基礎的, 所以適合用一般的CDN來做快取, 在做大量的直播優勢較大, 缺點是延遲太長了, 但這兩者其實也是可以合併使用的, 在小群體時用RTMP, 等觀眾成長到一定數量實再導流到HLS去</p>

<h3 id="proof-of-concept-">Proof of concept 的初步想法與簡單的設計</h3>
<p>幾個初步的想法</p>

<ol>
  <li>直播 = live stream + chat room</li>
  <li>現在直播應用很多, 所以應該不少現成的open source解決方案可以套用, POC可以從這些東西下手, 不用重造輪子</li>
  <li>需求: Client發布直播後, Viewer可以知道現在有誰在直播並觀看, 並可以透過訊息聊天</li>
</ol>

<p><strong>發布</strong></p>

<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.js"></script>
<div class="mermaid">
sequenceDiagram
    participant Client
    participant Register
    participant MediaServer
    participant Viewer
    Client-&gt;&gt;Register: I want to go live
    activate Register
    Register--&gt;&gt;Client: Here is your ID and token
    deactivate Register
    Client-&gt;&gt;MediaServer: Publish(id,token)
    activate MediaServer
    MediaServer-&gt;&gt;Register: token valid?
    activate Register
    Register--&gt;&gt;MediaServer: Yes
    deactivate Register
    MediaServer--&gt;&gt;Client: OK
    deactivate MediaServer
    Client-&gt;&gt;Register: I am ready to live
    activate Register
    Register-&gt;&gt;Viewer: Somebody is ready to live
    activate Viewer
    deactivate Register
    Viewer-&gt;Viewer: Update UI
    deactivate Viewer
</div>

<p><strong>觀賞直播</strong></p>

<p>這部分就沒什麼特別的了, 當一般的chat room做就好</p>

<h3 id="section-2">先看一下成果</h3>

<p>這成品有點粗劣, 有點不好意思 :P</p>

<div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/DyF27GlfuZ8" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>我publish client只實作iOS版本, 而Viewer只實作了Android版本(根本只各做一半嘛!!/翻桌), 後端用<a href="firebase.google.com">firebase</a>處理資料的部分, 所以即時通知新的直播, 和聊天沒啥問題(但我聊天的UI還是沒刻 &gt;”&lt;)</p>

<h3 id="section-3">相關解決方案</h3>

<p>既然沒有重新做輪子, 自然用了不少Open source的解決方案來達成, 從Server到Android, iOS要找到相關可用的實在不難, 可以說這部份實在是太成熟了, 研究完後覺得Facebook那篇文章也只是一般般而已</p>

<h4 id="steaming-server">Steaming server</h4>

<p>RTMP相關的解決方案還算不少, 這邊列幾個</p>

<ol>
  <li><a href="https://github.com/arut/nginx-rtmp-module">Nginx RTMP Module</a> - 架構在Nginx之上, 也算老牌了, 支援RTMP和HLS, 但看code base, 實在也沒啥在更新</li>
  <li><a href="http://www.monaserver.ovh">Mona server</a> - 支援RTMP, HTTP(非HLS), Web socket等等</li>
  <li><a href="http://red5.org">Red5 Media Server</a> - 支援RTMP, HLS, WebSocket, RTSP, 好像是要錢</li>
  <li><a href="https://github.com/ossrs/srs/">Simpe RTMP Server</a> - 這是由中國的觀止雲這家開源出來的, 講”Simple”其實一點都不Simple, 輕量, 穩定(至少我試直播一晚上都還蠻順利的), 好擴展(支援forward to edge), 可RTMP轉HLS, 因此我最後選擇這個方案</li>
</ol>

<h5 id="srs-simple-rtmp-server">SRS (Simple RTMP Server)</h5>

<p><strong>硬體</strong></p>

<p>我沒看到文件有寫硬體需求, 但我用Digital Ocean 1GB RAM, 30GB SSD的Droplet跑, 單一個直播, 直播好幾個鐘頭, CPU都不超過5%, 所以應該足夠</p>

<p><strong>安裝</strong></p>

<p>安裝上相當簡單</p>

<ol>
  <li>從git上抓下來: <code class="highlighter-rouge">git clone https://github.com/ossrs/srs.git</code></li>
  <li>切換到相對應版本的branch(我是用2.0release) - <code class="highlighter-rouge">git checkout 2.0release</code></li>
  <li><code class="highlighter-rouge">cd srs/trunk; ./configure ; make ;</code></li>
</ol>

<p>建置好的執行檔會在srs/trunk/objs目錄下, 可以直接執行</p>

<p><strong>設定</strong></p>

<p>conf目錄下有很多不同的設定檔可以參考, 因為我要試RTMP, HLS所以我用的設定檔如下:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>listen              1935;
max_connections     1000;
srs_log_tank        file;
srs_log_file        ./objs/srs.log;
http_api {
    enabled         on;
    listen          1985;
}
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}
stats {
    network         0;
    disk            sda sdb xvda xvdb;
}
vhost __defaultVhost__ {
    hls {
        enabled         on;
		hls_fragment    10;
        hls_window      60;
        hls_path        ./objs/nginx/html;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
}
</code></pre>
</div>

<p>相對應的設定可以參考文件</p>

<p><strong>執行</strong></p>

<p>很簡單: <code class="highlighter-rouge">srs -c my.conf</code> 即可</p>

<h4 id="ios-rtmp-publish">iOS RTMP Publish</h4>

<p>找到iOS支援RTMP publish的解決方案有幾種:</p>

<ol>
  <li><a href="https://github.com/jgh-/VideoCore">VideoCore</a> - 這個我還沒去試過, 不知道好不好用, 但似乎有支援Filter和Watermark, 感覺蠻威的</li>
  <li><a href="https://github.com/shogo4405/lf.swift">lf.swift</a> - 簡單, Swift做的, 這兩個是優點, 對我這個只看得懂Swift看不懂ObjC的, debug是比較方便, 但除此之外好像也沒啥特色了</li>
  <li><a href="https://github.com/runner365/LiveVideoCoreSDK">LiveVideoCoreSDK</a> - 這文件不多, 我暫時就沒試了, 也支援濾鏡, 而且似乎這個作者也提供了Android版本, 只是好像沒支援Cocoapods或Cathage, 有空再來玩玩</li>
  <li><a href="https://github.com/LaiFengiOS/LFLiveKit">LFLiveKit</a> - 我最後是選用這個, 簡單, 且”自帶美顏”(現在騙人是很基本的)</li>
</ol>

<h5 id="lfswift">lf.swift</h5>

<p>雖然文件上有提供cocoapods跟Carhtage的安裝方式, 但絕對不要用Carthage的那個, 第一原因是它Carthage支援似乎尚未搞定, 就算改點東西解決了它, 是可以安裝成功沒錯, 但會崩潰在XCGLogger, 似乎用framework含進來的方式會導致XCGLogger == nil, 這害我花了好多時間, 畢竟我是Carthage的愛用者, 後來轉用Cocoapods就沒事了</p>

<p>幾個需要加的部分:</p>

<p><em>AppDelegate.swift</em></p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span> <span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSObject</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>

        <span class="kt">XCGLogger</span><span class="o">.</span><span class="nf">defaultInstance</span><span class="p">()</span><span class="o">.</span><span class="n">outputLogLevel</span> <span class="o">=</span> <span class="o">.</span><span class="kt">Info</span>
        <span class="kt">XCGLogger</span><span class="o">.</span><span class="nf">defaultInstance</span><span class="p">()</span><span class="o">.</span><span class="n">xcodeColorsEnabled</span> <span class="o">=</span> <span class="kc">true</span>
        
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
</code></pre>
</div>
<p>這兩行是設定logger要記錄的東西, 方便debug用</p>

<p><em>ViewController</em></p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">rtmpStream</span> <span class="o">=</span> <span class="kt">RTMPStream</span><span class="p">(</span><span class="nv">rtmpConnection</span><span class="p">:</span> <span class="n">rtmpConnection</span><span class="p">)</span>
    <span class="n">rtmpStream</span><span class="o">.</span><span class="n">syncOrientation</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">rtmpStream</span><span class="o">.</span><span class="nf">attachAudio</span><span class="p">(</span><span class="kt">AVCaptureDevice</span><span class="o">.</span><span class="nf">defaultDeviceWithMediaType</span><span class="p">(</span><span class="kt">AVMediaTypeAudio</span><span class="p">))</span>
        <span class="n">rtmpStream</span><span class="o">.</span><span class="nf">attachCamera</span><span class="p">(</span><span class="kt">DeviceUtil</span><span class="o">.</span><span class="nf">deviceWithPosition</span><span class="p">(</span><span class="o">.</span><span class="kt">Back</span><span class="p">))</span>
    <span class="n">rtmpStream</span><span class="o">.</span><span class="nf">addObserver</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="nv">forKeyPath</span><span class="p">:</span> <span class="s">"currentFPS"</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">NSKeyValueObservingOptions</span><span class="o">.</span><span class="kt">New</span><span class="p">,</span> <span class="nv">context</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        
    <span class="n">rtmpStream</span><span class="o">.</span><span class="n">captureSettings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"sessionPreset"</span><span class="p">:</span> <span class="kt">AVCaptureSessionPreset1280x720</span><span class="p">,</span>
            <span class="s">"continuousAutofocus"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s">"continuousExposure"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="n">rtmpStream</span><span class="o">.</span><span class="n">videoSettings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"width"</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span>
            <span class="s">"height"</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="n">lfView</span><span class="o">.</span><span class="nf">attachStream</span><span class="p">(</span><span class="n">rtmpStream</span><span class="p">)</span>

    <span class="n">view</span><span class="o">.</span><span class="nf">addSubview</span><span class="p">(</span><span class="n">lfView</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>直播的部分會跟他的LFView綁一起</p>

<h5 id="lflivekithttpsgithubcomlaifengioslflivekit"><a href="https://github.com/LaiFengiOS/LFLiveKit">LFLiveKit</a></h5>

<p>後來選用LFLiveKit的原因不是因為他自帶美顏 :D, 他寫法跟lf.swift一樣簡單, 而且不一定要把preview加到UI裡面, 而且他的preview不用用特定的class,只要是UIView就可</p>

<p>範例直接貼他文件裡的就很清楚了:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// import LFLiveKit in [ProjectName]-Bridging-Header.h</span>
<span class="kd">import</span> <span class="o">&lt;</span><span class="kt">LFLiveKit</span><span class="o">.</span><span class="n">h</span><span class="o">&gt;</span> 

<span class="c1">//MARK: - Getters and Setters</span>
<span class="kd">lazy</span> <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">LFLiveSession</span> <span class="o">=</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">audioConfiguration</span> <span class="o">=</span> <span class="kt">LFLiveAudioConfiguration</span><span class="o">.</span><span class="nf">defaultConfiguration</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">videoConfiguration</span> <span class="o">=</span> <span class="kt">LFLiveVideoConfiguration</span><span class="o">.</span><span class="nf">defaultConfigurationForQuality</span><span class="p">(</span><span class="kt">LFLiveVideoQuality</span><span class="o">.</span><span class="kt">Low3</span><span class="p">,</span> <span class="nv">landscape</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">LFLiveSession</span><span class="p">(</span><span class="nv">audioConfiguration</span><span class="p">:</span> <span class="n">audioConfiguration</span><span class="p">,</span> <span class="nv">videoConfiguration</span><span class="p">:</span> <span class="n">videoConfiguration</span><span class="p">)</span>

    <span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
    <span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="n">preView</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">view</span>
    <span class="k">return</span> <span class="n">session</span><span class="o">!</span>
<span class="p">}()</span>

<span class="c1">//MARK: - Event</span>
<span class="kd">func</span> <span class="nf">startLive</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="p">{</span> 
    <span class="k">let</span> <span class="nv">stream</span> <span class="o">=</span> <span class="kt">LFLiveStreamInfo</span><span class="p">()</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s">"your server rtmp url"</span><span class="p">;</span>
    <span class="n">session</span><span class="o">.</span><span class="nf">startLive</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">stopLive</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="p">{</span>
    <span class="n">session</span><span class="o">.</span><span class="nf">stopLive</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">//MARK: - Callback</span>
<span class="kd">func</span> <span class="nf">liveSession</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="kt">LFLiveSession</span><span class="p">?,</span> <span class="nv">debugInfo</span><span class="p">:</span> <span class="kt">LFLiveDebug</span><span class="p">?)</span> 
<span class="kd">func</span> <span class="nf">liveSession</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="kt">LFLiveSession</span><span class="p">?,</span> <span class="nv">errorCode</span><span class="p">:</span> <span class="kt">LFLiveSocketErrorCode</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">liveSession</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="kt">LFLiveSession</span><span class="p">?,</span> <span class="n">liveStateDidChange</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">LFLiveState</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="android-stream-player">Android stream player</h4>

<p>寫到後面有點累了, 也有點懶了, 還剩下Android這塊沒寫, 這邊就只列出方案不寫細節了, 主要我測過:</p>

<ol>
  <li><a href="https://github.com/google/ExoPlayer/">ExoPlayer</a>: Google開源的Media player, 之前在做另一個東西時我有用過, 所以第一時間就想起這個, 不過, 原生的完全不支援RTMP, 不過可以參考<a href="https://github.com/ButterflyTV/ExoPlayer-with-RTMP-and-FLV-seek/blob/master/demo/src/main/java/com/google/android/exoplayer/demo/player/RtmpDataSource.java">這邊</a>, 但我實際上用, RTMP完全沒成功過, 一直出現FLV parse的問題, 倒是HLS沒問題</li>
  <li><a href="https://github.com/Bilibili/ijkplayer">Ijkplayer</a> - 這同時有Android和iOS版本, 是Bilibili開源的, 有點強大, 但基於ffmpeg, 不知道在license上會不會有風險, 使用起來還有點複雜, 但HLS, RTMP都是沒問題</li>
  <li><a href="https://github.com/pili-engineering/PLDroidPlayer">PLDroidPlayer</a> - 七牛雲針對ijkplayer的再製品, 比較方便的是, 它有封裝出一個video view可以直接使用, 相較於ijkplayer來說比較簡單易用</li>
</ol>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-08-31T16:33:15+08:00"><a href="http://blog.jln.co/blog-%E6%9B%BFjekyll%E7%9A%84markdown%E5%8A%A0%E4%B8%8A%E7%B0%A1%E6%98%93%E6%B5%81%E7%A8%8B%E5%9C%96%E5%8A%9F%E8%83%BD/">August 31, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/blog-%E6%9B%BFjekyll%E7%9A%84markdown%E5%8A%A0%E4%B8%8A%E7%B0%A1%E6%98%93%E6%B5%81%E7%A8%8B%E5%9C%96%E5%8A%9F%E8%83%BD/" rel="bookmark" title="[Blog] 替Jekyll的markdown加上簡易流程圖功能" itemprop="url">[Blog] 替Jekyll的markdown加上簡易流程圖功能</a></h1>
    
  </header>
  <div class="entry-content">
    <p>對一個developer的blog來說, 流程圖似乎是蠻需要的, 比較能夠清楚來解釋一些東西, 但每個東西都轉圖檔還蠻麻煩的, 下面介紹一個有用的Jekyll plugin, 可以做到像下面這樣的效果:</p>

<p><strong>第一例</strong></p>

<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.js"></script>
<div class="mermaid">
graph TD;
    A--&gt;B;
    A--&gt;C;
    B--&gt;D;
    C--&gt;D;
</div>

<p><strong>第二例</strong></p>

<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.js"></script>
<div class="mermaid">
sequenceDiagram
    participant John
    participant Alice
    Alice-&gt;&gt;John: Hello John, how are you?
    John--&gt;&gt;Alice: Great!
</div>

<p>這是利用一個叫做<a href="https://github.com/jasonbellamy/jekyll-mermaid">Jekyll-mermaid</a> 來達成的</p>

<p>而這plugin其實也沒做很多事, 它是包裝了<a href="https://github.com/knsv/mermaid">mermaid</a>這個工具, 而mermaid這工具他是利用了<a href="https://d3js.org">ds.js</a>來讓你用很簡單的方式來繪製流程, 以上面兩個例子為例</p>

<p><strong>第一例</strong></p>

<div class="language-markdown highlighter-rouge"><pre class="highlight"><code>graph TD;
    A--&gt;B;
    A--&gt;C;
    B--&gt;D;
    C--&gt;D;
</code></pre>
</div>

<p><strong>第二例</strong></p>

<div class="language-markdown highlighter-rouge"><pre class="highlight"><code>sequenceDiagram
    participant John
    participant Alice
    Alice-&gt;&gt;John: Hello John, how are you?
    John--&gt;&gt;Alice: Great!
</code></pre>
</div>

<p>所以你在markdown裡面只要加上</p>

<div class="language-markdown highlighter-rouge"><pre class="highlight"><code>{ % mermaid % }
sequenceDiagram
    participant John
    participant Alice
    Alice-&gt;&gt;John: Hello John, how are you?
    John--&gt;&gt;Alice: Great!
{ % endmermaid % }
</code></pre>
</div>

<p>他就會幫你render出相關的流程了</p>

<h4 id="section">安裝方法</h4>
<p>這邊以我自己blog的安裝方法來說明</p>

<ol>
  <li>把jekyll-mermaid.rb放到_plugins目錄去</li>
  <li>在_config.yml加上 (這邊以6.0.0的mermaid為例):</li>
</ol>

<div class="language-markdown highlighter-rouge"><pre class="highlight"><code>mermaid:
  src: 'https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.js'
</code></pre>
</div>
<ol>
  <li>還要在head.html加上css (要配合版面顏色), 可以用這個 : https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css</li>
</ol>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-08-17T23:46:04+08:00"><a href="http://blog.jln.co/%E7%AD%86%E8%A8%98-%E8%A3%BD%E4%BD%9C%E8%87%AA%E5%B7%B1%E7%9A%84icon-font/">August 17, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://blog.jln.co/about/" title="About Julian Shen">Julian Shen</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://blog.jln.co/%E7%AD%86%E8%A8%98-%E8%A3%BD%E4%BD%9C%E8%87%AA%E5%B7%B1%E7%9A%84icon-font/" rel="bookmark" title="[筆記]製作自己的Icon font" itemprop="url">[筆記]製作自己的Icon font</a></h1>
    
  </header>
  <div class="entry-content">
    <p>承續<a href="http://blog.jln.co/筆記-ios開發-使用icon-font來節省圖示空間/">上篇</a>的用icon font來製作圖示, 之前所提到的都是利用現成的icon font, 但似乎大部分的icon font都沒有像material icon有支援ligatures, 沒支援的話, 在xcode裡面就無法像上一篇一樣, 直接在UI designer顯示對應的圖示, 另外如果需要使用自己的圖示呢?其實是有方法用SVG圖檔來製作自己的icon font的, 這篇就來介紹兩種用SVG圖檔製作一個有ligatures支援的字型檔</p>

<h3 id="grunt-webfont">grunt-webfont</h3>
<p>第一個方法就是利用<a href="https://github.com/sapegin/grunt-webfont">grunt-webfont</a>, <a href="http://gruntjs.com">Grunt</a>是一個前端常用的建構工具, 而<a href="https://github.com/sapegin/grunt-webfont">grunt-webfont</a>是一個用來產生字型的task</p>

<h5 id="section">安裝相關工具</h5>
<p>由於需要使用<a href="http://gruntjs.com">Grunt</a>, <a href="nodejs.org">node.js</a>是必須的, 另外由於需要使用到<a href="http://fontforge.github.io">fontforge</a>, 所以python也是必須的, 雖然說grunt-webfont也可以純nodejs的module來產生字型, 但那並無法支援ligatures, 所以fontforge是一定需要的</p>

<p>用<code class="highlighter-rouge">npm i grunt --global</code>來安裝grunt</p>

<h5 id="section-1">製作字型</h5>
<ol>
  <li>建立一個空的目錄</li>
  <li>在這個目錄執行<code class="highlighter-rouge">npm init</code>來產生<code class="highlighter-rouge">package.json</code></li>
  <li><code class="highlighter-rouge">npm i grunt-webfont --save</code>來安裝grunt-webfont並且把這個dependency 加到<code class="highlighter-rouge">package.json</code></li>
  <li>建立一個svg子目錄(目錄名稱隨你高興, 這邊以svg當例子), 把所有圖示的svg檔案全部放到這目錄去</li>
  <li>建立Gruntfile.js , 這檔案就像是Makefile, 或像是build.gradle這樣的角色, 內容就像下面</li>
</ol>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span><span class="p">({</span>
    <span class="na">pkg</span><span class="p">:</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">readJSON</span><span class="p">(</span><span class="s1">'package.json'</span><span class="p">),</span>
    <span class="na">webfont</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">icons</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">src</span><span class="p">:</span> <span class="s1">'svg/*.svg'</span><span class="p">,</span>
                <span class="na">dest</span><span class="p">:</span> <span class="s1">'build/fonts'</span><span class="p">,</span>
                <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
                        <span class="na">engine</span><span class="p">:</span> <span class="s1">'fontforge'</span><span class="p">,</span>
                        <span class="na">htmlDemo</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                        <span class="na">fontHeight</span><span class="p">:</span> <span class="mi">96</span><span class="p">,</span>
                        <span class="na">normalize</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="na">ascent</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
                        <span class="na">descent</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                        <span class="na">font</span><span class="p">:</span> <span class="s1">'octicon'</span><span class="p">,</span>
                        <span class="na">fontFamilyName</span><span class="p">:</span> <span class="s1">'octicon'</span><span class="p">,</span>
                        <span class="na">types</span><span class="p">:</span> <span class="s1">'ttf'</span><span class="p">,</span>
                        <span class="na">ligatures</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                        <span class="na">startCodepoint</span><span class="p">:</span> <span class="mh">0xF101</span>
                    <span class="p">}</span>
                <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">clean</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'build/fonts/*'</span>
      <span class="p">]</span>
  <span class="p">});</span>

  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-contrib-clean'</span><span class="p">);</span>
  <span class="nx">grunt</span><span class="p">.</span><span class="nx">loadNpmTasks</span><span class="p">(</span><span class="s1">'grunt-webfont'</span><span class="p">);</span>
  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">'font'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'clean'</span><span class="p">,</span> <span class="s1">'webfont'</span><span class="p">]);</span>
  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">'default'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'font'</span><span class="p">]);</span>
<span class="p">};</span>
</code></pre>
</div>

<p>這邊最主要也最重要的task就是webfont這個, 這裡面<code class="highlighter-rouge">src</code>是svg檔的目錄, <code class="highlighter-rouge">dest</code>是字型輸出的目錄, engine的部分指名fontforge, ligatures設定必須要是true(產生的字型的ligature的名字其實就是沿用svg的檔名)</p>

<p>建立好這個檔後執行<code class="highlighter-rouge">grunt</code>即可</p>

<h3 id="icomoon">icomoon</h3>
<p>上面的方法還是有點麻煩, 蠻手動的, 還有一個更方便的工具就是<a href="https://icomoon.io/app/">icomoon</a>, 這東西方便更多, 它是一個相當強大的工具</p>

<p><img src="/images/posts/icomoon1.png" alt="Icomoon" /></p>

<p>從畫面上看, 它其實很簡單操作, 選定你所需要的圖示後, 按右下角的<code class="highlighter-rouge">Generate Font</code>即可, 除了你可以自己import自己的svg檔案外, 它也提供很多付費跟免費的圖示供選用:</p>

<p><img src="/images/posts/icomoon2.png" alt="Icomoon" /></p>

<p>按下<code class="highlighter-rouge">Generate Font</code>後, 並不會馬上讓你下載字型回家, 它會先讓你檢視字型將會包含的圖示, 這邊有件事很重要, 左上角有個<code class="highlighter-rouge">fi</code>圖示(參照下圖), 按下去後, 下面的圖示下面會多一個fi的欄位, 這就是讓你設定這些圖示的ligature的, 如果需要一個有支援ligature的字型, 就需要去設定這邊</p>

<p><img src="/images/posts/icomoon3.png" alt="Icomoon" /></p>

<p>所有都沒問題後按下右下角的<code class="highlighter-rouge">Download</code>就沒問題了</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    
      
        <li><a href="http://blog.jln.co/page6/" class="btn">Previous</a></li>
      
    

    
    
      <li><a href="http://blog.jln.co">1</a></li>
    

    
    
      
      
      <li>…</li>
    

    
    
    

    
      
        
        
        
        <li><a href="http://blog.jln.co/page5/">5</a></li>
      
    
      
        
        
        
        <li><a href="http://blog.jln.co/page6/">6</a></li>
      
    
      
        <li><strong class="current-page">7</strong></li>
      
    
      
        
        
        
        <li><a href="http://blog.jln.co/page8/">8</a></li>
      
    
      
        
        
        
        <li><a href="http://blog.jln.co/page9/">9</a></li>
      
    

    
    
      <li>…</li>
    

    
      <li><a href="http://blog.jln.co/page71/">71</a></li>
    

    
    
      <li><a href="http://blog.jln.co/page8/" class="btn">Next</a></li>
    
  </ul>
</div>


</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Julian Shen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://blog.jln.co/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://blog.jln.co/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79243751-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


          

</body>
</html>