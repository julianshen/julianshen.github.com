<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Posts &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jln.co/post/"><meta property="og:image" content="https://blog.jln.co/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.jln.co/images/avatar.png"><meta name=twitter:title content="Posts"><meta name=twitter:description content><link rel=canonical href=https://blog.jln.co/post/><link rel=alternate type=application/rss+xml href=https://blog.jln.co/post/feed.xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.109.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post-index class=feature><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=image-credit>Image credit: <a href=http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/>dargadgetz</a></div><div class=entry-image><img src=/abstract-2.jpg alt=Posts></div><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>All posts</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2023-01-02 21:45:11 +0800 +0800"><a href=/Zai-K8sshang-Jia-She-Mian-Zookeeperde-Kafka/>Jan 2, 2023</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~5 minutes</span></div><h1 class=entry-title><a href=/Zai-K8sshang-Jia-She-Mian-Zookeeperde-Kafka/ rel=bookmark title=在k8s上架設免zookeeper的Kafka itemprop=url>在k8s上架設免zookeeper的Kafka</a></h1></header><div class=entry-content><p>架設Kafka一個稍稍討厭的點就是先架好Zookeeper, 在Kafka 2.8 (2021/4發布)之後, 支援了以自家的KRaft實現的Quorum controller, 這就可以不用再依賴zookeeper了, Confluent<a href=https://developer.confluent.io/learn/kraft/>這篇文章</a>有簡單的介紹一下Quorum controller是怎運作的</p><p>在我前面<a href=https://blog.jln.co/dapr-raw-payload-pub-sub/>這篇</a>有提到, 如何用docker跑無zookeeper的Kafka:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --name kafka-zkless -p 9092:9092 -e LOG_DIR<span style=color:#f92672>=</span>/tmp/logs quay.io/strimzi/kafka:latest-kafka-2.8.1-amd64 /bin/sh -c <span style=color:#e6db74>&#39;export CLUSTER_ID=$(bin/kafka-storage.sh random-uuid) &amp;&amp; bin/kafka-storage.sh format -t $CLUSTER_ID -c config/kraft/server.properties &amp;&amp; bin/kafka-server-start.sh config/kraft/server.properties&#39;</span>
</span></span></code></pre></div><p>那如果要架設在K8S上, 可以怎麼做呢? 原本的Kafka需要依賴zookeeper, 加上Kafka的eco system其實蠻多東西的, 一般也不會光只用Kafka本身而已, Kafka Bridge, Kafka connect, schema registry, 進階一點就Kafka stream, KSQL, 規模大一點還需要用上Cruise control, Mirror Maker, 所以用Operator來架設可能會比單純寫manifest, helm chart來的好用, 而比較常見(有名的?)Kafka Operator大致上有這三個(就我知道的啦):</p><ol><li><a href=https://docs.confluent.io/5.5.1/installation/operator/index.html>Confluent Operator</a>, 由Confluent這家公司發布的, 由於Confluent這家公司的背景(<a href=https://docs.confluent.io/5.5.1/installation/operator/index.html>https://docs.confluent.io/5.5.1/installation/operator/index.html</a>), Kafka雖是Open source但就是他們家的產品, 所以這個也算是官方出品的Operator, 但這個功能上比較起來稍弱, 而且並沒啥更新, 當然也就還沒看到KRaft相關的支援</li><li><a href=https://banzaicloud.com/docs/supertubes/kafka-operator/>KOperator</a>, <a href=https://banzaicloud.com/>萬歲雲(Bonzai Cloud)</a>出品, 由於Bonzai Cloud目前是Cisco的, 所以這個也可以算大公司出品(?), 我自己是還沒用過, 但看架構, 預設就會架起Cruise control跟Prometheus, 感覺架構上考量是比較完整的, 另外就是也考量到部屬到Istio mesh的部分, 用Envoy來做external LB, 以及用等等, 另外一個值得一提的是Kafka這種Stateful application, 它卻並不是採用Statefulset來部署(它的文件有提到<code>All Kafka on Kubernetes operators use StatefulSet to create a Kafka Cluster</code>, 但事實是後來Strimzi也採用一樣的策略了), 但一樣的, 也還沒有支援KRaft</li><li><a href=https://strimzi.io/>Strimzi Operator</a>, 這應該算蠻廣泛被利用的一個Operator, 支援豐富, 更新迅速, 也是可以支援Cruise control (不一定要開), 基本該支援的, 應該也都差不多了, 而且從0.29就支援了KRaft, 不過這個Operator基本消費的記憶體就需要到300MB了</li></ol><p>總和以上, 看起來如果要在K8S上玩KRaft的話, Strimzi是一個比較適合的選擇</p><h2 id=安裝strimzi-operator>安裝Strimzi operator</h2><p>用以下指令安裝:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create namespace kafka
</span></span><span style=display:flex><span>kubectl create -f <span style=color:#e6db74>&#39;https://strimzi.io/install/latest?namespace=kafka&#39;</span> -n kafka
</span></span></code></pre></div><p>這除了會建立strimzi-cluster-operator這個Deployment, 也會建立相關的ClusterRoles, ClusterRoleBindings, 和相關的CRD, 所以要先確定你有權限建立這些(尤其是Cluster level的), 其實相當簡單</p><p>另外, 用以下的manifest就會幫你建立好一個Kafka Cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kafka.strimzi.io/v1beta2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Kafka</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kafka</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>3.3.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>listeners</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>plain</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9092</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>internal</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tls</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tls</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9093</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>internal</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tls</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>offsets.topic.replication.factor</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>transaction.state.log.replication.factor</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>transaction.state.log.min.isr</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default.replication.factor</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>min.insync.replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>inter.broker.protocol.version</span>: <span style=color:#e6db74>&#34;3.3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ephemeral</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>zookeeper</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ephemeral</span>
</span></span></code></pre></div><p>這會建立一個replica數量為3的Kafka cluster,以及對應的Zookeeper, 這邊的Storage type為ephemeral, 這表示它會用emptyDir當Volume, 如果你有相對應的PVC, 也可以把這替換掉</p><p>這邊還是會幫你建立出zookeeper, 那如何能擺脫zookeeper呢?</p><h2 id=打開實驗性功能>打開實驗性功能</h2><p>截至這邊文章寫的時間的版本(0.32), KRaft還是一個實驗性功能, 要以環境變數打開, 如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl set env deployments/strimzi-cluster-operator STRIMZI_FEATURE_GATES<span style=color:#f92672>=</span>+UseKRaft -n kafka
</span></span></code></pre></div><p>strimzi是靠STRIMZI_FEATURE_GATES來當作feature toggle, 在0.32只有一個實驗性功能的開關, 那就是<code>UseKRaft</code>, 上面那行指令就可以把這功能打開</p><p>用上面一模一樣的Manfest(Zookeeper那段要留著, 雖然沒用, 但在這版本還是必須), 就可以開出一個不依賴zookeeper的kafka cluster了, 以下是整個操作過程:</p><p><a href=https://asciinema.org/a/nibWve6U2E94pn1ljcNx6vscC><img src=https://asciinema.org/a/nibWve6U2E94pn1ljcNx6vscC.svg alt=asciicast></a></p><p>這邊你可能會發現, 我是用一個strimzipotset的資源來確認是否Kafka有沒正確被開成功, 你如果再去看Replica set, Stateful set, 你會發現找不到Kafka相關的, Strimzi其實就是靠自己的controller來管理Kafka的pods</p><p>你也可以用 <code>kubectl get kafkas -n kafka</code>來確認kafka這namespace下的kafka cluster的狀況</p><p>這個Manifest其實我拿掉了EntityOperator的部分, 是因為KRaft功能目前還沒支援TopicOperator, 沒拿掉會報錯</p><h2 id=是該拋棄zookeeper了嗎>是該拋棄Zookeeper了嗎?</h2><p>KRaft相對很新, 以三大有名的Kafka Operator來說, 目前也只有Strimzi有支援, 而且才剛開始, 實務上來說, 以功能, 穩定性或許應該還不是時候在production廣泛使用, 真要用, 還是多測試一下再說吧, 短時間還是跟zookeeper做做好朋友</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-12-10 02:15:17 +0800 +0800"><a href=/Ge-Ke-Neng-Rang-Mongodbzai-K8sxia-Bei-Oom_killde-Wen-Ti/>Dec 10, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~3 minutes</span></div><h1 class=entry-title><a href=/Ge-Ke-Neng-Rang-Mongodbzai-K8sxia-Bei-Oom_killde-Wen-Ti/ rel=bookmark title=一個可能讓Mongodb在k8s下被OOM_KILL的問題 itemprop=url>一個可能讓Mongodb在k8s下被OOM_KILL的問題</a></h1></header><div class=entry-content><p>做了些實驗, 紀錄一下, 剛好寫這篇時巴西也被幹掉了, 也記錄一下 XD</p><p>這個問題其實要滿足以下條件才可能發生:</p><ul><li>MongoDB版本在 4.4.14, 5.3.0, 5.0.7, 4.2.20 之前, 這算是一個Mongodb在2022一月才fix的一個bug, 所以比這幾版舊是有可能的</li><li>MongoDB instance在K8S上有設memory limit (且這limit要小於host node memory的一半?)</li><li>K8S所在的Host OS 的cgroup版本為V2, 可以<a href=https://github.com/opencontainers/runc/blob/main/docs/cgroup-v2.md>參考這文件</a>, Ubuntu 21.10, Fedora 31之後都開啟V2了, 不過如果你用的是WSL2, 由於WSL2的Kenel還是V1, 是試不出這問題的 (我是找了台Fedora來試)</li></ul><h3 id=問題是甚麼>問題是甚麼?</h3><p>查這問題的起因當然是碰到Mongodb被OOM Kill, 後來發現好像這也算蠻常踩到的坑, 只是好像沒人寫出完整可能性</p><p>碰到被OOM Kill第一個會思考的是, 他為何要那麼多記憶體?要給他多少才夠? 另外一個是, 由於是發生在container, 跑在K8S上, 一個疑問是, 那MongoDB是否會遵守設給他的resource limit? 還是他會當node所有記憶體都是他可用的?</p><h3 id=有沒有哪裡可疑的>有沒有哪裡可疑的?</h3><p>有哪些東西會吃記憶體? 連線會, index會, 但其實其中一個比較可疑的是給Wired Tiger的cache, 根據<a href=https://www.mongodb.com/docs/manual/core/wiredtiger/>這份文件</a>, Wired Tiger的cache會用掉</p><ul><li>50% 的(總記憶體 - 1GB) 或是</li><li>256MB</li></ul><p>也就是至少256MB, 然後如果你有64G記憶體, 他就會用掉最多 (64-1)/2, 到這聽起來好像沒啥問題, 只用一半還不至於有撐爆的問題, 會不會是其他的地方?</p><p>但另一個問題是, 直接裝在單機沒問題, 如果是跑在K8S上的容器, Memory limit我們是給在K8S上, MongoDB到底會以memory limit當總記憶體大小還是以整個node全部可用的記憶體計算?</p><p>其實根據文件的補充說明, 它是有考慮到的, 它會以<a href=https://www.mongodb.com/docs/manual/reference/command/hostInfo/#mongodb-data-hostInfo.system.memLimitMB>hostInfo.system.memLimitMB</a> 來計算</p><p><code>In some instances, such as when running in a container, the database can have memory constraints that are lower than the total system memory. In such instances, this memory limit, rather than the total system memory, is used as the maximum RAM available.</code></p><p>而它這資訊是透過cgroup去抓的, K8S也是用cgroup做資源管理的, 所以這值會等於你設定的limit</p><p>我第一次在WSL下測試, 把memory limit設為2Gi, <a href=https://www.mongodb.com/docs/manual/reference/command/hostInfo/#mongodb-data-hostInfo.system.memLimitMB>hostInfo.system.memLimitMB</a> 也的確是這個值(用mongo client下<code>db.hostInfo()</code>即可查詢)</p><p>那看來應該沒問題呀, 問題在哪?</p><p>後來查到一個bug : <a href=https://jira.mongodb.org/browse/SERVER-60412>https://jira.mongodb.org/browse/SERVER-60412</a>, 原來cgroup v1, v2抓這些資訊的位置是不同的, 所以導致舊版的會有抓不正確的狀況</p><p>看到這就來做個實驗, 找了台有開啟v2的fedora (with podman), 跑了k3s, 在這k3s上分別跑了4.4.13, 4.4.15兩個版本去做測試, memory limit都設為2Gi, 用<code>db.hostInfo()</code>查詢memLimitMB得到下面結果:</p><h4 id=4413>4.4.13</h4><p><img src=/images/posts/mongo4.13.mem.png alt></p><h4 id=4415>4.4.15</h4><p><img src=/images/posts/mongo4.15.mem.png alt></p><p>Bingo! 4.4.13果然抓到的memLimitMB是整個node的記憶體大小而非limit, 這樣如果node的記憶體大小遠大於limit, Wired Tiger cache是有可能用超過limit的</p><p>當然, 這只是其中一種可能性, 不見得一定都是這情形, 但碰到這類狀況, 這的確是可以考慮查的一個方向</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-11-13 13:11:27 +0800 +0800"><a href=/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/>Nov 13, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka/ rel=bookmark title="使用Dapr Input/Output Binding連接Kafka" itemprop=url>使用Dapr Input/Output Binding連接Kafka</a></h1></header><div class=entry-content><p>在Dapr元件有一種叫做Binding的元件(component)讓你的app跟外部系統做一個連結的, 這元件可分為兩類:</p><ol><li>Input BIndings: 用來接受外部事件的觸發,像是Webhook, 從Queue來的events, 甚至是人家新發的Tweets, 應該都可以歸為這一類</li><li>Ouput Bindings: 呼叫外部系統的動作,命名為Outpiut其實會讓人誤以為是資料的輸出,但其實,他不只可以用在資料輸出,呼叫外部系統的動作都可以包含在內, 舉個例子, <a href=https://github.com/dapr/components-contrib/tree/master/bindings/graphql>GraphQL 的Output binding</a>定義了兩個操作(Operations), 一個是QueryOperation, 一個是MutationOperation, 熟悉GraphQL的應該知道,MutationOperation一般才是應用在資料操作,而Query感覺就跟輸出比較無關了</li></ol><p>一開始我也有點搞不清楚這個模式目的在做啥的, 要接受事件觸發,我們有pub sub了,而state store本身就用在資料輸出, 感覺的確有點重複,但由上述兩點來看,其實Binding定義的範圍廣泛多了,它並不特定限制在Queue或是資料庫</p><p>但有個東西同時支援了Pub sub, input binding, output binding, 一開始我是看Kafka這應用,才讓我覺得有點錯亂,<a href=dapr-raw-payload-pub-sub>前一篇</a>有講過了怎實作Subscriber, 這邊來比較一下, 利用Input binding的話,會有什麼不一樣?</p><h3 id=建立binding元件>建立Binding元件</h3><p><img src=/post/images/55875EA9-6C5C-48BB-8289-FF95B5CB5409.jpeg alt></p><p>要用Kafka來觸發我們服務(如上圖),跟寫Subscriber一樣,我們需要在<code>~/.dapr/components</code>裡先建立好元件, 假設我們新增一個<code>kafka-binding.yaml</code>, 內容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>dapr.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Component</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-binding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>bindings.kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>brokers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>localhost:9092</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>topics</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>mytopic</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumerGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>group1</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>publishTopic</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#ae81ff>mytopic</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authRequired</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;false&#34;</span>
</span></span></code></pre></div><p>上面這個其實已經是定義好input和output binding了,topics定義的是input binding要聽取事件的topic, 而publishTopic定義的則是Output binding要輸出資料的目標</p><h3 id=實作input-binding>實作Input binding</h3><p>跟實做subscriber差不多, Input binding也是實作一個webhook讓Dapr打進來而已, 這邊假設Kafka會收到的資料會是一個數字</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dataBinding</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Bind</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>data</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Status</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>POST</span>(<span style=color:#e6db74>&#34;/kafka-binding&#34;</span>, <span style=color:#a6e22e>dataBinding</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>OPTIONS</span>(<span style=color:#e6db74>&#34;/kafka-binding&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Status</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:6003&#34;</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊幾個重點:</p><ol><li>endpoint path跟你的binding名稱一樣, 當然這可以在元件設定那邊改</li><li>OPTIONS有點像是讓Dapr確認你有沒支援這個binding的health endpoint, 在程式一開始跑就會被call, 這邊只要回OK, 其實都好</li><li>跟pub sub不一樣的是, 這邊會收到的格式不一定會是cloudevent, 除非publisher那邊過來的就是cloudevent, 因此, tracing應該是追蹤不到才是</li></ol><h3 id=實做output-binding>實做Output binding</h3><p>那如何實作跟剛剛的Input binding匹配的Output binding呢? 範例如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>dapr</span> <span style=color:#e6db74>&#34;github.com/dapr/go-sdk/client&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>BINDING_NAME</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;kafka-binding&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>BINDING_OPERATION</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;create&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>5000</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Seed</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixMicro</span>())
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>dataId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>1000</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>NewClient</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>InvokeBindingRequest</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>BINDING_NAME</span>, <span style=color:#a6e22e>Operation</span>: <span style=color:#a6e22e>BINDING_OPERATION</span>, <span style=color:#a6e22e>Data</span>: []byte(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InvokeOutputBinding</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sending message: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010> </span> <span style=color:#960050;background-color:#1e0010> </span> }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>這邊重點在於:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dapr</span>.<span style=color:#a6e22e>InvokeBindingRequest</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#a6e22e>BINDING_NAME</span>, <span style=color:#a6e22e>Operation</span>: <span style=color:#a6e22e>BINDING_OPERATION</span>, <span style=color:#a6e22e>Data</span>: []byte(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>dataId</span>))}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>InvokeOutputBinding</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>in</span>)
</span></span></code></pre></div><p>雖說是"Output" binding, 但這邊用的名字是"Invoke", 跟Output沒啥相關, Operation則是元件訂的, Kafka binding只定義一個"create", 就是讓你送訊息用的, Data則是要傳送的資料, 以Byte array表示</p><h3 id=用subscriber接收output-binding來的事件>用subscriber接收output binding來的事件</h3><p>這邊就不用多作解釋了, 從前面不難發現, 它接的就是raw payload, 這部分可以參考 <a href=dapr-raw-payload-pub-sub>前一篇</a></p><p>那啥時該用哪一種呢? 以Kafka這範例來說, 我是認為如果publisher跟subscriber都是自己實做的話, 應該是要選用pub sub, 用cloud events的話, 可以享受到distributed tracing帶來的好處, 如果不是, 差異應該不大, 都蠻簡單實作的</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-11-10 13:57:03 +0800 +0800"><a href=/Hugo-Rang-Wen-Zhang-De-Urlbu-Yao-Shi-Zhong-Wen-Zi/>Nov 10, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~3 minutes</span></div><h1 class=entry-title><a href=/Hugo-Rang-Wen-Zhang-De-Urlbu-Yao-Shi-Zhong-Wen-Zi/ rel=bookmark title="[Hugo] 讓文章的URL不要是中文字" itemprop=url>[Hugo] 讓文章的URL不要是中文字</a></h1></header><div class=entry-content><p>在發表<a href=dapr-raw-payload-pub-sub>前一篇</a>時, <a href=https://www.evanlin.com/>Evan</a> 跟我說, &ldquo;能不能用slug把url改好看點?&rdquo;, 從開始寫blog來, 其實我也沒在意有沒人看, 所以SEO相關的也沒太在意, 但既然有人講了, 我就來弄一下吧</p><h3 id=prama-links的設定>Prama links的設定</h3><p>首先先來看看pramalinks設定的部分:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>permalinks</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>post</span> = <span style=color:#e6db74>&#34;/:slug/&#34;</span>
</span></span></code></pre></div><p>這邊就是用來設定你URL長相的地方, 我的原文都放在post目錄內, 所以我一開始的設定就是以slug當URL沒錯, 那怎還是有中文呢?</p><h3 id=archetypes-初始文章的設定>Archetypes, 初始文章的設定</h3><p>當你用<code>hugo new filename</code>, 他會拿<code>themes/[theme_name]/archetypes/default.md</code>當範本來建立初始文章, 像我原本的設定是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>date</span>: {{ <span style=color:#ae81ff>.Date }}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>title</span>: <span style=color:#e6db74>&#34;{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>images</span>: 
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#34;https://og.jln.co/jlns1/{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title | base64Encode | replaceRE &#34;</span><span style=color:#ae81ff>=+$&#34; &#34;&#34; | replaceRE &#34;\\+&#34; &#34;-&#34; | replaceRE &#34;/&#34; &#34;_&#34;}}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>draft</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>slug是沒設定的, 不過它似乎應該會用title去算slug, 所以在Paramlinks那邊沒啥影響, 但其實你也可以加一行變成:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>date</span>: {{ <span style=color:#ae81ff>.Date }}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>title</span>: <span style=color:#e6db74>&#34;{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>slug</span>: <span style=color:#e6db74>&#34;{{ anchorize .Name | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>images</span>: 
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#34;https://og.jln.co/jlns1/{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title | base64Encode | replaceRE &#34;</span><span style=color:#ae81ff>=+$&#34; &#34;&#34; | replaceRE &#34;\\+&#34; &#34;-&#34; | replaceRE &#34;/&#34; &#34;_&#34;}}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>draft</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>anchorize是可以把"This is a cat"轉成"this-is-a-cat", 其實這兩段效果差不多, 問題在, 不支援中文, 因此像是"這是中文 Chinese", 其實翻成的是"這是中文-chinese", 如果再把這段放到url, unicode url並不是很好看</p><p>找了半天, 並不是很好用, 本來想寫個wrapper script來做新建文章好了, 然後自動加入比較好看的slug, 但轉念一想, 何不直接改Hugo?何不直接改Hugo?何不直接改Hugo? (回音持續)</p><h3 id=支援中文的slug轉換的go-module>支援中文的slug轉換的go module</h3><p>推薦這個<a href=https://github.com/gosimple/slug>github.com/gosimple/slug</a>, 這不只支援中文, 很多語言都有!用法也很簡單:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gosimple/slug&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>someText</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>slug</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#e6db74>&#34;影師&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>someText</span>) <span style=color:#75715e>// Will print: &#34;ying-shi&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>(以上範例來自它github)它很貼心的幫你把中文字轉成拼音了, 這用來做url感覺還蠻適合的呀!</p><h3 id=修改hugo>修改Hugo</h3><p>那我要加在Hugo哪裡呢?前面說到<code>anchorize</code>, 那其實仿效它做一個<code>slugify</code>不就好了, 那也容易知道要改哪, 抄<code>anchorize</code>就對了</p><p>要改的只有兩個檔:</p><ul><li>tpl/urls/init.go</li><li>tpl/urls/urls.go</li></ul><p>在<code>tpl/urls/urls.go</code>加入:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ns</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Namespace</span>) <span style=color:#a6e22e>Slugify</span>(<span style=color:#a6e22e>s</span> <span style=color:#a6e22e>any</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ss</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cast</span>.<span style=color:#a6e22e>ToStringE</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>slug</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>ss</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然後在<code>tpl/urls/init.go</code>的<code>init()</code>內加入:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>ns</span>.<span style=color:#a6e22e>AddMethodMapping</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Slugify</span>,
</span></span><span style=display:flex><span>    []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;slugify&#34;</span>},
</span></span><span style=display:flex><span>    [][<span style=color:#ae81ff>2</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>`</span><span style=color:#75715e>{{</span> <span style=color:#e6db74>&#34;This is a title&#34;</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>slugify</span> <span style=color:#75715e>}}</span><span style=color:#e6db74>`</span>, <span style=color:#e6db74>`this-is-a-title`</span>},
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>重新建置安裝好後, 就可以把<code>Archetypes</code>改成:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>date</span>: {{ <span style=color:#ae81ff>.Date }}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>title</span>: <span style=color:#e6db74>&#34;{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>slug</span>: <span style=color:#e6db74>&#34;{{ slugify .Name | title }}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>images</span>: 
</span></span><span style=display:flex><span>- <span style=color:#e6db74>&#34;https://og.jln.co/jlns1/{{ replace .Name &#34;</span>-<span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>&#34; | title | base64Encode | replaceRE &#34;</span><span style=color:#ae81ff>=+$&#34; &#34;&#34; | replaceRE &#34;\\+&#34; &#34;-&#34; | replaceRE &#34;/&#34; &#34;_&#34;}}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>draft</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><p>搞定! 結果寫這些code五分鐘, 但卻花了五十分鐘找方法呀, 果然Open source還是自己改來用最快</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2022-11-08 00:33:12 +0800 +0800"><a href=/dapr-raw-payload-pub-sub/>Nov 8, 2022</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/dapr-raw-payload-pub-sub/ rel=bookmark title="用Go實作Dapr的rawPayload Subscriber" itemprop=url>用Go實作Dapr的rawPayload Subscriber</a></h1></header><div class=entry-content><p>本來沒預計寫這篇的, 不過後來想想, 本來想寫的篇幅太大, 先寫這篇幫後面內容暖身, 後續相關內容會再更新到下面連結:</p><ol><li><a href=Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka>使用Dapr Input/Output Binding連接Kafka</a></li></ol><p>這篇並不是要寫怎用go實做Dapr的pubsub, 不完全是, 實做pubsub部分請參考<a href=https://docs.dapr.io/developing-applications/building-blocks/pubsub/howto-publish-subscribe/>官方文件</a>, 基本的Dapr的publisher跟subscriber是用所謂CloudEvent的格式在傳遞, 用CloudEvent的好處是, 由於CloudEvent會幫忙夾帶一些metadata, 因此也就可以實現分散式追蹤(Tracing)的功能, 但缺點就是無法支援一些原本寫好的legacy publisher或subscriber, 所幸Dapr的pubsub還是支援raw payload可以讓你自組你的訊息格式</p><p>在開始之前, 為了測試實做, 我這邊採用了Kafka, 但由於Dapr把實做封裝得不錯, 所以其實也不一定要用Kafka, 不過支援了Kraft之後的Kafka, 由於可以去掉對zoo keeper的依賴, 所以算蠻簡單裝的</p><h3 id=安裝kafka>安裝Kafka</h3><p>使用docker跑Kafka, 應該是最簡單的方式, 只要執行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --name kafka-zkless -p 9092:9092 -e LOG_DIR<span style=color:#f92672>=</span>/tmp/logs quay.io/strimzi/kafka:latest-kafka-2.8.1-amd64 /bin/sh -c <span style=color:#e6db74>&#39;export CLUSTER_ID=$(bin/kafka-storage.sh random-uuid) &amp;&amp; bin/kafka-storage.sh format -t $CLUSTER_ID -c config/kraft/server.properties &amp;&amp; bin/kafka-server-start.sh config/kraft/server.properties&#39;</span>
</span></span></code></pre></div><p>這樣Kafka就可以順利活起來了, 完全不需要跑zoo keeper&mldr;喔耶&mldr;</p><p>建議也可以順便跑一下<a href=https://github.com/dushixiang/kafka-map>Kafka map</a>, 這樣待會可以直接發event來測試</p><h3 id=新增kafka-component>新增Kafka component</h3><p>有了Kafka後, 我們需要在Dapr新增這個component 才可以讓Dapr應用程式使用, 在<code>~/.dape/components</code>底下加一個檔案(可叫做kafka.yaml),內容是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>dapr.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Component</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-pubsub</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>pubsub.kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>brokers</span> <span style=color:#75715e># Required. Kafka broker connection setting</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;localhost:9092&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumerGroup</span> <span style=color:#75715e># Optional. Used for input bindings.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;group1&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authType</span> <span style=color:#75715e># Required.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;none&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>disableTls</span> <span style=color:#75715e># Optional. Disable TLS. This is not safe for production!! You should read the `Mutual TLS` section for how to use TLS.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>內容就不多做解釋了, 官方文件會有更清楚的說明, 這邊先說明, 這新增上去後, 我們會多一個pubsub component叫做<code>kafka-pubsub</code>, 這名字寫程式會用到囉</p><h3 id=寫個subscriber來接收事件event吧>寫個subscriber來接收事件(event)吧</h3><p><a href=https://docs.dapr.io/developing-applications/building-blocks/pubsub/pubsub-raw/>官方文件</a>其實有寫如何寫一個接收raw payload的subscriber, 但不像其他文件一樣有多種語言範例, 只有Python, PHP兩種</p><p><img src=/post/images/20221108224329.png alt></p><p>但其實, 如上圖, Dapr用sidecar的作法, 簡化了寫pubsub的複雜度, 而且減低了對語言的依賴, 也不像是Istio是從系統的角度設計, 算是有點有趣的作法, 你不用理解pubsub, 也不用特別知道你是用Kafka, NATS, 或者是RabbitMQ, 寫法都一樣, 不囉嗦, 直接看code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/base64&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Subscription</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PubsubName</span> <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;pubsubname&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span>      <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;topic&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Route</span>      <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;route,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Metadata</span>   <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Event</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;topic&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Data</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;data_base64&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sub</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Subscription</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PubsubName</span>: <span style=color:#e6db74>&#34;kafka-pubsub&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span>:      <span style=color:#e6db74>&#34;myevent&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Route</span>:      <span style=color:#e6db74>&#34;create&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Metadata</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;rawPayload&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/dapr/subscribe&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, []<span style=color:#f92672>*</span><span style=color:#a6e22e>Subscription</span>{<span style=color:#a6e22e>sub</span>})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>POST</span>(<span style=color:#e6db74>&#34;/create&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>event</span> <span style=color:#a6e22e>Event</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Body</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawStdEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Data</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>decoded</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;success&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:6002&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>咦, 這不像是在寫subscriber呀, 倒像是一個web service, 沒錯, 實際上的subscribe的部分被封裝在Dapr內了, Dapr等於收到Event後會打給我們的程式</p><p>那他怎知道要收到哪個queue哪個topic要打到哪個endpoint? 很簡單, 你只要有一個叫做<code>/dapr/subscribe</code>的endpoint, 在開始執行後, Dapr會自行打這endpoint了解你希望幫忙它收哪些event, 這邊我們希望收的 PubsubName (這邊是我們剛剛加的<code>kafka-pubsub</code>), 另外我們希望收<code>myevent</code>這個topic, 然後我們會希望收到event後打<code>/create</code>這個endpoint, 這有個好處, 你換成另一個完全不一樣的方案, 比如說Redis, 是不需要重新改code的</p><p>那我們在<code>/create</code>會收到甚麼呢?基本上就是包裝成CloudEvent的資料結構, 不對, 我們不是要收raw payload嗎?別急, 它只是收到後幫你包裝, 你的raw payload是被base64編碼好好地放在欄位<code>data_base64</code>中</p><p>這邊我特別沒用任何Dapr SDK, 然後也用gin來寫(Dapr的sdk裡用的是Gorilla),主要是為了展示, 這簡單到不用SDK呀(其實sdk也還沒支援raw payload subscriber相關的呀 XD)</p><h3 id=執行>執行</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dapr run --app-id subs --app-port <span style=color:#ae81ff>6002</span> --dapr-http-port <span style=color:#ae81ff>3601</span> --dapr-grpc-port <span style=color:#ae81ff>60001</span> --log-level debug go run main.go
</span></span></code></pre></div><p>指令如上, 可以設定log level把debug訊息打開, 這邊有一點需要注意的, 這浪費我半天的青春, app port一定要設對, 我們程式內用<code>6002</code>那麼這邊的app port就要是<code>6002</code>, 不然Dapr不但會不知道要打事件給你, 連一開始的設定都拿不到(就是打<code>dapr/subscribe</code>)</p><h3 id=測試>測試</h3><p>測試方式很簡單, 如果你剛剛有裝Kafka map, 去那個topic發送一個訊息(按Produce message), 看有沒收到一樣的訊息就可以了</p></div></article><div class=pagination><ul class=inline-list><li><strong class=current-page>1</strong></li><li><a href=/post/page/2/>2</a></li><li><a href=/post/page/3/>3</a></li><li><a href=/post/page/4/>4</a></li><li><a href=/post/page/5/>5</a></li><li><a href=/post/page/6/>6</a></li><li><a href=/post/page/7/>7</a></li><li><a href=/post/page/8/>8</a></li><li><a href=/post/page/9/>9</a></li><li><a href=/post/page/10/>10</a></li><li><a href=/post/page/11/>11</a></li><li><a href=/post/page/12/>12</a></li><li><a href=/post/page/13/>13</a></li><li><a href=/post/page/14/>14</a></li><li><a href=/post/page/15/>15</a></li><li><a href=/post/page/16/>16</a></li><li><a href=/post/page/17/>17</a></li><li><a href=/post/page/18/>18</a></li><li><a href=/post/page/19/>19</a></li><li><a href=/post/page/20/>20</a></li><li><a href=/post/page/21/>21</a></li><li><a href=/post/page/22/>22</a></li><li><a href=/post/page/23/>23</a></li><li><a href=/post/page/24/>24</a></li><li><a href=/post/page/25/>25</a></li><li><a href=/post/page/26/>26</a></li><li><a href=/post/page/27/>27</a></li><li><a href=/post/page/28/>28</a></li><li><a href=/post/page/29/>29</a></li><li><a href=/post/page/30/>30</a></li><li><a href=/post/page/31/>31</a></li><li><a href=/post/page/32/>32</a></li><li><a href=/post/page/33/>33</a></li><li><a href=/post/page/34/>34</a></li><li><a href=/post/page/35/>35</a></li><li><a href=/post/page/36/>36</a></li><li><a href=/post/page/37/>37</a></li><li><a href=/post/page/38/>38</a></li><li><a href=/post/page/39/>39</a></li><li><a href=/post/page/40/>40</a></li><li><a href=/post/page/41/>41</a></li><li><a href=/post/page/42/>42</a></li><li><a href=/post/page/43/>43</a></li><li><a href=/post/page/44/>44</a></li><li><a href=/post/page/45/>45</a></li><li><a href=/post/page/46/>46</a></li><li><a href=/post/page/47/>47</a></li><li><a href=/post/page/48/>48</a></li><li><a href=/post/page/49/>49</a></li><li><a href=/post/page/50/>50</a></li><li><a href=/post/page/51/>51</a></li><li><a href=/post/page/52/>52</a></li><li><a href=/post/page/53/>53</a></li><li><a href=/post/page/54/>54</a></li><li><a href=/post/page/55/>55</a></li><li><a href=/post/page/56/>56</a></li><li><a href=/post/page/57/>57</a></li><li><a href=/post/page/58/>58</a></li><li><a href=/post/page/59/>59</a></li><li><a href=/post/page/60/>60</a></li><li><a href=/post/page/61/>61</a></li><li><a href=/post/page/62/>62</a></li><li><a href=/post/page/63/>63</a></li><li><a href=/post/page/64/>64</a></li><li><a href=/post/page/65/>65</a></li><li><a href=/post/page/66/>66</a></li><li><a href=/post/page/67/>67</a></li><li><a href=/post/page/68/>68</a></li><li><a href=/post/page/69/>69</a></li><li><a href=/post/page/70/>70</a></li><li><a href=/post/page/71/>71</a></li><li><a href=/post/page/72/>72</a></li><li><a href=/post/page/73/>73</a></li><li><a href=/post/page/74/>74</a></li><li><a href=/post/page/75/>75</a></li><li><a href=/post/page/76/>76</a></li><li><a href=/post/page/2/ class=btn>Next</a></li></ul></div></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>