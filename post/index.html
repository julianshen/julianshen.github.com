<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]-->
<head>
<meta charset=utf-8>
<title>Posts &#8211; Le murmure de Julian</title>
<meta name=description content>
<meta property="og:title" content="Posts">
<meta property="og:description" content>
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.jln.co/post/"><meta property="og:image" content="https://blog.jln.co/images/avatar.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.jln.co/images/avatar.png">
<meta name=twitter:title content="Posts">
<meta name=twitter:description content>
<link rel=canonical href=https://blog.jln.co/post/>
<link href=https://blog.jln.co/post/feed.xml rel=alternate type=application/rss+xml title="Le murmure de Julian">
<link href=https://blog.jln.co/post/feed.xml rel=feed type=application/rss+xml title="Le murmure de Julian">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href=/css/main.css>
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css>
<meta http-equiv=cleartype content="on">
<meta name=generator content="Hugo 0.88.1">
<script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png>
</head>
<body id=post-index class=feature>
<nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block>
<button class=dl-trigger>Open Menu</button>
<ul class=dl-menu>
<li><a href=/>Home</a></li>
<li>
<a href=#>About</a>
<ul class=dl-submenu>
<li>
<img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo>
<h4>Julian Shen</h4>
<p>Softward developer</p>
</li>
<li>
<a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a>
</li>
<li>
<a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
</li>
<li>
<a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a>
</li>
<li>
<a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a>
</li>
</ul>
</li>
<li>
<a href=#>Posts</a>
<ul class=dl-submenu>
<li><a href=/post/>All Posts</a></li>
<li><a href=/tags/>All Tags</a></li>
</ul>
</li>
<li><a href=/></a></li>
</ul>
</nav>
<div class=entry-header>
<div class=image-credit>Image credit: <a href=http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/>dargadgetz</a></div>
<div class=entry-image>
<img src=/abstract-2.jpg alt=Posts>
</div>
<div class=header-title>
<div class=header-title-wrap>
<h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1>
<h2>
All posts
</h2>
</div>
</div>
</div>
<div id=main role=main>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-09-17 14:21:09 +0800 +0800"><a href=/%E4%B8%8D%E5%AF%ABDockerfile%E5%BB%BA%E7%AB%8Bdocker-Image/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~1 minute
</span>
</div>
<h1 class=entry-title><a href=/%E4%B8%8D%E5%AF%ABDockerfile%E5%BB%BA%E7%AB%8Bdocker-Image/ rel=bookmark title="不寫Dockerfile建立docker Image" itemprop=url>不寫Dockerfile建立docker Image</a></h1>
</header>
<div class=entry-content>
<p>人都是懶的, 尤其如果拿同樣的工具, 開發不同的service, 又要部屬到cloud native環境, 免不了要一直重複寫類似的Dockerfile來建立docker image, 有沒懶方法?</p>
<p>有, 就是<a href=https://buildpacks.io/>Cloud native buildpacks</a>, 有用過<a href=https://www.heroku.com/>Heroku</a>的應該會有點耳熟, 對, 就是那個buildpacks, 只是把它變成一個標準</p>
<p>首先, 你需要的是<a href=https://buildpacks.io/docs/tools/pack/>pack</a>這工具, 在mac底下可以用 brew安裝</p>
<pre tabindex=0><code>brew install buildpacks/tap/pack
</code></pre><p>Windows下可以用scoop</p>
<pre tabindex=0><code>scoop install pack
</code></pre><p>安裝好後, 可以執行:</p>
<pre tabindex=0><code>pack builder suggest
</code></pre><p>來看看有甚麼buildpacks 可以用</p>
<pre tabindex=0><code>Suggested builders:
    Google:                gcr.io/buildpacks/builder:v1      Ubuntu 18 base image with buildpacks for .NET, Go, Java, Node.js, and Python
    Heroku:                heroku/buildpacks:18              Base builder for Heroku-18 stack, based on ubuntu:18.04 base image
    Heroku:                heroku/buildpacks:20              Base builder for Heroku-20 stack, based on ubuntu:20.04 base image
    Paketo Buildpacks:     paketobuildpacks/builder:base     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, Python, Ruby, NGINX and Procfile
    Paketo Buildpacks:     paketobuildpacks/builder:full     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, Python, PHP, Ruby, Apache HTTPD, NGINX and Procfile
    Paketo Buildpacks:     paketobuildpacks/builder:tiny     Tiny base image (bionic build image, distroless-like run image) with buildpacks for Java Native Image and Go
</code></pre><p>看你使用的開發語言或框架, 選擇適合的buildpack, 比如說像是node.js或是go, 只要簡單的在你的project底下執行:</p>
<pre tabindex=0><code>pack build image_name --builder gcr.io/buildpacks/builder:v1
</code></pre><p>就可以建立出一個名為<code>image_name</code>的docker image了, 而且建置過程都是自動偵測</p>
<p>不過當然沒辦法適用所有的狀況, 如果你有不同的語言不同的需求, 其實也可以自建buildpack喔</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-09-17 12:20:38 +0800 +0800"><a href=/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~6 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/ rel=bookmark title=用D3js建立台股板塊圖 itemprop=url>用D3js建立台股板塊圖</a></h1>
</header>
<div class=entry-content>
<p>這題目瑣碎的東西太多了, 所以這篇打算只是做個紀錄, 做這東西原因是看到<a href="https://finviz.com/map.ashx?t=sec_all">Finviz</a>這個板塊圖覺得還蠻有趣的, 想說該怎去做到這樣的圖表</p>
<p><img src=/images/posts/2021-09-17-12-25-23.png alt=stockmap></p>
<p>一眼就可以大略看市場的狀況, 感覺還蠻酷的, 查了一下, 這東西叫<a href=https://en.wikipedia.org/wiki/Treemapping>Treemapping</a>, 想到資料視覺化, 我是先想到<a href=https://d3js.org/>D3.js</a>, 雖然說<a href=https://www.highcharts.com/>Highcharts</a>也可以達到一樣的目的, 不過<a href=https://d3js.org/>D3.js</a>使用上跟jQuery類似, 比較簡單, 所以選擇它來實現</p>
<p>先給結果<a href=https://fviz.jln.co/marketmap>https://fviz.jln.co/marketmap</a></p>
<p><img src=/images/posts/2021-09-17-12-45-59.png alt=f></p>
<p>這邊使用到的東西有:</p>
<ul>
<li>D3.js</li>
<li>Next.js (deploy to GitHub page)</li>
</ul>
<p>純粹靜態網頁, 沒資料庫, 不過目前資料只抓到2021/09/14, 定期抓資料的部分還懶得弄</p>
<h2 id=資料來源>資料來源</h2>
<p>這邊所需要的資料有幾個:</p>
<ul>
<li>上市股票的收盤資訊</li>
<li>上櫃股票的收盤資訊</li>
<li>各股所屬的分類資訊</li>
</ul>
<p>雖然都是容易爬的到的資料, 但兩個市場資料格式不是那麼的統一</p>
<p>抓取集中市場的歷史資料用這個 URL : &ldquo;<a href="https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date=%25s&type=ALL&_=%25s%22">https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date=%s&type=ALL&_=%s"</a> , date的格式用"20060102"這樣, &ldquo;_&ldquo;可以用timestamp即可, 我要的當然是json, 會比csv來的好處理點</p>
<p>個股的交易資訊在<code>data9</code>這個欄位, 欄位定義是<code>fields9</code>, 所以用<code>jq</code>來看一下</p>
<pre tabindex=0><code>curl &quot;https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&amp;date=20210910&amp;type=ALL&amp;_=1631369120214&quot; | jq &quot;.fields9&quot;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 3122k    0 3122k    0     0  1526k      0 --:--:--  0:00:02 --:--:-- 1526k
[
  &quot;證券代號&quot;,
  &quot;證券名稱&quot;,
  &quot;成交股數&quot;,
  &quot;成交筆數&quot;,
  &quot;成交金額&quot;,
  &quot;開盤價&quot;,
  &quot;最高價&quot;,
  &quot;最低價&quot;,
  &quot;收盤價&quot;,
  &quot;漲跌(+/-)&quot;,
  &quot;漲跌價差&quot;,
  &quot;最後揭示買價&quot;,
  &quot;最後揭示買量&quot;,
  &quot;最後揭示賣價&quot;,
  &quot;最後揭示賣量&quot;,
  &quot;本益比&quot;
]
</code></pre><p>來看一下<code>.data9</code>內的單筆資料, 基本上就是都放到array去, 算好處理</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
    <span style=color:#e6db74>&#34;9944&#34;</span>,
    <span style=color:#e6db74>&#34;新麗&#34;</span>,
    <span style=color:#e6db74>&#34;92,813&#34;</span>,
    <span style=color:#e6db74>&#34;53&#34;</span>,
    <span style=color:#e6db74>&#34;1,950,673&#34;</span>,
    <span style=color:#e6db74>&#34;21.05&#34;</span>,
    <span style=color:#e6db74>&#34;21.10&#34;</span>,
    <span style=color:#e6db74>&#34;20.85&#34;</span>,
    <span style=color:#e6db74>&#34;21.10&#34;</span>,
    <span style=color:#e6db74>&#34;&lt;p style= color:red&gt;+&lt;/p&gt;&#34;</span>,
    <span style=color:#e6db74>&#34;0.10&#34;</span>,
    <span style=color:#e6db74>&#34;20.75&#34;</span>,
    <span style=color:#e6db74>&#34;2&#34;</span>,
    <span style=color:#e6db74>&#34;21.15&#34;</span>,
    <span style=color:#e6db74>&#34;3&#34;</span>,
    <span style=color:#e6db74>&#34;23.19&#34;</span>
  ]
</code></pre></div><p>這邊"漲跌(+/-)&ldquo;的部分, 其實不是只有+和-, 而居然是html tags, 包含四種狀況, +/-/ /X, +/-很好懂, 就是漲跟跌, 空白就是平盤了, X的狀況通常發生在除權息, 增減資這類狀況</p>
<p>那櫃檯市場呢? URL是這個<code>https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&d=110/09/01&_=1631603049</code>, 日期格式跟集中市場不同, 是用&rdquo;/&ldquo;隔開, 並且是民國紀年, 這邊資料也是array放在<code>aaData</code>這欄位</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[<span style=color:#e6db74>&#34;9960&#34;</span>,<span style=color:#e6db74>&#34;\u9081\u9054\u5eb7&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;+0.35&#34;</span>,<span style=color:#e6db74>&#34;27.00&#34;</span>,<span style=color:#e6db74>&#34;27.25&#34;</span>,<span style=color:#e6db74>&#34;26.85&#34;</span>,<span style=color:#e6db74>&#34;27.06&#34;</span>,<span style=color:#e6db74>&#34;56,004&#34;</span>,<span style=color:#e6db74>&#34;1,515,312&#34;</span>,<span style=color:#e6db74>&#34;37&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;27.15&#34;</span>,<span style=color:#e6db74>&#34;5&#34;</span>,<span style=color:#e6db74>&#34;33,592,500&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;29.80&#34;</span>,<span style=color:#e6db74>&#34;24.40&#34;</span>]
</code></pre></div><p>那個股基本資料呢?這邊就神奇了, 居然有Open API document: <a href=https://openapi.twse.com.tw/v1/swagger.json>https://openapi.twse.com.tw/v1/swagger.json</a>, 可以用&rdquo;/v1/opendata/t187ap03_L"取得基本資料, 這邊雖然也有API可以取得當日交易資訊, 但只有當日並無歷史資料</p>
<p>上櫃股票的資料也有一樣的東西, 在 <a href=https://www.tpex.org.tw/openapi/swagger.json>https://www.tpex.org.tw/openapi/swagger.json</a></p>
<p>抓到的分類類別是代號, 所以要對應到正確的類別名稱可以用這表:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Categories</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
	<span style=color:#e6db74>&#34;01&#34;</span>: <span style=color:#e6db74>&#34;水泥&#34;</span>,
	<span style=color:#e6db74>&#34;02&#34;</span>: <span style=color:#e6db74>&#34;食品&#34;</span>,
	<span style=color:#e6db74>&#34;03&#34;</span>: <span style=color:#e6db74>&#34;塑膠&#34;</span>,
	<span style=color:#e6db74>&#34;04&#34;</span>: <span style=color:#e6db74>&#34;紡織纖維&#34;</span>,
	<span style=color:#e6db74>&#34;05&#34;</span>: <span style=color:#e6db74>&#34;電機機械&#34;</span>,
	<span style=color:#e6db74>&#34;06&#34;</span>: <span style=color:#e6db74>&#34;電器電纜&#34;</span>,
	<span style=color:#e6db74>&#34;21&#34;</span>: <span style=color:#e6db74>&#34;化工&#34;</span>,
	<span style=color:#e6db74>&#34;22&#34;</span>: <span style=color:#e6db74>&#34;生技&#34;</span>,
	<span style=color:#e6db74>&#34;08&#34;</span>: <span style=color:#e6db74>&#34;玻璃陶瓷&#34;</span>,
	<span style=color:#e6db74>&#34;09&#34;</span>: <span style=color:#e6db74>&#34;造紙&#34;</span>,
	<span style=color:#e6db74>&#34;10&#34;</span>: <span style=color:#e6db74>&#34;鋼鐵&#34;</span>,
	<span style=color:#e6db74>&#34;11&#34;</span>: <span style=color:#e6db74>&#34;橡膠&#34;</span>,
	<span style=color:#e6db74>&#34;12&#34;</span>: <span style=color:#e6db74>&#34;汽車&#34;</span>,
	<span style=color:#e6db74>&#34;24&#34;</span>: <span style=color:#e6db74>&#34;半導體&#34;</span>,
	<span style=color:#e6db74>&#34;25&#34;</span>: <span style=color:#e6db74>&#34;電腦及週邊&#34;</span>,
	<span style=color:#e6db74>&#34;26&#34;</span>: <span style=color:#e6db74>&#34;光電&#34;</span>,
	<span style=color:#e6db74>&#34;27&#34;</span>: <span style=color:#e6db74>&#34;通信網路&#34;</span>,
	<span style=color:#e6db74>&#34;28&#34;</span>: <span style=color:#e6db74>&#34;電子零組件&#34;</span>,
	<span style=color:#e6db74>&#34;29&#34;</span>: <span style=color:#e6db74>&#34;電子通路&#34;</span>,
	<span style=color:#e6db74>&#34;30&#34;</span>: <span style=color:#e6db74>&#34;資訊服務&#34;</span>,
	<span style=color:#e6db74>&#34;31&#34;</span>: <span style=color:#e6db74>&#34;其他電子&#34;</span>,
	<span style=color:#e6db74>&#34;14&#34;</span>: <span style=color:#e6db74>&#34;建材營造&#34;</span>,
	<span style=color:#e6db74>&#34;15&#34;</span>: <span style=color:#e6db74>&#34;航運&#34;</span>,
	<span style=color:#e6db74>&#34;16&#34;</span>: <span style=color:#e6db74>&#34;觀光&#34;</span>,
	<span style=color:#e6db74>&#34;17&#34;</span>: <span style=color:#e6db74>&#34;金融保險&#34;</span>,
	<span style=color:#e6db74>&#34;18&#34;</span>: <span style=color:#e6db74>&#34;貿易百貨&#34;</span>,
	<span style=color:#e6db74>&#34;23&#34;</span>: <span style=color:#e6db74>&#34;油電燃氣&#34;</span>,
	<span style=color:#e6db74>&#34;19&#34;</span>: <span style=color:#e6db74>&#34;綜合&#34;</span>,
	<span style=color:#e6db74>&#34;20&#34;</span>: <span style=color:#e6db74>&#34;其他&#34;</span>,
	<span style=color:#e6db74>&#34;32&#34;</span>: <span style=color:#e6db74>&#34;文創&#34;</span>,
	<span style=color:#e6db74>&#34;33&#34;</span>: <span style=color:#e6db74>&#34;農業科技&#34;</span>,
	<span style=color:#e6db74>&#34;34&#34;</span>: <span style=color:#e6db74>&#34;電商&#34;</span>,
	<span style=color:#e6db74>&#34;80&#34;</span>: <span style=color:#e6db74>&#34;管理股票&#34;</span>,
	<span style=color:#e6db74>&#34;91&#34;</span>: <span style=color:#e6db74>&#34;存託憑證&#34;</span>,
}
</code></pre></div><p>把以上資料, 整合起來, 我需要的是這樣的資料:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;台股版塊&#34;</span>,
    <span style=color:#f92672>&#34;children&#34;</span>: [{
        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;集中市場&#34;</span>,
        <span style=color:#f92672>&#34;children&#34;</span>: [{
            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;水泥&#34;</span>,
            <span style=color:#f92672>&#34;children&#34;</span>: [{
                <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
                <span style=color:#f92672>&#34;data&#34;</span>: {
                    <span style=color:#f92672>&#34;Code&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
                    <span style=color:#f92672>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;台泥&#34;</span>,
                    <span style=color:#f92672>&#34;TradeVolume&#34;</span>: <span style=color:#e6db74>&#34;14853294&#34;</span>,
                    <span style=color:#f92672>&#34;Transaction&#34;</span>: <span style=color:#e6db74>&#34;6367&#34;</span>,
                    <span style=color:#f92672>&#34;TradeValue&#34;</span>: <span style=color:#e6db74>&#34;715327703&#34;</span>,
                    <span style=color:#f92672>&#34;OpeningPrice&#34;</span>: <span style=color:#e6db74>&#34;48.35&#34;</span>,
                    <span style=color:#f92672>&#34;HighestPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
                    <span style=color:#f92672>&#34;LowestPrice&#34;</span>: <span style=color:#e6db74>&#34;47.85&#34;</span>,
                    <span style=color:#f92672>&#34;ClosingPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
                    <span style=color:#f92672>&#34;Change&#34;</span>: <span style=color:#e6db74>&#34;-0.05&#34;</span>,
                    <span style=color:#f92672>&#34;Time&#34;</span>: <span style=color:#e6db74>&#34;2021-09-01T00:00:00+08:00&#34;</span>
                }
            }]
        }]
    }]
}
</code></pre></div><p>顧名思義, Treemap就是一個樹狀的結構而來的, 因此需要的資料結構就需要有個階層, 這邊設計成 &ldquo;台股板塊->市場別->分類->個股&rdquo;</p>
<h2 id=d3js--react-js>D3.js + React JS</h2>
<p>因為我用Next.js, 就想要把這個treemap包裝在一個react component</p>
<p>使用D3.js要先引入這幾個packages (我用typescript開發):</p>
<ul>
<li>@types/d3</li>
<li>@types/d3-hierarchy</li>
<li>d3</li>
<li>d3-hierarchy</li>
</ul>
<p><code>d3-hierarchy</code>是用來畫treemap的, 只用d3基本功能是不需要含進來的</p>
<p>先給這個Treemap的component一個殼:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Treemap</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>width</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>height</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>date</span>:<span style=color:#66d9ef>Date</span> }) <span style=color:#f92672>=&gt;</span> {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svgRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#66d9ef>null</span>);
    
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dataFile</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getFullYear</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> 
      <span style=color:#f92672>+</span> (<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getMonth</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) 
      <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getDate</span>().<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.json&#34;</span>;

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>renderTreemap</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>select</span>(<span style=color:#a6e22e>svgRef</span>.<span style=color:#a6e22e>current</span>).<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;font&#34;</span>, <span style=color:#e6db74>&#34;10px sans-serif&#34;</span>);
        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>width</span>).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>height</span>);
        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;*&#34;</span>).<span style=color:#a6e22e>remove</span>();
        
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stockData</span>:<span style=color:#66d9ef>StockData</span>

        <span style=color:#66d9ef>try</span> {
            <span style=color:#a6e22e>stockData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>dataFile</span>) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>StockData</span>;
        } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>e</span>) {
            <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;text&#34;</span>)
                .<span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#34;本日無資料, 請按左上角按鈕選取時間&#34;</span>)
                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;x&#34;</span>, <span style=color:#ae81ff>6</span>)
                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#ae81ff>22</span>)
                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;white&#34;</span>);
            <span style=color:#66d9ef>return</span>;
        }
    };

    <span style=color:#a6e22e>useEffect</span>(() <span style=color:#f92672>=&gt;</span> {
        <span style=color:#a6e22e>renderTreemap</span>();
    });
    
    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>Box</span>&gt;
            &lt;<span style=color:#f92672>svg</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>svgRef</span>} /&gt;
        &lt;/<span style=color:#f92672>Box</span>&gt;
      );
}

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Treemap</span>
</code></pre></div><p>d3的用法跟jQuery類似, 因此這邊跟React包裝一起的方法也很簡單, 就是用<code>useRef</code>給它有個reference可以select, 這邊要畫圖, 所以就包到一個svg去, 實際render出來的也是svg</p>
<p>抓取資料可以用<code>d3.json(dataFile)</code>, 其實也有<code>d3.csv</code>, 有點類似用<code>fetch</code></p>
<p>Treemap的實做就稍微有點複雜了, 可以參考這邊 &ldquo;<a href=https://observablehq.com/@d3/nested-treemap>Nested Treemap</a>&rdquo;, 這篇也不錯: &ldquo;<a href=http://blog.infographics.tw/2015/10/d3js-tutorial-treemap-and-budget/>D3.js 實戰 － 利用 Treemap Layout 將政府預算視覺化</a>&rdquo;, 這邊我使用了交易量跟交易總額去做面積跟排序</p>
<h2 id=加上tooltip>加上Tooltip</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
    .<span style=color:#a6e22e>data</span>(<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>leaves</span>())
    .<span style=color:#a6e22e>enter</span>()
    .<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;y&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; })
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { 
            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>h</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; 
            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>;
        })
    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;black&#34;</span>)
    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;fill&#34;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>ccolor</span>(<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>data</span>))
    .<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseover&#39;</span>, (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>)<span style=color:#f92672>=&gt;</span>{
        <span style=color:#a6e22e>mouseOver</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>);
    }).<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseleave&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
        <span style=color:#a6e22e>tooltip</span>().<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;opacity&#34;</span>, <span style=color:#ae81ff>0</span>);
    });
</code></pre></div><p>透過<code>on('mouseover')</code>和<code>on('mouseleave')</code>就可以來加上tooltip的效果</p>
<h2 id=發佈到github-pages>發佈到Github pages</h2>
<p>next.js由於ssg, ssr的關係, 需要跑個server, 但其實也有機會發布成全靜態網頁(只要沒需要有在server跑的部分), 步驟如下:</p>
<ul>
<li>next build</li>
<li>next export</li>
</ul>
<p>結果就會在<code>out/</code>目錄, 拿這個目錄的內容放github pages就可以了</p>
<p>最後附上寫這東西時來搗亂的傢伙</p>
<p><img src=/images/posts/2021-09-17-13-43-04.png alt></p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-09-01 14:13:25 +0800 +0800"><a href=/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/>Sep 1, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~8 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/ rel=bookmark title="在 Next.js 實作 Feature Toggles" itemprop=url>在 Next.js 實作 Feature Toggles</a></h1>
</header>
<div class=entry-content>
<p>之前一直有在思考, 如果把 Feature toggles或Feature flags帶入開發流程可以有甚麼幫助, 先撇開A/B Test不談(因為這還是要配合產品策略考量), 在一個開發Sprint週期時間越來越短下, 一個feature的完成通常也需要跨越多個sprints, 如果加上某些可能需要配合event時間推出的功能, 這對release也是會帶來一些挑戰, 理想化的狀況就是最新的程式碼一直都在, 測試沒問題後開個開關就可以打開, 甚或搭配一些技巧可以讓QA也能夠在生產環境驗證還沒release的功能</p>
<p>需要feature toggles的場合, 可能前後端都會有機會, 不過, 我想了一下, 後端還是可以從API版本或是其他方法隱藏未釋出功能, 而從前端一次隱藏整個功能區塊或是整個頁面, 或許是一個比較好開始切入的部分</p>
<p>先來介紹一下Feature toggle好了</p>
<h2 id=feature-toggles>Feature Toggles</h2>
<p>Feature Toggles (又名Feature Flags)是一個應該算是常見的軟體開發方式, 藉由開關旗標(flag)來開啟或隱藏程式中的功能, 土法一點, 你是可以自訂一個布林變數, 在release之前去打開或關閉它(true or false), 當然這樣彈性比較小, 理想上當然會希望可以彈性隨時開關</p>
<p>根據Martin Fowler這篇<a href=https://martinfowler.com/bliki/FeatureToggle.html>FeatureToggle</a>以及Pete Hodgson先生寫的這篇: <a href=https://www.martinfowler.com/articles/feature-toggles.html>Feature Toggles (aka Feature Flags)</a>, Feature toggles根據用途可以分做不同種類(後面那篇介紹比較詳細):</p>
<ol>
<li>Release Toggles: 這就如同前面講的, 開關或隱藏程式中功能, 或許是還未完成之功能, 可以搭配 trunk-based development服用, 通常Release toggles的變動頻率應該要是相當小的, 也可能等功能穩定後就會被拿掉</li>
<li>Experiment Toggles: 用在做A/B Test實驗, 會需要經過一些條件判斷來做啟用或禁用, 通常會根據request的資訊有變動</li>
<li>Ops Toggles: 用在跟系統運維相關, 比如說系統問題臨時需要下架, 需要上公告頁面, 或是像這種狀況需要下架某些功能(一個想法: 或許可以搭配系統監控使用)</li>
<li>Permission Toggles: 用在限定特定使用者可以使用, 或許直覺會想到是針對有權限控制的功能, 不過其實還可以用在Campaign/Event相關功能, 如果需要提早內部做dog fooding, 或許就可以考量beta user whitelist的作法, 搭配Permission Toggles</li>
</ol>
<p>類別只是一種定義而已, 真正使用狀況或許會更複雜搭配, 也可能需要考慮flags之間的相依性跟連動關係, 不過這篇並不是要討論這部分, 這篇會以簡單的實現Release toggle來先做探討</p>
<p>關於feature toggles資源跟相關探討也可參考 <a href=https://featureflags.io/>The Hub for Feature Flag Driven Development</a></p>
<h2 id=feature-toggles的解決方案>Feature toggles的解決方案</h2>
<p>有人提出方法, 就會有人提出解決方案和產品, Feature toggles相關的產品其實非常多, 商業產品有:</p>
<ol>
<li><a href=https://launchdarkly.com/about-us/>LaunchDarkly</a></li>
<li><a href=https://www.getunleash.io/plans>Unleash</a></li>
<li><a href=https://happykit.dev/>HappyKit</a></li>
</ol>
<p>另外也可以找到不少Open source的</p>
<ol>
<li><a href=https://www.togglz.org/>Togglez</a> (Java)</li>
<li><a href=https://ff4j.github.io>FF4J</a> (Java)</li>
<li><a href="https://twitter.github.io/finagle/guide/Configuration.html#:~:text=Feature%20toggles%20are%20a%20commonly%20used%20mechanism%20for,rollout%20functionality%20in%20a%20measured%20and%20controlled%20manner.">Finagle</a> (Finagle有內建, 不過不好用)</li>
<li><a href=https://github.com/AntoineAugusti/feature-flags>Feature Flags API for Go </a> (Go)</li>
</ol>
<p>你可以從<a href=https://featureflags.io/>The Hub for Feature Flag Driven Development</a>找到一大堆</p>
<p>但這些絕大部分作法是把feature toggles的設定集中管理, 不管是放在資料庫, 或是有一個server來提供(後面也是放資料庫)</p>
<p>個人是覺得, Feature toggles並不是主角, 而是跑龍套的, 應該盡可能的輕量化, 做成獨立系統有點多了, 在Cloud native (k8s native)時代, 考慮用檔案來存設定(搭配ConfigMap), 加上lib, 應該是相對輕量的作法</p>
<p>因此針對這想法, 我在Next.js上做了幾個做法來驗證, 這邊把我的作法跟碰到的狀況做一個紀錄</p>
<h2 id=基本設計>基本設計</h2>
<p>首先, 我先想了一下, 我在Next.js上要怎使用Feature toggles比較合適, 搭配tag應該是最為易讀的方式, 像是</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript>&lt;<span style=color:#f92672>div</span>&gt;
    &lt;<span style=color:#f92672>WithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature1&#34;</span>&gt;
        &lt;<span style=color:#f92672>div</span>&gt;<span style=color:#a6e22e>This</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>feature</span>&lt;/<span style=color:#f92672>div</span>&gt;
    &lt;/<span style=color:#f92672>WithFeature</span>&gt;
    &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
&lt;/<span style=color:#f92672>div</span>&gt;
</code></pre></div><p>用一個區塊包藏住需要開關的部分, 再由讀取到的設定做為開關</p>
<p>另一個想到的方式是:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript>&lt;<span style=color:#f92672>PageWithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature3&#34;</span>&gt;
    &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
&lt;/<span style=color:#f92672>PageWithFeature</span>&gt;
</code></pre></div><p>這種跟前一種的不同是, 如果功能未打開, 區塊就不會顯示, 但整頁的其他部分還會顯示, 但第二種應用在, 整頁都是新功能, 不想因為提早被發現URL而露出, 所以功能未打開的情況需要顯示404</p>
<p>另外config的設計希望是一個yaml檔案給程式去讀取, 像這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>features</span>:
  <span style=color:#f92672>feature1</span>: <span style=color:#66d9ef>false</span>
  <span style=color:#f92672>feature2</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>feature3</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>offline</span>: <span style=color:#66d9ef>false</span>
</code></pre></div><h2 id=使用custom-app跟react-context來做一個通用設計>使用Custom App跟React context來做一個通用設計</h2>
<p>為何說是通用設計? 這邊是希望每個需要用到toggle的頁面不用自已寫載入設定的部分(後面會講個範例是有需要的), 而是只要直接用 <code>&lt;WithFeature feature="feature1"></code> 就好</p>
<p>Next.js有支援<a href=https://nextjs.org/docs/advanced-features/custom-app>&ldquo;Custom <code>App</code>"</a>, 所以我們載入config的部分可以直接放在&rdquo;<code>_app.tsx</code>" 或 &ldquo;<code>_app.jsx</code>&ldquo;內就可以讓所有頁面共用(詳細請參考文件)載入部分的程式碼, 另外還得搭配<a href=https://reactjs.org/docs/context.html>React context</a>才能順利的把設定下傳到component</p>
<p>首先, 我們需要先來設計一個<code>Context</code>用來傳遞設定給<code>WithFeature</code>的元件(Component)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createContext</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeatureMap</span> <span style=color:#f92672>=</span> {
    [<span style=color:#a6e22e>key</span>:<span style=color:#66d9ef>string</span>]<span style=color:#f92672>:</span><span style=color:#66d9ef>boolean</span>
}

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FeatureContext</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createContext</span>({<span style=color:#a6e22e>features</span><span style=color:#f92672>:</span> {} <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>FeatureMap</span>})
</code></pre></div><p>這邊設計很單純, 假設每個feature都是true或false的開關, 前面的config yaml也是這樣的</p>
<p>在<code>_app.tsx</code>我們則需要有這東西:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../context/featurecontext&#39;</span>
<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>MyApp</span>({ <span style=color:#a6e22e>Component</span>, <span style=color:#a6e22e>pageProps</span> }<span style=color:#f92672>:</span> <span style=color:#a6e22e>AppProps</span>) {  
  <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>FeatureContext.Provider</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>features</span>:<span style=color:#66d9ef>pageProps.features</span>}}&gt;&lt;<span style=color:#f92672>Component</span> {<span style=color:#a6e22e>...pageProps</span>}/&gt;&lt;/<span style=color:#f92672>FeatureContext.Provider</span>&gt;
}
</code></pre></div><p>這邊是把pageProps裡的features給帶到<code>FeatureContext</code>以讓後面的可以讀到, 那pageProps是又哪裡來的? 這邊我們就得去實作<code>app.getInitialProps</code>了, 這個在每個page初始化都會呼叫到它, 並把它產生的pageProps給餵到前面那個function</p>
<p>那是不是就可以把下面這段直接放到<code>getInitialProps</code>就可以取得feature flags的設定了呢?</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
</code></pre></div><p>答案是"不行!!&rdquo;, 為何? 因為在Next.js的設計上:</p>
<ol>
<li><code>getInitialProps</code>是會有可能在client(瀏覽器), server跑</li>
<li>除非你頁面實作上有<code>getServerSideProps</code>, <code>getInitialProps</code>才會總是在server端跑</li>
<li>只有<code>getServerSideProps</code>,<code>getStaticProps</code>才可使用server端(node.js)API, 例如讀檔 (還有一個則是API, 但API實做不同, 我不規在此類)</li>
<li><code>getServerSideProps</code>只設計給頁面的實作使用, 所以每頁有自己的 <code>getServerSideProps</code>, 但 App沒<code>getServerSideProps</code></li>
</ol>
<p>因為client跟server都會有機會呼叫到, 如果要讓它們能夠共用, 那就只有做一個API給它, 我們在<code>page/api</code>目錄底下開一個<code>features.tsx</code>的檔案, 內容是</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>NextApiResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>YAML</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;yaml&#39;</span>

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Features</span> <span style=color:#f92672>=</span> {
    [<span style=color:#a6e22e>key</span>:<span style=color:#66d9ef>string</span>]<span style=color:#f92672>:</span><span style=color:#66d9ef>boolean</span>
}

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handler</span>(
    <span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextApiRequest</span>,
    <span style=color:#a6e22e>res</span>: <span style=color:#66d9ef>NextApiResponse</span>&lt;<span style=color:#f92672>Features</span>&gt;
  ) {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
    
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>features</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>Features</span>)
  }
</code></pre></div><p>那我們<code>getInitialProps</code>就可以這樣寫:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#a6e22e>MyApp</span>.<span style=color:#a6e22e>getInitialProps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>appContext</span>: <span style=color:#66d9ef>AppContext</span>) <span style=color:#f92672>=&gt;</span> {
   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>appProps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>App</span>.<span style=color:#a6e22e>getInitialProps</span>(<span style=color:#a6e22e>appContext</span>)
   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>appContext</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>req</span>
   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>
    <span style=color:#f92672>?</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#34;x-forwarded-host&#34;</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#34;host&#34;</span>]
    <span style=color:#f92672>:</span> window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>host</span>;
   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>`http://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>host</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/api/features`</span>)
   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>features</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>json</span>()
   <span style=color:#a6e22e>appProps</span>.<span style=color:#a6e22e>pageProps</span>[<span style=color:#e6db74>&#39;features&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>features</span>
   <span style=color:#66d9ef>return</span> { ...<span style=color:#a6e22e>appProps</span> }
 }
</code></pre></div><p>這邊有一點需要注意的, 雖然用<code>fetch</code>, 但它client端, server端用的是不一樣的, 雖然是長一樣的API, 所以這邊的URL是不可以用相對路徑的("<code>/api/features</code>"), 原因就是在server端只有相對路徑是無法知道實際要呼叫哪裡, 所以這邊還是組出一個完整的URL來使用(不過這實做有點不是很好, 需要改, 當PoC就算了 :p)</p>
<p>所以<code>WithFeature</code>就可以長這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ReactNode</span>, <span style=color:#a6e22e>useContext</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>
<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../context/featurecontext&#34;</span>

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeaturesProps</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>children?</span>:<span style=color:#66d9ef>ReactNode</span>
    <span style=color:#a6e22e>feature?</span>: <span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>WithFeature</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>FeaturesProps</span>) {
    <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>features</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>useContext</span>(<span style=color:#a6e22e>FeatureContext</span>)

    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>features</span>[<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span>]) {
        <span style=color:#66d9ef>return</span> (
            &lt;&gt;{<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>children</span>}&lt;/&gt;)   
    }
    <span style=color:#66d9ef>return</span> &lt;&gt;&lt;/&gt;
}

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>WithFeature</span>
</code></pre></div><p>因為<code>features</code>是放在<code>FeatureContext</code>中, 所以我們可以透過<code>useContext</code>來取值</p>
<p>這作法不算難, 而且也蠻好運用, 只要在每個需要的頁面自行運用<code>WithFeature</code>即可, 但缺點是甚麼? 基本上它算是CSR(Client side rendering), 而且要甚麼flag都是透過API跟server要, 會被看的一清二楚外, 或許可能還有方法偽造以至於你的功能提早被發現</p>
<h2 id=ssr-server-side-rendering的作法>SSR (Server Side Rendering)的作法</h2>
<p>Next.js強大的地方就是它有<a href=https://nextjs.org/docs/basic-features/data-fetching>支援SSR(Sever side rendering)和SSG(Server side generation)</a>, 兩者的好處就是在server端就把頁面內容給產生好</p>
<p>假設我們有一頁叫做<code>Post3</code>, 實作是這樣的:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextPage</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>;
<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>GetServerSideProps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Link</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/link&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>YAML</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;yaml&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>WithFeature</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../components/feature2&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PageWithFeature</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../components/feature3&#34;</span>;

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Params</span> <span style=color:#f92672>=</span> {}
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Props</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>features</span>: <span style=color:#66d9ef>any</span>
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Post3</span>:<span style=color:#66d9ef>NextPage</span>&lt;<span style=color:#f92672>Props</span>&gt; <span style=color:#f92672>=</span> (<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>Props</span>) <span style=color:#f92672>=&gt;</span> {
    <span style=color:#66d9ef>return</span> (
        &lt;<span style=color:#f92672>FeatureContext.Provider</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>features</span>:<span style=color:#66d9ef>props.features</span>}}&gt;
            &lt;<span style=color:#f92672>PageWithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature3&#34;</span>&gt;
                &lt;<span style=color:#f92672>WithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature4&#34;</span>&gt;
                    <span style=color:#66d9ef>this</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>feature</span> <span style=color:#ae81ff>3</span>
                &lt;/<span style=color:#f92672>WithFeature</span>&gt;                
                &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
            &lt;/<span style=color:#f92672>PageWithFeature</span>&gt;
        &lt;/<span style=color:#f92672>FeatureContext.Provider</span>&gt;
    )
}

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Post3</span>

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getServerSideProps</span>:<span style=color:#66d9ef>GetServerSideProps</span>&lt;<span style=color:#f92672>Props</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>Params</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>ctx</span>) <span style=color:#f92672>=&gt;</span>{
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())

    <span style=color:#66d9ef>return</span> {
        <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> {
            <span style=color:#a6e22e>features</span>: <span style=color:#66d9ef>config.features</span>
        }
    }
}
</code></pre></div><p>這頁面可以透過<code>/post3</code>來存取它, 這個頁面由於實做了<code>getServerSideProps</code>, 因此Next.js會使用SSR的模式, 這邊<code>getServerSideProps</code>就可以直接讀檔案了</p>
<p>但使用SSR這方法的話, 缺點就是</p>
<ol>
<li>每個頁面都得自己把讀config加入<code>getServerSideProps</code></li>
<li>也都需要自己把內容包在Context Provider如<code>&lt;FeatureContext.Provider value={{features:props.features}}></code></li>
</ol>
<p>就等於很多頁面都會有重複的程式碼, 不是那麼簡潔漂亮, 但優點應是內容在server端就已經先處理好了</p>
<h2 id=pagewithfeature>PageWithFeature</h2>
<p>上面有偷偷藏一個<code>PageWithFeature</code>, 這個實做可以是這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ReactNode</span>, <span style=color:#a6e22e>useContext</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>
<span style=color:#66d9ef>import</span> Error <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/error&#34;</span>
<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../context/featurecontext&#34;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Offline</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./offline&#34;</span>

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeaturesProps</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>features?</span>:<span style=color:#66d9ef>any</span>
    <span style=color:#a6e22e>children?</span>:<span style=color:#66d9ef>ReactNode</span>
    <span style=color:#a6e22e>feature?</span>: <span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PageWithFeature</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>FeaturesProps</span>) {
    <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>features</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>useContext</span>(<span style=color:#a6e22e>FeatureContext</span>)

    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span>[<span style=color:#e6db74>&#39;offline&#39;</span>]) {
        <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Offline</span>&gt;&lt;/<span style=color:#f92672>Offline</span>&gt;
    }
    
    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>features</span>[<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span>]) {
        <span style=color:#66d9ef>return</span> (
            &lt;&gt;{<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>children</span>}&lt;/&gt;)   
    }
    
    <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Error</span> <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>=</span>{<span style=color:#ae81ff>404</span>} /&gt;
}

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>PageWithFeature</span>
</code></pre></div><p>用途有兩個:</p>
<ol>
<li>Disable時導到404頁面</li>
<li>如果是系統下架狀態下, 導到一個暫時停止服務頁面(這邊用另一個component來解決)</li>
</ol>
<h2 id=開發流程上的思考>開發流程上的思考</h2>
<p>Atlassian這篇介紹<a href=https://www.atlassian.com/continuous-delivery/principles/feature-flags>Feature flags</a>裡有張圖, 我覺得蠻有趣的, 可以做為開發流程上的一個參考:
<img src="https://wac-cdn.atlassian.com/dam/jcr:cc55dc99-ddf4-4e61-a989-db6446cfef3c/Feature%20Flag-Driven%20Development@2x.png?cdnVersion=1785" alt></p>
<p>Facebook這篇<a href=https://engineering.fb.com/2017/08/31/web/rapid-release-at-massive-scale/>Rapid release at massive scale</a>, 雖然跟Feature flags關係比較不大, 但也蠻有參考價值的</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-08-22 12:42:50 +0800 +0800"><a href=/%E7%94%A8Kubernetes-ConfigMap%E5%AF%A6%E7%8F%BE%E9%85%8D%E7%BD%AE%E7%9A%84%E7%86%B1%E6%9B%B4%E6%96%B0/>Aug 22, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~7 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E7%94%A8Kubernetes-ConfigMap%E5%AF%A6%E7%8F%BE%E9%85%8D%E7%BD%AE%E7%9A%84%E7%86%B1%E6%9B%B4%E6%96%B0/ rel=bookmark title="用Kubernetes ConfigMap實現配置的熱更新" itemprop=url>用Kubernetes ConfigMap實現配置的熱更新</a></h1>
</header>
<div class=entry-content>
<p>程式配置(Configuration)的熱更新(hot reload)應該是建置服務會常碰到一個題目, 常會有狀況需要在不動用release去調整程式配置的狀況, 比較常見的做法應該是將這些配置集中管理, 因此就有相關的解決方案產生像是:</p>
<ul>
<li><a href=https://cloud.spring.io/spring-cloud-config/multi/multi__spring_cloud_config_server.html>Spring cloud config server</a></li>
<li><a href=https://github.com/Netflix/archaius>Netflix Archaius</a></li>
<li><a href=https://line.github.io/centraldogma/>LINE Central Dogma</a></li>
<li><a href=https://www.hashicorp.com/products/consul>HashiCorp Consul</a> (不過近來這個產品已經被延伸到Service Mash的領域去了)</li>
<li><a href=https://azure.microsoft.com/en-us/services/app-configuration/>Azure App configuration</a></li>
</ul>
<p>真要找, 應該還有, 這種中央管理的方式, 無非就是想要把分布在不同系統的所有的設定, 做一個集中管理, 隨時可以進行線上更新, 不過帶來的問題點就是除了要綁定選定系統用相關的API開發外, 這類的服務也是有可能是SPOF</p>
<p>在Kubernetes原生(Kubernetes Native)的角度來看這件事, Kubernetes就有內建ConfigMap, Secret, 是否還有必要導入這類的解決方案? 利用ConfigMap是否可以達成線上做熱更新的目的? 我的想法是, 如果用ConfigMap做到熱更新, 那麼搭配 GitOps 的流程, 這樣就可以做到簡單又兼顧集中管理的特性了(更新紀錄在git都可以查到, 另外可以用PR確保更改配置的安全性, 避免誤更, 在多叢集配置下也可以分享同一個git repository)</p>
<h2 id=使用configmap>使用ConfigMap</h2>
<p>這邊沒特別要說明怎麼去用ConfigMap, 那個 <a href=https://kubernetes.io/docs/concepts/configuration/configmap/>官方文件</a> 寫得很清楚, 先來看看ConfigMap在配合Pod/Deployment的兩個常見用法</p>
<p>先拿下面這範例來看:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo</span>
<span style=color:#f92672>data</span>:
  <span style=color:#75715e># property-like keys; each key maps to a simple value</span>
  <span style=color:#f92672>player_initial_lives</span>: <span style=color:#e6db74>&#34;3&#34;</span>
  <span style=color:#f92672>ui_properties_file_name</span>: <span style=color:#e6db74>&#34;user-interface.properties&#34;</span>

  <span style=color:#75715e># file-like keys</span>
  <span style=color:#f92672>game.properties</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    enemy.types=aliens,monsters
</span><span style=color:#e6db74>    player.maximum-lives=5    </span>    
  <span style=color:#f92672>user-interface.properties</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    color.good=purple
</span><span style=color:#e6db74>    color.bad=yellow
</span><span style=color:#e6db74>    allow.textmode=true </span>    
</code></pre></div><p>上面這個ConfigMap我們可以在Pod這樣使用它:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>configmap-demo-pod</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>containers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>demo</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine</span>
      <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;sleep&#34;</span>, <span style=color:#e6db74>&#34;3600&#34;</span>]
      <span style=color:#f92672>env</span>:
        <span style=color:#75715e># Define the environment variable</span>
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>PLAYER_INITIAL_LIVES</span> <span style=color:#75715e># Notice that the case is different here</span>
                                     <span style=color:#75715e># from the key name in the ConfigMap.</span>
          <span style=color:#f92672>valueFrom</span>:
            <span style=color:#f92672>configMapKeyRef</span>:
              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo          </span> <span style=color:#75715e># The ConfigMap this value comes from.</span>
              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>player_initial_lives</span> <span style=color:#75715e># The key to fetch.</span>
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>UI_PROPERTIES_FILE_NAME</span>
          <span style=color:#f92672>valueFrom</span>:
            <span style=color:#f92672>configMapKeyRef</span>:
              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo</span>
              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>ui_properties_file_name</span>
      <span style=color:#f92672>volumeMounts</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
        <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/config&#34;</span>
        <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#f92672>volumes</span>:
    <span style=color:#75715e># You set volumes at the Pod level, then mount them into containers inside that Pod</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
      <span style=color:#f92672>configMap</span>:
        <span style=color:#75715e># Provide the name of the ConfigMap you want to mount.</span>
        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo</span>
        <span style=color:#75715e># An array of keys from the ConfigMap to create as files</span>
        <span style=color:#f92672>items</span>:
        - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;game.properties&#34;</span>
          <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;game.properties&#34;</span>
        - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;user-interface.properties&#34;</span>
          <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;user-interface.properties&#34;</span>
</code></pre></div><p>一個是用<code>valueFrom</code>把ConfigMap裡面的設定拿來放在環境變數使用(參考上面範例)</p>
<p>另一個則是透過 <code>volumes</code> 把設定內容掛載成檔案</p>
<p>為了達成熱更新, 我們會有興趣的是, 當我們ConfigMap更新時, 相對應的內容會不會改變, 答案是只有第二種掛載成檔案的, 會隨之更新, 而第一種, 當ConfigMap更新時, 相關的環境變數是不會跟著變的</p>
<p>至於掛載成檔案的, 當ConfigMap內容做過更動時, 相對應的檔案內容也會更新, 但&mldr;不是即時的, 根據文件</p>
<blockquote>
<p>The kubelet checks whether the mounted ConfigMap is fresh on every periodic sync. However, the kubelet uses its local cache for getting the current value of the ConfigMap. The type of the cache is configurable using the ConfigMapAndSecretChangeDetectionStrategy field in the KubeletConfiguration struct. A ConfigMap can be either propagated by watch (default), ttl-based, or by redirecting all requests directly to the API server. As a result, the total delay from the moment when the ConfigMap is updated to the moment when new keys are projected to the Pod can be as long as the kubelet sync period + cache propagation delay, where the cache propagation delay depends on the chosen cache type (it equals to watch propagation delay, ttl of cache, or zero correspondingly).</p>
</blockquote>
<p>也就是說預期會有根據你設定是用watch, ttl-based, 全透過API取得更新跟cache時間造成的時間差, 也就是雖然ConfigMap也是一種集中式管理(放在etcd), 但實際上還是會有數秒到數十秒的更新時間差(我實測最多碰到一分鐘後才更新)</p>
<p>因此如果需要做到配置的熱更新, 那我們可以選擇是第二種掛載成檔案的作法, 藉由監控檔案內容的改變, 再由程式去做熱更新</p>
<h2 id=觀測configmap的異動狀況>觀測ConfigMap的異動狀況</h2>
<p>既然是檔案, 那我們可不可以由Linux的inotify去監控檔案的異動狀況? inotify是Linux核心的一個系統呼叫, 現在主流伺服端的程式設計應該也比較少用C直接去呼叫這些System call了吧? 不過, 基本上還是可行的, 這邊有一篇"<a href=https://cloud.tencent.com/developer/article/1557278>用 Sidecar 应用 Configmap 更新</a>", 這邊就用 <code>inotifywait</code> 這個指令放在sidecar中去監控config檔案, 在有變動時, 發送訊號重啟主程序</p>
<p>這方法的優點是, 程式可以不用自行監控ConfigMap的變化, 缺點就是, 重啟這件事是不可控的, 當你的服務有多個實體(instance)時, 也有可能這些全部會在同一時間被重啟, 造成你的服務被下線</p>
<p>另外一個就是在程式內自行監控, 現在Kubernetes大行其道, 已然是顯學, 如果已經採用它來管理配置系統的話, 在設計上配合它來做, 也是無可厚非, Dev要能針對Ops來設計, 才能真的有DevOps, 更何況這部分只需要監控檔案, 並不需要綁死Kubernetes API</p>
<p>監控檔案異動的作法, 各語言有自己包裝, golang有<a href=https://fsnotify.org/>fsnotify</a>, Java則有nio裡的<a href=https://www.baeldung.com/java-nio2-watchservice>WatcherService</a></p>
<p>這邊先以Java Nio做一個簡單的測試(實際是以Kotlin實作):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>suspend</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>watchConfig</span>(configFileName: String) {
	<span style=color:#66d9ef>val</span> dir:Path = Paths.<span style=color:#66d9ef>get</span>(configFileName).parent
	<span style=color:#66d9ef>val</span> fileName = Paths.<span style=color:#66d9ef>get</span>(configFileName).fileName

	<span style=color:#66d9ef>val</span> watcher = FileSystems.getDefault().newWatchService()

	dir.register(watcher, StandardWatchEventKinds.ENTRY_CREATE, StandardWatchEventKinds.ENTRY_DELETE, StandardWatchEventKinds.ENTRY_MODIFY)
	<span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>true</span>) {
		<span style=color:#66d9ef>val</span> key =watcher.take()
		key.pollEvents().forEach { <span style=color:#66d9ef>it</span> <span style=color:#f92672>-&gt;</span>
			<span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>it</span>.context() <span style=color:#f92672>==</span> fileName) {
				reloadConfig()
			}
		}

		<span style=color:#66d9ef>if</span>(!key.reset()) {
			key.cancel()
			watcher.close()
			<span style=color:#66d9ef>break</span>
		}
	}
}
</code></pre></div><p>以前面config map掛載的範例來看的話, 假設, 我們用 <code>watchConfig("/config/game.properties")</code> 來監控"/config/game.properties", 這邊的"/config/game.properties"是由ConfigMap裡的 <code>game.properties</code> 來的, 所以變更這邊的<code>game.properties</code>, &ldquo;/config/game.properties"也會跟著改變</p>
<p>但, 上面這段程式是"完全沒用的&rdquo;, 即使 <code>game.properties</code>和<code>/config/game.properties</code>內容都被改變了, 這邊的 <code>reloadConfig()</code> 也完全不會被觸發!!!! 如果使用golang的fsnotify, 也會是一樣的狀況</p>
<p>為什麼呢? 難道是這樣掛載的檔案有啥特異? 先來 <code>ls -l</code>看一下:</p>
<pre tabindex=0><code>ls -l /config/game.properties
lrwxrwxrwx 1 root root 24 Aug 21 16:55 /config/game.properties -&gt; ..data/game.properties
</code></pre><p>這邊可以發現<code>/config/game.properties</code>是一個Symbolic link連到<code>..data/game.properties</code>去, 這樣就導致我們監控不到它嗎? 其實還不只, 再來<code>ls -l ..data</code>看看</p>
<pre tabindex=0><code>ls -l ..data
lrwxrwxrwx 1 root root 31 Aug 21 16:58 ..data -&gt; ..2021_08_21_16_56_33.873456784
</code></pre><p>Ok, <code>..data</code>也是一個Symbolic link, 所以實際上ConfigMap被變更過後, 真正檔案變更大guy會是這樣的:</p>
<pre tabindex=0><code>CREATE ..2021_08_21_16_58_04.661956783
CREATE ..2021_08_21_16_58_04.661956783/game.properties
CREATE ..data_tmp (link to ..2021_08_21_16_58_04.661956783)
MOVE ..data_tmp ..data
DELETE ..2021_08_21_16_56_33.873456784
</code></pre><p>所以我們原本直覺應該會是認為它是會直接變更<code>/config/game.properties</code>內容, 但實際上<code>/config/game.properties</code>是一直沒被變動的, 它一直是一個連結到<code>/config/..data/game.properties</code>的Symbolic link, 所以觀測對象是不對的, 因此得這樣改:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>suspend</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>watchConfig</span>(configFileName: String) {
	<span style=color:#66d9ef>var</span> path:Path = Paths.<span style=color:#66d9ef>get</span>(configFileName)
	<span style=color:#66d9ef>val</span> parent:Path = path.parent

	<span style=color:#66d9ef>while</span> (Files.isSymbolicLink(path)) {
		path = Files.readSymbolicLink(path)
	}

	<span style=color:#66d9ef>val</span> realParent:String = path.parent.name
	<span style=color:#66d9ef>val</span> watcher = FileSystems.getDefault().newWatchService()

	parent.register(watcher, StandardWatchEventKinds.ENTRY_CREATE, StandardWatchEventKinds.ENTRY_DELETE, StandardWatchEventKinds.ENTRY_MODIFY)
	<span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>true</span>) {
		<span style=color:#66d9ef>val</span> key =watcher.take()
		key.pollEvents().forEach { <span style=color:#66d9ef>it</span> <span style=color:#f92672>-&gt;</span>
			<span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>it</span>.context() <span style=color:#f92672>==</span> realParent) {
				reloadConfig()
			}
		}

		<span style=color:#66d9ef>if</span>(!key.reset()) {
			key.cancel()
			watcher.close()
			<span style=color:#66d9ef>break</span>
		}
	}
}
</code></pre></div><p>這邊的<code>realParent</code>其實就是<code>..data</code>, 有變動的會是它, 所以監控它就好了</p>
<h2 id=使用golang的spf13viper>使用golang的spf13/viper</h2>
<p>如果你是用golang並且是用sp13大神的<a href=https://github.com/spf13/viper>viper</a>, 來管理設定檔, 那你只需要透過<code>viper.WatchConfig()</code>來監控ConfigMap掛載下來的設定檔就好</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>WatchConfig</span>()
<span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>OnConfigChange</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>e</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Event</span>) {
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Config file changed:&#34;</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Name</span>)
})
</code></pre></div><p>這是因為<a href=https://github.com/spf13/viper>viper</a>有針對這一狀況修正過, 有興趣可以參考<a href=https://github.com/spf13/viper/commit/e0f7631cf3ac7e7530949c7e154855076b0a4c17>&ldquo;WatchConfig and Kubernetes (#284)"</a>這段</p>
<h2 id=reloader>Reloader</h2>
<p>如果程式不想配合著改, 或大部分都是透過環境變數的方式來使用ConfigMap的話, 又怕使用前面inotify sidecar的作法會造成問題, 希望有更好的方式去RollOut, 那可以參考一下<a href=https://github.com/stakater/Reloader>Reloader</a></p>
<p><a href=https://github.com/stakater/Reloader>Reloader</a>會去監控ConfigMap跟Secret的變動, 來重啟跟他們有相關的DeploymentConfigs, Deployments, Daemonsets Statefulsets 和 Rollouts, 由於它是以Kubernetes conrtroller的形式存在, 並且採用Kubernetes API去監控資源: <a href=https://github.com/stakater/Reloader/blob/99a38bff8ea1346191b6a96583d3fbad72573ea5/internal/pkg/controller/controller.go#L47>https://github.com/stakater/Reloader/blob/99a38bff8ea1346191b6a96583d3fbad72573ea5/internal/pkg/controller/controller.go#L47</a></p>
<p>安裝方法很簡單, 只需要用:</p>
<pre tabindex=0><code>kubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml
</code></pre><p>裝到你所需要的namespace即可, 然後在你的Deployment設定上加上一個annotation <code>reloader.stakater.com/auto: "true"</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app</span>
  <span style=color:#f92672>annotations</span>:
    <span style=color:#f92672>reloader.stakater.com/auto</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</code></pre></div><p>這樣reloader就會幫你監控這個Deployment用到相關的ConfigMap跟Secret, 不管是用環境變數的方式, 還是掛載檔案的方式, 都適用, 並且由於它是直接透過Kubernetes API, 因此ConfigMap或是Secret有變化都是即時會監測到, 然後它就會用rolling update的方式去重啟相關的instances, 相較之下會比用sidecar的方式保險</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-08-20 19:11:48 +0800 +0800"><a href=/%E7%94%A8gradlesbt%E7%9B%B4%E6%8E%A5%E5%BB%BA%E7%BD%AEDocker-Image/>Aug 20, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~2 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E7%94%A8gradlesbt%E7%9B%B4%E6%8E%A5%E5%BB%BA%E7%BD%AEDocker-Image/ rel=bookmark title="用gradle／sbt直接建置Docker Image" itemprop=url>用gradle／sbt直接建置Docker Image</a></h1>
</header>
<div class=entry-content>
<p>現在流行甚麼東西都要包成Docker image來部署, 每一個都要寫一個Dockerfile, 每個又很類似, 建置完程式碼又得立刻跑Docker來建置Docker image, 如果有更簡單的方法可以一次做完, 應該會省事很多</p>
<p>以下提到的這些方法可以一行Dockerfile都不用寫</p>
<h2 id=使用gradle把java-application建置並包裝成docker-image>使用gradle把Java application建置並包裝成Docker image</h2>
<p>要達到這個目的, 可以使用 <code>com.bmuschko.docker-java-application</code> - <a href=https://bmuschko.github.io/gradle-docker-plugin/#java-application-plugin>https://bmuschko.github.io/gradle-docker-plugin/#java-application-plugin</a> 這個Gradle plugin, 這個plugin會去呼叫Docker client API, 所以使用前確定你有啟動dockerd</p>
<p>先來看一下底下這範例, 這是一個用<a href=https://ktor.io/>Ktor</a>寫的server application:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>val</span> ktor_version: String <span style=color:#66d9ef>by</span> project
<span style=color:#66d9ef>val</span> kotlin_version: String <span style=color:#66d9ef>by</span> project
<span style=color:#66d9ef>val</span> logback_version: String <span style=color:#66d9ef>by</span> project

plugins {
    application
    kotlin(<span style=color:#e6db74>&#34;jvm&#34;</span>) version <span style=color:#e6db74>&#34;1.5.21&#34;</span>
    id(<span style=color:#e6db74>&#34;com.bmuschko.docker-java-application&#34;</span>) version <span style=color:#e6db74>&#34;6.7.0&#34;</span>
}

group = <span style=color:#e6db74>&#34;co.jln&#34;</span>
version = <span style=color:#e6db74>&#34;0.0.1&#34;</span>
application {
    mainClass.<span style=color:#66d9ef>set</span>(<span style=color:#e6db74>&#34;co.jln.ApplicationKt&#34;</span>)
}

docker {
    javaApplication {
        baseImage.<span style=color:#66d9ef>set</span>(<span style=color:#e6db74>&#34;openjdk:11-jre&#34;</span>)
        ports.<span style=color:#66d9ef>set</span>(listOf(<span style=color:#ae81ff>8080</span>))
        images.<span style=color:#66d9ef>set</span>(setOf(<span style=color:#e6db74>&#34;julianshen/myexamplekt:&#34;</span> + version, <span style=color:#e6db74>&#34;julianshen/myexamplekt:latest&#34;</span>))
        jvmArgs.<span style=color:#66d9ef>set</span>(listOf(<span style=color:#e6db74>&#34;-Xms256m&#34;</span>, <span style=color:#e6db74>&#34;-Xmx2048m&#34;</span>))
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation(<span style=color:#e6db74>&#34;io.ktor:ktor-server-core:</span><span style=color:#e6db74>$ktor_version</span><span style=color:#e6db74>&#34;</span>)
    implementation(<span style=color:#e6db74>&#34;io.ktor:ktor-server-netty:</span><span style=color:#e6db74>$ktor_version</span><span style=color:#e6db74>&#34;</span>)
    implementation(<span style=color:#e6db74>&#34;ch.qos.logback:logback-classic:</span><span style=color:#e6db74>$logback_version</span><span style=color:#e6db74>&#34;</span>)
    testImplementation(<span style=color:#e6db74>&#34;io.ktor:ktor-server-tests:</span><span style=color:#e6db74>$ktor_version</span><span style=color:#e6db74>&#34;</span>)
    testImplementation(<span style=color:#e6db74>&#34;org.jetbrains.kotlin:kotlin-test:</span><span style=color:#e6db74>$kotlin_version</span><span style=color:#e6db74>&#34;</span>)
}
</code></pre></div><p>雖然是kotlin寫的, 不過這是一個標準的Java Application, 有它的main class, 我們要加上的只有 <code>id("com.bmuschko.docker-java-application") version "6.7.0"</code> 和 <code>docker {}</code> 內的內容而已, 基本主要就是baseImage跟image的名字就好了</p>
<p>執行 <code>gradle dockerBuildImage</code> 就可以直接幫你把程式建置好並包裝成docker image了</p>
<p>如果是要把image給push到repository上的話, 執行 <code>gradle dockerPushImage</code></p>
<p>如果你的不是一般的Java application 而是Spring boot application的話, 則是可以用 <code>com.bmuschko.docker-spring-boot-application</code> 這個plugin而不是上面那個, 不過如果是Spring boot 2.3之後, 還有另一個方法</p>
<h2 id=直接把spring-boot應用程式建置成docker-image>直接把Spring Boot應用程式建置成Docker image</h2>
<p>如果是Spring Boot 2.3之後, 因為內建就有支援 <a href=https://buildpacks.io/>Cloud Native Buildpacks</a> , 所以直接就可以建置成docker image , 蠻簡單的, 只要執行</p>
<pre tabindex=0><code>gradle bootBuildImage
</code></pre><p>不過, 它image的名字會是 <code>library/project_name</code> , 所以如果你需要用其他的名字取代的話, 有兩種方法, 一種是加上 <code>--imageName</code> 給定名字, 像是:</p>
<pre tabindex=0><code>gradle bootBuildImage --imageName=julianshen/springsample
</code></pre><p>另一種是把這段加到 <code>build.gradle.kts</code> 去(這邊以kotlin當範例):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>tasks.getByName&lt;org.springframework.boot.gradle.tasks.bundling.BootBuildImage&gt;(<span style=color:#e6db74>&#34;bootBuildImage&#34;</span>) {
	docker {
		imageName = <span style=color:#e6db74>&#34;julianshen/sprintsmaple&#34;</span>
	}
}
</code></pre></div><p>這個的缺點是, 不像前面提到的plugin有支援push, 如果你需要把建置好的結果放到repository上的話, 就得自己執行 <code>docker push</code></p>
<h2 id=把scala-application包裝成docker-image>把Scala application包裝成Docker image</h2>
<p>如果是Scala就需要用到 <a href=https://www.scala-sbt.org/sbt-native-packager/index.html>SBT Native Packager</a></p>
<p>用法也不難, 首先先把下面這段加到 <code>plugins.sbt</code> 去:</p>
<pre tabindex=0><code>addSbtPlugin(&quot;com.typesafe.sbt&quot; % &quot;sbt-native-packager&quot; % &quot;1.7.6&quot;)
</code></pre><p>在 <code>build.sbt</code> 內加入:</p>
<pre tabindex=0><code>enablePlugins(DockerPlugin)
</code></pre><p>然後執行 <code>sbt docker:publishLocal</code>即可, 相關設定可以參考 <a href=https://www.scala-sbt.org/sbt-native-packager/formats/docker.html>Docker plugin的文件</a></p>
</div>
</article>
<div class=pagination>
<ul class=inline-list>
<li><strong class=current-page>1</strong></li>
<li><a href=/post/page/2/>2</a></li>
<li><a href=/post/page/3/>3</a></li>
<li><a href=/post/page/4/>4</a></li>
<li><a href=/post/page/5/>5</a></li>
<li><a href=/post/page/6/>6</a></li>
<li><a href=/post/page/7/>7</a></li>
<li><a href=/post/page/8/>8</a></li>
<li><a href=/post/page/9/>9</a></li>
<li><a href=/post/page/10/>10</a></li>
<li><a href=/post/page/11/>11</a></li>
<li><a href=/post/page/12/>12</a></li>
<li><a href=/post/page/13/>13</a></li>
<li><a href=/post/page/14/>14</a></li>
<li><a href=/post/page/15/>15</a></li>
<li><a href=/post/page/16/>16</a></li>
<li><a href=/post/page/17/>17</a></li>
<li><a href=/post/page/18/>18</a></li>
<li><a href=/post/page/19/>19</a></li>
<li><a href=/post/page/20/>20</a></li>
<li><a href=/post/page/21/>21</a></li>
<li><a href=/post/page/22/>22</a></li>
<li><a href=/post/page/23/>23</a></li>
<li><a href=/post/page/24/>24</a></li>
<li><a href=/post/page/25/>25</a></li>
<li><a href=/post/page/26/>26</a></li>
<li><a href=/post/page/27/>27</a></li>
<li><a href=/post/page/28/>28</a></li>
<li><a href=/post/page/29/>29</a></li>
<li><a href=/post/page/30/>30</a></li>
<li><a href=/post/page/31/>31</a></li>
<li><a href=/post/page/32/>32</a></li>
<li><a href=/post/page/33/>33</a></li>
<li><a href=/post/page/34/>34</a></li>
<li><a href=/post/page/35/>35</a></li>
<li><a href=/post/page/36/>36</a></li>
<li><a href=/post/page/37/>37</a></li>
<li><a href=/post/page/38/>38</a></li>
<li><a href=/post/page/39/>39</a></li>
<li><a href=/post/page/40/>40</a></li>
<li><a href=/post/page/41/>41</a></li>
<li><a href=/post/page/42/>42</a></li>
<li><a href=/post/page/43/>43</a></li>
<li><a href=/post/page/44/>44</a></li>
<li><a href=/post/page/45/>45</a></li>
<li><a href=/post/page/46/>46</a></li>
<li><a href=/post/page/47/>47</a></li>
<li><a href=/post/page/48/>48</a></li>
<li><a href=/post/page/49/>49</a></li>
<li><a href=/post/page/50/>50</a></li>
<li><a href=/post/page/51/>51</a></li>
<li><a href=/post/page/52/>52</a></li>
<li><a href=/post/page/53/>53</a></li>
<li><a href=/post/page/54/>54</a></li>
<li><a href=/post/page/55/>55</a></li>
<li><a href=/post/page/56/>56</a></li>
<li><a href=/post/page/57/>57</a></li>
<li><a href=/post/page/58/>58</a></li>
<li><a href=/post/page/59/>59</a></li>
<li><a href=/post/page/60/>60</a></li>
<li><a href=/post/page/61/>61</a></li>
<li><a href=/post/page/62/>62</a></li>
<li><a href=/post/page/63/>63</a></li>
<li><a href=/post/page/64/>64</a></li>
<li><a href=/post/page/65/>65</a></li>
<li><a href=/post/page/66/>66</a></li>
<li><a href=/post/page/67/>67</a></li>
<li><a href=/post/page/68/>68</a></li>
<li><a href=/post/page/69/>69</a></li>
<li><a href=/post/page/70/>70</a></li>
<li><a href=/post/page/71/>71</a></li>
<li><a href=/post/page/72/>72</a></li>
<li><a href=/post/page/73/>73</a></li>
<li><a href=/post/page/74/>74</a></li>
<li><a href=/post/page/2/ class=btn>Next</a></li>
</ul>
</div>
</div>
<div class=footer-wrapper>
<footer role=contentinfo>
<span> Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span>
</footer>
</div>
<script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-79243751-1','auto'),ga('send','pageview'))</script>
<div id=fb-root></div>
<script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script>
</body>
</html>