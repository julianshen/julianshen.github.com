<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Posts &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="Posts"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://blog.jln.co/post/"><meta property="og:image" content="https://blog.jln.co/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.jln.co/images/avatar.png"><meta name=twitter:title content="Posts"><meta name=twitter:description content><link rel=canonical href=https://blog.jln.co/post/><link rel=alternate type=application/rss+xml href=https://blog.jln.co/post/feed.xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.104.3"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post-index class=feature><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=image-credit>Image credit: <a href=http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/>dargadgetz</a></div><div class=entry-image><img src=/abstract-2.jpg alt=Posts></div><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>All posts</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-09-17 14:48:19 +0800 +0800"><a href=/%E4%BD%BF%E7%94%A8podman%E5%92%8Ckind%E5%BB%BA%E7%AB%8Bk8s%E6%B8%AC%E8%A9%A6%E7%92%B0%E5%A2%83/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~3 minutes</span></div><h1 class=entry-title><a href=/%E4%BD%BF%E7%94%A8podman%E5%92%8Ckind%E5%BB%BA%E7%AB%8Bk8s%E6%B8%AC%E8%A9%A6%E7%92%B0%E5%A2%83/ rel=bookmark title=ä½¿ç”¨podmanå’Œkindå»ºç«‹k8sæ¸¬è©¦ç’°å¢ƒ itemprop=url>ä½¿ç”¨podmanå’Œkindå»ºç«‹k8sæ¸¬è©¦ç’°å¢ƒ</a></h1></header><div class=entry-content><p><a href=https://www.linuxadictos.com/zh-TW/Docker-%E6%A1%8C%E9%9D%A2%E5%B0%87%E4%B8%8D%E5%86%8D%E5%B0%8D%E4%BC%81%E6%A5%AD%E5%85%8D%E8%B2%BB%EF%BC%8C%E7%8F%BE%E5%9C%A8%E5%B0%87%E6%8C%89%E6%9C%88%E8%A8%82%E9%96%B1%E9%80%B2%E8%A1%8C%E7%AE%A1%E7%90%86.html>Docker Desktopè¦æ”¶éŒ¢äº†</a>, é›–ç„¶ä¸æ˜¯è·Ÿå€‹äººé–‹ç™¼è€…æ”¶, è€Œä¸”ä¸€å®¶å…¬å¸èµ°å‘ç‡Ÿåˆ©ä¹Ÿåˆç†, ä½†é€™ä½œæ³•èªªå¯¦åœ¨æœ‰é»ç²—ç³™, æ˜¯æ™‚å€™æ”¹ç”¨ä¸åŒçš„å·¥å…·ä¾†ç©äº†</p><p>ç¾åœ¨åœ¨é–‹ç™¼éšæ®µå¤šå¤šå°‘å°‘æœƒéœ€è¦åœ¨localæœ‰ä¸€å€‹æ¸¬è©¦ç’°å¢ƒäº‚æ, ä½†ä¸€èˆ¬çš„å°é›»è…¦, è·‘èµ·Docker + K8S, ä¹Ÿæ²’è¾¦æ³•è·‘å¤ªå¤šå®¹å™¨äº†, èƒ½å¤ æœ‰ç›¡é‡è¼•é‡åŒ–çš„æ±è¥¿ç•¶ç„¶æœ€å¥½, åœ¨æˆ‘çš„linux PCä¸Š, æˆ‘ç¾åœ¨ç”¨çš„æ˜¯podman + KIND (Windowsä¸‹æˆ‘é‚„æ˜¯ç”¨Docker desktop, é‚„æ²’åˆ‡æ›éå»)</p><h2 id=podman>Podman</h2><p><a href=https://podman.io/>Podman</a>æ˜¯ä¸€å€‹ç”±Redhaté–‹ç™¼çš„å·¥å…·, è·ŸDockeræœ€å¤§çš„ä¸åŒåœ¨æ–¼, å®ƒæ²’éœ€è¦è·‘ä¸€å€‹daemonå¸¸é§åœ¨é‚£é‚Š, Docker desktopå³ä½¿ä½ æ²’è·‘ä»»ä½•containerç‹€æ³ä¸‹daemoné‚„æœƒåœ¨, <a href=https://podman.io/>Podman</a>å‰‡å®Œå…¨æ²’é€™å•é¡Œ</p><p>å®‰è£çš„è©±è«‹åƒè€ƒ: <a href=https://podman.io/getting-started/installation>Podman Installation Instructions</a></p><p>å®‰è£å¥½å¾Œ, æŒ‡ä»¤å¹¾ä¹è·Ÿdocker é¡ä¼¼, åƒæ˜¯ <code>docker ps</code>å¯ä»¥ç”¨<code>podman ps</code>å–ä»£, <code>docker run</code>å¯ä»¥ç”¨<code>podman run</code>å–ä»£, å¹¾ä¹æ²’å¤ªå¤§å•é¡Œ</p><p>æœ‰äº›ç‹€æ³, æœƒéœ€è¦æœ‰docker daemon, åƒæ˜¯å¦‚æœä½¿ç”¨<a href=https://buildpacks.io/docs/tools/pack/>pack</a>, ç”±æ–¼<a href=https://buildpacks.io/docs/tools/pack/>pack</a>æœƒéœ€è¦å‘¼å«docker daemonä¾†å»ºç«‹image, å¦‚æœä½¿ç”¨podman, åœ¨é€™ç‹€æ³å°±å¾—è·‘ä¸€å€‹service:</p><pre tabindex=0><code>podman system service --time=0 tcp:localhost:1234
</code></pre><p>é€™é‚Šå¯ä»¥æ˜¯tcpæˆ–æ˜¯unix socket, ç„¶å¾ŒæŠŠDOCKER HOSTæ”¹æŒ‡åˆ°é€™é‚Šä¾†å°±å¥½äº†</p><h2 id=kindhttpskindsigsk8sio><a href=https://kind.sigs.k8s.io/>kind</a></h2><p><a href=https://kind.sigs.k8s.io/>kind</a>æ˜¯ä¸€å€‹è®“ä½ å»ºç«‹local K8S clusterçš„å·¥å…·, å…¶ä»–é¡ä¼¼çš„é‚„æœ‰<a href=https://microk8s.io/>MicroK8s</a>å’Œ<a href=https://github.com/kubernetes/minikube>MiniKube</a></p><p>ç‚ºä½•é¸<a href=https://kind.sigs.k8s.io/>kind</a>? æœ‰æ™‚å€™æœƒéœ€è¦æ¨¡æ“¬å¤šå€‹nodesçš„clusterç’°å¢ƒ, ä¸ç®¡æ˜¯MicoK8sé‚„æ˜¯MiniKube, åœ¨å–®æ©Ÿå»ºç«‹å‡ºçš„k8séƒ½åªæœ‰ä¸€å€‹node, ä½†<a href=https://kind.sigs.k8s.io/>kind</a>å»å¯ä»¥åœ¨å–®æ©Ÿå»ºç«‹å‡ºå¤šnodesçš„ç’°å¢ƒ</p><p>åœ¨Macä¸‹å¯ä»¥ç”¨Homebrewå®‰è£:</p><pre tabindex=0><code>brew install kind
</code></pre><p>å»ºç«‹ä¸€å€‹clusterå¾ˆç°¡å–®, åªè¦åŸ·è¡Œ</p><pre tabindex=0><code>kind create cluster
</code></pre><p>å¦‚æœä½ æ˜¯è¦ç”¨<a href=https://podman.io/>Podman</a>ä¹Ÿå¯ä»¥</p><pre tabindex=0><code>KIND_EXPERIMENTAL_PROVIDER=podman kind create cluster
</code></pre><p>ä½†ç¬¬ä¸€æ¬¡ä½¿ç”¨podmanå»ºç«‹æœƒç™¼ç”Ÿä¸€å€‹å•é¡Œ:</p><pre tabindex=0><code>KIND_EXPERIMENTAL_PROVIDER=podman kind create cluster
using podman due to KIND_EXPERIMENTAL_PROVIDER
enabling experimental podman provider
Creating cluster &#34;kind&#34; ...
 âœ— Ensuring node image (kindest/node:v1.21.1) ğŸ–¼ 
ERROR: failed to create cluster: failed to pull image &#34;kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6&#34;: command &#34;podman pull kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6&#34; failed with error: exit status 125
Command Output: Error: short-name resolution enforced but cannot prompt without a TTY
</code></pre><p>é€™æ˜¯ç”±æ–¼podmanåœ¨pull imageæ™‚ç¢°åˆ°short name(åƒæ˜¯java, ubuntu, fedoraé€™é¡çš„), å®ƒæœƒè«‹ä½ å¾<code>/etc/containers/registries.conf</code>è£¡é¢è¨­çš„search hostæŒ‘ä¸€å€‹æ˜¯å¯ä»¥æ‰¾åˆ°é€™å€‹imageçš„host, ä½†åœ¨kindè·³ä¸å‡ºä¾†çµ¦ä½ æŒ‘, é€™æ™‚å€™åªè¦çœ‹å“ªå€‹pullä¸ä¸‹ä¾†(åƒé€™é‚Šæ˜¯<code>kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6</code>)å°±è‡ªå·±æ‰‹å‹•åŸ·è¡Œä¸€æ¬¡</p><pre tabindex=0><code>podman pull kindest/node@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6
</code></pre><p>ä¸€æ¬¡å°±å¥½, ä¹‹å¾Œå®ƒæœƒè¨˜èµ·ä¾†, é€™æ™‚å€™å†ä¾†è·‘kindå°±æ²’å•é¡Œäº†</p><p>è¦æ¯€æ‰ä¸€å€‹clusterä¹Ÿå¾ˆç°¡å–®</p><pre tabindex=0><code>kind delete cluster
</code></pre><p>é›–ç„¶æ–‡ä»¶ä¸Šæœ‰èªªæ”¯æ´<a href=https://kind.sigs.k8s.io/docs/user/rootless/>Rootless</a>, ä¸éå¯¦éš›ä¸Šè©¦, è¦æ’é™¤çš„å•é¡Œé‚„å¾ˆå¤š, ä¸å»ºè­°ä½¿ç”¨</p><p>å¦‚æœä½ éœ€è¦ç”¨<code>kubectl</code>æˆ–æ˜¯<a href=https://k8slens.dev/>Lens</a>å»å­˜å–å»ºç«‹å‡ºä¾†çš„cluster, é‚£å¯ä»¥è¼¸å‡ºkubeconfig</p><pre tabindex=0><code>kind export kubeconfig
</code></pre><p>é‚£, èªªå¥½çš„å¤šè‚‰&mldr;å–”&mldr;å¤šnodesç’°å¢ƒå‘¢? å»ºç«‹ä»¥ä¸‹é€™æ¨£çš„config(ä¾‹å¦‚æª”åå«config.yaml):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kind.x-k8s.io/v1alpha4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>nodes</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>control-plane</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>worker</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>worker</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>role</span>: <span style=color:#ae81ff>worker</span>
</span></span></code></pre></div><p>ç„¶å¾Œç”¨<code>kind create cluster --config config.yaml</code>å°±å¯ä»¥å»ºç«‹å‡ºä¸€å€‹4 nodes (ä¸€å€‹control plane, ä¸‰å€‹worker)çš„ç’°å¢ƒäº†(åœ¨å–®æ©Ÿ)</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-09-17 14:21:09 +0800 +0800"><a href=/%E4%B8%8D%E5%AF%ABDockerfile%E5%BB%BA%E7%AB%8Bdocker-Image/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~1 minute</span></div><h1 class=entry-title><a href=/%E4%B8%8D%E5%AF%ABDockerfile%E5%BB%BA%E7%AB%8Bdocker-Image/ rel=bookmark title="ä¸å¯«Dockerfileå»ºç«‹docker Image" itemprop=url>ä¸å¯«Dockerfileå»ºç«‹docker Image</a></h1></header><div class=entry-content><p>äººéƒ½æ˜¯æ‡¶çš„, å°¤å…¶å¦‚æœæ‹¿åŒæ¨£çš„å·¥å…·, é–‹ç™¼ä¸åŒçš„service, åˆè¦éƒ¨å±¬åˆ°cloud nativeç’°å¢ƒ, å…ä¸äº†è¦ä¸€ç›´é‡è¤‡å¯«é¡ä¼¼çš„Dockerfileä¾†å»ºç«‹docker image, æœ‰æ²’æ‡¶æ–¹æ³•?</p><p>æœ‰, å°±æ˜¯<a href=https://buildpacks.io/>Cloud native buildpacks</a>, æœ‰ç”¨é<a href=https://www.heroku.com/>Heroku</a>çš„æ‡‰è©²æœƒæœ‰é»è€³ç†Ÿ, å°, å°±æ˜¯é‚£å€‹buildpacks, åªæ˜¯æŠŠå®ƒè®Šæˆä¸€å€‹æ¨™æº–</p><p>é¦–å…ˆ, ä½ éœ€è¦çš„æ˜¯<a href=https://buildpacks.io/docs/tools/pack/>pack</a>é€™å·¥å…·, åœ¨macåº•ä¸‹å¯ä»¥ç”¨ brewå®‰è£</p><pre tabindex=0><code>brew install buildpacks/tap/pack
</code></pre><p>Windowsä¸‹å¯ä»¥ç”¨scoop</p><pre tabindex=0><code>scoop install pack
</code></pre><p>å®‰è£å¥½å¾Œ, å¯ä»¥åŸ·è¡Œ:</p><pre tabindex=0><code>pack builder suggest
</code></pre><p>ä¾†çœ‹çœ‹æœ‰ç”šéº¼buildpacks å¯ä»¥ç”¨</p><pre tabindex=0><code>Suggested builders:
    Google:                gcr.io/buildpacks/builder:v1      Ubuntu 18 base image with buildpacks for .NET, Go, Java, Node.js, and Python
    Heroku:                heroku/buildpacks:18              Base builder for Heroku-18 stack, based on ubuntu:18.04 base image
    Heroku:                heroku/buildpacks:20              Base builder for Heroku-20 stack, based on ubuntu:20.04 base image
    Paketo Buildpacks:     paketobuildpacks/builder:base     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, Python, Ruby, NGINX and Procfile
    Paketo Buildpacks:     paketobuildpacks/builder:full     Ubuntu bionic base image with buildpacks for Java, .NET Core, NodeJS, Go, Python, PHP, Ruby, Apache HTTPD, NGINX and Procfile
    Paketo Buildpacks:     paketobuildpacks/builder:tiny     Tiny base image (bionic build image, distroless-like run image) with buildpacks for Java Native Image and Go
</code></pre><p>çœ‹ä½ ä½¿ç”¨çš„é–‹ç™¼èªè¨€æˆ–æ¡†æ¶, é¸æ“‡é©åˆçš„buildpack, æ¯”å¦‚èªªåƒæ˜¯node.jsæˆ–æ˜¯go, åªè¦ç°¡å–®çš„åœ¨ä½ çš„projectåº•ä¸‹åŸ·è¡Œ:</p><pre tabindex=0><code>pack build image_name --builder gcr.io/buildpacks/builder:v1
</code></pre><p>å°±å¯ä»¥å»ºç«‹å‡ºä¸€å€‹åç‚º<code>image_name</code>çš„docker imageäº†, è€Œä¸”å»ºç½®éç¨‹éƒ½æ˜¯è‡ªå‹•åµæ¸¬</p><p>ä¸éç•¶ç„¶æ²’è¾¦æ³•é©ç”¨æ‰€æœ‰çš„ç‹€æ³, å¦‚æœä½ æœ‰ä¸åŒçš„èªè¨€ä¸åŒçš„éœ€æ±‚, å…¶å¯¦ä¹Ÿå¯ä»¥è‡ªå»ºbuildpackå–”</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-09-17 12:20:38 +0800 +0800"><a href=/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/>Sep 17, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~6 minutes</span></div><h1 class=entry-title><a href=/%E7%94%A8D3js%E5%BB%BA%E7%AB%8B%E5%8F%B0%E8%82%A1%E6%9D%BF%E5%A1%8A%E5%9C%96/ rel=bookmark title=ç”¨D3jså»ºç«‹å°è‚¡æ¿å¡Šåœ– itemprop=url>ç”¨D3jså»ºç«‹å°è‚¡æ¿å¡Šåœ–</a></h1></header><div class=entry-content><p>é€™é¡Œç›®ç‘£ç¢çš„æ±è¥¿å¤ªå¤šäº†, æ‰€ä»¥é€™ç¯‡æ‰“ç®—åªæ˜¯åšå€‹ç´€éŒ„, åšé€™æ±è¥¿åŸå› æ˜¯çœ‹åˆ°<a href="https://finviz.com/map.ashx?t=sec_all">Finviz</a>é€™å€‹æ¿å¡Šåœ–è¦ºå¾—é‚„è »æœ‰è¶£çš„, æƒ³èªªè©²æ€å»åšåˆ°é€™æ¨£çš„åœ–è¡¨</p><p><img src=/images/posts/2021-09-17-12-25-23.png alt=stockmap></p><p>ä¸€çœ¼å°±å¯ä»¥å¤§ç•¥çœ‹å¸‚å ´çš„ç‹€æ³, æ„Ÿè¦ºé‚„è »é…·çš„, æŸ¥äº†ä¸€ä¸‹, é€™æ±è¥¿å«<a href=https://en.wikipedia.org/wiki/Treemapping>Treemapping</a>, æƒ³åˆ°è³‡æ–™è¦–è¦ºåŒ–, æˆ‘æ˜¯å…ˆæƒ³åˆ°<a href=https://d3js.org/>D3.js</a>, é›–ç„¶èªª<a href=https://www.highcharts.com/>Highcharts</a>ä¹Ÿå¯ä»¥é”åˆ°ä¸€æ¨£çš„ç›®çš„, ä¸é<a href=https://d3js.org/>D3.js</a>ä½¿ç”¨ä¸Šè·ŸjQueryé¡ä¼¼, æ¯”è¼ƒç°¡å–®, æ‰€ä»¥é¸æ“‡å®ƒä¾†å¯¦ç¾</p><p>å…ˆçµ¦çµæœ<a href=https://fviz.jln.co/marketmap>https://fviz.jln.co/marketmap</a></p><p><img src=/images/posts/2021-09-17-12-45-59.png alt=f></p><p>é€™é‚Šä½¿ç”¨åˆ°çš„æ±è¥¿æœ‰:</p><ul><li>D3.js</li><li>Next.js (deploy to GitHub page)</li></ul><p>ç´”ç²¹éœæ…‹ç¶²é , æ²’è³‡æ–™åº«, ä¸éç›®å‰è³‡æ–™åªæŠ“åˆ°2021/09/14, å®šæœŸæŠ“è³‡æ–™çš„éƒ¨åˆ†é‚„æ‡¶å¾—å¼„</p><h2 id=è³‡æ–™ä¾†æº>è³‡æ–™ä¾†æº</h2><p>é€™é‚Šæ‰€éœ€è¦çš„è³‡æ–™æœ‰å¹¾å€‹:</p><ul><li>ä¸Šå¸‚è‚¡ç¥¨çš„æ”¶ç›¤è³‡è¨Š</li><li>ä¸Šæ«ƒè‚¡ç¥¨çš„æ”¶ç›¤è³‡è¨Š</li><li>å„è‚¡æ‰€å±¬çš„åˆ†é¡è³‡è¨Š</li></ul><p>é›–ç„¶éƒ½æ˜¯å®¹æ˜“çˆ¬çš„åˆ°çš„è³‡æ–™, ä½†å…©å€‹å¸‚å ´è³‡æ–™æ ¼å¼ä¸æ˜¯é‚£éº¼çš„çµ±ä¸€</p><p>æŠ“å–é›†ä¸­å¸‚å ´çš„æ­·å²è³‡æ–™ç”¨é€™å€‹ URL : &ldquo;<a href="https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date=%25s&type=ALL&_=%25s%22">https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date=%s&type=ALL&_=%s"</a> , dateçš„æ ¼å¼ç”¨"20060102"é€™æ¨£, &ldquo;_&ldquo;å¯ä»¥ç”¨timestampå³å¯, æˆ‘è¦çš„ç•¶ç„¶æ˜¯json, æœƒæ¯”csvä¾†çš„å¥½è™•ç†é»</p><p>å€‹è‚¡çš„äº¤æ˜“è³‡è¨Šåœ¨<code>data9</code>é€™å€‹æ¬„ä½, æ¬„ä½å®šç¾©æ˜¯<code>fields9</code>, æ‰€ä»¥ç”¨<code>jq</code>ä¾†çœ‹ä¸€ä¸‹</p><pre tabindex=0><code>curl &#34;https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&amp;date=20210910&amp;type=ALL&amp;_=1631369120214&#34; | jq &#34;.fields9&#34;
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 3122k    0 3122k    0     0  1526k      0 --:--:--  0:00:02 --:--:-- 1526k
[
  &#34;è­‰åˆ¸ä»£è™Ÿ&#34;,
  &#34;è­‰åˆ¸åç¨±&#34;,
  &#34;æˆäº¤è‚¡æ•¸&#34;,
  &#34;æˆäº¤ç­†æ•¸&#34;,
  &#34;æˆäº¤é‡‘é¡&#34;,
  &#34;é–‹ç›¤åƒ¹&#34;,
  &#34;æœ€é«˜åƒ¹&#34;,
  &#34;æœ€ä½åƒ¹&#34;,
  &#34;æ”¶ç›¤åƒ¹&#34;,
  &#34;æ¼²è·Œ(+/-)&#34;,
  &#34;æ¼²è·Œåƒ¹å·®&#34;,
  &#34;æœ€å¾Œæ­ç¤ºè²·åƒ¹&#34;,
  &#34;æœ€å¾Œæ­ç¤ºè²·é‡&#34;,
  &#34;æœ€å¾Œæ­ç¤ºè³£åƒ¹&#34;,
  &#34;æœ€å¾Œæ­ç¤ºè³£é‡&#34;,
  &#34;æœ¬ç›Šæ¯”&#34;
]
</code></pre><p>ä¾†çœ‹ä¸€ä¸‹<code>.data9</code>å…§çš„å–®ç­†è³‡æ–™, åŸºæœ¬ä¸Šå°±æ˜¯éƒ½æ”¾åˆ°arrayå», ç®—å¥½è™•ç†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;9944&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;æ–°éº—&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;92,813&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;53&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;1,950,673&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.05&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.10&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;20.85&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.10&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&lt;p style= color:red&gt;+&lt;/p&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;0.10&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;20.75&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;21.15&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;23.19&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span></code></pre></div><p>é€™é‚Š"æ¼²è·Œ(+/-)&ldquo;çš„éƒ¨åˆ†, å…¶å¯¦ä¸æ˜¯åªæœ‰+å’Œ-, è€Œå±…ç„¶æ˜¯html tags, åŒ…å«å››ç¨®ç‹€æ³, +/-/ /X, +/-å¾ˆå¥½æ‡‚, å°±æ˜¯æ¼²è·Ÿè·Œ, ç©ºç™½å°±æ˜¯å¹³ç›¤äº†, Xçš„ç‹€æ³é€šå¸¸ç™¼ç”Ÿåœ¨é™¤æ¬Šæ¯, å¢æ¸›è³‡é€™é¡ç‹€æ³</p><p>é‚£æ«ƒæª¯å¸‚å ´å‘¢? URLæ˜¯é€™å€‹<code>https://www.tpex.org.tw/web/stock/aftertrading/daily_close_quotes/stk_quote_result.php?l=zh-tw&d=110/09/01&_=1631603049</code>, æ—¥æœŸæ ¼å¼è·Ÿé›†ä¸­å¸‚å ´ä¸åŒ, æ˜¯ç”¨&rdquo;/&ldquo;éš”é–‹, ä¸¦ä¸”æ˜¯æ°‘åœ‹ç´€å¹´, é€™é‚Šè³‡æ–™ä¹Ÿæ˜¯arrayæ”¾åœ¨<code>aaData</code>é€™æ¬„ä½</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[<span style=color:#e6db74>&#34;9960&#34;</span>,<span style=color:#e6db74>&#34;\u9081\u9054\u5eb7&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;+0.35&#34;</span>,<span style=color:#e6db74>&#34;27.00&#34;</span>,<span style=color:#e6db74>&#34;27.25&#34;</span>,<span style=color:#e6db74>&#34;26.85&#34;</span>,<span style=color:#e6db74>&#34;27.06&#34;</span>,<span style=color:#e6db74>&#34;56,004&#34;</span>,<span style=color:#e6db74>&#34;1,515,312&#34;</span>,<span style=color:#e6db74>&#34;37&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;27.15&#34;</span>,<span style=color:#e6db74>&#34;5&#34;</span>,<span style=color:#e6db74>&#34;33,592,500&#34;</span>,<span style=color:#e6db74>&#34;27.10&#34;</span>,<span style=color:#e6db74>&#34;29.80&#34;</span>,<span style=color:#e6db74>&#34;24.40&#34;</span>]
</span></span></code></pre></div><p>é‚£å€‹è‚¡åŸºæœ¬è³‡æ–™å‘¢?é€™é‚Šå°±ç¥å¥‡äº†, å±…ç„¶æœ‰Open API document: <a href=https://openapi.twse.com.tw/v1/swagger.json>https://openapi.twse.com.tw/v1/swagger.json</a>, å¯ä»¥ç”¨&rdquo;/v1/opendata/t187ap03_L"å–å¾—åŸºæœ¬è³‡æ–™, é€™é‚Šé›–ç„¶ä¹Ÿæœ‰APIå¯ä»¥å–å¾—ç•¶æ—¥äº¤æ˜“è³‡è¨Š, ä½†åªæœ‰ç•¶æ—¥ä¸¦ç„¡æ­·å²è³‡æ–™</p><p>ä¸Šæ«ƒè‚¡ç¥¨çš„è³‡æ–™ä¹Ÿæœ‰ä¸€æ¨£çš„æ±è¥¿, åœ¨ <a href=https://www.tpex.org.tw/openapi/swagger.json>https://www.tpex.org.tw/openapi/swagger.json</a></p><p>æŠ“åˆ°çš„åˆ†é¡é¡åˆ¥æ˜¯ä»£è™Ÿ, æ‰€ä»¥è¦å°æ‡‰åˆ°æ­£ç¢ºçš„é¡åˆ¥åç¨±å¯ä»¥ç”¨é€™è¡¨:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Categories</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;01&#34;</span>: <span style=color:#e6db74>&#34;æ°´æ³¥&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;02&#34;</span>: <span style=color:#e6db74>&#34;é£Ÿå“&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;03&#34;</span>: <span style=color:#e6db74>&#34;å¡‘è† &#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;04&#34;</span>: <span style=color:#e6db74>&#34;ç´¡ç¹”çº–ç¶­&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;05&#34;</span>: <span style=color:#e6db74>&#34;é›»æ©Ÿæ©Ÿæ¢°&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;06&#34;</span>: <span style=color:#e6db74>&#34;é›»å™¨é›»çºœ&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;21&#34;</span>: <span style=color:#e6db74>&#34;åŒ–å·¥&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;22&#34;</span>: <span style=color:#e6db74>&#34;ç”ŸæŠ€&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;08&#34;</span>: <span style=color:#e6db74>&#34;ç»ç’ƒé™¶ç“·&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;09&#34;</span>: <span style=color:#e6db74>&#34;é€ ç´™&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;10&#34;</span>: <span style=color:#e6db74>&#34;é‹¼éµ&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;11&#34;</span>: <span style=color:#e6db74>&#34;æ©¡è† &#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;12&#34;</span>: <span style=color:#e6db74>&#34;æ±½è»Š&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;24&#34;</span>: <span style=color:#e6db74>&#34;åŠå°é«”&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;25&#34;</span>: <span style=color:#e6db74>&#34;é›»è…¦åŠé€±é‚Š&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;26&#34;</span>: <span style=color:#e6db74>&#34;å…‰é›»&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;27&#34;</span>: <span style=color:#e6db74>&#34;é€šä¿¡ç¶²è·¯&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;28&#34;</span>: <span style=color:#e6db74>&#34;é›»å­é›¶çµ„ä»¶&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;29&#34;</span>: <span style=color:#e6db74>&#34;é›»å­é€šè·¯&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;30&#34;</span>: <span style=color:#e6db74>&#34;è³‡è¨Šæœå‹™&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;31&#34;</span>: <span style=color:#e6db74>&#34;å…¶ä»–é›»å­&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;14&#34;</span>: <span style=color:#e6db74>&#34;å»ºæç‡Ÿé€ &#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;15&#34;</span>: <span style=color:#e6db74>&#34;èˆªé‹&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;16&#34;</span>: <span style=color:#e6db74>&#34;è§€å…‰&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;17&#34;</span>: <span style=color:#e6db74>&#34;é‡‘èä¿éšª&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;18&#34;</span>: <span style=color:#e6db74>&#34;è²¿æ˜“ç™¾è²¨&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;23&#34;</span>: <span style=color:#e6db74>&#34;æ²¹é›»ç‡ƒæ°£&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;19&#34;</span>: <span style=color:#e6db74>&#34;ç¶œåˆ&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;20&#34;</span>: <span style=color:#e6db74>&#34;å…¶ä»–&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;32&#34;</span>: <span style=color:#e6db74>&#34;æ–‡å‰µ&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;33&#34;</span>: <span style=color:#e6db74>&#34;è¾²æ¥­ç§‘æŠ€&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;34&#34;</span>: <span style=color:#e6db74>&#34;é›»å•†&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;80&#34;</span>: <span style=color:#e6db74>&#34;ç®¡ç†è‚¡ç¥¨&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;91&#34;</span>: <span style=color:#e6db74>&#34;å­˜è¨—æ†‘è­‰&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æŠŠä»¥ä¸Šè³‡æ–™, æ•´åˆèµ·ä¾†, æˆ‘éœ€è¦çš„æ˜¯é€™æ¨£çš„è³‡æ–™:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;å°è‚¡ç‰ˆå¡Š&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;children&#34;</span>: [{
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;é›†ä¸­å¸‚å ´&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;children&#34;</span>: [{
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;æ°´æ³¥&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;children&#34;</span>: [{
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Code&#34;</span>: <span style=color:#e6db74>&#34;1101&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;å°æ³¥&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;TradeVolume&#34;</span>: <span style=color:#e6db74>&#34;14853294&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Transaction&#34;</span>: <span style=color:#e6db74>&#34;6367&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;TradeValue&#34;</span>: <span style=color:#e6db74>&#34;715327703&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;OpeningPrice&#34;</span>: <span style=color:#e6db74>&#34;48.35&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;HighestPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;LowestPrice&#34;</span>: <span style=color:#e6db74>&#34;47.85&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;ClosingPrice&#34;</span>: <span style=color:#e6db74>&#34;48.40&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Change&#34;</span>: <span style=color:#e6db74>&#34;-0.05&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Time&#34;</span>: <span style=color:#e6db74>&#34;2021-09-01T00:00:00+08:00&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }]
</span></span><span style=display:flex><span>        }]
</span></span><span style=display:flex><span>    }]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é¡§åæ€ç¾©, Treemapå°±æ˜¯ä¸€å€‹æ¨¹ç‹€çš„çµæ§‹è€Œä¾†çš„, å› æ­¤éœ€è¦çš„è³‡æ–™çµæ§‹å°±éœ€è¦æœ‰å€‹éšå±¤, é€™é‚Šè¨­è¨ˆæˆ &ldquo;å°è‚¡æ¿å¡Š->å¸‚å ´åˆ¥->åˆ†é¡->å€‹è‚¡&rdquo;</p><h2 id=d3js--react-js>D3.js + React JS</h2><p>å› ç‚ºæˆ‘ç”¨Next.js, å°±æƒ³è¦æŠŠé€™å€‹treemapåŒ…è£åœ¨ä¸€å€‹react component</p><p>ä½¿ç”¨D3.jsè¦å…ˆå¼•å…¥é€™å¹¾å€‹packages (æˆ‘ç”¨typescripté–‹ç™¼):</p><ul><li>@types/d3</li><li>@types/d3-hierarchy</li><li>d3</li><li>d3-hierarchy</li></ul><p><code>d3-hierarchy</code>æ˜¯ç”¨ä¾†ç•«treemapçš„, åªç”¨d3åŸºæœ¬åŠŸèƒ½æ˜¯ä¸éœ€è¦å«é€²ä¾†çš„</p><p>å…ˆçµ¦é€™å€‹Treemapçš„componentä¸€å€‹æ®¼:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Treemap</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>width</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>height</span>:<span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>date</span>:<span style=color:#66d9ef>Date</span> }) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svgRef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useRef</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dataFile</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getFullYear</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> 
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> (<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getMonth</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) 
</span></span><span style=display:flex><span>      <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getDate</span>().<span style=color:#a6e22e>toString</span>().<span style=color:#a6e22e>padStart</span>(<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#34;0&#34;</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.json&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>renderTreemap</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>svg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>select</span>(<span style=color:#a6e22e>svgRef</span>.<span style=color:#a6e22e>current</span>).<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;font&#34;</span>, <span style=color:#e6db74>&#34;10px sans-serif&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>width</span>).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>height</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;*&#34;</span>).<span style=color:#a6e22e>remove</span>();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stockData</span>:<span style=color:#66d9ef>StockData</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>stockData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>d3</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>dataFile</span>) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>StockData</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;text&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>text</span>(<span style=color:#e6db74>&#34;æœ¬æ—¥ç„¡è³‡æ–™, è«‹æŒ‰å·¦ä¸Šè§’æŒ‰éˆ•é¸å–æ™‚é–“&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;x&#34;</span>, <span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#ae81ff>22</span>)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;white&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>useEffect</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>renderTreemap</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>Box</span>&gt;
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>svg</span> <span style=color:#a6e22e>ref</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>svgRef</span>} /&gt;
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>Box</span>&gt;
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Treemap</span>
</span></span></code></pre></div><p>d3çš„ç”¨æ³•è·ŸjQueryé¡ä¼¼, å› æ­¤é€™é‚Šè·ŸReactåŒ…è£ä¸€èµ·çš„æ–¹æ³•ä¹Ÿå¾ˆç°¡å–®, å°±æ˜¯ç”¨<code>useRef</code>çµ¦å®ƒæœ‰å€‹referenceå¯ä»¥select, é€™é‚Šè¦ç•«åœ–, æ‰€ä»¥å°±åŒ…åˆ°ä¸€å€‹svgå», å¯¦éš›renderå‡ºä¾†çš„ä¹Ÿæ˜¯svg</p><p>æŠ“å–è³‡æ–™å¯ä»¥ç”¨<code>d3.json(dataFile)</code>, å…¶å¯¦ä¹Ÿæœ‰<code>d3.csv</code>, æœ‰é»é¡ä¼¼ç”¨<code>fetch</code></p><p>Treemapçš„å¯¦åšå°±ç¨å¾®æœ‰é»è¤‡é›œäº†, å¯ä»¥åƒè€ƒé€™é‚Š &ldquo;<a href=https://observablehq.com/@d3/nested-treemap>Nested Treemap</a>&rdquo;, é€™ç¯‡ä¹Ÿä¸éŒ¯: &ldquo;<a href=http://blog.infographics.tw/2015/10/d3js-tutorial-treemap-and-budget/>D3.js å¯¦æˆ° ï¼ åˆ©ç”¨ Treemap Layout å°‡æ”¿åºœé ç®—è¦–è¦ºåŒ–</a>&rdquo;, é€™é‚Šæˆ‘ä½¿ç”¨äº†äº¤æ˜“é‡è·Ÿäº¤æ˜“ç¸½é¡å»åšé¢ç©è·Ÿæ’åº</p><h2 id=åŠ ä¸Štooltip>åŠ ä¸ŠTooltip</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>svg</span>.<span style=color:#a6e22e>selectAll</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>data</span>(<span style=color:#a6e22e>root</span>.<span style=color:#a6e22e>leaves</span>())
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>enter</span>()
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;rect&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;x&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;y&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;width&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>x0</span>; })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;height&#39;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> { 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>h</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y1</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>d</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>HierarchyRectangularNode</span>&lt;<span style=color:#f92672>StockData</span>&gt;).<span style=color:#a6e22e>y0</span>; 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>;
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;stroke&#34;</span>, <span style=color:#e6db74>&#34;black&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;fill&#34;</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>ccolor</span>(<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>data</span>))
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseover&#39;</span>, (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>)<span style=color:#f92672>=&gt;</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mouseOver</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>dataNode</span>);
</span></span><span style=display:flex><span>    }).<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;mouseleave&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tooltip</span>().<span style=color:#a6e22e>style</span>(<span style=color:#e6db74>&#34;opacity&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    });
</span></span></code></pre></div><p>é€é<code>on('mouseover')</code>å’Œ<code>on('mouseleave')</code>å°±å¯ä»¥ä¾†åŠ ä¸Štooltipçš„æ•ˆæœ</p><h2 id=ç™¼ä½ˆåˆ°github-pages>ç™¼ä½ˆåˆ°Github pages</h2><p>next.jsç”±æ–¼ssg, ssrçš„é—œä¿‚, éœ€è¦è·‘å€‹server, ä½†å…¶å¯¦ä¹Ÿæœ‰æ©Ÿæœƒç™¼å¸ƒæˆå…¨éœæ…‹ç¶²é (åªè¦æ²’éœ€è¦æœ‰åœ¨serverè·‘çš„éƒ¨åˆ†), æ­¥é©Ÿå¦‚ä¸‹:</p><ul><li>next build</li><li>next export</li></ul><p>çµæœå°±æœƒåœ¨<code>out/</code>ç›®éŒ„, æ‹¿é€™å€‹ç›®éŒ„çš„å…§å®¹æ”¾github pageså°±å¯ä»¥äº†</p><p>æœ€å¾Œé™„ä¸Šå¯«é€™æ±è¥¿æ™‚ä¾†æ—äº‚çš„å‚¢ä¼™</p><p><img src=/images/posts/2021-09-17-13-43-04.png alt></p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-09-01 14:13:25 +0800 +0800"><a href=/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/>Sep 1, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~8 minutes</span></div><h1 class=entry-title><a href=/%E5%9C%A8-Next.js-%E5%AF%A6%E4%BD%9C-Feature-Toggles/ rel=bookmark title="åœ¨ Next.js å¯¦ä½œ Feature Toggles" itemprop=url>åœ¨ Next.js å¯¦ä½œ Feature Toggles</a></h1></header><div class=entry-content><p>ä¹‹å‰ä¸€ç›´æœ‰åœ¨æ€è€ƒ, å¦‚æœæŠŠ Feature togglesæˆ–Feature flagså¸¶å…¥é–‹ç™¼æµç¨‹å¯ä»¥æœ‰ç”šéº¼å¹«åŠ©, å…ˆæ’‡é–‹A/B Testä¸è«‡(å› ç‚ºé€™é‚„æ˜¯è¦é…åˆç”¢å“ç­–ç•¥è€ƒé‡), åœ¨ä¸€å€‹é–‹ç™¼Sprinté€±æœŸæ™‚é–“è¶Šä¾†è¶ŠçŸ­ä¸‹, ä¸€å€‹featureçš„å®Œæˆé€šå¸¸ä¹Ÿéœ€è¦è·¨è¶Šå¤šå€‹sprints, å¦‚æœåŠ ä¸ŠæŸäº›å¯èƒ½éœ€è¦é…åˆeventæ™‚é–“æ¨å‡ºçš„åŠŸèƒ½, é€™å°releaseä¹Ÿæ˜¯æœƒå¸¶ä¾†ä¸€äº›æŒ‘æˆ°, ç†æƒ³åŒ–çš„ç‹€æ³å°±æ˜¯æœ€æ–°çš„ç¨‹å¼ç¢¼ä¸€ç›´éƒ½åœ¨, æ¸¬è©¦æ²’å•é¡Œå¾Œé–‹å€‹é–‹é—œå°±å¯ä»¥æ‰“é–‹, ç”šæˆ–æ­é…ä¸€äº›æŠ€å·§å¯ä»¥è®“QAä¹Ÿèƒ½å¤ åœ¨ç”Ÿç”¢ç’°å¢ƒé©—è­‰é‚„æ²’releaseçš„åŠŸèƒ½</p><p>éœ€è¦feature togglesçš„å ´åˆ, å¯èƒ½å‰å¾Œç«¯éƒ½æœƒæœ‰æ©Ÿæœƒ, ä¸é, æˆ‘æƒ³äº†ä¸€ä¸‹, å¾Œç«¯é‚„æ˜¯å¯ä»¥å¾APIç‰ˆæœ¬æˆ–æ˜¯å…¶ä»–æ–¹æ³•éš±è—æœªé‡‹å‡ºåŠŸèƒ½, è€Œå¾å‰ç«¯ä¸€æ¬¡éš±è—æ•´å€‹åŠŸèƒ½å€å¡Šæˆ–æ˜¯æ•´å€‹é é¢, æˆ–è¨±æ˜¯ä¸€å€‹æ¯”è¼ƒå¥½é–‹å§‹åˆ‡å…¥çš„éƒ¨åˆ†</p><p>å…ˆä¾†ä»‹ç´¹ä¸€ä¸‹Feature toggleå¥½äº†</p><h2 id=feature-toggles>Feature Toggles</h2><p>Feature Toggles (åˆåFeature Flags)æ˜¯ä¸€å€‹æ‡‰è©²ç®—æ˜¯å¸¸è¦‹çš„è»Ÿé«”é–‹ç™¼æ–¹å¼, è—‰ç”±é–‹é—œæ——æ¨™(flag)ä¾†é–‹å•Ÿæˆ–éš±è—ç¨‹å¼ä¸­çš„åŠŸèƒ½, åœŸæ³•ä¸€é», ä½ æ˜¯å¯ä»¥è‡ªè¨‚ä¸€å€‹å¸ƒæ—è®Šæ•¸, åœ¨releaseä¹‹å‰å»æ‰“é–‹æˆ–é—œé–‰å®ƒ(true or false), ç•¶ç„¶é€™æ¨£å½ˆæ€§æ¯”è¼ƒå°, ç†æƒ³ä¸Šç•¶ç„¶æœƒå¸Œæœ›å¯ä»¥å½ˆæ€§éš¨æ™‚é–‹é—œ</p><p>æ ¹æ“šMartin Fowleré€™ç¯‡<a href=https://martinfowler.com/bliki/FeatureToggle.html>FeatureToggle</a>ä»¥åŠPete Hodgsonå…ˆç”Ÿå¯«çš„é€™ç¯‡: <a href=https://www.martinfowler.com/articles/feature-toggles.html>Feature Toggles (aka Feature Flags)</a>, Feature togglesæ ¹æ“šç”¨é€”å¯ä»¥åˆ†åšä¸åŒç¨®é¡(å¾Œé¢é‚£ç¯‡ä»‹ç´¹æ¯”è¼ƒè©³ç´°):</p><ol><li>Release Toggles: é€™å°±å¦‚åŒå‰é¢è¬›çš„, é–‹é—œæˆ–éš±è—ç¨‹å¼ä¸­åŠŸèƒ½, æˆ–è¨±æ˜¯é‚„æœªå®Œæˆä¹‹åŠŸèƒ½, å¯ä»¥æ­é… trunk-based developmentæœç”¨, é€šå¸¸Release togglesçš„è®Šå‹•é »ç‡æ‡‰è©²è¦æ˜¯ç›¸ç•¶å°çš„, ä¹Ÿå¯èƒ½ç­‰åŠŸèƒ½ç©©å®šå¾Œå°±æœƒè¢«æ‹¿æ‰</li><li>Experiment Toggles: ç”¨åœ¨åšA/B Testå¯¦é©—, æœƒéœ€è¦ç¶“éä¸€äº›æ¢ä»¶åˆ¤æ–·ä¾†åšå•Ÿç”¨æˆ–ç¦ç”¨, é€šå¸¸æœƒæ ¹æ“šrequestçš„è³‡è¨Šæœ‰è®Šå‹•</li><li>Ops Toggles: ç”¨åœ¨è·Ÿç³»çµ±é‹ç¶­ç›¸é—œ, æ¯”å¦‚èªªç³»çµ±å•é¡Œè‡¨æ™‚éœ€è¦ä¸‹æ¶, éœ€è¦ä¸Šå…¬å‘Šé é¢, æˆ–æ˜¯åƒé€™ç¨®ç‹€æ³éœ€è¦ä¸‹æ¶æŸäº›åŠŸèƒ½(ä¸€å€‹æƒ³æ³•: æˆ–è¨±å¯ä»¥æ­é…ç³»çµ±ç›£æ§ä½¿ç”¨)</li><li>Permission Toggles: ç”¨åœ¨é™å®šç‰¹å®šä½¿ç”¨è€…å¯ä»¥ä½¿ç”¨, æˆ–è¨±ç›´è¦ºæœƒæƒ³åˆ°æ˜¯é‡å°æœ‰æ¬Šé™æ§åˆ¶çš„åŠŸèƒ½, ä¸éå…¶å¯¦é‚„å¯ä»¥ç”¨åœ¨Campaign/Eventç›¸é—œåŠŸèƒ½, å¦‚æœéœ€è¦ææ—©å…§éƒ¨åšdog fooding, æˆ–è¨±å°±å¯ä»¥è€ƒé‡beta user whitelistçš„ä½œæ³•, æ­é…Permission Toggles</li></ol><p>é¡åˆ¥åªæ˜¯ä¸€ç¨®å®šç¾©è€Œå·², çœŸæ­£ä½¿ç”¨ç‹€æ³æˆ–è¨±æœƒæ›´è¤‡é›œæ­é…, ä¹Ÿå¯èƒ½éœ€è¦è€ƒæ…®flagsä¹‹é–“çš„ç›¸ä¾æ€§è·Ÿé€£å‹•é—œä¿‚, ä¸éé€™ç¯‡ä¸¦ä¸æ˜¯è¦è¨è«–é€™éƒ¨åˆ†, é€™ç¯‡æœƒä»¥ç°¡å–®çš„å¯¦ç¾Release toggleä¾†å…ˆåšæ¢è¨</p><p>é—œæ–¼feature togglesè³‡æºè·Ÿç›¸é—œæ¢è¨ä¹Ÿå¯åƒè€ƒ <a href=https://featureflags.io/>The Hub for Feature Flag Driven Development</a></p><h2 id=feature-togglesçš„è§£æ±ºæ–¹æ¡ˆ>Feature togglesçš„è§£æ±ºæ–¹æ¡ˆ</h2><p>æœ‰äººæå‡ºæ–¹æ³•, å°±æœƒæœ‰äººæå‡ºè§£æ±ºæ–¹æ¡ˆå’Œç”¢å“, Feature togglesç›¸é—œçš„ç”¢å“å…¶å¯¦éå¸¸å¤š, å•†æ¥­ç”¢å“æœ‰:</p><ol><li><a href=https://launchdarkly.com/about-us/>LaunchDarkly</a></li><li><a href=https://www.getunleash.io/plans>Unleash</a></li><li><a href=https://happykit.dev/>HappyKit</a></li></ol><p>å¦å¤–ä¹Ÿå¯ä»¥æ‰¾åˆ°ä¸å°‘Open sourceçš„</p><ol><li><a href=https://www.togglz.org/>Togglez</a> (Java)</li><li><a href=https://ff4j.github.io>FF4J</a> (Java)</li><li><a href="https://twitter.github.io/finagle/guide/Configuration.html#:~:text=Feature%20toggles%20are%20a%20commonly%20used%20mechanism%20for,rollout%20functionality%20in%20a%20measured%20and%20controlled%20manner.">Finagle</a> (Finagleæœ‰å…§å»º, ä¸éä¸å¥½ç”¨)</li><li><a href=https://github.com/AntoineAugusti/feature-flags>Feature Flags API for Go</a> (Go)</li></ol><p>ä½ å¯ä»¥å¾<a href=https://featureflags.io/>The Hub for Feature Flag Driven Development</a>æ‰¾åˆ°ä¸€å¤§å †</p><p>ä½†é€™äº›çµ•å¤§éƒ¨åˆ†ä½œæ³•æ˜¯æŠŠfeature togglesçš„è¨­å®šé›†ä¸­ç®¡ç†, ä¸ç®¡æ˜¯æ”¾åœ¨è³‡æ–™åº«, æˆ–æ˜¯æœ‰ä¸€å€‹serverä¾†æä¾›(å¾Œé¢ä¹Ÿæ˜¯æ”¾è³‡æ–™åº«)</p><p>å€‹äººæ˜¯è¦ºå¾—, Feature togglesä¸¦ä¸æ˜¯ä¸»è§’, è€Œæ˜¯è·‘é¾å¥—çš„, æ‡‰è©²ç›¡å¯èƒ½çš„è¼•é‡åŒ–, åšæˆç¨ç«‹ç³»çµ±æœ‰é»å¤šäº†, åœ¨Cloud native (k8s native)æ™‚ä»£, è€ƒæ…®ç”¨æª”æ¡ˆä¾†å­˜è¨­å®š(æ­é…ConfigMap), åŠ ä¸Šlib, æ‡‰è©²æ˜¯ç›¸å°è¼•é‡çš„ä½œæ³•</p><p>å› æ­¤é‡å°é€™æƒ³æ³•, æˆ‘åœ¨Next.jsä¸Šåšäº†å¹¾å€‹åšæ³•ä¾†é©—è­‰, é€™é‚ŠæŠŠæˆ‘çš„ä½œæ³•è·Ÿç¢°åˆ°çš„ç‹€æ³åšä¸€å€‹ç´€éŒ„</p><h2 id=åŸºæœ¬è¨­è¨ˆ>åŸºæœ¬è¨­è¨ˆ</h2><p>é¦–å…ˆ, æˆ‘å…ˆæƒ³äº†ä¸€ä¸‹, æˆ‘åœ¨Next.jsä¸Šè¦æ€ä½¿ç”¨Feature togglesæ¯”è¼ƒåˆé©, æ­é…tagæ‡‰è©²æ˜¯æœ€ç‚ºæ˜“è®€çš„æ–¹å¼, åƒæ˜¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>WithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature1&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>div</span>&gt;<span style=color:#a6e22e>This</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>feature</span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>WithFeature</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>div</span>&gt;
</span></span></code></pre></div><p>ç”¨ä¸€å€‹å€å¡ŠåŒ…è—ä½éœ€è¦é–‹é—œçš„éƒ¨åˆ†, å†ç”±è®€å–åˆ°çš„è¨­å®šåšç‚ºé–‹é—œ</p><p>å¦ä¸€å€‹æƒ³åˆ°çš„æ–¹å¼æ˜¯:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>&lt;<span style=color:#f92672>PageWithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature3&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>PageWithFeature</span>&gt;
</span></span></code></pre></div><p>é€™ç¨®è·Ÿå‰ä¸€ç¨®çš„ä¸åŒæ˜¯, å¦‚æœåŠŸèƒ½æœªæ‰“é–‹, å€å¡Šå°±ä¸æœƒé¡¯ç¤º, ä½†æ•´é çš„å…¶ä»–éƒ¨åˆ†é‚„æœƒé¡¯ç¤º, ä½†ç¬¬äºŒç¨®æ‡‰ç”¨åœ¨, æ•´é éƒ½æ˜¯æ–°åŠŸèƒ½, ä¸æƒ³å› ç‚ºææ—©è¢«ç™¼ç¾URLè€Œéœ²å‡º, æ‰€ä»¥åŠŸèƒ½æœªæ‰“é–‹çš„æƒ…æ³éœ€è¦é¡¯ç¤º404</p><p>å¦å¤–configçš„è¨­è¨ˆå¸Œæœ›æ˜¯ä¸€å€‹yamlæª”æ¡ˆçµ¦ç¨‹å¼å»è®€å–, åƒé€™æ¨£:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>features</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature1</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature2</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>feature3</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>offline</span>: <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><h2 id=ä½¿ç”¨custom-appè·Ÿreact-contextä¾†åšä¸€å€‹é€šç”¨è¨­è¨ˆ>ä½¿ç”¨Custom Appè·ŸReact contextä¾†åšä¸€å€‹é€šç”¨è¨­è¨ˆ</h2><p>ç‚ºä½•èªªæ˜¯é€šç”¨è¨­è¨ˆ? é€™é‚Šæ˜¯å¸Œæœ›æ¯å€‹éœ€è¦ç”¨åˆ°toggleçš„é é¢ä¸ç”¨è‡ªå·²å¯«è¼‰å…¥è¨­å®šçš„éƒ¨åˆ†(å¾Œé¢æœƒè¬›å€‹ç¯„ä¾‹æ˜¯æœ‰éœ€è¦çš„), è€Œæ˜¯åªè¦ç›´æ¥ç”¨ <code>&lt;WithFeature feature="feature1"></code> å°±å¥½</p><p>Next.jsæœ‰æ”¯æ´<a href=https://nextjs.org/docs/advanced-features/custom-app>&ldquo;Custom <code>App</code>&rdquo;</a>, æ‰€ä»¥æˆ‘å€‘è¼‰å…¥configçš„éƒ¨åˆ†å¯ä»¥ç›´æ¥æ”¾åœ¨"<code>_app.tsx</code>" æˆ– &ldquo;<code>_app.jsx</code>&ldquo;å…§å°±å¯ä»¥è®“æ‰€æœ‰é é¢å…±ç”¨(è©³ç´°è«‹åƒè€ƒæ–‡ä»¶)è¼‰å…¥éƒ¨åˆ†çš„ç¨‹å¼ç¢¼, å¦å¤–é‚„å¾—æ­é…<a href=https://reactjs.org/docs/context.html>React context</a>æ‰èƒ½é †åˆ©çš„æŠŠè¨­å®šä¸‹å‚³åˆ°component</p><p>é¦–å…ˆ, æˆ‘å€‘éœ€è¦å…ˆä¾†è¨­è¨ˆä¸€å€‹<code>Context</code>ç”¨ä¾†å‚³éè¨­å®šçµ¦<code>WithFeature</code>çš„å…ƒä»¶(Component)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createContext</span>, <span style=color:#a6e22e>useState</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeatureMap</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>key</span>:<span style=color:#66d9ef>string</span>]<span style=color:#f92672>:</span><span style=color:#66d9ef>boolean</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>FeatureContext</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createContext</span>({<span style=color:#a6e22e>features</span><span style=color:#f92672>:</span> {} <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>FeatureMap</span>})
</span></span></code></pre></div><p>é€™é‚Šè¨­è¨ˆå¾ˆå–®ç´”, å‡è¨­æ¯å€‹featureéƒ½æ˜¯trueæˆ–falseçš„é–‹é—œ, å‰é¢çš„config yamlä¹Ÿæ˜¯é€™æ¨£çš„</p><p>åœ¨<code>_app.tsx</code>æˆ‘å€‘å‰‡éœ€è¦æœ‰é€™æ±è¥¿:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../context/featurecontext&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>MyApp</span>({ <span style=color:#a6e22e>Component</span>, <span style=color:#a6e22e>pageProps</span> }<span style=color:#f92672>:</span> <span style=color:#a6e22e>AppProps</span>) {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>FeatureContext.Provider</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>features</span>:<span style=color:#66d9ef>pageProps.features</span>}}&gt;&lt;<span style=color:#f92672>Component</span> {<span style=color:#a6e22e>...pageProps</span>}/&gt;&lt;/<span style=color:#f92672>FeatureContext.Provider</span>&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é€™é‚Šæ˜¯æŠŠpagePropsè£¡çš„featuresçµ¦å¸¶åˆ°<code>FeatureContext</code>ä»¥è®“å¾Œé¢çš„å¯ä»¥è®€åˆ°, é‚£pagePropsæ˜¯åˆå“ªè£¡ä¾†çš„? é€™é‚Šæˆ‘å€‘å°±å¾—å»å¯¦ä½œ<code>app.getInitialProps</code>äº†, é€™å€‹åœ¨æ¯å€‹pageåˆå§‹åŒ–éƒ½æœƒå‘¼å«åˆ°å®ƒ, ä¸¦æŠŠå®ƒç”¢ç”Ÿçš„pagePropsçµ¦é¤µåˆ°å‰é¢é‚£å€‹function</p><p>é‚£æ˜¯ä¸æ˜¯å°±å¯ä»¥æŠŠä¸‹é¢é€™æ®µç›´æ¥æ”¾åˆ°<code>getInitialProps</code>å°±å¯ä»¥å–å¾—feature flagsçš„è¨­å®šäº†å‘¢?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
</span></span></code></pre></div><p>ç­”æ¡ˆæ˜¯"ä¸è¡Œ!!&rdquo;, ç‚ºä½•? å› ç‚ºåœ¨Next.jsçš„è¨­è¨ˆä¸Š:</p><ol><li><code>getInitialProps</code>æ˜¯æœƒæœ‰å¯èƒ½åœ¨client(ç€è¦½å™¨), serverè·‘</li><li>é™¤éä½ é é¢å¯¦ä½œä¸Šæœ‰<code>getServerSideProps</code>, <code>getInitialProps</code>æ‰æœƒç¸½æ˜¯åœ¨serverç«¯è·‘</li><li>åªæœ‰<code>getServerSideProps</code>,<code>getStaticProps</code>æ‰å¯ä½¿ç”¨serverç«¯(node.js)API, ä¾‹å¦‚è®€æª” (é‚„æœ‰ä¸€å€‹å‰‡æ˜¯API, ä½†APIå¯¦åšä¸åŒ, æˆ‘ä¸è¦åœ¨æ­¤é¡)</li><li><code>getServerSideProps</code>åªè¨­è¨ˆçµ¦é é¢çš„å¯¦ä½œä½¿ç”¨, æ‰€ä»¥æ¯é æœ‰è‡ªå·±çš„ <code>getServerSideProps</code>, ä½† Appæ²’<code>getServerSideProps</code></li></ol><p>å› ç‚ºclientè·Ÿserveréƒ½æœƒæœ‰æ©Ÿæœƒå‘¼å«åˆ°, å¦‚æœè¦è®“å®ƒå€‘èƒ½å¤ å…±ç”¨, é‚£å°±åªæœ‰åšä¸€å€‹APIçµ¦å®ƒ, æˆ‘å€‘åœ¨<code>page/api</code>ç›®éŒ„åº•ä¸‹é–‹ä¸€å€‹<code>features.tsx</code>çš„æª”æ¡ˆ, å…§å®¹æ˜¯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextApiRequest</span>, <span style=color:#a6e22e>NextApiResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>YAML</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;yaml&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Features</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>key</span>:<span style=color:#66d9ef>string</span>]<span style=color:#f92672>:</span><span style=color:#66d9ef>boolean</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handler</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextApiRequest</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>: <span style=color:#66d9ef>NextApiResponse</span>&lt;<span style=color:#f92672>Features</span>&gt;
</span></span><span style=display:flex><span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>200</span>).<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>features</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>Features</span>)
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>é‚£æˆ‘å€‘<code>getInitialProps</code>å°±å¯ä»¥é€™æ¨£å¯«:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#a6e22e>MyApp</span>.<span style=color:#a6e22e>getInitialProps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>appContext</span>: <span style=color:#66d9ef>AppContext</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>appProps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>App</span>.<span style=color:#a6e22e>getInitialProps</span>(<span style=color:#a6e22e>appContext</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>appContext</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>req</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>host</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>?</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#34;x-forwarded-host&#34;</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#34;host&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>:</span> window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>host</span>;
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>`http://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>host</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/api/features`</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>features</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>json</span>()
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>appProps</span>.<span style=color:#a6e22e>pageProps</span>[<span style=color:#e6db74>&#39;features&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>features</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> { ...<span style=color:#a6e22e>appProps</span> }
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>é€™é‚Šæœ‰ä¸€é»éœ€è¦æ³¨æ„çš„, é›–ç„¶ç”¨<code>fetch</code>, ä½†å®ƒclientç«¯, serverç«¯ç”¨çš„æ˜¯ä¸ä¸€æ¨£çš„, é›–ç„¶æ˜¯é•·ä¸€æ¨£çš„API, æ‰€ä»¥é€™é‚Šçš„URLæ˜¯ä¸å¯ä»¥ç”¨ç›¸å°è·¯å¾‘çš„("<code>/api/features</code>&rdquo;), åŸå› å°±æ˜¯åœ¨serverç«¯åªæœ‰ç›¸å°è·¯å¾‘æ˜¯ç„¡æ³•çŸ¥é“å¯¦éš›è¦å‘¼å«å“ªè£¡, æ‰€ä»¥é€™é‚Šé‚„æ˜¯çµ„å‡ºä¸€å€‹å®Œæ•´çš„URLä¾†ä½¿ç”¨(ä¸éé€™å¯¦åšæœ‰é»ä¸æ˜¯å¾ˆå¥½, éœ€è¦æ”¹, ç•¶PoCå°±ç®—äº† :p)</p><p>æ‰€ä»¥<code>WithFeature</code>å°±å¯ä»¥é•·é€™æ¨£:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ReactNode</span>, <span style=color:#a6e22e>useContext</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../context/featurecontext&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeaturesProps</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>children?</span>:<span style=color:#66d9ef>ReactNode</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>feature?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>WithFeature</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>FeaturesProps</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>features</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>useContext</span>(<span style=color:#a6e22e>FeatureContext</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>features</span>[<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span>]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>            &lt;&gt;{<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>children</span>}&lt;/&gt;)   
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> &lt;&gt;&lt;/&gt;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>WithFeature</span>
</span></span></code></pre></div><p>å› ç‚º<code>features</code>æ˜¯æ”¾åœ¨<code>FeatureContext</code>ä¸­, æ‰€ä»¥æˆ‘å€‘å¯ä»¥é€é<code>useContext</code>ä¾†å–å€¼</p><p>é€™ä½œæ³•ä¸ç®—é›£, è€Œä¸”ä¹Ÿè »å¥½é‹ç”¨, åªè¦åœ¨æ¯å€‹éœ€è¦çš„é é¢è‡ªè¡Œé‹ç”¨<code>WithFeature</code>å³å¯, ä½†ç¼ºé»æ˜¯ç”šéº¼? åŸºæœ¬ä¸Šå®ƒç®—æ˜¯CSR(Client side rendering), è€Œä¸”è¦ç”šéº¼flagéƒ½æ˜¯é€éAPIè·Ÿserverè¦, æœƒè¢«çœ‹çš„ä¸€æ¸…äºŒæ¥šå¤–, æˆ–è¨±å¯èƒ½é‚„æœ‰æ–¹æ³•å½é€ ä»¥è‡³æ–¼ä½ çš„åŠŸèƒ½ææ—©è¢«ç™¼ç¾</p><h2 id=ssr-server-side-renderingçš„ä½œæ³•>SSR (Server Side Rendering)çš„ä½œæ³•</h2><p>Next.jså¼·å¤§çš„åœ°æ–¹å°±æ˜¯å®ƒæœ‰<a href=https://nextjs.org/docs/basic-features/data-fetching>æ”¯æ´SSR(Sever side rendering)å’ŒSSG(Server side generation)</a>, å…©è€…çš„å¥½è™•å°±æ˜¯åœ¨serverç«¯å°±æŠŠé é¢å…§å®¹çµ¦ç”¢ç”Ÿå¥½</p><p>å‡è¨­æˆ‘å€‘æœ‰ä¸€é å«åš<code>Post3</code>, å¯¦ä½œæ˜¯é€™æ¨£çš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextPage</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>GetServerSideProps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Link</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/link&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>YAML</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;yaml&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>WithFeature</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../components/feature2&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>PageWithFeature</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../components/feature3&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Params</span> <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Props</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>features</span>: <span style=color:#66d9ef>any</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Post3</span>:<span style=color:#66d9ef>NextPage</span>&lt;<span style=color:#f92672>Props</span>&gt; <span style=color:#f92672>=</span> (<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>Props</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>FeatureContext.Provider</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span>{{<span style=color:#a6e22e>features</span>:<span style=color:#66d9ef>props.features</span>}}&gt;
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>PageWithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature3&#34;</span>&gt;
</span></span><span style=display:flex><span>                &lt;<span style=color:#f92672>WithFeature</span> <span style=color:#a6e22e>feature</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;feature4&#34;</span>&gt;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>feature</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>                &lt;/<span style=color:#f92672>WithFeature</span>&gt;                
</span></span><span style=display:flex><span>                &lt;<span style=color:#f92672>Link</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/&#34;</span>&gt;<span style=color:#a6e22e>HOME</span>&lt;/<span style=color:#f92672>Link</span>&gt;
</span></span><span style=display:flex><span>            &lt;/<span style=color:#f92672>PageWithFeature</span>&gt;
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>FeatureContext.Provider</span>&gt;
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>Post3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getServerSideProps</span>:<span style=color:#66d9ef>GetServerSideProps</span>&lt;<span style=color:#f92672>Props</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>Params</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>ctx</span>) <span style=color:#f92672>=&gt;</span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configFile</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;features.yaml&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yaml</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>configFile</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>YAML</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>yaml</span>.<span style=color:#a6e22e>toString</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>features</span>: <span style=color:#66d9ef>config.features</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é€™é é¢å¯ä»¥é€é<code>/post3</code>ä¾†å­˜å–å®ƒ, é€™å€‹é é¢ç”±æ–¼å¯¦åšäº†<code>getServerSideProps</code>, å› æ­¤Next.jsæœƒä½¿ç”¨SSRçš„æ¨¡å¼, é€™é‚Š<code>getServerSideProps</code>å°±å¯ä»¥ç›´æ¥è®€æª”æ¡ˆäº†</p><p>ä½†ä½¿ç”¨SSRé€™æ–¹æ³•çš„è©±, ç¼ºé»å°±æ˜¯</p><ol><li>æ¯å€‹é é¢éƒ½å¾—è‡ªå·±æŠŠè®€configåŠ å…¥<code>getServerSideProps</code></li><li>ä¹Ÿéƒ½éœ€è¦è‡ªå·±æŠŠå…§å®¹åŒ…åœ¨Context Providerå¦‚<code>&lt;FeatureContext.Provider value={{features:props.features}}></code></li></ol><p>å°±ç­‰æ–¼å¾ˆå¤šé é¢éƒ½æœƒæœ‰é‡è¤‡çš„ç¨‹å¼ç¢¼, ä¸æ˜¯é‚£éº¼ç°¡æ½”æ¼‚äº®, ä½†å„ªé»æ‡‰æ˜¯å…§å®¹åœ¨serverç«¯å°±å·²ç¶“å…ˆè™•ç†å¥½äº†</p><h2 id=pagewithfeature>PageWithFeature</h2><p>ä¸Šé¢æœ‰å·å·è—ä¸€å€‹<code>PageWithFeature</code>, é€™å€‹å¯¦åšå¯ä»¥æ˜¯é€™æ¨£:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ReactNode</span>, <span style=color:#a6e22e>useContext</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> Error <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/error&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>FeatureContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../context/featurecontext&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Offline</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./offline&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FeaturesProps</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>features?</span>:<span style=color:#66d9ef>any</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>children?</span>:<span style=color:#66d9ef>ReactNode</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>feature?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PageWithFeature</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>props</span>:<span style=color:#66d9ef>FeaturesProps</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>features</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>useContext</span>(<span style=color:#a6e22e>FeatureContext</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span>[<span style=color:#e6db74>&#39;offline&#39;</span>]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Offline</span>&gt;&lt;/<span style=color:#f92672>Offline</span>&gt;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>features</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>features</span>[<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>feature</span>]) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>            &lt;&gt;{<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>children</span>}&lt;/&gt;)   
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Error</span> <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>=</span>{<span style=color:#ae81ff>404</span>} /&gt;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>PageWithFeature</span>
</span></span></code></pre></div><p>ç”¨é€”æœ‰å…©å€‹:</p><ol><li>Disableæ™‚å°åˆ°404é é¢</li><li>å¦‚æœæ˜¯ç³»çµ±ä¸‹æ¶ç‹€æ…‹ä¸‹, å°åˆ°ä¸€å€‹æš«æ™‚åœæ­¢æœå‹™é é¢(é€™é‚Šç”¨å¦ä¸€å€‹componentä¾†è§£æ±º)</li></ol><h2 id=é–‹ç™¼æµç¨‹ä¸Šçš„æ€è€ƒ>é–‹ç™¼æµç¨‹ä¸Šçš„æ€è€ƒ</h2><p>Atlassiané€™ç¯‡ä»‹ç´¹<a href=https://www.atlassian.com/continuous-delivery/principles/feature-flags>Feature flags</a>è£¡æœ‰å¼µåœ–, æˆ‘è¦ºå¾—è »æœ‰è¶£çš„, å¯ä»¥åšç‚ºé–‹ç™¼æµç¨‹ä¸Šçš„ä¸€å€‹åƒè€ƒ:
<img src="https://wac-cdn.atlassian.com/dam/jcr:cc55dc99-ddf4-4e61-a989-db6446cfef3c/Feature%20Flag-Driven%20Development@2x.png?cdnVersion=1785" alt></p><p>Facebooké€™ç¯‡<a href=https://engineering.fb.com/2017/08/31/web/rapid-release-at-massive-scale/>Rapid release at massive scale</a>, é›–ç„¶è·ŸFeature flagsé—œä¿‚æ¯”è¼ƒä¸å¤§, ä½†ä¹Ÿè »æœ‰åƒè€ƒåƒ¹å€¼çš„</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2021-08-22 12:42:50 +0800 +0800"><a href=/%E7%94%A8Kubernetes-ConfigMap%E5%AF%A6%E7%8F%BE%E9%85%8D%E7%BD%AE%E7%9A%84%E7%86%B1%E6%9B%B4%E6%96%B0/>Aug 22, 2021</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~7 minutes</span></div><h1 class=entry-title><a href=/%E7%94%A8Kubernetes-ConfigMap%E5%AF%A6%E7%8F%BE%E9%85%8D%E7%BD%AE%E7%9A%84%E7%86%B1%E6%9B%B4%E6%96%B0/ rel=bookmark title="ç”¨Kubernetes ConfigMapå¯¦ç¾é…ç½®çš„ç†±æ›´æ–°" itemprop=url>ç”¨Kubernetes ConfigMapå¯¦ç¾é…ç½®çš„ç†±æ›´æ–°</a></h1></header><div class=entry-content><p>ç¨‹å¼é…ç½®(Configuration)çš„ç†±æ›´æ–°(hot reload)æ‡‰è©²æ˜¯å»ºç½®æœå‹™æœƒå¸¸ç¢°åˆ°ä¸€å€‹é¡Œç›®, å¸¸æœƒæœ‰ç‹€æ³éœ€è¦åœ¨ä¸å‹•ç”¨releaseå»èª¿æ•´ç¨‹å¼é…ç½®çš„ç‹€æ³, æ¯”è¼ƒå¸¸è¦‹çš„åšæ³•æ‡‰è©²æ˜¯å°‡é€™äº›é…ç½®é›†ä¸­ç®¡ç†, å› æ­¤å°±æœ‰ç›¸é—œçš„è§£æ±ºæ–¹æ¡ˆç”¢ç”Ÿåƒæ˜¯:</p><ul><li><a href=https://cloud.spring.io/spring-cloud-config/multi/multi__spring_cloud_config_server.html>Spring cloud config server</a></li><li><a href=https://github.com/Netflix/archaius>Netflix Archaius</a></li><li><a href=https://line.github.io/centraldogma/>LINE Central Dogma</a></li><li><a href=https://www.hashicorp.com/products/consul>HashiCorp Consul</a> (ä¸éè¿‘ä¾†é€™å€‹ç”¢å“å·²ç¶“è¢«å»¶ä¼¸åˆ°Service Mashçš„é ˜åŸŸå»äº†)</li><li><a href=https://azure.microsoft.com/en-us/services/app-configuration/>Azure App configuration</a></li></ul><p>çœŸè¦æ‰¾, æ‡‰è©²é‚„æœ‰, é€™ç¨®ä¸­å¤®ç®¡ç†çš„æ–¹å¼, ç„¡éå°±æ˜¯æƒ³è¦æŠŠåˆ†å¸ƒåœ¨ä¸åŒç³»çµ±çš„æ‰€æœ‰çš„è¨­å®š, åšä¸€å€‹é›†ä¸­ç®¡ç†, éš¨æ™‚å¯ä»¥é€²è¡Œç·šä¸Šæ›´æ–°, ä¸éå¸¶ä¾†çš„å•é¡Œé»å°±æ˜¯é™¤äº†è¦ç¶å®šé¸å®šç³»çµ±ç”¨ç›¸é—œçš„APIé–‹ç™¼å¤–, é€™é¡çš„æœå‹™ä¹Ÿæ˜¯æœ‰å¯èƒ½æ˜¯SPOF</p><p>åœ¨KubernetesåŸç”Ÿ(Kubernetes Native)çš„è§’åº¦ä¾†çœ‹é€™ä»¶äº‹, Kuberneteså°±æœ‰å…§å»ºConfigMap, Secret, æ˜¯å¦é‚„æœ‰å¿…è¦å°å…¥é€™é¡çš„è§£æ±ºæ–¹æ¡ˆ? åˆ©ç”¨ConfigMapæ˜¯å¦å¯ä»¥é”æˆç·šä¸Šåšç†±æ›´æ–°çš„ç›®çš„? æˆ‘çš„æƒ³æ³•æ˜¯, å¦‚æœç”¨ConfigMapåšåˆ°ç†±æ›´æ–°, é‚£éº¼æ­é… GitOps çš„æµç¨‹, é€™æ¨£å°±å¯ä»¥åšåˆ°ç°¡å–®åˆå…¼é¡§é›†ä¸­ç®¡ç†çš„ç‰¹æ€§äº†(æ›´æ–°ç´€éŒ„åœ¨gitéƒ½å¯ä»¥æŸ¥åˆ°, å¦å¤–å¯ä»¥ç”¨PRç¢ºä¿æ›´æ”¹é…ç½®çš„å®‰å…¨æ€§, é¿å…èª¤æ›´, åœ¨å¤šå¢é›†é…ç½®ä¸‹ä¹Ÿå¯ä»¥åˆ†äº«åŒä¸€å€‹git repository)</p><h2 id=ä½¿ç”¨configmap>ä½¿ç”¨ConfigMap</h2><p>é€™é‚Šæ²’ç‰¹åˆ¥è¦èªªæ˜æ€éº¼å»ç”¨ConfigMap, é‚£å€‹ <a href=https://kubernetes.io/docs/concepts/configuration/configmap/>å®˜æ–¹æ–‡ä»¶</a> å¯«å¾—å¾ˆæ¸…æ¥š, å…ˆä¾†çœ‹çœ‹ConfigMapåœ¨é…åˆPod/Deploymentçš„å…©å€‹å¸¸è¦‹ç”¨æ³•</p><p>å…ˆæ‹¿ä¸‹é¢é€™ç¯„ä¾‹ä¾†çœ‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># property-like keys; each key maps to a simple value</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>player_initial_lives</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ui_properties_file_name</span>: <span style=color:#e6db74>&#34;user-interface.properties&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># file-like keys</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>game.properties</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    enemy.types=aliens,monsters
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    player.maximum-lives=5    </span>    
</span></span><span style=display:flex><span>  <span style=color:#f92672>user-interface.properties</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    color.good=purple
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    color.bad=yellow
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    allow.textmode=true </span>    
</span></span></code></pre></div><p>ä¸Šé¢é€™å€‹ConfigMapæˆ‘å€‘å¯ä»¥åœ¨Podé€™æ¨£ä½¿ç”¨å®ƒ:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>configmap-demo-pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;sleep&#34;</span>, <span style=color:#e6db74>&#34;3600&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Define the environment variable</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>PLAYER_INITIAL_LIVES</span> <span style=color:#75715e># Notice that the case is different here</span>
</span></span><span style=display:flex><span>                                     <span style=color:#75715e># from the key name in the ConfigMap.</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>configMapKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo          </span> <span style=color:#75715e># The ConfigMap this value comes from.</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>player_initial_lives</span> <span style=color:#75715e># The key to fetch.</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>UI_PROPERTIES_FILE_NAME</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>configMapKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>ui_properties_file_name</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/config&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># You set volumes at the Pod level, then mount them into containers inside that Pod</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Provide the name of the ConfigMap you want to mount.</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>game-demo</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># An array of keys from the ConfigMap to create as files</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>items</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;game.properties&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;game.properties&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;user-interface.properties&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;user-interface.properties&#34;</span>
</span></span></code></pre></div><p>ä¸€å€‹æ˜¯ç”¨<code>valueFrom</code>æŠŠConfigMapè£¡é¢çš„è¨­å®šæ‹¿ä¾†æ”¾åœ¨ç’°å¢ƒè®Šæ•¸ä½¿ç”¨(åƒè€ƒä¸Šé¢ç¯„ä¾‹)</p><p>å¦ä¸€å€‹å‰‡æ˜¯é€é <code>volumes</code> æŠŠè¨­å®šå…§å®¹æ›è¼‰æˆæª”æ¡ˆ</p><p>ç‚ºäº†é”æˆç†±æ›´æ–°, æˆ‘å€‘æœƒæœ‰èˆˆè¶£çš„æ˜¯, ç•¶æˆ‘å€‘ConfigMapæ›´æ–°æ™‚, ç›¸å°æ‡‰çš„å…§å®¹æœƒä¸æœƒæ”¹è®Š, ç­”æ¡ˆæ˜¯åªæœ‰ç¬¬äºŒç¨®æ›è¼‰æˆæª”æ¡ˆçš„, æœƒéš¨ä¹‹æ›´æ–°, è€Œç¬¬ä¸€ç¨®, ç•¶ConfigMapæ›´æ–°æ™‚, ç›¸é—œçš„ç’°å¢ƒè®Šæ•¸æ˜¯ä¸æœƒè·Ÿè‘—è®Šçš„</p><p>è‡³æ–¼æ›è¼‰æˆæª”æ¡ˆçš„, ç•¶ConfigMapå…§å®¹åšéæ›´å‹•æ™‚, ç›¸å°æ‡‰çš„æª”æ¡ˆå…§å®¹ä¹Ÿæœƒæ›´æ–°, ä½†&mldr;ä¸æ˜¯å³æ™‚çš„, æ ¹æ“šæ–‡ä»¶</p><blockquote><p>The kubelet checks whether the mounted ConfigMap is fresh on every periodic sync. However, the kubelet uses its local cache for getting the current value of the ConfigMap. The type of the cache is configurable using the ConfigMapAndSecretChangeDetectionStrategy field in the KubeletConfiguration struct. A ConfigMap can be either propagated by watch (default), ttl-based, or by redirecting all requests directly to the API server. As a result, the total delay from the moment when the ConfigMap is updated to the moment when new keys are projected to the Pod can be as long as the kubelet sync period + cache propagation delay, where the cache propagation delay depends on the chosen cache type (it equals to watch propagation delay, ttl of cache, or zero correspondingly).</p></blockquote><p>ä¹Ÿå°±æ˜¯èªªé æœŸæœƒæœ‰æ ¹æ“šä½ è¨­å®šæ˜¯ç”¨watch, ttl-based, å…¨é€éAPIå–å¾—æ›´æ–°è·Ÿcacheæ™‚é–“é€ æˆçš„æ™‚é–“å·®, ä¹Ÿå°±æ˜¯é›–ç„¶ConfigMapä¹Ÿæ˜¯ä¸€ç¨®é›†ä¸­å¼ç®¡ç†(æ”¾åœ¨etcd), ä½†å¯¦éš›ä¸Šé‚„æ˜¯æœƒæœ‰æ•¸ç§’åˆ°æ•¸åç§’çš„æ›´æ–°æ™‚é–“å·®(æˆ‘å¯¦æ¸¬æœ€å¤šç¢°åˆ°ä¸€åˆ†é˜å¾Œæ‰æ›´æ–°)</p><p>å› æ­¤å¦‚æœéœ€è¦åšåˆ°é…ç½®çš„ç†±æ›´æ–°, é‚£æˆ‘å€‘å¯ä»¥é¸æ“‡æ˜¯ç¬¬äºŒç¨®æ›è¼‰æˆæª”æ¡ˆçš„ä½œæ³•, è—‰ç”±ç›£æ§æª”æ¡ˆå…§å®¹çš„æ”¹è®Š, å†ç”±ç¨‹å¼å»åšç†±æ›´æ–°</p><h2 id=è§€æ¸¬configmapçš„ç•°å‹•ç‹€æ³>è§€æ¸¬ConfigMapçš„ç•°å‹•ç‹€æ³</h2><p>æ—¢ç„¶æ˜¯æª”æ¡ˆ, é‚£æˆ‘å€‘å¯ä¸å¯ä»¥ç”±Linuxçš„inotifyå»ç›£æ§æª”æ¡ˆçš„ç•°å‹•ç‹€æ³? inotifyæ˜¯Linuxæ ¸å¿ƒçš„ä¸€å€‹ç³»çµ±å‘¼å«, ç¾åœ¨ä¸»æµä¼ºæœç«¯çš„ç¨‹å¼è¨­è¨ˆæ‡‰è©²ä¹Ÿæ¯”è¼ƒå°‘ç”¨Cç›´æ¥å»å‘¼å«é€™äº›System calläº†å§? ä¸é, åŸºæœ¬ä¸Šé‚„æ˜¯å¯è¡Œçš„, é€™é‚Šæœ‰ä¸€ç¯‡"<a href=https://cloud.tencent.com/developer/article/1557278>ç”¨ Sidecar åº”ç”¨ Configmap æ›´æ–°</a>", é€™é‚Šå°±ç”¨ <code>inotifywait</code> é€™å€‹æŒ‡ä»¤æ”¾åœ¨sidecarä¸­å»ç›£æ§configæª”æ¡ˆ, åœ¨æœ‰è®Šå‹•æ™‚, ç™¼é€è¨Šè™Ÿé‡å•Ÿä¸»ç¨‹åº</p><p>é€™æ–¹æ³•çš„å„ªé»æ˜¯, ç¨‹å¼å¯ä»¥ä¸ç”¨è‡ªè¡Œç›£æ§ConfigMapçš„è®ŠåŒ–, ç¼ºé»å°±æ˜¯, é‡å•Ÿé€™ä»¶äº‹æ˜¯ä¸å¯æ§çš„, ç•¶ä½ çš„æœå‹™æœ‰å¤šå€‹å¯¦é«”(instance)æ™‚, ä¹Ÿæœ‰å¯èƒ½é€™äº›å…¨éƒ¨æœƒåœ¨åŒä¸€æ™‚é–“è¢«é‡å•Ÿ, é€ æˆä½ çš„æœå‹™è¢«ä¸‹ç·š</p><p>å¦å¤–ä¸€å€‹å°±æ˜¯åœ¨ç¨‹å¼å…§è‡ªè¡Œç›£æ§, ç¾åœ¨Kuberneteså¤§è¡Œå…¶é“, å·²ç„¶æ˜¯é¡¯å­¸, å¦‚æœå·²ç¶“æ¡ç”¨å®ƒä¾†ç®¡ç†é…ç½®ç³»çµ±çš„è©±, åœ¨è¨­è¨ˆä¸Šé…åˆå®ƒä¾†åš, ä¹Ÿæ˜¯ç„¡å¯åšé, Devè¦èƒ½é‡å°Opsä¾†è¨­è¨ˆ, æ‰èƒ½çœŸçš„æœ‰DevOps, æ›´ä½•æ³é€™éƒ¨åˆ†åªéœ€è¦ç›£æ§æª”æ¡ˆ, ä¸¦ä¸éœ€è¦ç¶æ­»Kubernetes API</p><p>ç›£æ§æª”æ¡ˆç•°å‹•çš„ä½œæ³•, å„èªè¨€æœ‰è‡ªå·±åŒ…è£, golangæœ‰<a href=https://fsnotify.org/>fsnotify</a>, Javaå‰‡æœ‰nioè£¡çš„<a href=https://www.baeldung.com/java-nio2-watchservice>WatcherService</a></p><p>é€™é‚Šå…ˆä»¥Java Nioåšä¸€å€‹ç°¡å–®çš„æ¸¬è©¦(å¯¦éš›æ˜¯ä»¥Kotlinå¯¦ä½œ):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>suspend</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>watchConfig</span>(configFileName: String) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> dir:Path = Paths.<span style=color:#66d9ef>get</span>(configFileName).parent
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> fileName = Paths.<span style=color:#66d9ef>get</span>(configFileName).fileName
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> watcher = FileSystems.getDefault().newWatchService()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	dir.register(watcher, StandardWatchEventKinds.ENTRY_CREATE, StandardWatchEventKinds.ENTRY_DELETE, StandardWatchEventKinds.ENTRY_MODIFY)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>val</span> key =watcher.take()
</span></span><span style=display:flex><span>		key.pollEvents().forEach { <span style=color:#66d9ef>it</span> <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>it</span>.context() <span style=color:#f92672>==</span> fileName) {
</span></span><span style=display:flex><span>				reloadConfig()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(!key.reset()) {
</span></span><span style=display:flex><span>			key.cancel()
</span></span><span style=display:flex><span>			watcher.close()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»¥å‰é¢config mapæ›è¼‰çš„ç¯„ä¾‹ä¾†çœ‹çš„è©±, å‡è¨­, æˆ‘å€‘ç”¨ <code>watchConfig("/config/game.properties")</code> ä¾†ç›£æ§"/config/game.properties", é€™é‚Šçš„"/config/game.properties"æ˜¯ç”±ConfigMapè£¡çš„ <code>game.properties</code> ä¾†çš„, æ‰€ä»¥è®Šæ›´é€™é‚Šçš„<code>game.properties</code>, &ldquo;/config/game.properties"ä¹Ÿæœƒè·Ÿè‘—æ”¹è®Š</p><p>ä½†, ä¸Šé¢é€™æ®µç¨‹å¼æ˜¯"å®Œå…¨æ²’ç”¨çš„&rdquo;, å³ä½¿ <code>game.properties</code>å’Œ<code>/config/game.properties</code>å…§å®¹éƒ½è¢«æ”¹è®Šäº†, é€™é‚Šçš„ <code>reloadConfig()</code> ä¹Ÿå®Œå…¨ä¸æœƒè¢«è§¸ç™¼!!!! å¦‚æœä½¿ç”¨golangçš„fsnotify, ä¹Ÿæœƒæ˜¯ä¸€æ¨£çš„ç‹€æ³</p><p>ç‚ºä»€éº¼å‘¢? é›£é“æ˜¯é€™æ¨£æ›è¼‰çš„æª”æ¡ˆæœ‰å•¥ç‰¹ç•°? å…ˆä¾† <code>ls -l</code>çœ‹ä¸€ä¸‹:</p><pre tabindex=0><code>ls -l /config/game.properties
lrwxrwxrwx 1 root root 24 Aug 21 16:55 /config/game.properties -&gt; ..data/game.properties
</code></pre><p>é€™é‚Šå¯ä»¥ç™¼ç¾<code>/config/game.properties</code>æ˜¯ä¸€å€‹Symbolic linké€£åˆ°<code>..data/game.properties</code>å», é€™æ¨£å°±å°è‡´æˆ‘å€‘ç›£æ§ä¸åˆ°å®ƒå—? å…¶å¯¦é‚„ä¸åª, å†ä¾†<code>ls -l ..data</code>çœ‹çœ‹</p><pre tabindex=0><code>ls -l ..data
lrwxrwxrwx 1 root root 31 Aug 21 16:58 ..data -&gt; ..2021_08_21_16_56_33.873456784
</code></pre><p>Ok, <code>..data</code>ä¹Ÿæ˜¯ä¸€å€‹Symbolic link, æ‰€ä»¥å¯¦éš›ä¸ŠConfigMapè¢«è®Šæ›´éå¾Œ, çœŸæ­£æª”æ¡ˆè®Šæ›´å¤§guyæœƒæ˜¯é€™æ¨£çš„:</p><pre tabindex=0><code>CREATE ..2021_08_21_16_58_04.661956783
CREATE ..2021_08_21_16_58_04.661956783/game.properties
CREATE ..data_tmp (link to ..2021_08_21_16_58_04.661956783)
MOVE ..data_tmp ..data
DELETE ..2021_08_21_16_56_33.873456784
</code></pre><p>æ‰€ä»¥æˆ‘å€‘åŸæœ¬ç›´è¦ºæ‡‰è©²æœƒæ˜¯èªç‚ºå®ƒæ˜¯æœƒç›´æ¥è®Šæ›´<code>/config/game.properties</code>å…§å®¹, ä½†å¯¦éš›ä¸Š<code>/config/game.properties</code>æ˜¯ä¸€ç›´æ²’è¢«è®Šå‹•çš„, å®ƒä¸€ç›´æ˜¯ä¸€å€‹é€£çµåˆ°<code>/config/..data/game.properties</code>çš„Symbolic link, æ‰€ä»¥è§€æ¸¬å°è±¡æ˜¯ä¸å°çš„, å› æ­¤å¾—é€™æ¨£æ”¹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>suspend</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>watchConfig</span>(configFileName: String) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> path:Path = Paths.<span style=color:#66d9ef>get</span>(configFileName)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> parent:Path = path.parent
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> (Files.isSymbolicLink(path)) {
</span></span><span style=display:flex><span>		path = Files.readSymbolicLink(path)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> realParent:String = path.parent.name
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>val</span> watcher = FileSystems.getDefault().newWatchService()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	parent.register(watcher, StandardWatchEventKinds.ENTRY_CREATE, StandardWatchEventKinds.ENTRY_DELETE, StandardWatchEventKinds.ENTRY_MODIFY)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span>(<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>val</span> key =watcher.take()
</span></span><span style=display:flex><span>		key.pollEvents().forEach { <span style=color:#66d9ef>it</span> <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>it</span>.context() <span style=color:#f92672>==</span> realParent) {
</span></span><span style=display:flex><span>				reloadConfig()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(!key.reset()) {
</span></span><span style=display:flex><span>			key.cancel()
</span></span><span style=display:flex><span>			watcher.close()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é€™é‚Šçš„<code>realParent</code>å…¶å¯¦å°±æ˜¯<code>..data</code>, æœ‰è®Šå‹•çš„æœƒæ˜¯å®ƒ, æ‰€ä»¥ç›£æ§å®ƒå°±å¥½äº†</p><h2 id=ä½¿ç”¨golangçš„spf13viper>ä½¿ç”¨golangçš„spf13/viper</h2><p>å¦‚æœä½ æ˜¯ç”¨golangä¸¦ä¸”æ˜¯ç”¨sp13å¤§ç¥çš„<a href=https://github.com/spf13/viper>viper</a>, ä¾†ç®¡ç†è¨­å®šæª”, é‚£ä½ åªéœ€è¦é€é<code>viper.WatchConfig()</code>ä¾†ç›£æ§ConfigMapæ›è¼‰ä¸‹ä¾†çš„è¨­å®šæª”å°±å¥½</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>WatchConfig</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>OnConfigChange</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>e</span> <span style=color:#a6e22e>fsnotify</span>.<span style=color:#a6e22e>Event</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Config file changed:&#34;</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>é€™æ˜¯å› ç‚º<a href=https://github.com/spf13/viper>viper</a>æœ‰é‡å°é€™ä¸€ç‹€æ³ä¿®æ­£é, æœ‰èˆˆè¶£å¯ä»¥åƒè€ƒ<a href=https://github.com/spf13/viper/commit/e0f7631cf3ac7e7530949c7e154855076b0a4c17>&ldquo;WatchConfig and Kubernetes (#284)&rdquo;</a>é€™æ®µ</p><h2 id=reloader>Reloader</h2><p>å¦‚æœç¨‹å¼ä¸æƒ³é…åˆè‘—æ”¹, æˆ–å¤§éƒ¨åˆ†éƒ½æ˜¯é€éç’°å¢ƒè®Šæ•¸çš„æ–¹å¼ä¾†ä½¿ç”¨ConfigMapçš„è©±, åˆæ€•ä½¿ç”¨å‰é¢inotify sidecarçš„ä½œæ³•æœƒé€ æˆå•é¡Œ, å¸Œæœ›æœ‰æ›´å¥½çš„æ–¹å¼å»RollOut, é‚£å¯ä»¥åƒè€ƒä¸€ä¸‹<a href=https://github.com/stakater/Reloader>Reloader</a></p><p><a href=https://github.com/stakater/Reloader>Reloader</a>æœƒå»ç›£æ§ConfigMapè·ŸSecretçš„è®Šå‹•, ä¾†é‡å•Ÿè·Ÿä»–å€‘æœ‰ç›¸é—œçš„DeploymentConfigs, Deployments, Daemonsets Statefulsets å’Œ Rollouts, ç”±æ–¼å®ƒæ˜¯ä»¥Kubernetes conrtrollerçš„å½¢å¼å­˜åœ¨, ä¸¦ä¸”æ¡ç”¨Kubernetes APIå»ç›£æ§è³‡æº: <a href=https://github.com/stakater/Reloader/blob/99a38bff8ea1346191b6a96583d3fbad72573ea5/internal/pkg/controller/controller.go#L47>https://github.com/stakater/Reloader/blob/99a38bff8ea1346191b6a96583d3fbad72573ea5/internal/pkg/controller/controller.go#L47</a></p><p>å®‰è£æ–¹æ³•å¾ˆç°¡å–®, åªéœ€è¦ç”¨:</p><pre tabindex=0><code>kubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml
</code></pre><p>è£åˆ°ä½ æ‰€éœ€è¦çš„namespaceå³å¯, ç„¶å¾Œåœ¨ä½ çš„Deploymentè¨­å®šä¸ŠåŠ ä¸Šä¸€å€‹annotation <code>reloader.stakater.com/auto: "true"</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>reloader.stakater.com/auto</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>é€™æ¨£reloaderå°±æœƒå¹«ä½ ç›£æ§é€™å€‹Deploymentç”¨åˆ°ç›¸é—œçš„ConfigMapè·ŸSecret, ä¸ç®¡æ˜¯ç”¨ç’°å¢ƒè®Šæ•¸çš„æ–¹å¼, é‚„æ˜¯æ›è¼‰æª”æ¡ˆçš„æ–¹å¼, éƒ½é©ç”¨, ä¸¦ä¸”ç”±æ–¼å®ƒæ˜¯ç›´æ¥é€éKubernetes API, å› æ­¤ConfigMapæˆ–æ˜¯Secretæœ‰è®ŠåŒ–éƒ½æ˜¯å³æ™‚æœƒç›£æ¸¬åˆ°, ç„¶å¾Œå®ƒå°±æœƒç”¨rolling updateçš„æ–¹å¼å»é‡å•Ÿç›¸é—œçš„instances, ç›¸è¼ƒä¹‹ä¸‹æœƒæ¯”ç”¨sidecarçš„æ–¹å¼ä¿éšª</p></div></article><div class=pagination><ul class=inline-list><li><a href=/post/ class=btn>Previous</a></li><li><a href=/post/>1</a></li><li><strong class=current-page>2</strong></li><li><a href=/post/page/3/>3</a></li><li><a href=/post/page/4/>4</a></li><li><a href=/post/page/5/>5</a></li><li><a href=/post/page/6/>6</a></li><li><a href=/post/page/7/>7</a></li><li><a href=/post/page/8/>8</a></li><li><a href=/post/page/9/>9</a></li><li><a href=/post/page/10/>10</a></li><li><a href=/post/page/11/>11</a></li><li><a href=/post/page/12/>12</a></li><li><a href=/post/page/13/>13</a></li><li><a href=/post/page/14/>14</a></li><li><a href=/post/page/15/>15</a></li><li><a href=/post/page/16/>16</a></li><li><a href=/post/page/17/>17</a></li><li><a href=/post/page/18/>18</a></li><li><a href=/post/page/19/>19</a></li><li><a href=/post/page/20/>20</a></li><li><a href=/post/page/21/>21</a></li><li><a href=/post/page/22/>22</a></li><li><a href=/post/page/23/>23</a></li><li><a href=/post/page/24/>24</a></li><li><a href=/post/page/25/>25</a></li><li><a href=/post/page/26/>26</a></li><li><a href=/post/page/27/>27</a></li><li><a href=/post/page/28/>28</a></li><li><a href=/post/page/29/>29</a></li><li><a href=/post/page/30/>30</a></li><li><a href=/post/page/31/>31</a></li><li><a href=/post/page/32/>32</a></li><li><a href=/post/page/33/>33</a></li><li><a href=/post/page/34/>34</a></li><li><a href=/post/page/35/>35</a></li><li><a href=/post/page/36/>36</a></li><li><a href=/post/page/37/>37</a></li><li><a href=/post/page/38/>38</a></li><li><a href=/post/page/39/>39</a></li><li><a href=/post/page/40/>40</a></li><li><a href=/post/page/41/>41</a></li><li><a href=/post/page/42/>42</a></li><li><a href=/post/page/43/>43</a></li><li><a href=/post/page/44/>44</a></li><li><a href=/post/page/45/>45</a></li><li><a href=/post/page/46/>46</a></li><li><a href=/post/page/47/>47</a></li><li><a href=/post/page/48/>48</a></li><li><a href=/post/page/49/>49</a></li><li><a href=/post/page/50/>50</a></li><li><a href=/post/page/51/>51</a></li><li><a href=/post/page/52/>52</a></li><li><a href=/post/page/53/>53</a></li><li><a href=/post/page/54/>54</a></li><li><a href=/post/page/55/>55</a></li><li><a href=/post/page/56/>56</a></li><li><a href=/post/page/57/>57</a></li><li><a href=/post/page/58/>58</a></li><li><a href=/post/page/59/>59</a></li><li><a href=/post/page/60/>60</a></li><li><a href=/post/page/61/>61</a></li><li><a href=/post/page/62/>62</a></li><li><a href=/post/page/63/>63</a></li><li><a href=/post/page/64/>64</a></li><li><a href=/post/page/65/>65</a></li><li><a href=/post/page/66/>66</a></li><li><a href=/post/page/67/>67</a></li><li><a href=/post/page/68/>68</a></li><li><a href=/post/page/69/>69</a></li><li><a href=/post/page/70/>70</a></li><li><a href=/post/page/71/>71</a></li><li><a href=/post/page/72/>72</a></li><li><a href=/post/page/73/>73</a></li><li><a href=/post/page/74/>74</a></li><li><a href=/post/page/75/>75</a></li><li><a href=/post/page/3/ class=btn>Next</a></li></ul></div></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>