<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]-->
<head>
<meta charset=utf-8>
<title>Posts &#8211; Le murmure de Julian</title>
<meta name=description content>
<meta property="og:title" content="Posts">
<meta property="og:description" content>
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.jln.co/post/"><meta property="og:image" content="https://blog.jln.co/images/avatar.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.jln.co/images/avatar.png">
<meta name=twitter:title content="Posts">
<meta name=twitter:description content>
<link rel=canonical href=https://blog.jln.co/post/>
<link href=https://blog.jln.co/post/feed.xml rel=alternate type=application/rss+xml title="Le murmure de Julian">
<link href=https://blog.jln.co/post/feed.xml rel=feed type=application/rss+xml title="Le murmure de Julian">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet href=/css/main.css>
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css>
<meta http-equiv=cleartype content="on">
<meta name=generator content="Hugo 0.88.1">
<script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png>
</head>
<body id=post-index class=feature>
<nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block>
<button class=dl-trigger>Open Menu</button>
<ul class=dl-menu>
<li><a href=/>Home</a></li>
<li>
<a href=#>About</a>
<ul class=dl-submenu>
<li>
<img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo>
<h4>Julian Shen</h4>
<p>Softward developer</p>
</li>
<li>
<a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a>
</li>
<li>
<a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
</li>
<li>
<a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a>
</li>
<li>
<a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a>
</li>
</ul>
</li>
<li>
<a href=#>Posts</a>
<ul class=dl-submenu>
<li><a href=/post/>All Posts</a></li>
<li><a href=/tags/>All Tags</a></li>
</ul>
</li>
<li><a href=/></a></li>
</ul>
</nav>
<div class=entry-header>
<div class=image-credit>Image credit: <a href=http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/>dargadgetz</a></div>
<div class=entry-image>
<img src=/abstract-2.jpg alt=Posts>
</div>
<div class=header-title>
<div class=header-title-wrap>
<h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1>
<h2>
All posts
</h2>
</div>
</div>
</div>
<div id=main role=main>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-08-12 15:54:06 +0800 +0800"><a href=/%E6%B5%81%E7%A8%8B%E5%9C%96%E7%9A%84%E5%A5%BD%E5%B9%AB%E6%89%8B-vscode-%E6%95%B4%E5%90%88-Drawio/>Aug 12, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~1 minute
</span>
</div>
<h1 class=entry-title><a href=/%E6%B5%81%E7%A8%8B%E5%9C%96%E7%9A%84%E5%A5%BD%E5%B9%AB%E6%89%8B-vscode-%E6%95%B4%E5%90%88-Drawio/ rel=bookmark title="流程圖的好幫手: vscode 整合 Drawio" itemprop=url>流程圖的好幫手: vscode 整合 Drawio</a></h1>
</header>
<div class=entry-content>
<p>本來我寫blog畫流程圖都用<a href=https://github.com/mermaid-js/mermaid>Mermaid</a>, 不過由於不好預覽, 要畫比較複雜的圖也有點麻煩</p>
<p><a href=https://app.diagrams.net/>Draw.io</a>是一個不錯的免費工具, 蠻便利好用的, 但缺點就是是網頁版的, 要跟平常寫文章的流程整合比較不方便, 由於我是在vscode上寫文章的, 所以發現了 <a href="https://marketplace.visualstudio.com/items?itemName=hediet.vscode-drawio">Draw.io Integration</a> 這個vscode的extension, 蠻方便的</p>
<p><img src=https://raw.githubusercontent.com/hediet/vscode-drawio/2387501b949e43692efa027eb82255f3d060d8c3/docs/drawio-png.gif alt></p>
<p>除了可以直接在vscode上編輯流程圖外, 如果你的檔名是"XXXX.drawio.png", 或是 &ldquo;XXXX.drawio.svg&rdquo; 畫完後就直接輸出成png/svg, 就可以直接拿來用了, 有問題也可以直接改, 不用轉檔轉來轉去的</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-08-12 00:35:55 +0800 +0800"><a href=/%E4%BD%BF%E7%94%A8-OpenTelemetry-%E8%B7%A8%E4%B8%8D%E5%90%8C%E5%B9%B3%E5%8F%B0%E8%BF%BD%E8%B9%A4-Thrift-Rpc/>Aug 12, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~12 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E4%BD%BF%E7%94%A8-OpenTelemetry-%E8%B7%A8%E4%B8%8D%E5%90%8C%E5%B9%B3%E5%8F%B0%E8%BF%BD%E8%B9%A4-Thrift-Rpc/ rel=bookmark title="使用 OpenTelemetry 跨不同平台追蹤 Thrift Rpc" itemprop=url>使用 OpenTelemetry 跨不同平台追蹤 Thrift Rpc</a></h1>
</header>
<div class=entry-content>
<p>在離職前一周研究的一個小題目, 說小其實也蠻難搞的, 搞到這兩天重新看, 才釐清完整做法</p>
<p>難搞的原因有幾個, 雖然<a href=https://opentelemetry.io/>OpenTelemetry</a>有支援<a href=https://grpc.io/>gRPC</a>, 但對於 <a href=http://thrift.apache.org/>Thrift</a> 就沒人做相關的支援了, 再來就是系統環境跨了nodejs和<a href=https://twitter.github.io/finagle/>Finagle</a>/Scala兩種平台, Thrift 是用在這兩者之間的溝通, Finagle雖是有支援<a href=https://zipkin.io/>ZipKin</a><a href=https://twitter.github.io/finagle/guide/Tracing.html>做分散式追蹤</a>, 但那僅限於Finagle client呼叫Finagle server的部分才有支援在這之間傳遞追蹤資訊, 跨nodejs (client) 到 Finagle (server), 這邊也一樣找不到啥資訊</p>
<p>所以這邊主要會想做到的:</p>
<ol>
<li>自動插入追蹤的程式碼</li>
<li>在 Thrift client/server 間傳遞追蹤資訊 (client/server不同平台)</li>
</ol>
<p>大致上的原理有做過些小實驗, 確定應該可行, 只是懶得把整套完整做好就是了</p>
<h2 id=分散式追蹤-distributed-tracinghttpslightstepcomdistributed-tracing><a href=https://lightstep.com/distributed-tracing/>分散式追蹤 Distributed Tracing</a></h2>
<p>在大型的分散式系統, 一個從使用者端來的request通常都會被分發到不同的系統去做處理, 尤其現在大多流行微服務(Micro services)架構, 這種狀況相當的常見, 當問題發生的時候, 到底甚麼時間點在哪個系統, 碰到甚麼事, 要追查原因便得從這麼多系統分散且看不出關聯性的log去想辦法分析出來, 因此導入分散式追蹤, 就是為了解決這問題</p>
<p>最早出現應該是Google內部使用的Dapper, 也有發表相關的<a href=https://static.googleusercontent.com/media/research.google.com/en//archive/papers/dapper-2010-1.pdf>論文</a>, 開源的部分, 早期又有Twitter的<a href=https://zipkin.io/>ZipKin</a>和Uber的<a href=https://www.jaegertracing.io/>Jaeger</a>, 前面有提到的<a href=https://twitter.github.io/finagle/>Finagle</a>, 由於也是Twitter開源出來的應用程式框架, 所以<a href=https://twitter.github.io/finagle/>Finagle</a>出廠就支援<a href=https://zipkin.io/>ZipKin</a>也是理所當然的</p>
<p>後來又出現想要大一統的<a href=https://opentracing.io/>OpenTracing</a>和<a href=https://opencensus.io/>OpenCensus</a>, 這兩個後來又被大一統到這邊所要提到的<a href=https://opentelemetry.io/>OpenTelemetry</a></p>
<p>做Distributed Tracing雖然對追問題會有幫助, 但要導入並不見的容易, 先是要在所有要追蹤的插入追蹤程式碼, 對於既有系統的改動幅度自是不小, 此外, 早期, 不管是<a href=https://zipkin.io/>ZipKin</a>和Uber的<a href=https://www.jaegertracing.io/>Jaeger</a>還是<a href=https://www.jaegertracing.io/>Jaeger</a>考量的主要還是REST API的架構, REST是透過HTTP傳輸的, 因此在設計上, 就可以透過HTTP header帶追蹤相關資訊, 但在一個複雜的分散式系統, 可能包含不同的通訊協定, 像是REST, GraphQL, gRPC, Thrift, 或是呼叫資料庫之類的, 不見得都是透過HTTP, 那怎麼傳遞追蹤資訊就是個問題, 跨系統間如果無法分享追蹤資訊, 那也是白搭</p>
<h2 id=opentelemetryhttpsopentelemetryio><a href=https://opentelemetry.io/>OpenTelemetry</a></h2>
<p><a href=https://opentelemetry.io/>OpenTelemetry</a>其實也不是只有支援Distributed Tracing, 它能處理的資料型態, 主要就有下面這幾種:</p>
<ol>
<li>Traces</li>
<li>Metrics</li>
<li>Logs</li>
</ol>
<p>也就是說除了追蹤資訊, 它也囊括了系統狀態跟Logs, 另外也支援很多不同語言, 算是野心蠻大的, 這邊來看一下它的架構:</p>
<p><img src=https://raw.github.com/open-telemetry/opentelemetry.io/main/iconography/Reference_Architecture.svg alt></p>
<p>主要它包含了兩部分, 一個是各程式語言使用的程式庫 - OT Library, 另一個是蒐集資訊的Collector, 而Collector是這樣的:</p>
<p><img src=https://raw.github.com/open-telemetry/opentelemetry.io/main/iconography/Otel_Collector.svg alt></p>
<p>Collector包含了Receiver, Processor, Exporter, 這架構讓它有能力相容/支援不同的系統, 所以像是Finagle這種本來就有支援ZipKin的, 其實只要把原本倒到ZipKin的資料轉倒到OpenTelemetry的Collector就好, 這邊算是好解決, 如果系統是跑在K8S這類的環境上的話, 也可以考慮把Collector
當成sidecar來佈署</p>
<p>而各程式語言的程式庫的部分, 方便的是在某些程式語言有支援所謂的auto instrumentation, 針對有支援的程式庫或是框架, 可以在不寫任何程式碼或是寫少少的程式碼, 就可以達到分散式追蹤的目的(聽來有點玄), 像是Java就<a href=https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md#libraries--frameworks>支援了這些</a>(請參考連結), 而<a href=https://github.com/open-telemetry/opentelemetry-js-contrib>Javascript有這些</a>(請參考連結)</p>
<p>但畢竟沒有甚麼是萬能的, 沒支援的還是得靠自己手動插追蹤的程式碼, 或是想辦法支援, 像是這篇正題的部分, 這邊想要追蹤從nodejs呼叫Finagle的部分, 就沒辦法使用現成的 (實際狀況更複雜, nodejs本身是graphql server, Finagle server又可能呼叫ElasticSearch或Kafka, 如果想全部串起來, 不算小, 這邊主要針對 nodejs &lt;-> Finagle部分)</p>
<h2 id=在nodejs下用opentelemetry做tracing>在Node.JS下用OpenTelemetry做Tracing</h2>
<p>基本使用上其實相當簡單, 可以參考這個<a href=https://opentelemetry.io/docs/js/getting_started/nodejs/>連結</a>, 先用一個小範例來解釋:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>HttpInstrumentation</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation-http&#39;</span>);
<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>GrpcInstrumentation</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation-grpc&#39;</span>);
<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ExpressInstrumentation</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation-express&#39;</span>);
<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ConsoleSpanExporter</span>, <span style=color:#a6e22e>SimpleSpanProcessor</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/tracing&#39;</span>);
<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>NodeTracerProvider</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/node&#39;</span>);
<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>registerInstrumentations</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/instrumentation&#39;</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NodeTracerProvider</span>();

<span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>addSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SimpleSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ConsoleSpanExporter</span>()));
<span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>register</span>();

<span style=color:#a6e22e>registerInstrumentations</span>({
  <span style=color:#a6e22e>instrumentations</span><span style=color:#f92672>:</span> [
      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>HttpInstrumentation</span>(), 
      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GrpcInstrumentation</span>(),
      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ExpressInstrumentation</span>()
      ],
});
</code></pre></div><p>以這範例來說, 它打開了支援http, grpc, express等程式庫的auto instrumentation, 亦即在你的程式中如果有用到這幾個程式庫, 它會自動加上對應的追蹤程式碼, 你不用額外做任何事, 從client到server都處理好, 或是你也可以像文件中用:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// This will automatically enable all instrumentations
</span><span style=color:#75715e></span><span style=color:#a6e22e>registerInstrumentations</span>({
  <span style=color:#a6e22e>instrumentations</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>getNodeAutoInstrumentations</span>()],
});
</code></pre></div><p><code>getNodeAutoInstrumentations()</code>包含了底下這幾種的資源:</p>
<ul>
<li><code>@opentelemetry/instrumentation-dns': DnsInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-express': ExpressInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-graphql': GraphQLInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-grpc': GrpcInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-http': HttpInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-ioredis': IORedisInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-koa': KoaInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-mongodb': MongoDBInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-mysql': MySQLInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-pg': PgInstrumentation</code></li>
<li><code>@opentelemetry/instrumentation-redis': RedisInstrumentation</code></li>
</ul>
<p>建議如果沒要追蹤這麼多東西的話, 還是一個個加就好, 畢竟資訊多雜訊也多</p>
<p>在這邊:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>NodeTracerProvider</span>();
<span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>addSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SimpleSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ConsoleSpanExporter</span>()));
</code></pre></div><p>這兩行是建立Trace Provider, 告訴它要用哪個Processor或哪個Exporter去處理追蹤資訊, 這跟前面提到的Collector的架構上大致類似, 這邊用的是Consle exporter,也就是追蹤資訊會被直接印在螢幕上, 如果想輸出到ZipKin或是Jaeger就用相對應的Exporter就可以了, 或者也可以用OTLP的Exporter直接輸出到OpenTelemetry的collector</p>
<p>但這是在有支援的狀況下, 如果沒有呢? 就得手動去插了, 看一下下面這範例:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>opentelemetry</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@opentelemetry/api&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tracer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>opentelemetry</span>.<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>getTracer</span>(<span style=color:#e6db74>&#39;example-basic-tracer-node&#39;</span>);

<span style=color:#75715e>// Create a span. A span must be closed.
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>span</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>startSpan</span>(<span style=color:#e6db74>&#39;main&#39;</span>);
<span style=color:#a6e22e>doWork</span>();
<span style=color:#75715e>// Be sure to end the span.
</span><span style=color:#75715e></span><span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>end</span>();
</code></pre></div><p>這是簡單追蹤一個程序的方法, 在這範例是<code>doWork()</code>, 這邊就可以追蹤從<code>startSpan</code>到<code>end</code>之間的耗費的時間了, 針對沒有支援auto instrumentation, 或是你想額外在你程式內追蹤些別的, 那就得用這種方式在需要追蹤的地方加入這些</p>
<p>很不幸的, 目前不管哪個語言, Java, Javascript, 都沒支援Thrift相關的, 所以如果要追蹤 Thrift, 可能就得是這樣, 除了可能需要改不少地方外, 插入這些code其實也不太好看啦 :p</p>
<h2 id=追蹤-thrift-rpc>追蹤 Thrift RPC</h2>
<p>Thrift算是一個有點歷史的RPC框架(framework)了, 雖然應該還有不少大公司像是Twitter, Facebook, LINE, LinkedIn還有在使用, 不過現在大家大部分應該是比較常用比較潮的gRPC, 比較少用Thrift了, 所以在OpenTelemetry這種新東西找不到支援應該也情有可原</p>
<p>為了比較好確認解決這問題的概念是怎樣, 這邊先把問題/架構先簡化如下:</p>
<ol>
<li>Thrift client: 跑在nodejs下, 以typescript開發</li>
<li>Thrift server: 跑在Twitter Finagle框架, 以scala開發 (事實上, 我也有實做一個go版本的server, 不過先不在這討論)</li>
</ol>
<p>所以這邊會需要知道的是:</p>
<ol>
<li>client呼叫每個Thrift call需要的時間</li>
<li>在server上每個call又對應哪些呼叫或花費</li>
</ol>
<p>用以下ZipKin這張圖來當範例, 就可以這樣一層層追蹤下去</p>
<p><img src=/images/posts/2021-08-12-11-43-50.png alt=ZipKin></p>
<p>Client部分雖然可以使用手工插入tracing相關的程式碼, 但當然還是做成自動的最好, 而且client必須要可以把相關的trace ID, span ID給傳遞到server, 要不然線索就會斷掉了</p>
<p>為了達到這目標, 首先我們先來看一下Thrift從Client到Server經過哪些地方:</p>
<p><img src=/images/posts/thrift.drawio.png alt=Thrift></p>
<p>從這圖看來, 可能可以插入追蹤碼的點可以是產生出來的Client code或是TProtocol的位置(為何?後面再提)</p>
<p>在前面我也寫了一篇"<a href=https://blog.jln.co/%E5%9C%A8nodejs%E4%BD%BF%E7%94%A8typescript%E5%91%BC%E5%8F%ABthrift-client/>在nodejs使用typescript呼叫thrift client</a>&ldquo;裡面有提到利用<code>thrift -r --gen js:ts smaple.thrift</code>來產生nodejs用的client code</p>
<p>以下面這個Thrift IDL來當範例:</p>
<pre tabindex=0><code>namespace java sample.thrift
#@namespace scala sample.thrift
namespace go rpc

service SampleService {
    string hello(1: i64 a, 2: i64 b)
    void hello2()
}
</code></pre><p>用<code>thrift -r --gen js:ts sample.thrift</code>就可以產生四個檔案, 分別是:</p>
<ol>
<li>sample_types.js</li>
<li>sample_types.d.ts</li>
<li>SampleService.js SampleService的定義</li>
<li>SampleService.d.ts SampleService的javascript實作(Client + Processor)</li>
</ol>
<p>再仔細去看SampleService.js, 以hello這個method為例, 你會發現在 <code>SampleServiceClient</code> 裡關於hello的部分有三部分:</p>
<ol>
<li><code>hello(a, b, callback)</code> 實際給程式呼叫的介面, 這邊回傳是個Promise</li>
<li><code>send_hello(a, b)</code> 會由hello去呼叫, 實際上負責傳遞呼叫的相關資訊</li>
<li><code>recv_hello(input,mtype,rseqid)</code> 當send_hello送出呼叫資訊到server後, Connection會等到Server回應後, 會呼叫 recv_functionname, 去處理回傳回來的資訊</li>
</ol>
<p>另外在 <code>send_hello</code> 的一開始會去呼叫 <code>output.writeMessageBegin('hello', Thrift.MessageType.CALL, this.seqid());</code> , 這邊的output是TProtocol, 在呼叫 <code>recv_hello</code> 之前則是會呼叫 <code>input.readMessageBegin()</code> 這邊也可以得到呼叫的method的資訊</p>
<p>由上面的線索看來, 可以插入追蹤程式碼可能的幾個點:</p>
<ol>
<li><code>hello(a, b, callback)</code> 的一開始到Promise結束</li>
<li><code>send_hello(a, b)</code>到<code>recv_hello(input,mtype,rseqid)</code>的結束</li>
<li><code>writeMessageBegin</code> 到 <code>readMessageBegin</code></li>
</ol>
<p>這邊問題在於 <code>hello</code>, <code>send_hello</code>, <code>recv_hello</code>都是由<code>thrift</code>這個指令產出的, 而<code>writeMessageBegin</code>, <code>readMessageBegin</code>則是在thrift的程式庫內</p>
<p>我們要怎樣在裡面插入追蹤的程式碼?或是有沒辦法做到auto instrumentation那樣?</p>
<h2 id=javascript-auto-instrumentation-in-opentelemetry>Javascript auto instrumentation in OpenTelemetry</h2>
<p>OpenTelemetry其實是有開放介面給大家去開發相關的auto instrumentation, 不過這一塊實在看得有點頭痛, 沒文件, 又不好懂, 我最後沒採用這方法實作, 但因為在這邊花了不少時間, 還是簡單的介紹一下</p>
<p>前面有提到的有許多auto instrumentation的實作, 都是被放到 <a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>opentelemetry-js-contrib/plugins/node</a>, 也就是說你可以用一樣的方法做出自己的auto instrumentation</p>
<p>其架構的原始碼可以參考<a href=https://github.com/open-telemetry/opentelemetry-js/tree/4a1f2e5fd441cc9c0359d6aaff1919d9c6672682/packages/opentelemetry-instrumentation>opentelemetry-js/packages/opentelemetry-instrumentation</a>, 至於如何去寫一個plugin則可以參考 <a href=https://reachmnadeem.wordpress.com/2021/02/22/opentelemetry-automatic-instrumentation-of-a-nodejs-library/>這篇</a></p>
<p>基本的plugin大致上像這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>mssql</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;mypackage&#39;</span>;
<span style=color:#66d9ef>import</span> {
    <span style=color:#a6e22e>InstrumentationBase</span>,
    <span style=color:#a6e22e>InstrumentationConfig</span>,
    <span style=color:#a6e22e>InstrumentationModuleDefinition</span>,
} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@opentelemetry/instrumentation&#39;</span>;
 
<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>InstrumentationConfig</span> ;
 
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MYPlugin</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>InstrumentationBase</span>&lt;<span style=color:#f92672>typeof</span> <span style=color:#a6e22e>mypackage</span>&gt; {
       
    <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>init</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>InstrumentationModuleDefinition</span>&lt;<span style=color:#f92672>any</span>&gt; <span style=color:#f92672>|</span> <span style=color:#a6e22e>InstrumentationModuleDefinition</span>&lt;<span style=color:#f92672>any</span>&gt;[] {
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Method not implemented.&#39;</span>);
    }
}
</code></pre></div><p>Plugin必須繼承自InstrumentationBase, 最好的範例應該是 <a href=https://github.com/open-telemetry/opentelemetry-js/blob/4a1f2e5fd441cc9c0359d6aaff1919d9c6672682/packages/opentelemetry-instrumentation-http/src/http.ts>http的instrumentation的實作</a>, 在這裏面, 你會看到像是:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_wrap</span>(
          <span style=color:#66d9ef>module</span><span style=color:#a6e22e>Exports</span>,
          <span style=color:#e6db74>&#39;request&#39;</span>,
          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_getPatchOutgoingRequestFunction</span>(<span style=color:#e6db74>&#39;http&#39;</span>)
        );
</code></pre></div><p>這目的就是為了把原本的函數替換成包裝過有插追蹤碼的程式, 原理其實很容易理解, 而它是用了 <a href=https://github.com/othiym23/shimmer/>shimmer</a> 這個package, 來達到這個替換的目的, 實際上去看 <a href=https://github.com/othiym23/shimmer/>shimmer</a>, 也並不是一個很複雜的做法就是了</p>
<p>本來我是考慮寫一個plugin來處理Thrift client的部分, 原本的考量點是, 由於 <a href=https://github.com/othiym23/shimmer/>shimmer</a> 需要先知道method的名字才能替代, 所以 <code>hello</code>, <code>send_hello</code>, <code>recv_hello</code> 就不適合用來做包裝, 畢竟要做也是要做一個通用的, 不然試作後, 單純包裝 <code>hello</code> 其實算容易 (在呼叫原版本hello前先startSpan, 並把span.end包裝到回傳的Promise), 所以適合用在這邊的可能是包裝 <code>TProtocol.writeMessageBegin</code>, <code>TProtocol.readMessageBegin</code> ,不過這邊一直弄不成功, 可能也沒搞很懂instrumentation plugin, 後來又發現更簡便的做法就先放棄</p>
<h2 id=從-thift-generator-下手>從 thift generator 下手</h2>
<p>在用 <a href=https://github.com/othiym23/shimmer/>shimmer</a> 包裝 <code>hello</code> 時, 發現了一個問題, 由於我是用 typescript 而非javascript 在做這個實驗, typescript會去做型別檢查, 本來Javascript版本的 <code>hello</code> 的回傳是Promise, 但我在定義wrapped function的時候, 回傳型別設成
<code>Promise&lt;string></code> 則是會報錯, 結果實際上去看產生的程式碼:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#a6e22e>hello</span>(<span style=color:#a6e22e>a</span>: <span style=color:#66d9ef>Int64</span>, <span style=color:#a6e22e>b</span>: <span style=color:#66d9ef>Int64</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>;
</code></pre></div><p>這完全是錯的, 也就是由Apache thrift這個工具產生的typescript是有問題的</p>
<p>想到在Scala中, 產生Thrift相關程式碼是用scrooge並不會去用官方Apache thrift的工具, typescript會不會也有像scrooge這工具? 結果就找到了<a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>creditkarma/thrift-typescript</a></p>
<p>這個專案也是蠻有趣的, 它是透過 <a href=https://github.com/Microsoft/TypeScript/wiki/Using-the-Compiler-API>Typescript compiler API</a>, 把Thrift IDL完全轉成typescript程式碼, 跟官方工具不同的地方是, 它產生的是純typecsript實做, 而非javascript實做搭配typescript定義, 因此產生的程式碼也好讀多了</p>
<p>所以我想, 何必一定糾結在auto instrumentation, 從code generator 去修改也是一個可行的做法, 要做到這件事, 那就要先看看, 我們預期它產生怎樣的程式碼, 於是我就去修改產生的程式碼來實驗, 像這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Client</span> {
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>_seqid</span>: <span style=color:#66d9ef>number</span>;
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>_reqs</span><span style=color:#f92672>:</span> {
        [<span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>number</span>]<span style=color:#f92672>:</span> (<span style=color:#a6e22e>err</span>: <span style=color:#66d9ef>Error</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>object</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span>, <span style=color:#a6e22e>val?</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>;
    };
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>output</span>: <span style=color:#66d9ef>thrift.TTransport</span>;
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>protocol</span>: <span style=color:#66d9ef>new</span> (<span style=color:#a6e22e>trans</span>: <span style=color:#66d9ef>thrift.TTransport</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TProtocol</span>;
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>tracer</span>:<span style=color:#66d9ef>opentelemetry.Tracer</span>;
    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>serverSupportTracing</span>: <span style=color:#66d9ef>boolean</span>;

    <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>output</span>: <span style=color:#66d9ef>thrift.TTransport</span>, <span style=color:#a6e22e>protocol</span>: <span style=color:#66d9ef>new</span> (<span style=color:#a6e22e>trans</span>: <span style=color:#66d9ef>thrift.TTransport</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TProtocol</span>) {
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_seqid</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_reqs</span> <span style=color:#f92672>=</span> {};
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>output</span>;
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>protocol</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>protocol</span>;
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tracer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>opentelemetry</span>.<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>getTracer</span>(<span style=color:#e6db74>&#39;SampleServiceClient&#39;</span>);
        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>serverSupportTracing</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
    }
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>incrementSeqId</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_seqid</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
    }
    
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>hello</span>(<span style=color:#a6e22e>a</span>: <span style=color:#66d9ef>Int64</span>, <span style=color:#a6e22e>b</span>: <span style=color:#66d9ef>Int64</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt; {
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>incrementSeqId</span>();
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>span</span>:<span style=color:#66d9ef>opentelemetry.Span</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>startSpan</span>(<span style=color:#e6db74>&#34;hello&#34;</span>);
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt;((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>=&gt;</span> {
            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_reqs</span>[<span style=color:#a6e22e>requestId</span>] <span style=color:#f92672>=</span> (<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>result</span>) <span style=color:#f92672>=&gt;</span> {
                <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_reqs</span>[<span style=color:#a6e22e>requestId</span>];
                
                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
                    <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>error</span>);
                }
                <span style=color:#66d9ef>else</span> {
                    <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>result</span>);
                }
                <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>end</span>();
            };
            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>send_hello</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>requestId</span>);
        });
    }
}
</code></pre></div><p>這一段程式碼是截自 <a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>creditkarma/thrift-typescript</a> 從我的IDL產生的程式碼, 加上了tracer跟span, <code>startSpan</code>和<code>span.end</code>就插在hello裡面</p>
<p>這一段先用手工插入實驗後沒問題, 接下來我們就可以去改 <a href=https://github.com/open-telemetry/opentelemetry-js-contrib/tree/main/plugins/node>creditkarma/thrift-typescript</a> 讓程式自動去產生</p>
<p>由於這邊牽涉多一點, 我就不一一解釋, 貼上我修改的<a href=https://github.com/julianshen/thrift-typescript/commit/5f2ebeb85f6e639be11d5184f5470ca8d4d466b9>commit</a>, 大家有興趣可以參考 : <a href=https://github.com/julianshen/thrift-typescript/commit/5f2ebeb85f6e639be11d5184f5470ca8d4d466b9>https://github.com/julianshen/thrift-typescript/commit/5f2ebeb85f6e639be11d5184f5470ca8d4d466b9</a></p>
<p>這樣一來, 產生我們要的client code就沒啥問題了</p>
<h2 id=傳遞追蹤資訊>傳遞追蹤資訊</h2>
<p>前面有提到<a href=https://twitter.github.io/finagle/>Finagle</a>有支援Zipkin Tracing, 只有client和server都是Finagle才可以在Thrift間傳遞追蹤資訊, 那實際上Finagle又是怎做的呢? 它的做法是在Thrift的通訊協定上做了一些小修改, 先來看看底下這三張圖</p>
<p><img src=/images/posts/twitterthrift.drawio.png alt="Twitter Thrift"></p>
<p>第一張是通常狀況, 在兩端都不支援傳遞追蹤資訊, 或是Client不支援, 就是走正常的路線, 第二三張則是在Client有支援(Finagle client), client會先送<code>__can__finagle__trace__v3__</code>這個呼叫確認server有支援, server如果有支援的話, 就會回傳正確的結果, 如果沒支援則會是 <code>UNKNOW_METHOD</code></p>
<p>Client在確認server有支援後, 後面的request就會先多帶一個header包含Tracing相關的資訊了</p>
<p>這部分, 我目前也只實做go版本的server, client版本尚未做, 這邊會需要做的部份包含:</p>
<ol>
<li>呼叫 <code>__can__finagle__trace__v3__</code> 確認是否支援tracing</li>
<li>將client端的tracing資訊帶入相關的header中</li>
</ol>
<p>如果client是用OpenTelemetry, 而server這邊是用Finagle加zipkin的話, 就得要注意Trace ID, Span ID的轉換, 這兩邊用的長度跟型別有點不太一樣, 轉換的範例如下:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>UInt64ToTraceID</span>(<span style=color:#a6e22e>high</span>, <span style=color:#a6e22e>low</span> <span style=color:#66d9ef>uint64</span>) <span style=color:#a6e22e>pdata</span>.<span style=color:#a6e22e>TraceID</span> {
	<span style=color:#a6e22e>traceID</span> <span style=color:#f92672>:=</span> [<span style=color:#ae81ff>16</span>]<span style=color:#66d9ef>byte</span>{}
	<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>.<span style=color:#a6e22e>PutUint64</span>(<span style=color:#a6e22e>traceID</span>[:<span style=color:#ae81ff>8</span>], <span style=color:#a6e22e>high</span>)
	<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>BigEndian</span>.<span style=color:#a6e22e>PutUint64</span>(<span style=color:#a6e22e>traceID</span>[<span style=color:#ae81ff>8</span>:], <span style=color:#a6e22e>low</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pdata</span>.<span style=color:#a6e22e>NewTraceID</span>(<span style=color:#a6e22e>traceID</span>)
}
</code></pre></div><p>(Source: <a href=https://github.com/open-telemetry/opentelemetry-collector/blob/6ae558c8757cad4ed29f7c9496b38827990f156f/internal/idutils/big_endian_converter.go#L24>https://github.com/open-telemetry/opentelemetry-collector/blob/6ae558c8757cad4ed29f7c9496b38827990f156f/internal/idutils/big_endian_converter.go#L24</a>)</p>
<p>只要在把這整段整合到code generator, 應該就可以大功告成了</p>
<p>雖然一開始覺得是個小題目, 沒想到居然讓我用這麼大篇幅介紹, 而且全部實做還沒完成, 看來是有點太過低估了</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-08-09 20:24:52 +0800 +0800"><a href=/%E5%84%AA%E5%8C%96-Open-Graph-Image/>Aug 9, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~7 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E5%84%AA%E5%8C%96-Open-Graph-Image/ rel=bookmark title="優化 Open Graph Image" itemprop=url>優化 Open Graph Image</a></h1>
</header>
<div class=entry-content>
<p>在<a href=http://blog.jln.co/%E7%94%A8Hugo-GitHub-Actions%E6%89%93%E9%80%A0Blog/>之前一篇</a>寫用Hugo打造blog有提到, 寫了一個<a href=https://github.com/julianshen/myblog_hugo/tree/master/ogp>小工具來產生open graph image</a>, 但由於這個是一個command line工具, 而我又是把它放在 git pre-commit 去觸發並寫回檔案, 感覺不是那麼乾淨, 因此我又有另一個想法想把它寫成一個服務, 順便又思考了一下, 怎樣的圖片比較適合OG(Open Graph)</p>
<h2 id=為什麼要設定-open-graph-image>為什麼要設定 Open Graph Image</h2>
<p>這邊並沒有要探討<a href=https://ogp.me/>Open Graph</a>是什麼, 怎麼去使用, 這應該可以找到其他相關的文章或是參考官網 <a href=https://ope.me/>https://ope.me/</a></p>
<p>目前OG會影響到的, 大概就是被分享到社群的文章/網頁, Facebook跟Twitter都支援OG來產生分享到Timeline上的預覽, Twitter則是另外支援它自己的<a href=https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/abouts-cards>Twitter Card</a>, 而這其中 og:image 會影響到分享後的版面</p>
<p>首先, 這邊先介紹一下工具, 如果要先預覽Facebook分享出去的結果可以使用Facebook提供的 <a href=https://developers.facebook.com/tools/debug/>分享偵錯工具</a>, Twitter部分則可使用<a href=https://cards-dev.twitter.com/validator>Card validator</a></p>
<p>先來看看沒設定og:image的版面是怎樣一個狀況?</p>
<p><img src=/images/posts/og/og_sample_no_image.jpg alt="OG No Image"></p>
<p><img src=/images/posts/og/tc_sample_no_image.jpg alt="Twitter card No Image"></p>
<p>前面一個是分享到Facebook上的版面, 後一個則是在Twitter上會看到的, 很明顯的版面偏小, 不起眼, 分享出去後應該也引不起使用者點擊的慾望</p>
<p>這邊Twitter跟Facebook不太一樣的地方是, Facebook決定大小版面是以og:image的大小來決定的, 大版面的圖片需要有1200x630的解析度, 但對Twitter來說, 你如果設定Twitter card的型別是 <strong>&ldquo;summary_large_image&rdquo;</strong> , 那就會選擇使用大版面來顯示, 因此如果圖不是很大的話, 會像下個範例:</p>
<p><img src=/images/posts/og/og_sample_small.jpg alt="OG Small"></p>
<p><img src=/images/posts/og/tc_sample_small.jpg alt="Twitter card small Image"></p>
<p>這邊Twitter card使用的是 <strong>&ldquo;summary_large_image&rdquo;</strong> , 因此可以看到結果(第二張), 版面是較大的版面, 但圖片的部分就糊的有點慘了, 而且, 重點被截到了, Facebook圖雖沒那麼糊, 但版面依然很小</p>
<p>現在應該很多網站都有注意使用了大圖來做為og:image了, 效果就像是這樣:</p>
<p><img src=/images/posts/og/og_sample_big_prod.jpg alt="OG Big"></p>
<p>這樣版面是大得很明顯了, 但似乎有點問題, 這邊用的是LOGO, 但它賣的是"【JOYOUNG 九陽】LINE FRIENDS系列真空悶燒罐 熊大", 沒商品圖片, 我不知道大家是怎看, 至少, 不吸引我</p>
<p>再來看另一個例子:</p>
<p><img src=/images/posts/og/og_sample_pchome.jpg alt="OG PCHOME"></p>
<p>看的到商品, 但部分字被遮住了, 而且"限時優惠"這個是有時效性的, 被分享出去的圖片是不會被改變的</p>
<p>那我自己之前的blog文章呢? 我最早設定的邏輯是這樣的, 如果文章內有圖, 就挑第一張圖, 把它放大到1200x630的規格, 如果沒有圖, 就拿標題做一張圖(前面提到的<a href=https://github.com/julianshen/myblog_hugo/tree/master/ogp>小工具</a>)</p>
<p><img src=/images/posts/og/og_sample_blog_1.jpg alt="OG Blog"></p>
<p><img src=/images/posts/og/og_sample_blog_2.jpg alt="OG Blog"></p>
<p><img src=/images/posts/og/og_sample_blog_3.jpg alt="OG Blog"></p>
<p><img src=/images/posts/og/og_sample_blog_4.jpg alt="OG Blog"></p>
<p>我的文章大多偏技術面的文章, 這裡面有些是用到了流程圖, 看起來沒啥太大問題, 有些就沒那麼優了, 再來看看文章內沒有圖的狀況</p>
<p><img src=/images/posts/og/og_sample_blog_5.jpg alt="OG Blog"></p>
<p>自從用了這版本後, 覺得好像這樣會比較清楚一點, 與其去選一張跟內容沒那麼相關, 品質又沒保證的, 還不如使用標題來的直觀一點</p>
<p>但之前的小工具, 需要綁在git pre-commit, 我換台電腦就又得設定一次, 也是有點不方便, 重新來寫一個版本, 跑在heroku上, 反正文章沒那麼多, Facebook又不會常常跑來抓, Free dyno就夠用了</p>
<p>下面就來把這版本：<a href=https://github.com/julianshen/betterog>Better OG</a> 幾個實作來做一個介紹, 原始碼都在Github上, 因為都是用現成的package來簡單達成的, 所以我沒想把code整理當成一個可以直接發行的版本, 單純當範例, 大家有用到的片段可以直接拿去使用</p>
<h2 id=純文字的og-image>純文字的OG Image</h2>
<p>想達成的效果就跟前面提到這張圖一樣</p>
<p><img src=/images/posts/og/og_sample_blog_5.jpg alt="OG Blog"></p>
<h3 id=使用text2imghttpsgithubcomjulianshentext2img>使用<a href=https://github.com/julianshen/text2img>text2img</a></h3>
<p>這一部分算最簡單的, 就是前面的文章有提到的<a href=https://github.com/julianshen/text2img>text2img</a>, 它的設計也就是為了產生og:image, 所以很簡單就可以應用在這邊了, 我是用我自己改過的版本:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>bog</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BetterOG</span>) <span style=color:#a6e22e>drawText</span>(<span style=color:#a6e22e>text</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>0</span>))
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawURLEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>text</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>text</span> = string(<span style=color:#a6e22e>decoded</span>)
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>img</span> <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>img</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>bog</span>.<span style=color:#a6e22e>drawer</span>.<span style=color:#a6e22e>Draw</span>(<span style=color:#a6e22e>text</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>jpeg</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>img</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>jpeg</span>.<span style=color:#a6e22e>Options</span>{<span style=color:#a6e22e>Quality</span>: <span style=color:#ae81ff>90</span>}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>, <span style=color:#66d9ef>nil</span>
		}
	}

	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
}
</code></pre></div><p>因為我是要直接放在URL上, 像<code>https://og.jln.co/t/W-ethuiomF3liKnnlKhheGlvcy1tb2NrLWFkYXB0ZXLngrpheGlvc-aPkOS-m-a4rOippueUqOeahOWBh-izh-aWmQ</code>, 所以文字部分就用base64先編碼過(必須要用RawURLEncoding)</p>
<h3 id=unit-test>Unit test</h3>
<p>這邊為了測試畫出來的文字是不是正確, 所以就引入了<a href=https://github.com/otiai10/gosseract>gosseract</a>, gosseract是<a href=https://github.com/tesseract-ocr/tessdoc>tesseract-ocr</a>的go封裝, <a href=https://github.com/tesseract-ocr/tessdoc>tesseract-ocr</a>算是很老牌的OCR了, 辨識率還不錯, 不過老實說, 這邊只是想玩玩gosseract XD</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestDrawText</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
	<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewServer</span>(<span style=color:#e6db74>&#34;:8888&#34;</span>, <span style=color:#a6e22e>text2img</span>.<span style=color:#a6e22e>Params</span>{
		<span style=color:#a6e22e>FontPath</span>: <span style=color:#e6db74>&#34;../../fonts/SourceHanSansTC-VF.ttf&#34;</span>,
	})

	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)

	<span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gosseract</span>.<span style=color:#a6e22e>NewClient</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()

	<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>drawText</span>(<span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>URLEncoding</span>.<span style=color:#a6e22e>EncodeToString</span>([]byte(<span style=color:#e6db74>&#34;For testing&#34;</span>)))
	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
	<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>SetImageFromBytes</span>(<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>Bytes</span>())
	<span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Text</span>()
	<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#e6db74>&#34;For testing&#34;</span>, <span style=color:#a6e22e>text</span>)
}
</code></pre></div><h2 id=使用網頁截圖來當og-image>使用網頁截圖來當OG Image</h2>
<p>這種類型應該比較常在ptt分享文章上看到, 像這樣</p>
<p><img src=/images/posts/og/og_sample_ptt.jpg alt="OG ptt"></p>
<p>這也是不錯的做法</p>
<h3 id=使用chromedphttpsgithubcomchromedpchromedp來擷取網頁畫面>使用<a href=https://github.com/chromedp/chromedp>chromedp</a>來擷取網頁畫面</h3>
<p><a href=https://github.com/chromedp/chromedp>chromedp</a>是透過chrome debug protocol 來操作Chrome的, 這邊就很適合從程式來操作截取網頁畫面, 只是擷取畫面, 還算蠻簡單的:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Capture</span>(<span style=color:#a6e22e>encodedurl</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>decoded</span> []<span style=color:#66d9ef>byte</span>

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawURLEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>encodedurl</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>decoded</span>)
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;capture URL:%s\n&#34;</span>, <span style=color:#a6e22e>url</span>)

		<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewExecAllocator</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NoSandbox</span>)
		<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>NewContext</span>(
			<span style=color:#a6e22e>ctx</span>,
			<span style=color:#75715e>// chromedp.WithDebugf(log.Printf),
</span><span style=color:#75715e></span>		)

		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()

		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buf</span> []<span style=color:#66d9ef>byte</span>

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Tasks</span>{
			<span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>EmulateViewport</span>(<span style=color:#ae81ff>1200</span>, <span style=color:#ae81ff>630</span>),
			<span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>Navigate</span>(<span style=color:#a6e22e>url</span>),
			<span style=color:#a6e22e>FullScreenshotInViewport</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>buf</span>, <span style=color:#ae81ff>90</span>),
		}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
		}

		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>buf</span>, <span style=color:#66d9ef>nil</span>
	}
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
}
</code></pre></div><p>這邊要擷取的URL一樣是透過base64編碼完放在url傳過來的, 因為我們要的圖大小是1200x630, 所以這邊的View port就設定成那個大小, 有一個比較要特別注意的是, 跟原本chromdp範例不同的地方是, 這邊要用<code>ctx, _ := chromedp.NewExecAllocator(context.Background(), chromedp.NoSandbox)</code> <strong>&ldquo;NoSandbox&rdquo;</strong> 的模式來初始chrome, 要不然無法在heroku下跑</p>
<p>這邊並不是使用<code>chrome.FullScreenshot</code>來擷取畫面, 取而代之的是用自己寫的<code>FullScreenshotInViewport</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FullScreenshotInViewport</span>(<span style=color:#a6e22e>res</span> <span style=color:#f92672>*</span>[]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>quality</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>EmulateAction</span> {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#e6db74>&#34;res cannot be nil&#34;</span>)
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>chromedp</span>.<span style=color:#a6e22e>ActionFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
		<span style=color:#a6e22e>format</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>CaptureScreenshotFormatJpeg</span>

		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
		<span style=color:#75715e>// capture screenshot
</span><span style=color:#75715e></span>		<span style=color:#f92672>*</span><span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>CaptureScreenshot</span>().
			<span style=color:#a6e22e>WithCaptureBeyondViewport</span>(<span style=color:#66d9ef>true</span>).
			<span style=color:#a6e22e>WithFormat</span>(<span style=color:#a6e22e>format</span>).
			<span style=color:#a6e22e>WithQuality</span>(int64(<span style=color:#a6e22e>quality</span>)).<span style=color:#a6e22e>WithClip</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Viewport</span>{
			<span style=color:#a6e22e>X</span>:      <span style=color:#ae81ff>0</span>,
			<span style=color:#a6e22e>Y</span>:      <span style=color:#ae81ff>0</span>,
			<span style=color:#a6e22e>Width</span>:  <span style=color:#ae81ff>1200</span>,
			<span style=color:#a6e22e>Height</span>: <span style=color:#ae81ff>630</span>,
			<span style=color:#a6e22e>Scale</span>:  <span style=color:#ae81ff>1</span>,
		}).<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>ctx</span>)

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
		}
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
	})
}
</code></pre></div><p>其實這支是抄自<code>chrome.FullScreenshot</code>, 但不一樣的是<code>WithClip</code>這邊的寬高用的是1200x630, 這是因為原本<code>chrome.FullScreenshot</code>會抓整頁完整頁面, 要多長有多長, 結果寬度雖是1200, 但長度可能超長, 這樣的比例可能也會被Facebook視為要用小版面來顯示</p>
<h3 id=佈署到heroku>佈署到heroku</h3>
<p><a href=https://github.com/chromedp/chromedp>chromedp</a>是沒辦法單獨運作的, 必須要有chrome才可以正常運作, 如果要部屬到heroku, heroku的環境上是沒裝chrome的, 這該怎麼辦?</p>
<p>一種方式是建立自己的<a href=https://devcenter.heroku.com/articles/buildpacks#creating-a-buildpack>Build Pack</a>, <a href=https://developers.google.com/web/updates/2017/04/headless-chrome>裝個chrome跑headless mode</a>, 不過這條路太麻煩, 不是我選擇的路</p>
<p>一個是在heroku上用<a href=https://devcenter.heroku.com/articles/build-docker-images-heroku-yml>docker image來跑</a>, 這樣只要包裝好一個docker image就搞定了, 簡單</p>
<p>為了這目的, 可以選用<a href=https://github.com/chromedp/docker-headless-shell>Headless shell</a>這個docker image當作base image, 這個image已經等同包裝好一個headless chrome了</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>FROM</span> <span style=color:#a6e22e>chromedp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>headless</span><span style=color:#f92672>-</span><span style=color:#a6e22e>shell</span>:<span style=color:#a6e22e>latest</span>
<span style=color:#f92672>...</span>
<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>Install</span> <span style=color:#a6e22e>dumb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>init</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>tini</span>
<span style=color:#a6e22e>RUN</span> <span style=color:#a6e22e>apt</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>dumb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>init</span>
<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>RUN</span> <span style=color:#a6e22e>apt</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>tini</span>
<span style=color:#f92672>...</span>
<span style=color:#a6e22e>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;dumb-init&#34;</span>, <span style=color:#e6db74>&#34;--&#34;</span>]
<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;tini&#34;</span>, <span style=color:#e6db74>&#34;--&#34;</span>]
<span style=color:#a6e22e>CMD</span> [<span style=color:#e6db74>&#34;/path/to/your/program&#34;</span>]
</code></pre></div><p>這邊的<code>dumb-init</code>, <code>tini</code>是必須的, 因為這個container不只會跑一個procewss, 包含chrome是兩個, 所以不包這個的話, 在結束container時會有zombie process造成container無法被結束</p>
<h2 id=有黑貓就加分>有黑貓就加分!</h2>
<p>不過, 也不是每個網頁都像ptt那樣適合用截圖來做og:image, 後來想了一下, 我想要的大概介於兩者之間, 有文字, 但不太單調的版面, 像這樣</p>
<p><img src=/images/posts/og/og_sample_cat.jpg alt="OG cat"></p>
<p>那其實這也不難, 做一個網頁範本, 用前面的截圖的方法截出來就好了, 那這也是目前最後使用的版本</p>
<h2 id=小收尾>小收尾</h2>
<p>順便做了幾個小收尾</p>
<ol>
<li>除了Facebook bot跟Twitter bot外, 不可以抓到產生的圖, 這是為了以防有人偷用, 用UA去判斷</li>
<li>加上cache-control, cdn-cache-control header, 前面再擋一層cloudflare</li>
</ol>
<h2 id=碰到的問題>碰到的問題</h2>
<p>目前碰到的主要問題有兩個</p>
<ol>
<li>heroku的free dyno冷啟動至少要6秒, 如果網頁又太慢, 那很有可能造成Facebook bot或Twitter bot timeout</li>
<li>最最詭異的部分是, Facebook部分, 字形跑掉了, 比照前面那張貓圖跟下面這張, 會發現"Julian Shen"的字形跑掉了, 前面那個是Twitter抓出來的, 後者是Facebook, 明明就同一個URL, 同一個browser render, 如果直接看那張圖字形也是正常的, 但Facebook不知道哪抓來的靈異照片
<img src=/images/posts/og/og_sample_cat_2.jpg alt="OG cat"></li>
</ol>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2021-08-02 00:52:04 +0800 +0800"><a href=/%E5%9C%A8nodejs%E4%BD%BF%E7%94%A8typescript%E5%91%BC%E5%8F%ABthrift-client/>Aug 2, 2021</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~2 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E5%9C%A8nodejs%E4%BD%BF%E7%94%A8typescript%E5%91%BC%E5%8F%ABthrift-client/ rel=bookmark title="在nodejs使用typescript呼叫thrift client" itemprop=url>在nodejs使用typescript呼叫thrift client</a></h1>
</header>
<div class=entry-content>
<p>在<a href=https://thrift.apache.org/>Apache Thrift</a>的官網上, 有提供了<a href=http://thrift.apache.org/tutorial/nodejs>如何在nodejs下呼叫Thrift client的範例</a></p>
<p>這邊這個範例其實針對的是javascript, 而其由Thrift idl產生javascript的指令是:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>thrift -r --gen js:node tutorial.thrift
</code></pre></div><p>但如果我們想要用typescript來寫呢? 這邊產生的程式碼就沒有適用於typescript的封裝, 那這個thrift generator有沒支援typescript呢? 如果我們用 <code>thrift --help</code> 來看看它的說明:</p>
<pre tabindex=0><code>  js (Javascript):
    jquery:          Generate jQuery compatible code.
    node:            Generate node.js compatible code.
    ts:              Generate TypeScript definition files.
    with_ns:         Create global namespace objects when using node.js
    es6:             Create ES6 code with Promises
    thrift_package_output_directory=&lt;path&gt;:
                     Generate episode file and use the &lt;path&gt; as prefix
    imports=&lt;paths_to_modules&gt;:
                     ':' separated list of paths of modules that has episode files in their root   
</code></pre><p>除了我們剛剛用的<code>js:node</code>外, 還有一個<code>js:ts</code>, 似乎好像是有支援, 但你如果直接用<code>thrift -r --gen js:ts tutorial.thrift</code> ,它產生的typescript code是給browser用的, 並非給nodejs用的, 這怎回事?難道就不能兼顧嗎?其實可以, 如果你去看<a href=https://github.com/apache/thrift/blob/master/lib/nodets/Makefile.am>這段程式碼</a>, 就會發現答案是用<code>-gen js:node,ts</code>, 範例沒寫, help也沒寫清楚</p>
<p>假設我們有一個範例叫sample.thrift:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-thrift data-lang=thrift><span style=color:#66d9ef>service</span> <span style=color:#a6e22e>SampleService</span> {
    <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>hello</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span>: <span style=color:#66d9ef>i64</span> a, <span style=color:#ae81ff>2</span>: <span style=color:#66d9ef>i64</span> b)
    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>hello2</span><span style=color:#f92672>(</span>)
}
</code></pre></div><p>那我們用這個指令</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>thrift -s -gen js:node,ts sample.ts
</code></pre></div><p>那就會在<code>gen-nodejs</code>產生以下四個檔</p>
<ul>
<li>sample_types.d.ts</li>
<li>sample_types.js</li>
<li>SampleService.d.ts</li>
<li>SampleService.js</li>
</ul>
<p>那我們如何在我們程式裡面呼叫Thrift client呢?參考以下範例:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>createConnection</span>, <span style=color:#a6e22e>TFramedTransport</span>, <span style=color:#a6e22e>TBinaryProtocol</span>, <span style=color:#a6e22e>createClient</span>, <span style=color:#a6e22e>Connection</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;thrift&#34;</span>;
<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Client</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./gen-nodejs/SampleService&#34;</span>;
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Int64</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>require</span>(<span style=color:#e6db74>&#39;node-int64&#39;</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>conn</span>:<span style=color:#66d9ef>Connection</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createConnection</span>(<span style=color:#e6db74>&#34;localhost&#34;</span>, <span style=color:#ae81ff>8080</span>, {
    <span style=color:#a6e22e>transport</span> : <span style=color:#66d9ef>TFramedTransport</span>,
    <span style=color:#a6e22e>protocol</span> : <span style=color:#66d9ef>TBinaryProtocol</span>
  });

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span>:<span style=color:#66d9ef>Client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createClient</span>(<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>conn</span>);
(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>hello</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Int64</span>(<span style=color:#ae81ff>11</span>), <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Int64</span>(<span style=color:#ae81ff>34</span>)));
    <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>end</span>();
  })()
</code></pre></div><p>對照一下原本javascript版本:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>thrift</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;thrift&#39;</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>SampleService</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;./gen-nodejs/SampleService&#39;</span>);

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>transport</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TFramedTransport</span>;
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>protocol</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>TBinaryProtocol</span>;

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>connection</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>createConnection</span>(<span style=color:#e6db74>&#34;localhost&#34;</span>, <span style=color:#ae81ff>8080</span>, {
    <span style=color:#a6e22e>transport</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>transport</span>,
    <span style=color:#a6e22e>protocol</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>protocol</span>
  });

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>thrift</span>.<span style=color:#a6e22e>createClient</span>(<span style=color:#a6e22e>SampleService</span>, <span style=color:#a6e22e>connection</span>);

<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>hello</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>then</span>(<span style=color:#a6e22e>resp</span> =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>resp</span>);
}).<span style=color:#a6e22e>fin</span>(() =&gt; {
    <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>end</span>();
});
</code></pre></div><p>相較之下, typescript的版本好像好讀一些</p>
</div>
</article>
<article class=hentry>
<header>
<div class=entry-meta>
<span class="entry-date date published updated"><time datetime="2020-07-05 14:54:23 +0800 +0800"><a href=/%E7%94%A8golang%E8%A7%A3%E6%9E%90json%E8%A3%A1%E7%9A%84%E6%95%B8%E5%AD%97%E6%AC%84%E4%BD%8D/>Jul 5, 2020</a></time></span>
<span class=entry-reading-time>
<i class="fa fa-clock-o"></i>
Reading time ~4 minutes
</span>
</div>
<h1 class=entry-title><a href=/%E7%94%A8golang%E8%A7%A3%E6%9E%90json%E8%A3%A1%E7%9A%84%E6%95%B8%E5%AD%97%E6%AC%84%E4%BD%8D/ rel=bookmark title=用golang解析json裡的數字欄位 itemprop=url>用golang解析json裡的數字欄位</a></h1>
</header>
<div class=entry-content>
<p>在寫網路相關應用的時候, 應該常常會碰到需要去解析JSON格式的資料, 而Go在這邊也已經內建了一個蠻方便的套件 - <strong>&ldquo;encoding/json&rdquo;</strong> 可以讓我們輕易地來處理這類型的資料</p>
<p>先來看看下面這段範例:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
)

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Sample</span> <span style=color:#66d9ef>struct</span> {
   <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
   <span style=color:#a6e22e>Age</span> <span style=color:#66d9ef>int</span> 
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sampleData</span> = <span style=color:#e6db74>`{
</span><span style=color:#e6db74>   &#34;name&#34;:&#34;julian&#34;,
</span><span style=color:#e6db74>   &#34;age&#34;: -1
</span><span style=color:#e6db74>}`</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sample</span> <span style=color:#a6e22e>Sample</span>
	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>([]byte(<span style=color:#a6e22e>sampleData</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sample</span>)
	
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
	   panic(<span style=color:#a6e22e>err</span>)
	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sample</span>)
}
</code></pre></div><p>[<a href=https://play.golang.org/p/YfOPBMXGGl5>執行</a>]</p>
<p>從這個範例可以看到, 我們可以用很簡單的程式碼, 把下面這段JSON內容給對應到<code>Sample</code>這個結構裡面</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
   <span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;julian&#34;</span>,
   <span style=color:#f92672>&#34;age&#34;</span>: <span style=color:#ae81ff>-1</span>
}
</code></pre></div><p>但這邊其實有一個問題, 如果你把這個JSON資料, 改成下面這樣子:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
   <span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;julian&#34;</span>,
   <span style=color:#f92672>&#34;age&#34;</span>: <span style=color:#e6db74>&#34;-1&#34;</span>
}
</code></pre></div><p>這在現實世界應該蠻常看到的, 只是多加個雙引號而已, 大家應該也會預期這邊應該也會沒問題的解析出一樣的結果吧? 但你如果實際改了資料<a href=https://play.golang.org/p/nxMnQFY3CQ->執行看看</a>, 你得到的結果應該會是:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>panic: json: cannot unmarshal string into Go struct field Sample.Age of type int

goroutine <span style=color:#ae81ff>1</span> <span style=color:#f92672>[</span>running<span style=color:#f92672>]</span>:
main.main<span style=color:#f92672>()</span>
	/tmp/sandbox247755092/prog.go:23 +0x162
</code></pre></div><p>這其實是 <em><strong>&ldquo;encoding/json&rdquo;</strong></em> 把雙引號的內容都當作字串來看, 所以當我要把它塞到一個 <em>int</em> 欄位時, 就會出事了</p>
<p>解決方法有好幾種, 下面就一一來看看:</p>
<h2 id=用field-tag來解決>用Field tag來解決</h2>
<p>如果把<code>Sample</code>的定義改成下面這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Sample</span> <span style=color:#66d9ef>struct</span> {
   <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
   <span style=color:#a6e22e>Age</span> <span style=color:#66d9ef>int</span> <span style=color:#e6db74>`json:&#34;,string&#34;`</span>
}
</code></pre></div><p>[<a href=https://play.golang.org/p/qexEcHzamM3>執行範例</a>]</p>
<p>喔耶, 沒問題了耶!!!可以正常的解出資料了耶!! 慢著, 先別高興太早!! 再試試把雙引號拿掉看看(參考這個<a href=https://play.golang.org/p/Cz17VTbCBBX>範例</a>)</p>
<p>呃, 是怎樣啦!! 換成這個錯誤了!!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>panic: json: invalid use of ,string struct tag, trying to unmarshal unquoted value into int

goroutine <span style=color:#ae81ff>1</span> <span style=color:#f92672>[</span>running<span style=color:#f92672>]</span>:
main.main<span style=color:#f92672>()</span>
	/tmp/sandbox912379425/prog.go:23 +0x162
</code></pre></div><p>在現實案例中, 的確是有可能碰到有時送來的資料有雙引號, 有時候沒有, 這方法是沒法一次滿足的</p>
<h2 id=利用unmarshaler界面來解決>利用Unmarshaler界面來解決</h2>
<p><em><strong>&ldquo;encoding/json&rdquo;</strong></em> 是可以讓開發者自行指定怎去解析JSON內容的, 只需要定義一個自定義的型別並實做Unmarshaler界面就可以了, 為了解決這個問題, 我們可以定義一個新的<code>MyInt</code>的型別, 並幫它實做<code>UnmarshalJSON</code>的方法, 參考下面範例:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MyInt</span> <span style=color:#66d9ef>int</span>

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MyInt</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#a6e22e>str</span> <span style=color:#f92672>:=</span> string(<span style=color:#a6e22e>data</span>)
	
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>unquoted</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Unquote</span>(<span style=color:#a6e22e>str</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
	   <span style=color:#a6e22e>str</span> = <span style=color:#a6e22e>unquoted</span>
	}
	
	<span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>str</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	}
	<span style=color:#f92672>*</span><span style=color:#a6e22e>m</span> = <span style=color:#a6e22e>MyInt</span>(<span style=color:#a6e22e>result</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Sample</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>Age</span>  <span style=color:#a6e22e>MyInt</span>
}
</code></pre></div><p>[<a href=https://play.golang.org/p/FAqSuBcDXgl>執行範例</a>]</p>
<p>在Sample這個結構中的Age欄位, 從原本的int改成MyInt, 這樣<code>json.Unmarshal</code>碰到Age這欄位的話, 就會用<code>MyInt</code>的<code>UnmarshalJSON</code>方法去解析</p>
<p>這方法是麻煩了點, 而且可能針對不同型別要去個別做, 但卻是可以同時處理掉前述兩種型態的資料, 程式沒那好看就是了</p>
<h2 id=使用jsonnumberhttpsgolangorgpkgencodingjsonnumber>使用<a href=https://golang.org/pkg/encoding/json/#Number>json.Number</a></h2>
<p>在 <em><strong>&ldquo;encoding/json&rdquo;</strong></em> 裡其實還提供一個資料型態<a href=https://golang.org/pkg/encoding/json/#Number>json.Number</a>, 這個應該是這個問題的比較正規的解法了, 把Sample的定義改成下面這樣:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Sample</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>Age</span>  <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Number</span>
}
</code></pre></div><p>[<a href=https://play.golang.org/p/sWbmNX1aZwi>執行範例</a>]</p>
<p>這方法也是可以無誤的解析兩種的型態, 然後當你要取用<code>Age</code>這欄位的<code>int</code>型態時, 你可以用<code>sample.Age.Int64()</code>去取得, 要多一層是麻煩點</p>
<p>那它是怎做到的呢? 來看一下它的原始碼:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#75715e>// A Number represents a JSON number literal.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Number</span> <span style=color:#66d9ef>string</span>

<span style=color:#75715e>// String returns the literal text of the number.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#a6e22e>Number</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> { <span style=color:#66d9ef>return</span> string(<span style=color:#a6e22e>n</span>) }

<span style=color:#75715e>// Float64 returns the number as a float64.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#a6e22e>Number</span>) <span style=color:#a6e22e>Float64</span>() (<span style=color:#66d9ef>float64</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>ParseFloat</span>(string(<span style=color:#a6e22e>n</span>), <span style=color:#ae81ff>64</span>)
}

<span style=color:#75715e>// Int64 returns the number as an int64.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#a6e22e>Number</span>) <span style=color:#a6e22e>Int64</span>() (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>ParseInt</span>(string(<span style=color:#a6e22e>n</span>), <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>64</span>)
}
</code></pre></div><p>會發現, 其實沒啥了不起的, Number本身就是一個string, 所以它是當字串在處理, 而當你需要數字表示(int或float)時, 再呼叫ParseInt或ParseFloat來處理</p>
<h2 id=使用-jsoniterhttpsgithubcomjson-iteratorgo-來取代-encodingjson>使用 <a href=https://github.com/json-iterator/go>Jsoniter</a> 來取代 &ldquo;encoding/json&rdquo;</h2>
<p><a href=https://github.com/json-iterator/go>Jsoniter</a>是一個號稱比原生的***&ldquo;encoding/json&rdquo;***效能還要來的更好的JSON處理套件, 除了Go的版本外, 它也有Java的版本</p>
<p>效能不在這邊的討論範圍, 但除效能外, 它也是最簡單解決這問題的方法, 先來看看完整的程式碼吧:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;fmt&#34;</span>
	<span style=color:#a6e22e>jsoniter</span> <span style=color:#e6db74>&#34;github.com/json-iterator/go&#34;</span>
	<span style=color:#a6e22e>extra</span> <span style=color:#e6db74>&#34;github.com/json-iterator/go/extra&#34;</span>
)

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Sample</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>Age</span>  <span style=color:#66d9ef>int</span>
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sampleData</span> = <span style=color:#e6db74>`{
</span><span style=color:#e6db74>   &#34;name&#34;:&#34;julian&#34;,
</span><span style=color:#e6db74>   &#34;age&#34;: 45
</span><span style=color:#e6db74>}`</span>

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sampleData2</span> = <span style=color:#e6db74>`{
</span><span style=color:#e6db74>   &#34;name&#34;:&#34;julian&#34;,
</span><span style=color:#e6db74>   &#34;age&#34;: &#34;45&#34;
</span><span style=color:#e6db74>}`</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>extra</span>.<span style=color:#a6e22e>RegisterFuzzyDecoders</span>()
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sample</span> <span style=color:#a6e22e>Sample</span>
	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>jsoniter</span>.<span style=color:#a6e22e>Unmarshal</span>([]byte(<span style=color:#a6e22e>sampleData</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sample</span>)

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#a6e22e>err</span>)
	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sample</span>)

	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>jsoniter</span>.<span style=color:#a6e22e>Unmarshal</span>([]byte(<span style=color:#a6e22e>sampleData2</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sample</span>)

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#a6e22e>err</span>)
	}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>sample</span>)

}
</code></pre></div><p>[<a href=https://play.golang.org/p/vKl1YcH6lt8>執行範例</a>]</p>
<p>為啥說是最簡單的方法呢? 首先, 它有跟 <em><strong>&ldquo;encoding/json&rdquo;</strong></em> 完全一樣的使用方法, 把套件換掉後, 程式幾乎一樣, 所以也不需要改啥程式, 但如果只有改這樣, 會發現問題都還是在, 並沒有解決掉, 這時候就要帶入它額外的功能 <code>FuzzyDecoders</code> 了, <code>FuzzyDecoders</code>是在它額外的套件裡面, 所以只需要加入import就可以用了</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>import</span> <span style=color:#a6e22e>extra</span> <span style=color:#e6db74>&#34;github.com/json-iterator/go/extra&#34;</span>
</code></pre></div><p>然後在開始使用前, 註冊 <code>FuzzyDecoders</code> 即可(<code>extra.RegisterFuzzyDecoders()</code>), 這樣, 不管有沒雙引號都不會有問題了!!</p>
</div>
</article>
<div class=pagination>
<ul class=inline-list>
<li><a href=/post/ class=btn>Previous</a></li>
<li><a href=/post/>1</a></li>
<li><strong class=current-page>2</strong></li>
<li><a href=/post/page/3/>3</a></li>
<li><a href=/post/page/4/>4</a></li>
<li><a href=/post/page/5/>5</a></li>
<li><a href=/post/page/6/>6</a></li>
<li><a href=/post/page/7/>7</a></li>
<li><a href=/post/page/8/>8</a></li>
<li><a href=/post/page/9/>9</a></li>
<li><a href=/post/page/10/>10</a></li>
<li><a href=/post/page/11/>11</a></li>
<li><a href=/post/page/12/>12</a></li>
<li><a href=/post/page/13/>13</a></li>
<li><a href=/post/page/14/>14</a></li>
<li><a href=/post/page/15/>15</a></li>
<li><a href=/post/page/16/>16</a></li>
<li><a href=/post/page/17/>17</a></li>
<li><a href=/post/page/18/>18</a></li>
<li><a href=/post/page/19/>19</a></li>
<li><a href=/post/page/20/>20</a></li>
<li><a href=/post/page/21/>21</a></li>
<li><a href=/post/page/22/>22</a></li>
<li><a href=/post/page/23/>23</a></li>
<li><a href=/post/page/24/>24</a></li>
<li><a href=/post/page/25/>25</a></li>
<li><a href=/post/page/26/>26</a></li>
<li><a href=/post/page/27/>27</a></li>
<li><a href=/post/page/28/>28</a></li>
<li><a href=/post/page/29/>29</a></li>
<li><a href=/post/page/30/>30</a></li>
<li><a href=/post/page/31/>31</a></li>
<li><a href=/post/page/32/>32</a></li>
<li><a href=/post/page/33/>33</a></li>
<li><a href=/post/page/34/>34</a></li>
<li><a href=/post/page/35/>35</a></li>
<li><a href=/post/page/36/>36</a></li>
<li><a href=/post/page/37/>37</a></li>
<li><a href=/post/page/38/>38</a></li>
<li><a href=/post/page/39/>39</a></li>
<li><a href=/post/page/40/>40</a></li>
<li><a href=/post/page/41/>41</a></li>
<li><a href=/post/page/42/>42</a></li>
<li><a href=/post/page/43/>43</a></li>
<li><a href=/post/page/44/>44</a></li>
<li><a href=/post/page/45/>45</a></li>
<li><a href=/post/page/46/>46</a></li>
<li><a href=/post/page/47/>47</a></li>
<li><a href=/post/page/48/>48</a></li>
<li><a href=/post/page/49/>49</a></li>
<li><a href=/post/page/50/>50</a></li>
<li><a href=/post/page/51/>51</a></li>
<li><a href=/post/page/52/>52</a></li>
<li><a href=/post/page/53/>53</a></li>
<li><a href=/post/page/54/>54</a></li>
<li><a href=/post/page/55/>55</a></li>
<li><a href=/post/page/56/>56</a></li>
<li><a href=/post/page/57/>57</a></li>
<li><a href=/post/page/58/>58</a></li>
<li><a href=/post/page/59/>59</a></li>
<li><a href=/post/page/60/>60</a></li>
<li><a href=/post/page/61/>61</a></li>
<li><a href=/post/page/62/>62</a></li>
<li><a href=/post/page/63/>63</a></li>
<li><a href=/post/page/64/>64</a></li>
<li><a href=/post/page/65/>65</a></li>
<li><a href=/post/page/66/>66</a></li>
<li><a href=/post/page/67/>67</a></li>
<li><a href=/post/page/68/>68</a></li>
<li><a href=/post/page/69/>69</a></li>
<li><a href=/post/page/70/>70</a></li>
<li><a href=/post/page/71/>71</a></li>
<li><a href=/post/page/72/>72</a></li>
<li><a href=/post/page/73/>73</a></li>
<li><a href=/post/page/74/>74</a></li>
<li><a href=/post/page/3/ class=btn>Next</a></li>
</ul>
</div>
</div>
<div class=footer-wrapper>
<footer role=contentinfo>
<span> Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span>
</footer>
</div>
<script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-79243751-1','auto'),ga('send','pageview'))</script>
<div id=fb-root></div>
<script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script>
</body>
</html>