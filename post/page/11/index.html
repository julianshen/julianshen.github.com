<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>Posts &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:url" content="https://blog.jln.co/post/"><meta property="og:site_name" content="Le murmure de Julian"><meta property="og:title" content="Posts"><meta property="og:locale" content="zh_tw"><meta property="og:type" content="website"><meta property="og:image" content="https://blog.jln.co/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.jln.co/images/avatar.png"><meta name=twitter:title content="Posts"><link rel=canonical href=https://blog.jln.co/post/><link rel=alternate type=application/rss+xml href=https://blog.jln.co/post/feed.xml title="Le murmure de Julian"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.149.1"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script><script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script><link rel="shortcut icon" href=/favicon.png></head><body id=post-index class=feature><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div class=entry-header><div class=image-credit>Image credit: <a href=http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/>dargadgetz</a></div><div class=entry-image><img src=/abstract-2.jpg alt=Posts></div><div class=header-title><div class=header-title-wrap><h1><a href=/ title="Go to the homepage">Le murmure de Julian</a></h1><h2>All posts</h2></div></div></div><div id=main role=main><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2016-11-29 17:39:41 +0000 UTC"><a href=/Android-Firebase--WebRTC-on-Android/>Nov 29, 2016</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~7 minutes</span></div><h1 class=entry-title><a href=/Android-Firebase--WebRTC-on-Android/ rel=bookmark title="[Android] Firebase + WebRTC on Android" itemprop=url>[Android] Firebase + WebRTC on Android</a></h1></header><div class=entry-content><p><a href=https://webrtc.org/>WebRTC</a>是一個支援瀏覽器的即時影音對話的架構, 算是一個業界標(W3C,IETF), 最近由於想做一個有影音通話的應用, 就研究了一下這東西</p><p>如果只是想嘗試一下<a href=https://webrtc.org/>WebRTC</a>, 是可以直接是可以直接試<a href=https://appr.tc/>AppRTC</a>這個Google的範例, 不過這個是Web的版本, 我想要做的是
手機的版本(Android, iOS), <a href=https://appr.tc/>AppRTC</a>其實也有Android的版本可搭配</p><p>為了熟悉一下整個用WebRTC建立video call的流程, 因此我就決定改一下這個Android版本, 原本Google的版本是透過Web Socket</p><p>至於流程與架構我會建議看這影片:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/HS1eKPL4f1o?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>如果不想看太長, 就看這個:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/nDPlGcoArdM?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>把Web RTC那段換成Firebase(好, 其實我蠻後悔選Firebase來實作的)其實就是把Signaling這段給換掉, 而這段流程是(節錄自影片):</p><p><img src=/images/posts/webrtc.png alt></p><p>這部分其實就是交換兩邊的SDP和ICE candidate的過程, 詳細可以參考<a href=http://blog.mozilla.com.tw/posts/3261/webrtc-%E7%9B%B8%E9%97%9C%E7%B8%AE%E5%AF%AB%E5%90%8D%E8%A9%9E%E7%B0%A1%E4%BB%8B>這邊:WebRTC 相關縮寫名詞簡介</a></p><p>結果的source code放在<a href=https://github.com/julianshen/apprtc-android-demo>這邊 : apprtc-android-demo</a></p><h3 id=building-webrtc-lib-on-android>Building WebRTC lib on Android</h3><p>其實現在寫WebRTC的應用的話, 也不用從頭實作, Google老早就把它實作在<a href=http://chromium.org>Chromium</a>裡面了, 也可以單獨build出library用</p><p>這邊有官方的<a href=https://webrtc.org/native-code/android/>如何建置出Android版本的Web RTC library</a>, 不過, 不要照著這份文件做呀, 不然頭髮會白好幾根, 可能還build不太起來,
找了一堆網路上人家的建議也都是不要直接build, 直接用人家build好現成的, 不過, 現成的雖然有一些, 但大多是過時的, API跟現今的也不太一樣, 如果
要套用到現在的Android版本AppRTC的source code內, 大多都沒辦法用</p><p>所幸找到這個<a href=https://github.com/pristineio/webrtc-build-scripts/tree/master/android>build script: pristineio/webrtc-build-scripts</a>,
這個從下載最新的source code到build出library一律包辦, 用法也很簡單, 只要執行下面的:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>source android/build.sh
</span></span><span style=display:flex><span>install_dependencies
</span></span><span style=display:flex><span>get_webrtc
</span></span><span style=display:flex><span>build_apprtc
</span></span></code></pre></div><p>簡單明暸, 但&mldr;有幾個問題, 第一個是只能在Linux下build, 因此在Mac跟Windows下要透過<a href=https://www.vagrantup.com/>Vagrant</a>這類的工具,
而且對硬體需求也很高, 我的2012年中版的Macbook Pro retina實在是跑不動, 後來跑去Digital Ocean租了台VM來build, 本以為最便宜的可以勝任,
後來發現, 至少要4G RAM, 硬碟要20G以上的instance(哭哭, 浪費好多時間)</p><p>build出來後, 所需要的東西包含了libjingle_peerconnection.jar和libjingle_peerconnection_so.so, 把這幾個備份起來就是了, 待會build apk需要用</p><h3 id=apprtc-範例的android-source-codes>AppRTC 範例的Android source codes</h3><p>Android的範例的source codes<a href=https://chromium.googlesource.com/external/webrtc/+/master/webrtc/examples/androidapp/>可以在這邊下載</a></p><p>不過這並不是Android studio的project格式, 因此需要用匯入的方式, 或是可以直接fork<a href=https://github.com/julianshen/apprtc-android-demo>我的版本</a>去改,
由於原本的版本使用了Web socket做singaling的管道, 因此需要<a href=http://autobahn.ws/>Autobahn</a>, 但你切記絕對不能用<a href=http://autobahn.ws/>Autobahn</a>官方最新的jar檔,
而是要用Google放在third_party裡面那個autobanh.jar(啊, 我到現在才發現名字有些許不同), 這邊的差異是, 原本<a href=http://autobahn.ws/>Autobahn</a>是沒有支援SSL的websocket的,
但AppRTC的websocket則是要透過SSL來連接</p><p>把jar跟so檔放到對應的目錄去後, 記得改一下app目錄下的build.gradle加入 (因為import產生的不會幫你加):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gradle data-lang=gradle><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    compile <span style=color:#a6e22e>fileTree</span><span style=color:#f92672>(</span>dir: <span style=color:#e6db74>&#39;libs&#39;</span><span style=color:#f92672>,</span> include: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;*.jar&#39;</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=加上firebase>加上firebase</h3><p>除了原本的Webcoket和Direct connect兩種方式外, 為了跑一次他的流程我多加了Firebase的部分, 利用它的realtime database來做Signaling這部分,
至於怎樣開始開發firebase, 就參考一下他的<a href=https://firebase.google.com/docs/database/android/start/>官方文件</a>吧</p><h3 id=signaling的實作>Signaling的實作</h3><h4 id=callactivity>CallActivity</h4><p>選擇哪種signaling的方式是在CallActivity裡面依據roomId來看使用哪一個signaling client, 程式碼如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>// Create connection client. Use DirectRTCClient if room name is an IP otherwise use the</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// standard WebSocketRTCClient.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#34;firebase&#34;</span>.<span style=color:#a6e22e>equals</span>(roomId)) {
</span></span><span style=display:flex><span>      Log.<span style=color:#a6e22e>d</span>(TAG, <span style=color:#e6db74>&#34;firebase&#34;</span>);
</span></span><span style=display:flex><span>      appRtcClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FirebaseRTCClient(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (loopback <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>DirectRTCClient.<span style=color:#a6e22e>IP_PATTERN</span>.<span style=color:#a6e22e>matcher</span>(roomId).<span style=color:#a6e22e>matches</span>()) {
</span></span><span style=display:flex><span>      appRtcClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WebSocketRTCClient(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      Log.<span style=color:#a6e22e>i</span>(TAG, <span style=color:#e6db74>&#34;Using DirectRTCClient because room name looks like an IP.&#34;</span>);
</span></span><span style=display:flex><span>      appRtcClient <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DirectRTCClient(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>原本有WebSocketRTCClient和DirectRTCClient, 如果是IP的話就用DirectRTCClient,這邊我多加一個FirebaseRTCClient, 只要roomId是firebase就會使用這個(我偷懶)</p><h4 id=firebasertcclient>FirebaseRTCClient</h4><p>XXXRTCClient這部分實作了signaling的部分, 因此我參考了WebSocketRTCClient和DirectRTCClient的內容來寫FirebaseRTCClient</p><p>跟WebSocketRTCClinet一樣, 它必須實作AppRTCClient, AppRTCClient這個Interface定義如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * AppRTCClient is the interface representing an AppRTC client.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AppRTCClient</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Struct holding the connection parameters of an AppRTC room.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RoomConnectionParameters</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> String roomUrl;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> String roomId;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> loopback;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RoomConnectionParameters</span>(String roomUrl, String roomId, <span style=color:#66d9ef>boolean</span> loopback) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>roomUrl</span> <span style=color:#f92672>=</span> roomUrl;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>roomId</span> <span style=color:#f92672>=</span> roomId;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>loopback</span> <span style=color:#f92672>=</span> loopback;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Asynchronously connect to an AppRTC room URL using supplied connection
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * parameters. Once connection is established onConnectedToRoom()
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * callback with room parameters is invoked.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>connectToRoom</span>(RoomConnectionParameters connectionParameters);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Send offer SDP to the other participant.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendOfferSdp</span>(<span style=color:#66d9ef>final</span> SessionDescription sdp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Send answer SDP to the other participant.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendAnswerSdp</span>(<span style=color:#66d9ef>final</span> SessionDescription sdp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Send Ice candidate to the other participant.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendLocalIceCandidate</span>(<span style=color:#66d9ef>final</span> IceCandidate candidate);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Send removed ICE candidates to the other participant.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendLocalIceCandidateRemovals</span>(<span style=color:#66d9ef>final</span> IceCandidate<span style=color:#f92672>[]</span> candidates);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Disconnect from room.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>disconnectFromRoom</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Struct holding the signaling parameters of an AppRTC room.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SignalingParameters</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>PeerConnection.<span style=color:#a6e22e>IceServer</span><span style=color:#f92672>&gt;</span> iceServers;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> initiator;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> String clientId;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> String wssUrl;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> String wssPostUrl;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> SessionDescription offerSdp;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>IceCandidate<span style=color:#f92672>&gt;</span> iceCandidates;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SignalingParameters</span>(List<span style=color:#f92672>&lt;</span>PeerConnection.<span style=color:#a6e22e>IceServer</span><span style=color:#f92672>&gt;</span> iceServers, <span style=color:#66d9ef>boolean</span> initiator,
</span></span><span style=display:flex><span>        String clientId, String wssUrl, String wssPostUrl, SessionDescription offerSdp,
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>IceCandidate<span style=color:#f92672>&gt;</span> iceCandidates) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>iceServers</span> <span style=color:#f92672>=</span> iceServers;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>initiator</span> <span style=color:#f92672>=</span> initiator;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>clientId</span> <span style=color:#f92672>=</span> clientId;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>wssUrl</span> <span style=color:#f92672>=</span> wssUrl;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>wssPostUrl</span> <span style=color:#f92672>=</span> wssPostUrl;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>offerSdp</span> <span style=color:#f92672>=</span> offerSdp;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>iceCandidates</span> <span style=color:#f92672>=</span> iceCandidates;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * Callback interface for messages delivered on signaling channel.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   *
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * &lt;p&gt;Methods are guaranteed to be invoked on the UI thread of |activity|.
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SignalingEvents</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Callback fired once the room&#39;s signaling parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * SignalingParameters are extracted.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onConnectedToRoom</span>(<span style=color:#66d9ef>final</span> SignalingParameters params);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Callback fired once remote SDP is received.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onRemoteDescription</span>(<span style=color:#66d9ef>final</span> SessionDescription sdp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Callback fired once remote Ice candidate is received.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onRemoteIceCandidate</span>(<span style=color:#66d9ef>final</span> IceCandidate candidate);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Callback fired once remote Ice candidate removals are received.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onRemoteIceCandidatesRemoved</span>(<span style=color:#66d9ef>final</span> IceCandidate<span style=color:#f92672>[]</span> candidates);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Callback fired once channel is closed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onChannelClose</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Callback fired once channel error happened.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onChannelError</span>(<span style=color:#66d9ef>final</span> String description);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>主要就是定義了如何處理connect, disconnect, 還有怎麼去註冊SDP和ICE candidate, 在確定好連接成功後, AppRTCClient要負責呼叫onConnectedToRoom來通知
CallActivity已經可以準備建立video call的後續流程, 且要負責處理如果Signal server(這邊是firebase)有傳來遠端的SDP跟ICE candidate, 要負責呼叫SignalingEvents對應的處理
(這邊一樣會叫到CallActivity, 而CallActivity則會使用PeerConnectionClient來處理需要傳遞給PeerConnection相關的參數)</p><p>這邊用Firebase處理Signaling的方式是監聽某一個key的改變, 有新的裝置連接, 註冊SDP, ICE Candidate, 就寫到這下面去, 這其實不是一個很好的方式,
因為這下面只要有值的改變, 就會觸發, 不像是WebSocket那個版本是一來一往的API calls, 而且你不知道每次觸發被更動的是哪一部分, 一開始發生了好幾次PeerConnection重複註冊SDP才讓我發現因為這原因被重複呼叫的問題</p><h3 id=turn-server>TURN server</h3><p>WebRTC是P2P的, 因此如果不具備穿牆能力的話, 在牆外就會被擋掉, 一開始我本來想說試驗P2P而不走TURN Server穿牆的(因為我一時也懶得架一台), 結果測試時老是連不上, 後來才發現我阿呆,
我的測試環境是一台實體手機, 另一台是電腦上跑模擬器, 本以為兩個(手機, 電腦)是同一個區網沒問題, 後來才想到模擬器是在另一個虛擬網路, 因此還是有需要TURN server</p><p>如果不想架一台, 要怎辦? 用Google免錢的, 他們做了這個demo, 一定有! 因此就偷看了一下WebRTCClient的code跟傳輸內容,發現它跟https://networktraversal.googleapis.com/v1alpha/iceconfig?key=AIzaSyAJdh2HkajseEIltlZ3SIXO02Tze9sO3NY
去要TURN server list, 所以基本上只要照copy下面這段就好:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#66d9ef>private</span> LinkedList<span style=color:#f92672>&lt;</span>PeerConnection.<span style=color:#a6e22e>IceServer</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>requestTurnServers</span>(String url)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> IOException, JSONException {
</span></span><span style=display:flex><span>        LinkedList<span style=color:#f92672>&lt;</span>PeerConnection.<span style=color:#a6e22e>IceServer</span><span style=color:#f92672>&gt;</span> turnServers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedList<span style=color:#f92672>&lt;</span>PeerConnection.<span style=color:#a6e22e>IceServer</span><span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>        Log.<span style=color:#a6e22e>d</span>(TAG, <span style=color:#e6db74>&#34;Request TURN from: &#34;</span> <span style=color:#f92672>+</span> url);
</span></span><span style=display:flex><span>        HttpURLConnection connection <span style=color:#f92672>=</span> (HttpURLConnection) <span style=color:#66d9ef>new</span> URL(url).<span style=color:#a6e22e>openConnection</span>();
</span></span><span style=display:flex><span>        connection.<span style=color:#a6e22e>setDoOutput</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        connection.<span style=color:#a6e22e>setRequestProperty</span>(<span style=color:#e6db74>&#34;REFERER&#34;</span>, <span style=color:#e6db74>&#34;https://appr.tc&#34;</span>);
</span></span><span style=display:flex><span>        connection.<span style=color:#a6e22e>setConnectTimeout</span>(TURN_HTTP_TIMEOUT_MS);
</span></span><span style=display:flex><span>        connection.<span style=color:#a6e22e>setReadTimeout</span>(TURN_HTTP_TIMEOUT_MS);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> responseCode <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>getResponseCode</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (responseCode <span style=color:#f92672>!=</span> 200) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IOException(<span style=color:#e6db74>&#34;Non-200 response when requesting TURN server from &#34;</span> <span style=color:#f92672>+</span> url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; : &#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> connection.<span style=color:#a6e22e>getHeaderField</span>(<span style=color:#66d9ef>null</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        InputStream responseStream <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>getInputStream</span>();
</span></span><span style=display:flex><span>        String response <span style=color:#f92672>=</span> drainStream(responseStream);
</span></span><span style=display:flex><span>        connection.<span style=color:#a6e22e>disconnect</span>();
</span></span><span style=display:flex><span>        Log.<span style=color:#a6e22e>d</span>(TAG, <span style=color:#e6db74>&#34;TURN response: &#34;</span> <span style=color:#f92672>+</span> response);
</span></span><span style=display:flex><span>        JSONObject responseJSON <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JSONObject(response);
</span></span><span style=display:flex><span>        JSONArray iceServers <span style=color:#f92672>=</span> responseJSON.<span style=color:#a6e22e>getJSONArray</span>(<span style=color:#e6db74>&#34;iceServers&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> iceServers.<span style=color:#a6e22e>length</span>(); <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>            JSONObject server <span style=color:#f92672>=</span> iceServers.<span style=color:#a6e22e>getJSONObject</span>(i);
</span></span><span style=display:flex><span>            JSONArray turnUrls <span style=color:#f92672>=</span> server.<span style=color:#a6e22e>getJSONArray</span>(<span style=color:#e6db74>&#34;urls&#34;</span>);
</span></span><span style=display:flex><span>            String username <span style=color:#f92672>=</span> server.<span style=color:#a6e22e>has</span>(<span style=color:#e6db74>&#34;username&#34;</span>) <span style=color:#f92672>?</span> server.<span style=color:#a6e22e>getString</span>(<span style=color:#e6db74>&#34;username&#34;</span>) : <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>            String credential <span style=color:#f92672>=</span> server.<span style=color:#a6e22e>has</span>(<span style=color:#e6db74>&#34;credential&#34;</span>) <span style=color:#f92672>?</span> server.<span style=color:#a6e22e>getString</span>(<span style=color:#e6db74>&#34;credential&#34;</span>) : <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> 0; j <span style=color:#f92672>&lt;</span> turnUrls.<span style=color:#a6e22e>length</span>(); j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                String turnUrl <span style=color:#f92672>=</span> turnUrls.<span style=color:#a6e22e>getString</span>(j);
</span></span><span style=display:flex><span>                turnServers.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> PeerConnection.<span style=color:#a6e22e>IceServer</span>(turnUrl, username, credential));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> turnServers;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Return the contents of an InputStream as a String.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>drainStream</span>(InputStream in) {
</span></span><span style=display:flex><span>        Scanner s <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Scanner(in).<span style=color:#a6e22e>useDelimiter</span>(<span style=color:#e6db74>&#34;\\A&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> s.<span style=color:#a6e22e>hasNext</span>() <span style=color:#f92672>?</span> s.<span style=color:#a6e22e>next</span>() : <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>把這邊拿來的list當ICE candidate, 就可以成功透過Google的TURN server去穿牆了(長久之計還是自己架一台吧)</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2016-11-23 12:05:38 +0000 UTC"><a href=/Rate-limit-with-Go-and-Gin/>Nov 23, 2016</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/Rate-limit-with-Go-and-Gin/ rel=bookmark title="Rate limit with Go and Gin" itemprop=url>Rate limit with Go and Gin</a></h1></header><div class=entry-content><p>昨天趁等著去面試前稍微把這之前想要寫一下的這題目打包成一個<a href=https://github.com/gin-gonic/gin>Gin</a>的middleware :</p><ul><li><a href=https://github.com/julianshen/gin-limiter>Gin-limiter</a></li></ul><p>Rate limiting 通常在很多開放API的服務內會常看到, 像是<a href=https://dev.twitter.com/rest/public/rate-limiting>Twitter</a>,
像是<a href=https://developers.facebook.com/docs/graph-api/advanced/rate-limiting>Facebook</a>或是<a href=http://open.weibo.com/wiki/Rate-limiting>新浪微博</a>,
其目的就是希望API不要被特定節點頻繁存取以致於造成伺服器端的過載</p><h3 id=rate-limiter>rate limiter</h3><p>一般的Rate limiting的設計大致上來說就是限制某一個特定的節點(或使用者或API Key等等)在一段特定的時間內的存取次數,
比如說, 限制一分鐘最多60次存取這樣的規則, 最直覺的方式我們是可以起一個timer和一個counter, counter大於60就限制存取, timer則每60秒重置counter一次,
看似這樣就好了, 但其實這有漏洞, 假設我在第59秒時瞬間存取了60次, 第61秒又瞬間存取了60次, 在這設計上是合法的, 因為counter在第60秒時就被重置了,
但實質上卻違反了一分鐘最多60次這限制, 因為他在兩秒內就存取了120次, 遠大於我們設計的限制, 當然我們也可以用Sliding time window來解決,
但那個實作上就稍稍複雜點</p><p>目前兩個主流比較常見的做法是<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>和<a href=https://en.wikipedia.org/wiki/Leaky_bucket>Leaky Bucket</a>,
這兩個原理上大同小異</p><p>先來說說<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>, 他的做法是, 假設你有個桶子, 裡面是拿來裝令牌(Token)的,
桶子不是Doraemon的四次元口袋, 所以他空間是有限的, 令牌(Token)的作用在於, 要執行命令的人, 如果沒從桶子內摸到令牌, 就不准執行,
然後我們一段時間內丟一些令牌進去, 如果桶子裡面已經裝滿就不丟, 以上個例子來說, 我們可以準備一個最多可以裝60個令牌的桶子, 每秒鐘丟一個進去,
如果消耗速度大於每秒一個, 自然桶子很快就乾了, 就沒牌子拿了</p><p><a href=https://en.wikipedia.org/wiki/Leaky_bucket>Leaky Bucket</a>跟<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>很像, 不過就是反過來,
我們把每次的存取都當作一滴水滴入桶子中, 桶子滿了就會溢出(拒絕存取), 桶子底下打個洞, 讓水以固定速率流出去, 這樣一樣能達到類似的效果</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/c/c4/Leaky_bucket_analogy.JPG alt="Leaky Bucket"></p><h3 id=go的rate-limiter實作>Go的rate limiter實作</h3><p>Go官方的package內其實是有rate limiter的實作的:</p><ul><li><a href=https://godoc.org/golang.org/x/time/rate>package rate</a></li></ul><p>照他的說法他是實作了<a href=https://en.wikipedia.org/wiki/Token_bucket>Token Bucket</a>, <a href=https://godoc.org/golang.org/x/time/rate#NewLimiter>創建一個Limiter</a>,
要給的參數是<a href=https://godoc.org/golang.org/x/time/rate#Limit>Limit</a>和b, 這個Limit指的是每秒鐘丟多少Token進桶字(? 我不知道有沒理解錯),
而b是桶子的大小</p><p>實際上去用了之後發現好像也不是那麼好用, 可能我理解有問題, 出現的並不是我想像的結果, 因此我換用了<a href=https://github.com/juju/ratelimit>Juju&rsquo;s ratelimit</a>,
這個是在<a href=https://github.com/go-kit/kit>gokit</a>這邊看到它有用, 所以應該不會差到哪去, 一樣也是Token Bucket,給的參數就是多久餵一次牌子, 跟桶子的大小, 這就簡單用了一點</p><h3 id=包裝成gin-middleware>包裝成Gin middleware</h3><p>要套在web server上使用的話, 包裝成middleware是比較方便的, 因此我就花了點時間把<a href=https://github.com/juju/ratelimit>Juju&rsquo;s ratelimit</a>包裝成這個:</p><ul><li><a href=https://github.com/julianshen/gin-limiter>Gin-limiter</a></li></ul><p>使用範例如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#75715e>//Allow only 10 requests per minute per API-Key</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lm</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>limiter</span>.<span style=color:#a6e22e>NewRateLimiter</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>, <span style=color:#ae81ff>10</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;X-API-KEY&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>key</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;API key is missing&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#75715e>//Apply only to /ping</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/ping&#34;</span>, <span style=color:#a6e22e>lm</span>.<span style=color:#a6e22e>Middleware</span>(), <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//Allow only 5 requests per second per user</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lm2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>limiter</span>.<span style=color:#a6e22e>NewRateLimiter</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#ae81ff>5</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;X-USER-TOKEN&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>key</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;User is not authorized&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//Apply to a group</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Group</span>(<span style=color:#e6db74>&#34;/v2&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>lm2</span>.<span style=color:#a6e22e>Middleware</span>())
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/ping&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>,
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/another_ping&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;pong pong&#34;</span>,
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>這邊本來想說為了簡單理解一點把參數設計成"每分鐘不能超過10次"這樣的描述, 然後後面再轉換成實際的fillInterval, 不過好像覺得怪怪的,
有點不太符合Token Bucket的特質, 寫成middleware後的彈性就較大一點, 可以全部都用一個limiter或是分不同的資源不同限制都可</p><p>這邊建構時要傳入一個用來產生key的函數, 這是考慮到每個人想限制的依據不同, 例如根據API key, 或是session, 或是不同來源之類的, 由這函數去
產生一個對應的key來找到limiter, 如果傳回error, 就是這個request不符合規則, 直接把他拒絕掉</p><h3 id=跨server的rate-limit>跨server的rate limit</h3><p>這方法只能針對單一server, 但現在通常都是多台server水平擴展, 因此也是會需要橫跨server的解決方案, 這部分的話, 用Redis來實作Token Bucket是可行的, 這等下次再來弄好了</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2016-11-11 14:53:03 +0000 UTC"><a href=/%E7%94%A8Groupcache%E5%92%8Cetcd%E5%BB%BA%E7%BD%AEthumbnail%E6%9C%8D%E5%8B%99/>Nov 11, 2016</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</span></div><h1 class=entry-title><a href=/%E7%94%A8Groupcache%E5%92%8Cetcd%E5%BB%BA%E7%BD%AEthumbnail%E6%9C%8D%E5%8B%99/ rel=bookmark title=用Groupcache和etcd建置thumbnail服務 itemprop=url>用Groupcache和etcd建置thumbnail服務</a></h1></header><div class=entry-content><p>在之前工作的時候, 做了一個專門用來產生thumbnail(縮圖)的服務, 當時這東西主要的目的是為了因應<a href=http://www.zencircle.com>Zencircle</a>會有不同尺寸的縮圖的需求,
而且每次client app改版又可能多新的尺寸, 因此當時寫了這個叫Minami的服務, 當時幾個簡單的需求是:</p><ol><li>要能夠被CDN所cache (因此URL設定上不採用query string,而是簡單的URL)</li><li>能夠容易被deploy</li><li>能夠的簡單的被擴展 (加一台新的instance就可以)</li><li>不需要太多額外的dependencies</li></ol><p>不過那時候寫的版本, 沒寫得很好, 這兩天花了點時間重寫了一個叫做<a href=https://github.com/julianshen/minami_t>Minami_t</a>(本來Minami這名字就是來自於Minami Takahashi, 所以加個"t" XD),
新的這個重寫的版本採一樣的架構(使用了<a href=https://github.com/golang/groupcache>groupcache</a>), 但多加了Peer discovery的功能(使用<a href=https://github.com/coreos/etcd>etcd</a>), 但少了
臉部辨識跟色情照片偵測功能(原本在前公司的版本有, 新寫的這個我懶得加了)</p><p>我把這次重寫的版本放到github上: <a href=https://github.com/julianshen/minami_t>Minami_t</a></p><p>不過這算是一個sample project, 影像來源來自於Imgur, 如何使用或如何改成支援自己的Image host, 那就自行看source code吧, 這版本縮圖的部分用了我改過的<a href=https://github.com/julianshen/vips>VIPS</a>,
當然原來版本的VIPS也是可用, 這版本只是我當初為了支援Face crop所改出來的</p><h3 id=groupcache>Groupcache</h3><p>先來說說為什麼採用<a href=https://github.com/golang/groupcache>groupcache</a>? 我不是很確定當時為何會看到<a href=https://github.com/golang/groupcache>groupcache</a>這來, 但後來想想, 採用它的原因可能是看到<a href=https://talks.golang.org/2013/oscon-dl.slide#43>這份投影片</a>,
它是memchached的作者寫來用在dl.google.com上面的, 架構上剛好也適合thumbnail service, 可能剛好投影片又提到thumbnail(我腦波也太弱了吧), 所以當初採用它來實作這個service</p><p>架構上會像是這樣:</p><p><img src=/images/posts/minami1.001.jpeg alt></p><p>Groupcache有幾個特色</p><ol><li>Embedded, 不像memcached, redis需要額外的server, 它是嵌入在你原本的程式內的</li><li>Shared, Cache是可以所有Peer共享的, 資料未必放在某特定的Peer上, 有可能在本機, 也可能在另一台, 當然如果剛好在本機時就會快一點</li><li>LRU, Cache總量有上限限制的, 過久沒使用的資料有可能會被移出記憶體</li><li>Immutable, key所對應的值不像memcached, redis可以修改, 而是當cache miss時, 他會再透過你實作的getter去抓真正的資料</li></ol><p>要讓Groupcache可以在不同node間共享cache, 就必須開啟HTTPPool, 像下面</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>	<span style=color:#a6e22e>ln</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;:%d&#34;</span>, <span style=color:#a6e22e>port</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>port</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>port</span> = <span style=color:#a6e22e>ln</span>.<span style=color:#a6e22e>Addr</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>TCPAddr</span>).<span style=color:#a6e22e>Port</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;http://%s:%d&#34;</span>, <span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>port</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pool</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>groupcache</span>.<span style=color:#a6e22e>NewHTTPPool</span>(<span style=color:#a6e22e>_url</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Group cache served at port %s:%d\n&#34;</span>, <span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>port</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Serve</span>(<span style=color:#a6e22e>ln</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>ServeHTTP</span>)); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;GROUPCACHE PORT %d, ERROR: %s\n&#34;</span>, <span style=color:#a6e22e>port</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span></code></pre></div><p>Groupcache 的getter範例:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getter</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>groupcache</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>dest</span> <span style=color:#a6e22e>groupcache</span>.<span style=color:#a6e22e>Sink</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Cache missed for &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>key</span>, <span style=color:#e6db74>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>params</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrWrongKey</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>Downloader</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Download</span>(<span style=color:#e6db74>&#34;http://i.imgur.com/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>params</span>[<span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//Should assume correct since it is checked at where it is from</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>params</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>height</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>params</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resize</span>(<span style=color:#a6e22e>fileName</span>, <span style=color:#a6e22e>width</span>, <span style=color:#a6e22e>height</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dest</span>.<span style=color:#a6e22e>SetBytes</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=etcd>etcd</h3><p>我之前寫的版本有個問題是, 沒有自動的peer discovery的功能, 所以必須手動加peer, 這版本把etcd導入, etcd已經是coreos的核心之一了, 簡單, 又蠻好用的,
不過選它也是它直接有Go的client了</p><p>Peer discovery的部分, 參考了<a href=https://github.com/go-kit/kit>Go kit</a>的<a href=https://github.com/go-kit/kit/tree/master/sd/etcd>etcd實作</a>,
<a href=https://github.com/go-kit/kit>Go kit</a>是一個蠻好的Go的微服務框架, 它裡面也有實作用etcd做service discovery, 這一部分正好是這邊需要的, 因此
參考並寫出了這邊這個版本</p><p>重點是要能夠在有新server加入後就新增到peer list去, 有server離開後要拿掉, 因此必須利用到etcd的watch功能</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceRegistry</span>) <span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>watcher</span> <span style=color:#a6e22e>Watcher</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;/%s/nodes&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;watch &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>etcd_client</span>.<span style=color:#a6e22e>Watcher</span>(<span style=color:#a6e22e>key</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>etcd</span>.<span style=color:#a6e22e>WatcherOptions</span>{<span style=color:#a6e22e>AfterIndex</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>Recursive</span>: <span style=color:#66d9ef>true</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>retryInterval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Next</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to connect to etcd. Will retry after %d sec \n&#34;</span>, <span style=color:#a6e22e>retryInterval</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>retryInterval</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>retryInterval</span> = (<span style=color:#a6e22e>retryInterval</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>retryInterval</span> &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>retryInterval</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>list</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GetNodes</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>watcher</span>(<span style=color:#a6e22e>list</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>//skip first</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Watch可以用來監測某一個key有無改變, 因此我們只要一直監測server node的list就好(指定一個key來放), 因此流程是這樣的:</p><ol><li>Server開啟後, 自己到etcd註冊自己, 並把etcd上找到的nodes全加到peer list中</li><li>另一台由etcd發現有另一台出現後, 把它加到peer list中</li><li>Server下線後, 要移除自己的註冊, 其他機器要從peer list把它移除</li></ol><p>問題點在最後一點, Server下線有可能是被kill的, 也有可能按ctrl-c中斷的, 這時候就要監聽os的signal,
在程式被結束前, 可以先去移除註冊, 像這樣:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>//Listening to exit signals for graceful leave</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGINT</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGTERM</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;I&#39;m leaving&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cm</span>.<span style=color:#a6e22e>Leave</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>}()
</span></span></code></pre></div><p>這只是一個sample而已, 還有一些待改進的</p></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2016-11-04 15:11:58 +0000 UTC"><a href=/ES6-Generators/>Nov 4, 2016</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~2 minutes</span></div><h1 class=entry-title><a href=/ES6-Generators/ rel=bookmark title="[ES6] Generators" itemprop=url>[ES6] Generators</a></h1></header><div class=entry-content><p>這個語法蠻有趣的, 早上一直都在看這個想能拿來幹嘛? 結果早上有個phone interview就有點腦袋小小的轉不過來,
不過這不是重點, 先簡單的來講一下<a href=https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Statements/function*>Generators</a></p><p>產生器? 顧名思義或許是這樣, 可以先看一下MDN上的<a href=https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Statements/function*>文件</a>,
這是一個從ES6開始才有的功能, 因此要在比較新的瀏覽器, 或是nodejs 6之後才有支援, 先來看看MDN上那個簡單的例子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>idMaker</span>(){
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>index</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span>(<span style=color:#a6e22e>index</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> <span style=color:#a6e22e>index</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>gen</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>idMaker</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>gen</span>.<span style=color:#a6e22e>next</span>().<span style=color:#a6e22e>value</span>); <span style=color:#75715e>// 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>gen</span>.<span style=color:#a6e22e>next</span>().<span style=color:#a6e22e>value</span>); <span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>gen</span>.<span style=color:#a6e22e>next</span>().<span style=color:#a6e22e>value</span>); <span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>gen</span>.<span style=color:#a6e22e>next</span>().<span style=color:#a6e22e>value</span>); <span style=color:#75715e>// undefined
</span></span></span></code></pre></div><p>一個generator是以"function*&ldquo;宣告的, 可以說它是一種特別的function, 跟一般的function一次跑到結束不同,
它是可以中途暫停的, 以上面這例子來說, 如果習慣傳統的寫法, 可能會有點小暈, while loop在idMaker裡面不是一次做到完嗎?
剛剛說generator是可被中途暫停的, 因此, 在第一輪的時候會先停在"yield"處, 當你呼叫next()才會到下一個yield位置停下來並回傳,
我的感覺是比較像一種有帶state的function之類的</p><p>有什麼用途? 從上面的例子, 當然最直覺想到的是ID產生器或是計數器之類的東西, 網路上應該可以找到一些不同的用法, 比如說搭配Promise, 有興趣可以自己找找,
是不只可以用在產生器, 拿我早上interview被問到的實作strstr, 不是很難的東西, 我原本拿go寫,出了點小槌, 而且也只能找第一個發生的字串, 後來用generator改了這版本:</p><script src=https://gist.github.com/julianshen/6c06ccfa0942829ea24973778a96ab64.js></script><p>以這個來說, 第一次呼叫會找出第一個發生的點, 可以持續呼叫到所有的都找出來為止, generator是可以被iterate的, 因此這邊可以用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>gen</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>i</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>不需要一直call next(), next()回傳回來的會是{value:&mldr;, done:&mldr;}, 因此可以看done知道是否已經結束</p><p>下面這範例則是一個質數產生器, 一直call next就可以產生下一個質數:</p><script src=https://gist.github.com/julianshen/0c283f6f76abf258f9c0d4292a1e14f9.js></script></div></article><article class=hentry><header><div class=entry-meta><span class="entry-date date published updated"><time datetime="2016-11-02 09:15:35 +0000 UTC"><a href=/%E6%B7%BA%E8%AB%87Social-Feed-%E5%BE%8C%E7%AB%AF%E6%9E%B6%E6%A7%8B%E5%AF%A6%E4%BD%9C-Server/>Nov 2, 2016</a></time></span>
<span class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~10 minutes</span></div><h1 class=entry-title><a href=/%E6%B7%BA%E8%AB%87Social-Feed-%E5%BE%8C%E7%AB%AF%E6%9E%B6%E6%A7%8B%E5%AF%A6%E4%BD%9C-Server/ rel=bookmark title="淺談Social Feed - 後端架構實作 [Server]" itemprop=url>淺談Social Feed - 後端架構實作 [Server]</a></h1></header><div class=entry-content><p>這應該是這系列最後一篇了吧, 雖然回頭看, 可能有些漏寫, 不過, 以後想到再補吧, 如果還沒看過前兩篇, 可以再複習一下:
<a href=/%E6%B7%BA%E8%AB%87social-feed-%E6%A6%82%E5%BF%B5%E7%AF%87/>概念篇</a>,<a href=/%E6%B7%BA%E8%AB%87social-feed-%E5%A4%9A%E6%9C%8D%E5%8B%99%E5%BD%99%E6%95%B4%E5%BC%8F%E7%9A%84social-feed-client/>多服務彙整</a></p><p>這篇主要要著眼在如何做Timeline這東西(怎又突然把它叫Timeline了? 好吧, 複習了一下很多文章, 發現這還是比較通用的名詞)</p><p>先借用一下以前跟老闆報告時, 老闆問的</p><pre><code>&quot;做這很難嗎?&quot;
</code></pre><p>這不是啥記恨啦(雖然我還蠻有印象這問題跟我的回答的), 而是開始做這個的時候, 我也覺得應該沒什麼難的, 不過, 實作這個功能本身的確不難,
倒是要讓它可以擴展(scale)這件事, 的確會比較麻煩, 也不止一個方法做, 先從基本來看一下</p><h2 id=什麼構成一個timeline-social-feed>什麼構成一個Timeline (Social feed)</h2><p>Twitter和Facebook主要把這東西分為兩類 - User timeline和Home timeline</p><p>User timeline主要就是單一使用者的近況更新, 也就是所有的內容都是由那個使用者產生, 並以時間排序(不然怎叫Timeline),
這部分倒沒什麼困難的, 因為它就是單一個人的流水帳(從軟體的角度也可以說成他活動的"log")</p><p>Home timeline包含的則不是單一個人的, 而是包含你關注的人所有的動態, 在Twitter就是你follow的人, 而Facebook則是你的朋友加上你關注的人(follow)和粉絲頁,
講"follow"其實蠻貼切的啦, 有點偷窺(光明正大吧?), 又有點跟蹤狂的感覺, 但現今的Home timeline大多(尤其是Facebook)不是用時間排序, 好像也不能真的叫Timeline (ㄠ回來了, 這樣我叫Social feed好像比較貼切 XD)</p><p>假設我follow了user1, user2, user3等三個人, 那我的Home timeline就會變成這樣:</p><p><img src=/images/posts/timline.003.jpeg alt></p><p>Ok, 其實這有點像前一篇講的<a href=/%E6%B7%BA%E8%AB%87social-feed-%E5%A4%9A%E6%9C%8D%E5%8B%99%E5%BD%99%E6%95%B4%E5%BC%8F%E7%9A%84social-feed-client/>多服務彙整</a>那種, 不同的是, 這些feeds是來自於同一個來源, 並不是多個不同的服務, 比較沒資料異質性問題</p><h2 id=1-9-90-理論>1 9 90 理論</h2><p>在切入實作面之前, 先提一下這個理論, 這邊有Mr. Jamine對這個的解釋: <a href=http://mrjamie.cc/2013/08/08/1-9-90-rule/>&ldquo;網路內容的 1/9/90 定律&rdquo;</a>
(他用"定律", 但定律是比較恆常的, 但這比例並不是那麼的絕對, 所以我比較覺得用理論或假設比較適合)</p><p>這理論說的是, 大約有90%(甚或以上)的人是屬於讀者, 9%的人會參與進一步互動(比如說按讚或回文), 只有1%的創作者(你可以看一下你自己是屬於哪類的人),
根據我的經驗, 讀者可能會多於90%, 創作者甚至可能少於1%</p><p>那對於開發者來說, 知道這些有什麼用? 我個人是覺得一個開發者或是架構設計者, 必須要清楚暸解所做的東西所會產生的行為才能產出一個好的架構, 以這個來說,
如果要設計一個高度可擴展的架構的話, 我們可知道, 絕大部分的request其實都是讀取(read), 高併發(highly concurrent)的寫入機會並不大(反而比較容易發生在like, comment)</p><h2 id=比較直覺的實作方式>比較直覺的實作方式</h2><p>好, 難免的, 我一開始也是選用這種方式 - 都交給資料庫(database), 這邊的資料庫, 不管SQL或No-SQL, 差不多原理啦, 雖然說針對Feed這種time squences看起來像比較適合No SQL, 但Facebook不也是用My SQL(雖然用的方式比較是key-value的方式)</p><p>依照前面的說法, 我們可以簡單的假設有兩種資料 - 使用者(User)和內容(Feed)</p><ol><li>使用者可以跟隨(Follow)其他使用者(這邊引用Twitter的設定), 因此每個使用者會有n個"follower"</li><li>使用者可以發文(Feed/Post), 每則發文都有(只有)一個作者(author)</li><li>每個使用者的Homeline是由他跟隨的所有人的發文所組成</li><li>每次client來要求homeline最多給m則(比如說25則)</li></ol><p>按照這樣的說法, 我們可以想像Query或許長得像這樣(No SQL版本自行想像):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> FEED <span style=color:#66d9ef>WHERE</span> AUTHOR <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> FOLLOWERS <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>USER</span> <span style=color:#66d9ef>WHERE</span> ID<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;myid&#39;</span>) <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> TIME LIMITS m
</span></span></code></pre></div><p>這邊暫時先省略掉query出來你還要再query出user大頭照跟人名的部分, 但加上這部分每次至少要有兩次queries</p><p>這樣不就搞定了? 有什麼問題? 有, 後面就會撐不住了! (切身之痛), 先來看看什麼問題</p><h3 id=查詢效率>查詢效率</h3><p>從上面的query來說, 它還包含了個sub query去取出所有的followers, 所以這整串在資料庫裡可能的做法是, 把所有相關使用者的feed取出,
在記憶體中排序, 取前m個, 前面有提到, Feed就像流水帳, 全部的人加起來可能不少, 這聽起來就像是耗時耗CPU的查詢</p><p>因此在兩個狀況下就慘了:</p><ol><li>讀取高併發時</li><li>使用者follow了"一大堆"人!!!</li></ol><p>關於第一點, 這很容易發生呀! 90%的人一天到晚窺探&mldr;ㄟ &mldr;關心&mldr;人家在幹嘛, 當一堆這些queries湧入, 資料庫會非常忙碌的, 因為沒有不同的兩個人會follow同樣的人, 根本無法cache</p><p>第二點其實更慘了, follow個幾個人還好, 幾十個人還搞得定, 偏偏這個社群網路時代的, 幾百人是標配, 上千人的也不少, 如果有上萬, 可能更跑不動了(Facebook限制你只能交5000個朋友, Twitter超過5000也是選擇性的讓你少量follow, 所以上萬目前應該還比較少見)</p><h3 id=materialized-view>Materialized View</h3><p>有些資料庫, 像是<a href=http://www.fromdual.com/mysql-materialized-views>MySQL</a>, <a href=postgresql.org/docs/9.3/static/sql-creatematerializedview.html>Postgresql</a>, <a href=http://www.datastax.com/dev/blog/new-in-cassandra-3-0-materialized-views>Cassandra (3.0+)</a>都有支援Materialized view, materialized view就像是一個query的snapshot, join的部分是發生在create或是refresh時, 因此用來解決讀取高併發可能是可行的, 因為讀取時只有單純的query, 直到有更新時再呼叫refresh</p><p>但對於更新比較頻繁, 比較熱門的social network service, 資料庫的負擔還是不算小</p><h3 id=sharding>Sharding</h3><p>如果以時間為基準來做sharding, 或許可以解決這兩個問題, 因為不是所有的人不時都在更新狀態, 所以在含有最新的shard裡面包含的可能只有少數人的feed, 這減少了遍訪所有人的feed的工, 而且不用排序所有的feed</p><p>但還是有幾個問題:</p><ol><li>無法join, 如果根據feed的時間去做sharding, feed跟user就不見得在同一資料庫, 這樣就無法join了</li><li>邊界問題, 有可能你需要的資料剛好就在時間間界的附近, 導致一開始query不到足夠的資料</li></ol><p>其實上面問題寫程式解決都不是問題啦, 這邊想說的只是, 沒辦法以一兩個簡單的queries就搞定了</p><h2 id=大家都怎麼做>大家都怎麼做</h2><p>這邊講的"大家"就那些大咖囉, Facebook, Twitter, Pinterest, Tumblr &mldr;等等, 關於這個問題, 其實Yahoo曾經出過一篇論文:</p><p><a href=http://jeffterrace.com/docs/feeding-frenzy-sigmod10-web.pdf>&ldquo;Feeding Frenzy: Selectively Materializing Users’ Event
Feeds&rdquo;</a></p><p>如果沒耐心看完論文(我也沒耐心), 這邊先簡單提一下兩種模式:</p><ol><li>Push model</li><li>Pull model</li></ol><p><img src=/images/posts/timline.005.jpeg alt></p><p>Push model又被稱為Megafeed(<a href=https://www.infoq.com/presentations/Facebook-News-Feed>根據某場Facebook的分享</a>),
而Pull model則是Facebook使用的Multifeed, 其實不管哪種模式, 大多不是直接存取資料庫增加資料庫的負擔, 而是大量的應用快取(cache), 像是Memcached, Redis等等</p><p>簡單的來說, Push model在整合feed的時間發生在寫入, 而Pull model則是發生在讀取</p><h3 id=push-model-megafeed>Push model (Megafeed)</h3><p>這是Twitter所採用的方式, 也是我以前採用過的做法, 我自己則是把它稱為Inbox model, 比較詳細的內容推薦可以參考Twiter的:</p><p><a href=https://www.infoq.com/presentations/Twitter-Timeline-Scalability>&ldquo;Timelines at Scale&rdquo;</a></p><p>先來看看他們這張架構圖</p><p><img src=/images/posts/twitter_mega_feed.png alt></p><p>Home timeline的部分主要是中間的那個流程, 這做法比較像是E-mail一樣(所以我才稱它為inbox), 當使用者發表了一則新的動態後,
系統會根據有訂閱這則動態有那些人(也就是follow這個使用者的人), 然後把這則動態複製到各個訂閱者的Home timeline (Inbox)上</p><p>這方法的優點是, 對於讀取相當之快, 因為Home timeline已經在寫入期間就準備好了, 所以當使用者要讀取時, 不需要複雜的join就能取得, 在做pagination也相當簡單, 因為本來就是依時序排下去的</p><p>但缺點是, 很顯而易見的, 非常耗費空間, 因為每個timeline都要複製一份, 假設你被上千人follow, 就要上千份, 因此Twitter只有存ID和flag, 詳細的內容跟Meta data, 是後來才從cache去合併來的, 另外Twitter也只存了最近的八百則, 所以你不可能得無窮無盡的往前滑</p><p>另一點就是耗時, 這種寫入通常是非同步的, 使用者發布動態後, 他只知道他動態發布成功了, 但系統還需要在背後寫到各個Inbox中, 因此他不會知道別人其實可能還看不到的, 對於一個follower數量不多的不是問題,
但如果像是Lady gaga那種大人物, 有幾百萬粉絲, 那就是大問題了! 寫入幾百萬的timeline即使只寫入memcached也是相當耗時的事,
而且這會產生時間錯亂的問題, follower比較少得很快就做完了, 所以很容易看到比較熱門的人物的貼文比較晚出現</p><p>Twitter是把follower多的人另案處理, 也就是讀取時段再合併(那就是類似下面要講的multifeed了), 這樣可以省下一些空間跟時間, 另一種可行的做法(我們之前的做法),
就是不寫到所有人的timeline, 而是只cache最近有上線的人的timeline, 這樣就算Lady gaga有幾百萬粉絲, 實際上最近才有上線的可能才幾十萬或更少,
處理這部分就好了, 如果cache裡面並沒有現在上線這個人的timeline, 就在從資料庫讀取合成就好</p><p>不過總歸來說, 這方法讀取快, 但寫入慢, 耗費空間, 較適合讀比寫多上許多的應用</p><p>此外其實也有不同的變形, 像是Pinterest:</p><p><a href=https://engineering.pinterest.com/blog/building-smarter-home-feed>Building a smarter home feed</a></p><h3 id=pull-model-multifeed>Pull model (Multifeed)</h3><p>Facebook採用了一個完全不同的方式, 叫做Multifeed, 這方式從2009開始在Infoq就一直被提到:</p><ol><li><a href=https://www.infoq.com/presentations/Facebook-Software-Stack>Facebook: Science and the Social Graph</a> 2009, by Aditya Agarwal</li><li><a href=https://www.infoq.com/presentations/Scale-at-Facebook>Scale at Facebook</a> 2010, by Aditya Agarwal</li><li><a href=https://www.infoq.com/presentations/Facebook-News-Feed>Facebook News Feed: Social Data at Scale</a> 2012, by Serkan Piantino (Aditya Agarwal這時候應該跑到Dropbox去了)</li></ol><p>這跟Push model有什麼不同? 其實說起來跟前面一開始用DB的方式比較像, 就是在讀取時, 才取得所跟隨的人的feed, 合併並排序,
但這樣不是讀取很沒效率嗎?先來看看圖:</p><p><img src=/images/posts/timline.004.jpeg alt></p><ol><li>在寫入時, feed資料只會寫入"一個"leaf server, 應該是根據user去分流的</li><li>leaf server主要是memcached, 所以都是in memory的</li><li>在memory裡面不可能保存所有動態, 只會保存最近一段時間的 (所以不可能包含所有人所有的動態, 在做整合時就輕鬆多了)</li><li>前端跟Aggregator query後, Aggregator會去跟"所有"的leaf server問所有相關的人的feed再回來整合</li></ol><p>因為資料存儲跟處理都在memory, 所以可以很快, 但還是要考慮到網路的部分, 因此leaf server跨區的話效率就不會高了, 自然空間需求會比Pull model來得少, 但home timeline的讀取時間就較長了(因為是read time aggregation的關係),也不會有名人問題, 不會因為follower多, 複製耗時耗空間
另一個優點是, 排序的方式控制在Aggregator, 因此很容易立刻更動規則, 不像pull model, 當home timeline組好後要去變動它就較麻煩</p><h3 id=混搭風>混搭風</h3><p>當然沒有絕對的好壞, 兩種模式各有優缺, 所以也有人採用的是混合模式, 根據使用者使用頻率來決定, 這就跟穿衣服一樣, 每個人怎搭衣服都是不一樣的, 端看你要怎混搭</p><h2 id=rest-api的問題>REST API的問題</h2><p>在前面一篇<a href=/%E6%B7%BA%E8%AB%87social-feed-%E5%A4%9A%E6%9C%8D%E5%8B%99%E5%BD%99%E6%95%B4%E5%BC%8F%E7%9A%84social-feed-client/>多服務彙整</a>裡有提到REST API都是輪詢(polling)的模式, 不管資料有沒更新,
Client都是會常常來server查詢資料, 這對server可能會是夢靨, 因為只有1%在努力創作, 所以搞不好有很大量的查詢都是浪費的, 而這些查詢通常是造成系統多餘負擔的元兇</p><p>關於這問題, 我有兩個想法, 不過都還沒實際去實證過</p><ol><li>增加HEAD的API, 大部分REST API是以GET直接抓取資料, 所以針對個別資源(Resource), 應可實作HEAD, 讓Client在實際去查詢資料前先確訂一下資源的更新時間, 資源的更新時間在資料更新時就可以放在cache內了, 相對的可以省傳輸的數據量跟處理時間</li><li>利用PUSH, 現在大部分的應用都在手機上, 也大多有實作PUSH, 當有資料更新且App在前景時, 利用PUSH通知有資料更新, Client收到後才會真的去抓取, 不過這比較起來感覺相對負擔較重</li></ol><p>另外這篇也是值得去參考(只是這個還要帶入XMPP):</p><p><a href=http://cdn.oreillystatic.com/en/assets/1/event/12/Beyond%20REST_%20Building%20Data%20Services%20with%20XMPP%20PubSub%20Presentation.pdf>Beyond REST?Building data services with XMPP PubSub</a></p></div></article><div class=pagination><ul class=inline-list><li><a href=/post/page/10/ class=btn>Previous</a></li><li><a href=/post/>1</a></li><li><a href=/post/page/2/>2</a></li><li><a href=/post/page/3/>3</a></li><li><a href=/post/page/4/>4</a></li><li><a href=/post/page/5/>5</a></li><li><a href=/post/page/6/>6</a></li><li><a href=/post/page/7/>7</a></li><li><a href=/post/page/8/>8</a></li><li><a href=/post/page/9/>9</a></li><li><a href=/post/page/10/>10</a></li><li><strong class=current-page>11</strong></li><li><a href=/post/page/12/>12</a></li><li><a href=/post/page/13/>13</a></li><li><a href=/post/page/14/>14</a></li><li><a href=/post/page/15/>15</a></li><li><a href=/post/page/16/>16</a></li><li><a href=/post/page/17/>17</a></li><li><a href=/post/page/18/>18</a></li><li><a href=/post/page/19/>19</a></li><li><a href=/post/page/20/>20</a></li><li><a href=/post/page/21/>21</a></li><li><a href=/post/page/22/>22</a></li><li><a href=/post/page/23/>23</a></li><li><a href=/post/page/24/>24</a></li><li><a href=/post/page/25/>25</a></li><li><a href=/post/page/26/>26</a></li><li><a href=/post/page/27/>27</a></li><li><a href=/post/page/28/>28</a></li><li><a href=/post/page/29/>29</a></li><li><a href=/post/page/30/>30</a></li><li><a href=/post/page/31/>31</a></li><li><a href=/post/page/32/>32</a></li><li><a href=/post/page/33/>33</a></li><li><a href=/post/page/34/>34</a></li><li><a href=/post/page/35/>35</a></li><li><a href=/post/page/36/>36</a></li><li><a href=/post/page/37/>37</a></li><li><a href=/post/page/38/>38</a></li><li><a href=/post/page/39/>39</a></li><li><a href=/post/page/40/>40</a></li><li><a href=/post/page/41/>41</a></li><li><a href=/post/page/42/>42</a></li><li><a href=/post/page/43/>43</a></li><li><a href=/post/page/44/>44</a></li><li><a href=/post/page/45/>45</a></li><li><a href=/post/page/46/>46</a></li><li><a href=/post/page/47/>47</a></li><li><a href=/post/page/48/>48</a></li><li><a href=/post/page/49/>49</a></li><li><a href=/post/page/50/>50</a></li><li><a href=/post/page/51/>51</a></li><li><a href=/post/page/52/>52</a></li><li><a href=/post/page/53/>53</a></li><li><a href=/post/page/54/>54</a></li><li><a href=/post/page/55/>55</a></li><li><a href=/post/page/56/>56</a></li><li><a href=/post/page/57/>57</a></li><li><a href=/post/page/58/>58</a></li><li><a href=/post/page/59/>59</a></li><li><a href=/post/page/60/>60</a></li><li><a href=/post/page/61/>61</a></li><li><a href=/post/page/62/>62</a></li><li><a href=/post/page/63/>63</a></li><li><a href=/post/page/64/>64</a></li><li><a href=/post/page/65/>65</a></li><li><a href=/post/page/66/>66</a></li><li><a href=/post/page/67/>67</a></li><li><a href=/post/page/68/>68</a></li><li><a href=/post/page/69/>69</a></li><li><a href=/post/page/70/>70</a></li><li><a href=/post/page/71/>71</a></li><li><a href=/post/page/72/>72</a></li><li><a href=/post/page/73/>73</a></li><li><a href=/post/page/74/>74</a></li><li><a href=/post/page/75/>75</a></li><li><a href=/post/page/76/>76</a></li><li><a href=/post/page/77/>77</a></li><li><a href=/post/page/12/ class=btn>Next</a></li></ul></div></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script><script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>