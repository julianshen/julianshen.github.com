<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=en><![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang=en><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang=en><![endif]--><!--[if gt IE 8]><!--><html class=no-js lang=en><!--<![endif]--><head><meta charset=utf-8><title>用Go實作Dapr的rawPayload Subscriber &#8211; Le murmure de Julian</title><meta name=description content><meta property="og:title" content="用Go實作Dapr的rawPayload Subscriber"><meta property="og:description" content="本來沒預計寫這篇的, 不過後來想想, 本來想寫的篇幅太大, 先寫這篇幫後面內容暖身, 後續相關內容會再更新到下面連結: 使用Dapr Input/Output Binding連"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.jln.co/dapr-raw-payload-pub-sub/"><meta property="og:image" content="https://og.jln.co/jlns1/55SoR2_lr6bkvZxEYXBy55qEcmF3UGF5bG9hZCBTdWJzY3JpYmVy"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-11-08T00:33:12+08:00"><meta property="article:modified_time" content="2022-11-08T00:33:12+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://og.jln.co/jlns1/55SoR2_lr6bkvZxEYXBy55qEcmF3UGF5bG9hZCBTdWJzY3JpYmVy"><meta name=twitter:title content="用Go實作Dapr的rawPayload Subscriber"><meta name=twitter:description content="本來沒預計寫這篇的, 不過後來想想, 本來想寫的篇幅太大, 先寫這篇幫後面內容暖身, 後續相關內容會再更新到下面連結: 使用Dapr Input/Output Binding連"><link rel=canonical href=https://blog.jln.co/dapr-raw-payload-pub-sub/><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.css><link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel=stylesheet type=text/css><meta http-equiv=cleartype content="on"><meta name=generator content="Hugo 0.105.0"><script src=/js/vendor/modernizr-2.6.2.custom.min.js></script>
<script async src=https://unpkg.com/mermaid@8.2.3/dist/mermaid.min.js></script>
<link rel="shortcut icon" href=/favicon.png></head><body id=post><nav id=dl-menu class=dl-menuwrapper role=navigation style=display:inline-block><button class=dl-trigger>Open Menu</button><ul class=dl-menu><li><a href=/>Home</a></li><li><a href=#>About</a><ul class=dl-submenu><li><img src=/images/avatar.png alt="Julian Shen's photo" class=author-photo><h4>Julian Shen</h4><p>Softward developer</p></li><li><a href=mailto:julianshen22@gmail.com><i class="fa fa-fw fa-envelope"></i> Email</a></li><li><a href=https://linkedin.com/in/julianshen><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a></li><li><a href=https://github.com/julianshen><i class="fa fa-fw fa-github"></i> GitHub</a></li><li><a href=https://instagram.com/julianshen><i class="fa fa-fw fa-instagram"></i> Instagram</a></li></ul></li><li><a href=#>Posts</a><ul class=dl-submenu><li><a href=/post/>All Posts</a></li><li><a href=/tags/>All Tags</a></li></ul></li><li><a href=/></a></li></ul></nav><div id=main role=main><article class=hentry><header class=header-title><div class=header-title-wrap><h1 class=entry-title><a href=/dapr-raw-payload-pub-sub/ rel=bookmark title="用Go實作Dapr的rawPayload Subscriber">用Go實作Dapr的rawPayload Subscriber</a></h1><h2><span class="entry-date date published"><time datetime="2022-11-08 00:33:12 +0800 +0800">November 8, 2022</time></span></h2><p class=entry-reading-time><i class="fa fa-clock-o"></i>
Reading time ~4 minutes</p></div></header><div class=entry-content><p>本來沒預計寫這篇的, 不過後來想想, 本來想寫的篇幅太大, 先寫這篇幫後面內容暖身, 後續相關內容會再更新到下面連結:</p><ol><li><a href=Shi-Yong-Dapr-Input-Output-Bindinglian-Jie-Kafka>使用Dapr Input/Output Binding連接Kafka</a></li></ol><p>這篇並不是要寫怎用go實做Dapr的pubsub, 不完全是, 實做pubsub部分請參考<a href=https://docs.dapr.io/developing-applications/building-blocks/pubsub/howto-publish-subscribe/>官方文件</a>, 基本的Dapr的publisher跟subscriber是用所謂CloudEvent的格式在傳遞, 用CloudEvent的好處是, 由於CloudEvent會幫忙夾帶一些metadata, 因此也就可以實現分散式追蹤(Tracing)的功能, 但缺點就是無法支援一些原本寫好的legacy publisher或subscriber, 所幸Dapr的pubsub還是支援raw payload可以讓你自組你的訊息格式</p><p>在開始之前, 為了測試實做, 我這邊採用了Kafka, 但由於Dapr把實做封裝得不錯, 所以其實也不一定要用Kafka, 不過支援了Kraft之後的Kafka, 由於可以去掉對zoo keeper的依賴, 所以算蠻簡單裝的</p><h3 id=安裝kafka>安裝Kafka</h3><p>使用docker跑Kafka, 應該是最簡單的方式, 只要執行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --name kafka-zkless -p 9092:9092 -e LOG_DIR<span style=color:#f92672>=</span>/tmp/logs quay.io/strimzi/kafka:latest-kafka-2.8.1-amd64 /bin/sh -c <span style=color:#e6db74>&#39;export CLUSTER_ID=$(bin/kafka-storage.sh random-uuid) &amp;&amp; bin/kafka-storage.sh format -t $CLUSTER_ID -c config/kraft/server.properties &amp;&amp; bin/kafka-server-start.sh config/kraft/server.properties&#39;</span>
</span></span></code></pre></div><p>這樣Kafka就可以順利活起來了, 完全不需要跑zoo keeper&mldr;喔耶&mldr;</p><p>建議也可以順便跑一下<a href=https://github.com/dushixiang/kafka-map>Kafka map</a>, 這樣待會可以直接發event來測試</p><h3 id=新增kafka-component>新增Kafka component</h3><p>有了Kafka後, 我們需要在Dapr新增這個component 才可以讓Dapr應用程式使用, 在<code>~/.dape/components</code>底下加一個檔案(可叫做kafka.yaml),內容是:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>dapr.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Component</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-pubsub</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>pubsub.kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>brokers</span> <span style=color:#75715e># Required. Kafka broker connection setting</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;localhost:9092&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>consumerGroup</span> <span style=color:#75715e># Optional. Used for input bindings.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;group1&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>authType</span> <span style=color:#75715e># Required.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;none&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>disableTls</span> <span style=color:#75715e># Optional. Disable TLS. This is not safe for production!! You should read the `Mutual TLS` section for how to use TLS.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>內容就不多做解釋了, 官方文件會有更清楚的說明, 這邊先說明, 這新增上去後, 我們會多一個pubsub component叫做<code>kafka-pubsub</code>, 這名字寫程式會用到囉</p><h3 id=寫個subscriber來接收事件event吧>寫個subscriber來接收事件(event)吧</h3><p><a href=https://docs.dapr.io/developing-applications/building-blocks/pubsub/pubsub-raw/>官方文件</a>其實有寫如何寫一個接收raw payload的subscriber, 但不像其他文件一樣有多種語言範例, 只有Python, PHP兩種</p><p><img src=/post/images/20221108224329.png alt></p><p>但其實, 如上圖, Dapr用sidecar的作法, 簡化了寫pubsub的複雜度, 而且減低了對語言的依賴, 也不像是Istio是從系統的角度設計, 算是有點有趣的作法, 你不用理解pubsub, 也不用特別知道你是用Kafka, NATS, 或者是RabbitMQ, 寫法都一樣, 不囉嗦, 直接看code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/base64&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Subscription</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PubsubName</span> <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;pubsubname&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span>      <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;topic&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Route</span>      <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;route,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Metadata</span>   <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Event</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;topic&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Data</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;data_base64&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sub</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Subscription</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PubsubName</span>: <span style=color:#e6db74>&#34;kafka-pubsub&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Topic</span>:      <span style=color:#e6db74>&#34;myevent&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Route</span>:      <span style=color:#e6db74>&#34;create&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Metadata</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;rawPayload&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Default</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/dapr/subscribe&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, []<span style=color:#f92672>*</span><span style=color:#a6e22e>Subscription</span>{<span style=color:#a6e22e>sub</span>})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>POST</span>(<span style=color:#e6db74>&#34;/create&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>event</span> <span style=color:#a6e22e>Event</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Body</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base64</span>.<span style=color:#a6e22e>RawStdEncoding</span>.<span style=color:#a6e22e>DecodeString</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Data</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>decoded</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#ae81ff>200</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;success&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:6002&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>咦, 這不像是在寫subscriber呀, 倒像是一個web service, 沒錯, 實際上的subscribe的部分被封裝在Dapr內了, Dapr等於收到Event後會打給我們的程式</p><p>那他怎知道要收到哪個queue哪個topic要打到哪個endpoint? 很簡單, 你只要有一個叫做<code>/dapr/subscribe</code>的endpoint, 在開始執行後, Dapr會自行打這endpoint了解你希望幫忙它收哪些event, 這邊我們希望收的 PubsubName (這邊是我們剛剛加的<code>kafka-pubsub</code>), 另外我們希望收<code>myevent</code>這個topic, 然後我們會希望收到event後打<code>/create</code>這個endpoint, 這有個好處, 你換成另一個完全不一樣的方案, 比如說Redis, 是不需要重新改code的</p><p>那我們在<code>/create</code>會收到甚麼呢?基本上就是包裝成CloudEvent的資料結構, 不對, 我們不是要收raw payload嗎?別急, 它只是收到後幫你包裝, 你的raw payload是被base64編碼好好地放在欄位<code>data_base64</code>中</p><p>這邊我特別沒用任何Dapr SDK, 然後也用gin來寫(Dapr的sdk裡用的是Gorilla),主要是為了展示, 這簡單到不用SDK呀(其實sdk也還沒支援raw payload subscriber相關的呀 XD)</p><h3 id=執行>執行</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>dapr run --app-id subs --app-port <span style=color:#ae81ff>6002</span> --dapr-http-port <span style=color:#ae81ff>3601</span> --dapr-grpc-port <span style=color:#ae81ff>60001</span> --log-level debug go run main.go
</span></span></code></pre></div><p>指令如上, 可以設定log level把debug訊息打開, 這邊有一點需要注意的, 這浪費我半天的青春, app port一定要設對, 我們程式內用<code>6002</code>那麼這邊的app port就要是<code>6002</code>, 不然Dapr不但會不知道要打事件給你, 連一開始的設定都拿不到(就是打<code>dapr/subscribe</code>)</p><h3 id=測試>測試</h3><p>測試方式很簡單, 如果你剛剛有裝Kafka map, 去那個topic發送一個訊息(按Produce message), 看有沒收到一樣的訊息就可以了</p><footer class=entry-meta><span class=entry-tags></span><div class=social-share><ul class="socialcount socialcount-small inline-list"><li class=facebook><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.jln.co%2fdapr-raw-payload-pub-sub%2f" target=_blank title="Share on Facebook"><span class=count><i class="fa fa-facebook-square"></i> Like</span></a></li><li class=twitter><a href="https://twitter.com/intent/tweet?text=https%3a%2f%2fblog.jln.co%2fdapr-raw-payload-pub-sub%2f" target=_blank title="Share on Twitter"><span class=count><i class="fa fa-twitter-square"></i> Tweet</span></a></li><li class=line><a href="https://social-plugins.line.me/lineit/share?url=https%3a%2f%2fblog.jln.co%2fdapr-raw-payload-pub-sub%2f" target=_blank title="Share on LINE"><span class=count><i class="fab fa-line"></i>LINE</span></a></li></ul></div></footer></div><section id=disqus_thread><div class=fb-comments data-href=https://blog.jln.co/dapr-raw-payload-pub-sub/ data-numposts=5 data-width></div></section></article></div><div class=footer-wrapper><footer role=contentinfo><span>Powered by <a href=https://gohugo.io/ rel=nofollow>Hugo</a> using the <a href=https://github.com/dldx/hpstr-hugo-theme rel=nofollow>HPSTR theme</a>.</span></footer></div><script src=//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js></script>
<script src=https://kit.fontawesome.com/872a53b461.js crossorigin=anonymous></script>
<script>window.jQuery||document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script><script src=/js/scripts.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-79243751-1","auto"),ga("send","pageview"))</script><div id=fb-root></div><script async defer crossorigin=anonymous src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=293999444006555&autoLogAppEvents=1" nonce=geZSUIUh></script></body></html>